// ==== FILE: app\layout.tsx ====
export { default, generateMetadata } from '../src/app/layout'


// ==== FILE: app\loading.tsx ====
import React from 'react'

import { PostCardSkeleton } from '@/components/post-card-skeleton'

export default function RootLoading() {
  return (
    <div className="container mx-auto px-4 py-12">
      <div className="grid gap-6 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3">
        {Array.from({ length: 6 }).map((_, i) => (
          <PostCardSkeleton key={i} />
        ))}
      </div>
    </div>
  )
}


// ==== FILE: app\not-found.tsx ====
import Link from 'next/link'

export default function NotFound() {
  return (
    <div className="container mx-auto px-4 py-24 text-center">
      <h1 className="text-4xl font-bold mb-4">Page not found</h1>
      <p className="text-muted-foreground mb-8">The page you‚Äôre looking for doesn‚Äôt exist.</p>
      <Link href="/" className="bg-primary text-primary-foreground px-4 py-2 rounded">Back to Home</Link>
    </div>
  )
}


// ==== FILE: app\page.tsx ====
export { default } from "../src/app/page";
export * from "../src/app/page";


// ==== FILE: app\about\page.tsx ====
import { Avatar, AvatarImage, AvatarFallback } from "@/components/ui/avatar";

export default function AboutPage() {
  return (
    <section className="container mx-auto px-4 py-12 max-w-2xl animate-fade-in">
      <div className="flex flex-col items-center bg-card/60 rounded-xl shadow-lg p-8 mb-8">
        <Avatar className="h-24 w-24 mb-4 ring-4 ring-primary/30">
          <AvatarImage src="https://avatars.githubusercontent.com/u/10296482?v=4" alt="Ajay Chaturvedi" />
          <AvatarFallback>AC</AvatarFallback>
        </Avatar>
        <h1 className="text-3xl font-bold mb-1 text-center">Ajay Chaturvedi</h1>
        <p className="text-muted-foreground mb-4 text-center">Founder, TechOblivion</p>
        <p className="mb-6 text-lg text-center">I‚Äôm Ajay, passionate about technology and problem-solving. Through <span className="font-semibold">TechOblivion</span>, I share my journey, projects, and ideas to inspire and build together.</p>
        <div className="flex flex-wrap justify-center gap-3 mb-2">
          <a href="https://techoblivion.in/" className="btn-link" target="_blank" rel="noopener noreferrer">üåê Website</a>
          <a href="https://github.com/Ajaykr2109" className="btn-link" target="_blank" rel="noopener noreferrer">GitHub</a>
          <a href="https://www.facebook.com/ajaykrchaturvedi/" className="btn-link" target="_blank" rel="noopener noreferrer">Facebook</a>
          <a href="https://x.com/ChaturvediKrAj" className="btn-link" target="_blank" rel="noopener noreferrer">X (Twitter)</a>
          <a href="https://www.linkedin.com/in/ajaykrchaturvedi/" className="btn-link" target="_blank" rel="noopener noreferrer">LinkedIn</a>
          <a href="https://www.youtube.com/@tech.oblivion" className="btn-link" target="_blank" rel="noopener noreferrer">YouTube</a>
        </div>
      </div>
      <div className="bg-muted/40 rounded-lg p-6 shadow-sm">
        <h2 className="text-xl font-semibold mb-2">About TechOblivion</h2>
        <p className="mb-2">TechOblivion is a platform dedicated to sharing knowledge, projects, and inspiration in technology. Whether you‚Äôre a developer, enthusiast, or just curious, you‚Äôll find something to spark your interest.</p>
        <ul className="list-disc list-inside text-muted-foreground mb-2">
          <li>Project showcases & tutorials</li>
          <li>Tech blogs & insights</li>
          <li>Community-driven learning</li>
        </ul>
        <p className="text-sm text-muted-foreground">¬© 2025 Tech Oblivion. All Rights Reserved.</p>
      </div>
    </section>
  );
}


// ==== FILE: app\account\layout.tsx ====
'use client'

import Link from 'next/link'
import { usePathname } from 'next/navigation'
import { User as UserIcon, LayoutDashboard, Shield, Image as ImageIcon, Settings } from 'lucide-react'

import { cn } from '@/lib/utils'

const sidebarNavLinks = [
  { href: '/account', label: 'Overview', icon: LayoutDashboard },
  { href: '/account/profile', label: 'Profile', icon: UserIcon },
  { href: '/account/avatar', label: 'Avatar', icon: ImageIcon },
  { href: '/account/security', label: 'Security', icon: Shield },
  { href: '/account/settings', label: 'Preferences', icon: Settings },
]

export default function AccountLayout({ children }: { children: React.ReactNode }) {
  const pathname = usePathname()

  return (
    <div className="flex min-h-screen">
      <aside className="w-64 flex-shrink-0 border-r bg-card/50 p-4">
        <div className="flex h-full flex-col">
          <div className="mb-8 flex items-center gap-2 px-2 font-bold">
            <Link href="/" className="font-bold">
              tech.oblivion
            </Link>
          </div>
          <nav className="flex flex-col gap-2">
            {sidebarNavLinks.map((link) => {
              const isActive = pathname === link.href
              return (
                <Link
                  key={link.href}
                  href={link.href}
                  className={cn(
                    'flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium transition-colors',
                    isActive
                      ? 'bg-primary text-primary-foreground'
                      : 'text-muted-foreground hover:bg-accent hover:text-accent-foreground'
                  )}
                >
                  <link.icon className="h-4 w-4" />
                  <span>{link.label}</span>
                </Link>
              )
            })}
          </nav>
        </div>
      </aside>
      <main className="flex-1 overflow-auto bg-background">{children}</main>
    </div>
  )
}


// ==== FILE: app\account\page.tsx ====
import { redirect } from 'next/navigation'

import { getSessionUser } from '@/lib/auth'

import AccountCentral from '../../src/app/account/page'

export default async function AccountPageWrapper() {
	const user = await getSessionUser()
	if (!user) redirect('/login?next=/account')
	return <AccountCentral />
}


// ==== FILE: app\account\avatar\page.tsx ====
import { redirect } from 'next/navigation'

import { getSessionUser } from '@/lib/auth'

import AccountAvatarPage from '../../../src/app/account/avatar/page'

export default async function AccountAvatarWrapper() {
	const user = await getSessionUser()
	if (!user) redirect('/login?next=/account/avatar')
	return <AccountAvatarPage />
}


// ==== FILE: app\account\profile\page.tsx ====
import { redirect } from 'next/navigation'

import { getSessionUser } from '@/lib/auth'

import AccountProfilePage from '../../../src/app/account/profile/page'

export default async function AccountProfileWrapper() {
	const user = await getSessionUser()
	if (!user) redirect('/login?next=/account/profile')
	return <AccountProfilePage />
}


// ==== FILE: app\account\security\page.tsx ====
export default function SecurityPage() {
  return <div className="p-6">Security settings coming soon.</div>
}


// ==== FILE: app\account\settings\page.tsx ====
export default function PreferencesPage() {
  return <div className="p-6">Preferences coming soon.</div>
}


// ==== FILE: app\admin\layout.tsx ====

'use client'

import Link from 'next/link'
import { usePathname } from 'next/navigation'
import { LayoutDashboard, FileText, Users, MessageSquare, SettingsIcon, ImageIcon, Tags, FolderCog, PlugIcon, Palette, Activity, TestTubes } from 'lucide-react'
import { motion, AnimatePresence } from 'framer-motion'

import { cn } from '@/lib/utils'
import { ThemeToggle } from '@/components/theme-toggle'
import { useMe } from '@/hooks/useRoleGate'
import { mapToApiRole } from '@/lib/rbac'
import checkAccess from '@/lib/checkAccess'

type IconType = React.ComponentType<React.SVGProps<SVGSVGElement>>
type Item = { href: string; label: string; icon: IconType; key: string }
type Group = { label: string; items: Item[] }

const RAW_GROUPS: Group[] = [
  {
    label: 'Overview',
    items: [
      { href: '/admin', label: 'Dashboard', icon: LayoutDashboard, key: 'dashboard' },
      { href: '/admin/analytics', label: 'Analytics', icon: Activity, key: 'analytics' },
    ],
  },
  {
    label: 'Content',
    items: [
      { href: '/admin/posts', label: 'Posts', icon: FileText, key: 'posts' },
      { href: '/admin/media', label: 'Media', icon: ImageIcon, key: 'media' },
      { href: '/admin/categories', label: 'Categories', icon: FolderCog, key: 'categories' },
      { href: '/admin/tags', label: 'Tags', icon: Tags, key: 'tags' },
      { href: '/admin/comments', label: 'Comments', icon: MessageSquare, key: 'comments' },
    ],
  },
  {
    label: 'People',
    items: [
      { href: '/admin/users', label: 'Users', icon: Users, key: 'users' },
    ],
  },
  {
    label: 'System',
    items: [
      { href: '/admin/settings', label: 'Settings', icon: SettingsIcon, key: 'settings' },
      { href: '/admin/plugins', label: 'Plugins', icon: PlugIcon, key: 'plugins' },
      { href: '/admin/themes', label: 'Themes', icon: Palette, key: 'themes' },
      { href: '/admin/site-health', label: 'Site Health', icon: Activity, key: 'site-health' },
      { href: '/admin/debug', label: 'Debug/Test', icon: TestTubes, key: 'debug' },
    ],
  },
]

// Associate keys with RBAC-capable endpoints for gating
const KEY_TO_ENDPOINT: Record<string, { path: string; method: string; action: 'read' | 'write' | 'delete' | 'moderate' }[]> = {
  analytics: [
    { path: '/api/analytics/summary', method: 'GET', action: 'read' },
  ],
  posts: [
    { path: '/api/wp/posts', method: 'POST', action: 'write' },
  ],
  media: [
    { path: '/api/wp/media', method: 'POST', action: 'write' },
  ],
  categories: [
    { path: '/api/wp/categories', method: 'POST', action: 'write' },
  ],
  tags: [
    { path: '/api/wp/tags', method: 'POST', action: 'write' },
  ],
  comments: [
    { path: '/api/wp/comments/[id]', method: 'PATCH', action: 'moderate' },
  ],
  users: [
    { path: '/api/wp/users', method: 'GET', action: 'read' },
  ],
  settings: [
    { path: '/api/wp/settings', method: 'GET', action: 'read' },
  ],
  plugins: [
    { path: '/api/wp/plugins', method: 'GET', action: 'read' },
  ],
  themes: [
    { path: '/api/wp/themes', method: 'GET', action: 'read' },
  ],
  'site-health': [
    { path: '/api/wp/site-health/background-updates', method: 'GET', action: 'read' },
  ],
  debug: [
    { path: '/api/_debug', method: 'GET', action: 'read' },
    { path: '/api/test', method: 'GET', action: 'read' },
  ],
  dashboard: [
    { path: '/api/admin', method: 'GET', action: 'read' },
  ],
}

export default function AdminLayout({
  children,
}: {
  children: React.ReactNode
}) {
  const pathname = usePathname()
  const { me } = useMe()
  const apiRole = mapToApiRole(me?.roles)

  // Build groups filtered by RBAC matrix; also dedupe by key
  const filtered: Group[] = RAW_GROUPS.map((g) => {
    const uniq = new Map<string, Item>()
    for (const it of g.items) {
      if (uniq.has(it.key)) continue
      const endpoints = KEY_TO_ENDPOINT[it.key] || []
      const allowed = endpoints.length === 0 || endpoints.some((e) => checkAccess(apiRole, e.path, e.method, e.action))
      if (allowed) uniq.set(it.key, it)
    }
    return { label: g.label, items: Array.from(uniq.values()) }
  }).filter((g) => g.items.length > 0)

  return (
    <div className="flex min-h-screen">
      <aside className="w-64 flex-shrink-0 border-r bg-card/50 p-4">
        <div className="flex h-full flex-col">
          <div className="mb-8 flex items-center gap-2 px-2 font-bold">
            <Link href="/" className="font-bold">
              tech.oblivion
            </Link>
            <div className="ml-auto"><ThemeToggle /></div>
          </div>
          <nav className="flex flex-col gap-4">
            {filtered.map((group) => (
              <div key={group.label}>
                <div className="px-3 pb-1 text-xs font-medium uppercase text-muted-foreground">{group.label}</div>
                <div className="flex flex-col gap-1">
                  <AnimatePresence initial={false}>
                    {group.items.map((link) => {
                      const isActive = pathname === link.href
                      return (
                        <motion.div
                          key={link.href}
                          initial={{ opacity: 0, y: -4 }}
                          animate={{ opacity: 1, y: 0 }}
                          exit={{ opacity: 0, y: -4 }}
                          transition={{ duration: 0.15 }}
                        >
                          <Link
                            href={link.href}
                            className={cn(
                              'flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium transition-colors',
                              isActive
                                ? 'bg-primary text-primary-foreground'
                                : 'text-muted-foreground hover:bg-accent hover:text-accent-foreground'
                            )}
                          >
                            <link.icon className="h-4 w-4" />
                            <span>{link.label}</span>
                          </Link>
                        </motion.div>
                      )
                    })}
                  </AnimatePresence>
                </div>
              </div>
            ))}
          </nav>
        </div>
      </aside>
      <main className="flex-1 overflow-auto bg-background">
        {children}
      </main>
    </div>
  )
}


// ==== FILE: app\admin\page.tsx ====
import { redirect } from 'next/navigation'

export const runtime = 'nodejs'

export default function AdminHomePage() {
  redirect('/admin/dashboard')
}


// ==== FILE: app\admin\analytics\page.tsx ====
import AdminDashboard from '@/components/admin/AdminDashboard'

export const runtime = 'nodejs'

export default function Page() {
  return <AdminDashboard sectionKey="analytics" />
}


// ==== FILE: app\admin\categories\page.tsx ====
import AdminDashboard from '@/components/admin/AdminDashboard'

export const runtime = 'nodejs'

export default function Page() { return <AdminDashboard sectionKey="categories" /> }


// ==== FILE: app\admin\comments\page.tsx ====
import AdminDashboard from '@/components/admin/AdminDashboard'

export const runtime = 'nodejs'

export default function Page() { return <AdminDashboard sectionKey="comments" /> }


// ==== FILE: app\admin\comments\pageClient.tsx ====
"use client"

import { useMemo, useState } from 'react'
import { Reply, Trash2 } from 'lucide-react'

import BulkActionsBar, { BulkAction } from '@/components/admin/BulkActionsBar'
import { TableCell } from '@/components/ui/table'
import SelectableTable from '@/components/admin/SelectableTable'
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar'
import { Button } from '@/components/ui/button'

const dummyComments = [
  { id: 1, author: "Alex Johnson", avatar: "https://i.pravatar.cc/150?u=a04258114e29026702d", text: "This was an incredibly insightful article. The section on server components really cleared things up for me. Thanks!", post: "A Deep Dive into React Server Components", date: "2024-07-29" },
  { id: 2, author: "Maria Garcia", avatar: "https://i.pravatar.cc/150?u=a042581f4e29026703d", text: "I'm not sure I agree with point number 3. Have you considered the performance implications on larger-scale applications?", post: "The Future of AI in Web Development", date: "2024-07-28" },
  { id: 3, author: "Sam Lee", avatar: "https://i.pravatar.cc/150?u=a042581f4e29026704d", text: "Great post! Do you have a GitHub repository with the code examples?", post: "Mastering Tailwind CSS for Modern UIs", date: "2024-07-28" },
]

export default function CommentsClient() {
  const [selected, setSelected] = useState<number[]>([])
  const header = useMemo(()=>[
    'Author', 'Comment', 'Post', 'Date', 'Actions'
  ], [])
  const rows = useMemo(()=> dummyComments.map(c => ({
    id: c.id,
    cells: [
      <div className="flex items-center gap-3" key="author">
        <Avatar>
          <AvatarImage src={c.avatar} alt={c.author} />
          <AvatarFallback>{c.author.charAt(0)}</AvatarFallback>
        </Avatar>
        <span className="font-medium">{c.author}</span>
      </div>,
      <span className="text-muted-foreground" key="text">{c.text}</span>,
      <span key="post">{c.post}</span>,
      <span key="date">{c.date}</span>,
      <div className="flex justify-end gap-2" key="actions">
        <Button variant="outline" size="sm"><Reply className="mr-2 h-4 w-4" /> Reply</Button>
        <Button variant="destructive" size="sm"><Trash2 className="mr-2 h-4 w-4" /> Delete</Button>
      </div>
    ]
  })), [])

  const onAction = async (action: BulkAction) => {
    if (selected.length === 0) return
    const res = await fetch('/api/wp/comments/bulk', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ ids: selected, action })
    })
    if (!res.ok) throw new Error('Bulk action failed')
  }

  return (
    <div>
      <BulkActionsBar onAction={onAction} disabled={selected.length===0} />
      <SelectableTable rows={rows} header={header} onSelectionChange={setSelected} />
    </div>
  )
}


// ==== FILE: app\admin\dashboard\page.tsx ====
import AdminDashboard from '@/components/admin/AdminDashboard'

export const runtime = 'nodejs'

export default async function Page() {
  return <AdminDashboard sectionKey="dashboard" />
}


// ==== FILE: app\admin\debug\page.tsx ====
import AdminDashboard from '@/components/admin/AdminDashboard'

export const runtime = 'nodejs'

export default function Page() { return <AdminDashboard sectionKey="debug" /> }


// ==== FILE: app\admin\media\page.tsx ====
import AdminDashboard from '@/components/admin/AdminDashboard'

export const runtime = 'nodejs'

export default function Page() { return <AdminDashboard sectionKey="media" /> }


// ==== FILE: app\admin\plugins\page.tsx ====
import AdminDashboard from '@/components/admin/AdminDashboard'

export const runtime = 'nodejs'

export default function Page() { return <AdminDashboard sectionKey="plugins" /> }


// ==== FILE: app\admin\posts\page.tsx ====
import AdminDashboard from '@/components/admin/AdminDashboard'

export const runtime = 'nodejs'

export default function Page() { return <AdminDashboard sectionKey="posts" /> }


// ==== FILE: app\admin\posts\new\edit\page.tsx ====
export default function NewPostEditPage() {
  return (
    <div className="p-6">
      <h1 className="text-xl font-semibold mb-2">New Post Editor</h1>
      <p className="text-sm text-muted-foreground">Inline editor coming soon. Use Posts section tiles to create and autosave drafts.</p>
    </div>
  )
}


// ==== FILE: app\admin\posts\[id]\edit\page.tsx ====
import { notFound } from 'next/navigation'

import PostEditorPageClient from '@/components/admin/PostEditorPageClient'

export const runtime = 'nodejs'

async function fetchPost(id: string) {
  const res = await fetch(`${process.env.NEXT_PUBLIC_SITE_URL || ''}/api/wp/posts?id=${id}`, { cache: 'no-store' })
  if (!res.ok) return null
  const p = await res.json()
  return p
}

export default async function EditPostPage({ params }: { params: { id: string } }) {
  const { id } = params
  if (!id) notFound()
  // Role gate via Roles Matrix API (single source of truth)
  const rmRes = await fetch('/api/roles/matrix', { cache: 'no-store' })
  if (!rmRes.ok) notFound()
  const matrix = await rmRes.json()
  if (!matrix?.can?.posts?.edit) notFound()
  const post = await fetchPost(id)
  if (!post) notFound()
  const title = typeof post?.title === 'string' ? post.title : post?.title?.rendered || ''
  const content = typeof post?.content === 'string' ? post.content : post?.content?.rendered || ''
  const excerpt = typeof post?.excerpt === 'string' ? post.excerpt : post?.excerpt?.rendered || ''
  const status = post?.status || 'draft'
  return (
    <PostEditorPageClient postId={Number(id)} initial={{ title, content, excerpt, status }} />
  )
}


// ==== FILE: app\admin\settings\page.tsx ====
import AdminDashboard from '@/components/admin/AdminDashboard'

export const runtime = 'nodejs'

export default function Page() { return <AdminDashboard sectionKey="settings" /> }


// ==== FILE: app\admin\site-health\page.tsx ====
import AdminDashboard from '@/components/admin/AdminDashboard'

export const runtime = 'nodejs'

export default function Page() { return <AdminDashboard sectionKey="site-health" /> }


// ==== FILE: app\admin\tags\page.tsx ====
import AdminDashboard from '@/components/admin/AdminDashboard'

export const runtime = 'nodejs'

export default function Page() { return <AdminDashboard sectionKey="tags" /> }


// ==== FILE: app\admin\themes\page.tsx ====
import AdminDashboard from '@/components/admin/AdminDashboard'

export const runtime = 'nodejs'

export default function Page() { return <AdminDashboard sectionKey="themes" /> }


// ==== FILE: app\admin\users\page.tsx ====
import AdminDashboard from '@/components/admin/AdminDashboard'

export const runtime = 'nodejs'

export default function Page() { return <AdminDashboard sectionKey="users" /> }


// ==== FILE: app\admin\users\pageClient.tsx ====
"use client"

import { useMemo, useState } from 'react'
import { MoreHorizontal, Search, UserPlus } from 'lucide-react'

import { Input } from '@/components/ui/input'
import { Button } from '@/components/ui/button'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'
import { Badge } from '@/components/ui/badge'
import { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuLabel, DropdownMenuTrigger } from '@/components/ui/dropdown-menu'
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar'
import BulkActionsBar, { BulkAction } from '@/components/admin/BulkActionsBar'
import SelectableTable from '@/components/admin/SelectableTable'

const dummyUsers = [
  { id: 1, name: "Jane Doe", email: "jane.doe@example.com", role: "Administrator", avatar: "https://i.pravatar.cc/150?u=a042581f4e29026704d" },
  { id: 2, name: "John Smith", email: "john.smith@example.com", role: "Editor", avatar: "https://i.pravatar.cc/150?u=a042581f4e29026705d" },
  { id: 3, name: "Emily White", email: "emily.white@example.com", role: "Author", avatar: "https://i.pravatar.cc/150?u=a042581f4e29026706d" },
  { id: 4, name: "Chris Green", email: "chris.green@example.com", role: "Subscriber", avatar: "https://i.pravatar.cc/150?u=a042581f4e29026707d" },
];

export default function UsersClient() {
  const [selected, setSelected] = useState<number[]>([])
  const header = useMemo(()=>['User','Role','Actions'],[])
  const rows = useMemo(()=> dummyUsers.map(u => ({
    id: u.id,
    cells: [
      <div className="flex items-center gap-3" key="user">
        <Avatar>
          <AvatarImage src={u.avatar} alt={u.name} />
          <AvatarFallback>{u.name.charAt(0)}</AvatarFallback>
        </Avatar>
        <div>
          <p className="font-medium">{u.name}</p>
          <p className="text-sm text-muted-foreground">{u.email}</p>
        </div>
      </div>,
      <Badge variant="outline" key="role">{u.role}</Badge>,
      <div key="actions" className="text-right">
        <DropdownMenu>
          <DropdownMenuTrigger asChild>
            <Button variant="ghost" className="h-8 w-8 p-0">
              <span className="sr-only">Open menu</span>
              <MoreHorizontal className="h-4 w-4" />
            </Button>
          </DropdownMenuTrigger>
          <DropdownMenuContent align="end">
            <DropdownMenuLabel>Actions</DropdownMenuLabel>
            <DropdownMenuItem>Edit User</DropdownMenuItem>
            <DropdownMenuItem>View Profile</DropdownMenuItem>
            <DropdownMenuItem className="text-red-500">Delete User</DropdownMenuItem>
          </DropdownMenuContent>
        </DropdownMenu>
      </div>
    ]
  })), [])

  const onAction = async (action: BulkAction) => {
    if (action !== 'delete' || selected.length === 0) return
    const res = await fetch('/api/wp/users/bulk-delete', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ ids: selected })
    })
    if (!res.ok) throw new Error('Bulk delete failed')
  }

  return (
    <div>
      <div className="flex justify-between items-center mb-8">
        <Button><UserPlus className="mr-2 h-4 w-4" /> Add User</Button>
      </div>

      <Card>
        <CardHeader>
          <CardTitle>All Users</CardTitle>
          <div className="mt-4 flex flex-col md:flex-row gap-4">
            <div className="relative flex-1">
              <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-muted-foreground" />
              <Input placeholder="Search users by name or email..." className="pl-10" />
            </div>
            <Select>
              <SelectTrigger className="w-full md:w-[180px]">
                <SelectValue placeholder="Filter by role" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="all">All Roles</SelectItem>
                <SelectItem value="admin">Administrator</SelectItem>
                <SelectItem value="editor">Editor</SelectItem>
                <SelectItem value="author">Author</SelectItem>
                <SelectItem value="subscriber">Subscriber</SelectItem>
              </SelectContent>
            </Select>
          </div>
        </CardHeader>
        <CardContent>
          <BulkActionsBar onAction={onAction} disabled={selected.length===0} />
          <SelectableTable rows={rows} header={header} onSelectionChange={setSelected} />
        </CardContent>
      </Card>
    </div>
  )
}


// ==== FILE: app\admin\users\UsersClient.tsx ====
"use client"

import { useMemo, useState } from 'react'
import { MoreHorizontal, Search, UserPlus } from 'lucide-react'

import { Input } from '@/components/ui/input'
import { Button } from '@/components/ui/button'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'
import { Badge } from '@/components/ui/badge'
import { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuLabel, DropdownMenuTrigger } from '@/components/ui/dropdown-menu'
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar'
import BulkActionsBar, { BulkAction } from '@/components/admin/BulkActionsBar'
import SelectableTable from '@/components/admin/SelectableTable'

const dummyUsers = [
  { id: 1, name: "Jane Doe", email: "jane.doe@example.com", role: "Administrator", avatar: "https://i.pravatar.cc/150?u=a042581f4e29026704d" },
  { id: 2, name: "John Smith", email: "john.smith@example.com", role: "Editor", avatar: "https://i.pravatar.cc/150?u=a042581f4e29026705d" },
  { id: 3, name: "Emily White", email: "emily.white@example.com", role: "Author", avatar: "https://i.pravatar.cc/150?u=a042581f4e29026706d" },
  { id: 4, name: "Chris Green", email: "chris.green@example.com", role: "Subscriber", avatar: "https://i.pravatar.cc/150?u=a042581f4e29026707d" },
];

export default function UsersClient() {
  const [selected, setSelected] = useState<number[]>([])
  const header = useMemo(()=>['User','Role','Actions'],[])
  const rows = useMemo(()=> dummyUsers.map(u => ({
    id: u.id,
    cells: [
      <div className="flex items-center gap-3" key="user">
        <Avatar>
          <AvatarImage src={u.avatar} alt={u.name} />
          <AvatarFallback>{u.name.charAt(0)}</AvatarFallback>
        </Avatar>
        <div>
          <p className="font-medium">{u.name}</p>
          <p className="text-sm text-muted-foreground">{u.email}</p>
        </div>
      </div>,
      <Badge variant="outline" key="role">{u.role}</Badge>,
      <div key="actions" className="text-right">
        <DropdownMenu>
          <DropdownMenuTrigger asChild>
            <Button variant="ghost" className="h-8 w-8 p-0">
              <span className="sr-only">Open menu</span>
              <MoreHorizontal className="h-4 w-4" />
            </Button>
          </DropdownMenuTrigger>
          <DropdownMenuContent align="end">
            <DropdownMenuLabel>Actions</DropdownMenuLabel>
            <DropdownMenuItem>Edit User</DropdownMenuItem>
            <DropdownMenuItem>View Profile</DropdownMenuItem>
            <DropdownMenuItem className="text-red-500">Delete User</DropdownMenuItem>
          </DropdownMenuContent>
        </DropdownMenu>
      </div>
    ]
  })), [])

  const onAction = async (action: BulkAction) => {
    if (action !== 'delete' || selected.length === 0) return
    const res = await fetch('/api/wp/users/bulk-delete', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ ids: selected })
    })
    if (!res.ok) throw new Error('Bulk delete failed')
  }

  return (
    <div>
      <div className="flex justify-between items-center mb-8">
        <Button><UserPlus className="mr-2 h-4 w-4" /> Add User</Button>
      </div>

      <Card>
        <CardHeader>
          <CardTitle>All Users</CardTitle>
          <div className="mt-4 flex flex-col md:flex-row gap-4">
            <div className="relative flex-1">
              <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-muted-foreground" />
              <Input placeholder="Search users by name or email..." className="pl-10" />
            </div>
            <Select>
              <SelectTrigger className="w-full md:w-[180px]">
                <SelectValue placeholder="Filter by role" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="all">All Roles</SelectItem>
                <SelectItem value="admin">Administrator</SelectItem>
                <SelectItem value="editor">Editor</SelectItem>
                <SelectItem value="author">Author</SelectItem>
                <SelectItem value="subscriber">Subscriber</SelectItem>
              </SelectContent>
            </Select>
          </div>
        </CardHeader>
        <CardContent>
          <BulkActionsBar onAction={onAction} disabled={selected.length===0} />
          <SelectableTable rows={rows} header={header} onSelectionChange={setSelected} />
        </CardContent>
      </Card>
    </div>
  )
}


// ==== FILE: app\api\admin\route.ts ====
import { NextResponse } from 'next/server'

import { requireRole } from '../../../src/lib/auth'

export async function GET() {
  try {
    await requireRole('administrator')
    return NextResponse.json({ ok: true })
  } catch (err: any) {
    return NextResponse.json({ message: err.message || 'Forbidden' }, { status: err.status ?? 403 })
  }
}


// ==== FILE: app\api\analytics\check\route.ts ====
import { apiMap } from '@/lib/wpAPIMap'
import { fetchWithAuth, MissingWpTokenError } from '@/lib/fetchWithAuth'

export const runtime = 'nodejs'
export const dynamic = 'force-dynamic'

export async function GET(req: Request) {
  try {
    const url = apiMap.analytics.check
    if (!url) return new Response(JSON.stringify({ error: 'WP_URL env required' }), { status: 500 })
    return await fetchWithAuth(req, url)
  } catch (err: any) {
    if (err instanceof MissingWpTokenError) {
      return new Response(JSON.stringify({ error: 'unauthorized', message: err.message }), { status: err.status, headers: { 'Content-Type': 'application/json' } })
    }
    console.error('analytics.check unexpected error:', err)
    return new Response(JSON.stringify({ error: 'proxy_error', message: 'Failed to check analytics' }), { status: 502, headers: { 'Content-Type': 'application/json' } })
  }
}


// ==== FILE: app\api\analytics\countries\route.ts ====
import { apiMap } from '@/lib/wpAPIMap'
import { fetchWithAuth } from '@/lib/fetchWithAuth'

export const runtime = 'nodejs'
export const dynamic = 'force-dynamic'

export async function GET(req: Request) {
  const base = apiMap.analytics.countries
  if (!base) return new Response(JSON.stringify({ error: 'WP_URL env required' }), { status: 500 })
  const inUrl = new URL(req.url)
  const period = inUrl.searchParams.get('period') || 'month'
  const u = new URL(base)
  u.searchParams.set('period', period)
  return fetchWithAuth(req, u.toString())
}


// ==== FILE: app\api\analytics\devices\route.ts ====
import { apiMap } from '@/lib/wpAPIMap'
import { fetchWithAuth } from '@/lib/fetchWithAuth'

export const runtime = 'nodejs'
export const dynamic = 'force-dynamic'

export async function GET(req: Request) {
  const base = apiMap.analytics.devices
  if (!base) return new Response(JSON.stringify({ error: 'WP_URL env required' }), { status: 500 })
  const inUrl = new URL(req.url)
  const period = inUrl.searchParams.get('period') || 'month'
  const u = new URL(base)
  u.searchParams.set('period', period)
  return fetchWithAuth(req, u.toString())
}


// ==== FILE: app\api\analytics\export\route.ts ====
export const runtime = 'nodejs'
export const dynamic = 'force-dynamic'

function toCSV(rows: any[], headers?: string[]) {
  if (!Array.isArray(rows) || rows.length === 0) return ''
  const cols = headers || Object.keys(rows[0])
  const esc = (v: any) => {
    if (v == null) return ''
    const s = String(v)
    if (/[",\n]/.test(s)) return '"' + s.replace(/"/g, '""') + '"'
    return s
  }
  const out = [cols.join(',')]
  for (const r of rows) out.push(cols.map(c => esc(r[c])).join(','))
  return out.join('\n')
}

export async function GET(req: Request) {
  const inUrl = new URL(req.url)
  const type = inUrl.searchParams.get('type') || 'views'
  const period = inUrl.searchParams.get('period') || 'month'
  const postId = inUrl.searchParams.get('postId') || ''

  let api = ''
  if (type === 'views') {
    api = `/api/analytics/views?period=${encodeURIComponent(period)}${postId ? `&postId=${encodeURIComponent(postId)}` : ''}`
  } else if (type === 'top-posts') {
    api = `/api/analytics/top-posts?period=${encodeURIComponent(period)}`
  } else if (type === 'devices') {
  api = `/api/analytics/summary?period=${encodeURIComponent(period)}`
  } else if (type === 'countries') {
  api = `/api/analytics/summary?period=${encodeURIComponent(period)}`
  } else if (type === 'referers') {
  api = `/api/analytics/summary?period=${encodeURIComponent(period)}`
  } else {
    return new Response('unknown type', { status: 400 })
  }

  const origin = inUrl.origin
  const res = await fetch(new URL(api, origin), { headers: { cookie: req.headers.get('cookie') || '' } })
  if (!res.ok) return new Response(await res.text(), { status: res.status })
  const data = await res.json()
  let csv = ''
  if (type === 'views') {
    csv = toCSV(data?.series || [], ['date','views'])
  } else if (type === 'top-posts') {
    csv = toCSV(data || [], ['id','slug','title','views'])
  } else if (type === 'devices') {
    csv = toCSV((data?.devices || []), ['device_type','count'])
  } else if (type === 'countries') {
    csv = toCSV((data?.countries || []), ['country_code','count'])
  } else if (type === 'referers') {
    csv = toCSV((data?.referers || []), ['source','count','category'])
  }
  return new Response(csv, { status: 200, headers: { 'Content-Type': 'text/csv', 'Content-Disposition': `attachment; filename="${type}-${period}.csv"` } })
}


// ==== FILE: app\api\analytics\referers\route.ts ====
import { apiMap } from '@/lib/wpAPIMap'
import { fetchWithAuth } from '@/lib/fetchWithAuth'

export const runtime = 'nodejs'
export const dynamic = 'force-dynamic'

export async function GET(req: Request) {
  const base = apiMap.analytics.referers
  if (!base) return new Response(JSON.stringify({ error: 'WP_URL env required' }), { status: 500 })
  const inUrl = new URL(req.url)
  const period = inUrl.searchParams.get('period') || 'month'
  const u = new URL(base)
  u.searchParams.set('period', period)
  return fetchWithAuth(req, u.toString())
}


// ==== FILE: app\api\analytics\sessions\route.ts ====
import { apiMap } from '@/lib/wpAPIMap'
import { fetchWithAuth } from '@/lib/fetchWithAuth'

export const runtime = 'nodejs'
export const dynamic = 'force-dynamic'

export async function GET(req: Request) {
  const base = apiMap.analytics.sessions
  if (!base) return new Response(JSON.stringify({ error: 'WP_URL env required' }), { status: 500 })
  const inUrl = new URL(req.url)
  const period = inUrl.searchParams.get('period') || 'month'
  const u = new URL(base)
  u.searchParams.set('period', period)
  return fetchWithAuth(req, u.toString())
}


// ==== FILE: app\api\analytics\sessions\summary\route.ts ====
import { fetchWithAuth } from '@/lib/fetchWithAuth'

export const runtime = 'nodejs'
export const dynamic = 'force-dynamic'
const WP = (process.env.WP_URL || '').replace(/\/$/, '')

export async function GET(req: Request) {
  if (!WP) return Response.json({ error: 'WP_URL env required' }, { status: 500 })
  return fetchWithAuth(req, `${WP}/wp-json/fe-analytics/v1/sessions/summary`)
}


// ==== FILE: app\api\analytics\sessions\timeseries\route.ts ====
import { fetchWithAuth } from '@/lib/fetchWithAuth'

export const runtime = 'nodejs'
export const dynamic = 'force-dynamic'
const WP = (process.env.WP_URL || '').replace(/\/$/, '')

export async function GET(req: Request) {
  if (!WP) return Response.json({ error: 'WP_URL env required' }, { status: 500 })
  return fetchWithAuth(req, `${WP}/wp-json/fe-analytics/v1/sessions/timeseries`)
}


// ==== FILE: app\api\analytics\stream\route.ts ====
import { getWpTokenFromRequest } from '@/lib/fetchWithAuth'

export const runtime = 'nodejs'
export const dynamic = 'force-dynamic'
const WP = (process.env.WP_URL || '').replace(/\/$/, '')

export async function GET(req: Request) {
  if (!WP) return new Response('WP_URL not set', { status: 500 })
  const token = await getWpTokenFromRequest(req)
  if (!token) return new Response('Unauthorized', { status: 401 })
  const upstream = await fetch(`${WP}/wp-json/fe-analytics/v1/stream`, {
    headers: {
      Authorization: `Bearer ${token}`,
      Cookie: `Authorization=Bearer ${token}`,
      Accept: 'text/event-stream',
    },
  })
  if (!upstream.body) return new Response('No stream', { status: 502 })
  return new Response(upstream.body, { headers: { 'Content-Type': 'text/event-stream', 'Cache-Control': 'no-cache', Connection: 'keep-alive' } })
}


// ==== FILE: app\api\analytics\summary\route.ts ====
import { cookies } from 'next/headers'

import { apiMap } from '@/lib/wpAPIMap'
import { fetchWithAuth, MissingWpTokenError } from '@/lib/fetchWithAuth'
import { verifySession } from '@/lib/jwt'

export const runtime = 'nodejs'
export const dynamic = 'force-dynamic'

export async function GET(req: Request) {
  try {
    // Derive wpToken from session cookie (or fall back to request parsing in fetchWithAuth)
    let wpToken: string | null = null
    try {
      const store = await cookies()
      const sessionCookie = store.get(process.env.SESSION_COOKIE_NAME ?? 'session')?.value
      if (sessionCookie) {
        const claims = await verifySession(sessionCookie)
        wpToken = (claims as any)?.wpToken || null
      }
    } catch (e) {
      // ignore cookie/verify errors; fetchWithAuth will throw if no token
    }
    const inUrl = new URL(req.url)
    const period = inUrl.searchParams.get('period') || 'month'
    const refresh = inUrl.searchParams.get('refresh') || ''

    const { analytics } = apiMap
    const endpoints = {
      views: analytics.views,
      devices: analytics.devices,
      countries: analytics.countries,
      referers: analytics.referers,
    }
    if (!endpoints.views) {
      return new Response(JSON.stringify({ error: 'WP_URL env required' }), { status: 500, headers: { 'Content-Type': 'application/json' } })
    }

    const buildUrl = (base: string) => {
      const u = new URL(base)
      u.searchParams.set('period', period)
      if (refresh) u.searchParams.set('refresh', refresh)
      return u.toString()
    }

    // Fetch concurrently; apply light ISR-style caching
    const tokenOrReq = wpToken || req
    const [viewsRes, devicesRes, countriesRes, referersRes] = await Promise.all([
      fetchWithAuth(tokenOrReq, buildUrl(endpoints.views), { next: { revalidate: 60 } }),
      endpoints.devices ? fetchWithAuth(tokenOrReq, buildUrl(endpoints.devices), { next: { revalidate: 60 } }) : Promise.resolve(new Response('{}', { status: 204 })),
      endpoints.countries ? fetchWithAuth(tokenOrReq, buildUrl(endpoints.countries), { next: { revalidate: 60 } }) : Promise.resolve(new Response('{}', { status: 204 })),
      endpoints.referers ? fetchWithAuth(tokenOrReq, buildUrl(endpoints.referers), { next: { revalidate: 60 } }) : Promise.resolve(new Response('{}', { status: 204 })),
    ])

    const parseJSON = async (r: Response) => {
      if (!r || r.status === 204) return null
      const t = await r.text()
      try { return t ? JSON.parse(t) : null } catch { return { raw: t } }
    }

    const [views, devices, countries, referers] = await Promise.all([
      parseJSON(viewsRes),
      parseJSON(devicesRes),
      parseJSON(countriesRes),
      parseJSON(referersRes),
    ])

    const status = Math.max(viewsRes.status, devicesRes.status, countriesRes.status, referersRes.status)
    const body = { summary: { views, devices, countries, referers } }
    if (status === 401 || status === 403) {
      return new Response(JSON.stringify({ error: 'unauthorized', message: 'Not authorized to view analytics' }), { status, headers: { 'Content-Type': 'application/json' } })
    }
    return new Response(JSON.stringify(body), { status: status >= 400 ? 502 : 200, headers: { 'Content-Type': 'application/json' } })
  } catch (err: any) {
    if (err instanceof MissingWpTokenError) {
      return new Response(JSON.stringify({ error: 'unauthorized', message: err.message }), { status: err.status, headers: { 'Content-Type': 'application/json' } })
    }
    const message = typeof err?.message === 'string' ? err.message : 'Failed to fetch analytics summary'
    console.error('analytics.summary unexpected error:', err)
    return new Response(JSON.stringify({ error: 'proxy_error', message }), { status: 502, headers: { 'Content-Type': 'application/json' } })
  }
}


// ==== FILE: app\api\analytics\top-posts\route.ts ====
import { apiMap } from '@/lib/wpAPIMap'
import { fetchWithAuth } from '@/lib/fetchWithAuth'

export const runtime = 'nodejs'
export const dynamic = 'force-dynamic'

export async function GET(req: Request) {
  try {
    const base = apiMap.analytics.topPosts
    if (!base) {
      return new Response(JSON.stringify({ error: 'WP_URL env required' }), { status: 500, headers: { 'Content-Type': 'application/json' } })
    }
    const inUrl = new URL(req.url)
    const period = inUrl.searchParams.get('period') || 'month'
    const limit = inUrl.searchParams.get('limit') || '10'
    const u = new URL(base)
    u.searchParams.set('period', period)
    u.searchParams.set('limit', limit)

    // Light caching to reduce WP load
    const resp = await fetchWithAuth(req, u.toString(), { next: { revalidate: 60 } })
    return resp
  } catch (err: any) {
    const message = typeof err?.message === 'string' ? err.message : 'Failed to fetch top posts'
    return new Response(JSON.stringify({ error: 'proxy_error', message }), { status: 502, headers: { 'Content-Type': 'application/json' } })
  }
}


// ==== FILE: app\api\analytics\views\route.ts ====
import { apiMap } from '@/lib/wpAPIMap'
import { fetchWithAuth, MissingWpTokenError } from '@/lib/fetchWithAuth'

export const runtime = 'nodejs'
export const dynamic = 'force-dynamic'

export async function GET(req: Request) {
  try {
    const base = apiMap.analytics.views
    if (!base) return new Response(JSON.stringify({ error: 'WP_URL env required' }), { status: 500 })
    const inUrl = new URL(req.url)
    const period = inUrl.searchParams.get('period') || 'month'
    const postId = inUrl.searchParams.get('postId')
    const u = new URL(base)
    u.searchParams.set('period', period)
    if (postId) u.searchParams.set('post_id', postId)
    return await fetchWithAuth(req, u.toString())
  } catch (err: any) {
    if (err instanceof MissingWpTokenError) {
      return new Response(JSON.stringify({ error: 'unauthorized', message: err.message }), { status: err.status, headers: { 'Content-Type': 'application/json' } })
    }
    console.error('analytics.views unexpected error:', err)
    return new Response(JSON.stringify({ error: 'proxy_error', message: 'Failed to fetch analytics views' }), { status: 502, headers: { 'Content-Type': 'application/json' } })
  }
}


// ==== FILE: app\api\auth\login\route.ts ====
// cookies import removed (unused)
import { z } from 'zod'

import { signSession } from '../../../../src/lib/jwt'
import { logWPError } from '../../../../src/lib/log'
import { validateCsrf, validateCsrfFromRequest } from '../../../../src/lib/csrf'

const schema = z.object({ identifier: z.string().min(1), password: z.string().min(1) })

export async function POST(req: Request) {
  // CSRF double-submit protection
  const csrfHeader = req.headers.get('x-csrf-token') || undefined
  // Validate via cookies() or directly from request headers; accept either for robustness
  const ok = validateCsrf(csrfHeader) || validateCsrfFromRequest(req, csrfHeader)
  if (!ok) {
    console.warn('CSRF validation failed', {
      hasHeader: Boolean(csrfHeader),
      hasCookieHeader: Boolean(req.headers.get('cookie')),
    })
    return new Response(JSON.stringify({ error: 'Invalid CSRF' }), { status: 403, headers: { 'Content-Type': 'application/json' } })
  }
  const body = await req.json()
  const { identifier, password } = schema.parse(body)
  let data: any
  
  try {
    // Direct fetch to WordPress JWT endpoint
    const wpUrl = process.env.WP_URL || 'http://example.com'
    // Add a timeout to avoid hanging requests
    const controller = new AbortController()
    const timeout = setTimeout(() => controller.abort(), 10000)
    const response = await fetch(`${wpUrl}/wp-json/jwt-auth/v1/token`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'User-Agent': 'tech-oblivion-fe/1.0',
      },
      body: JSON.stringify({ username: identifier, password }),
      signal: controller.signal,
    }).finally(() => clearTimeout(timeout))

    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}))
      logWPError('jwt-auth-failed', { 
        status: response.status, 
        statusText: response.statusText,
        body: JSON.stringify(errorData)
      })
      
      if (response.status === 403) {
        return new Response(JSON.stringify({ 
          error: 'Invalid credentials', 
          message: 'Username or password is incorrect' 
        }), { 
          status: 401, 
          headers: { 'Content-Type': 'application/json' } 
        })
      }
      
      return new Response(JSON.stringify({ 
        error: 'WordPress authentication failed', 
        details: errorData 
      }), { 
        status: response.status, 
        headers: { 'Content-Type': 'application/json' } 
      })
    }

    data = await response.json()
    
  } catch (err: any) {
    console.error('WordPress connection error:', err)
    logWPError('wordpress-connection-error', { 
      statusText: err.message,
      body: err.stack || ''
    })
    
    return new Response(JSON.stringify({ 
      error: 'Unable to reach WordPress backend', 
      details: err.message 
    }), { 
      status: 502, 
      headers: { 'Content-Type': 'application/json' } 
    })
  }

  // JWT auth endpoint returns token and user info
  const { token, user_email, user_nicename, user_display_name, user_id } = data as { 
    token: string; 
    user_email: string; 
    user_nicename: string; 
    user_display_name: string;
    user_id?: number;
  }

  // Try to enrich roles via WP /users/me (requires edit context)
  let wpRoles: string[] | undefined = undefined
  try {
    const wpUrl = process.env.WP_URL || 'http://example.com'
    const meResp = await fetch(`${wpUrl}/wp-json/wp/v2/users/me?context=edit`, {
      headers: {
        'Authorization': `Bearer ${token}`,
        'User-Agent': 'tech-oblivion-fe/1.0',
      },
      cache: 'no-store',
    })
    if (meResp.ok) {
      const meJson: any = await meResp.json()
      if (meJson && Array.isArray(meJson.roles)) {
        wpRoles = meJson.roles
      }
    }
  } catch (e) {
    // ignore; fallback to default below
  }

  // Create session with the user data from JWT response
  // IMPORTANT: include the upstream WP JWT as `wpToken` so protected proxy routes can authenticate.
  const sessionToken = await signSession({ 
    sub: String(user_id || user_nicename), 
    username: user_nicename, 
    email: user_email, 
  roles: Array.isArray(wpRoles) && wpRoles.length ? wpRoles : ['subscriber'],
    wpUserId: user_id,
    displayName: user_display_name,
    wpToken: token,
  })

  // Only set Secure on HTTPS; using it on HTTP drops the cookie and causes auth loops
  const xfProto = req.headers.get('x-forwarded-proto')
  const isHttps = (xfProto ? xfProto.split(',')[0].trim() : '') === 'https' || new URL(req.url).protocol === 'https:'
  const cookie = `${process.env.SESSION_COOKIE_NAME || 'session'}=${sessionToken}; Path=/; Max-Age=${60 * 60 * 24 * 7}; SameSite=Lax; ${isHttps ? 'Secure; ' : ''}HttpOnly`
  
  return new Response(JSON.stringify({ 
    user: {
      id: data.user_id || user_nicename,
      username: user_nicename,
      email: user_email,
      displayName: user_display_name
    },
    token 
  }), { status: 200, headers: { 'Set-Cookie': cookie, 'Content-Type': 'application/json' } })
}


// ==== FILE: app\api\auth\logout\route.ts ====
// cookies import removed (unused)

export async function POST(req: Request) {
  const xfProto = req.headers.get('x-forwarded-proto')
  const isHttps = (xfProto ? xfProto.split(',')[0].trim() : '') === 'https' || new URL(req.url).protocol === 'https:'
  const cookie = `${process.env.SESSION_COOKIE_NAME || 'session'}=; Path=/; Max-Age=0; SameSite=Lax; ${isHttps ? 'Secure; ' : ''}HttpOnly`
  return new Response(null, { status: 204, headers: { 'Set-Cookie': cookie } })
}

export async function GET(req: Request) {
  const xfProto = req.headers.get('x-forwarded-proto')
  const isHttps = (xfProto ? xfProto.split(',')[0].trim() : '') === 'https' || new URL(req.url).protocol === 'https:'
  const cookie = `${process.env.SESSION_COOKIE_NAME || 'session'}=; Path=/; Max-Age=0; SameSite=Lax; ${isHttps ? 'Secure; ' : ''}HttpOnly`
  const url = new URL(req.url)
  const redirect = url.searchParams.get('redirect') || '/'
  return new Response(null, { status: 302, headers: { 'Set-Cookie': cookie, Location: redirect } })
}


// ==== FILE: app\api\auth\me\route.ts ====
// cookies import removed (unused)
import { createHash } from 'crypto'

import { verifySession } from '../../../../src/lib/jwt'

export async function GET(req: Request) {
  const cookieHeader = req.headers.get('cookie') || ''
  const match = cookieHeader.match(new RegExp(`${process.env.SESSION_COOKIE_NAME || 'session'}=([^;]+)`))
  const token = match?.[1]
  if (!token) return new Response(JSON.stringify({ error: 'Unauthorized' }), { status: 401 })
  try {
    const claims = await verifySession(token) as any
  const user: any = {
      id: claims.wpUserId ?? claims.sub,
      username: claims.username,
      email: claims.email,
      displayName: claims.displayName ?? claims.username,
      roles: Array.isArray(claims.roles) ? claims.roles : [],
    }
    // Enrich with live WP profile data (avatar, url, description, updated roles) when possible
    const WP = process.env.WP_URL
    const wpToken = claims.wpToken
    if (WP && wpToken) {
      try {
        const url = new URL('/wp-json/wp/v2/users/me', WP)
        url.searchParams.set('context', 'edit')
  // Ask WP for profile_fields (plugin) along with core profile fields
  url.searchParams.set('_fields', 'id,slug,name,email,roles,avatar_urls,description,url,locale,nickname,profile_fields,meta')
        const res = await fetch(url, { headers: { Authorization: `Bearer ${wpToken}` }, cache: 'no-store' })
        if (res.ok) {
          const wp = await res.json()
          if (wp?.roles) user.roles = wp.roles
          if (wp?.email) user.email = wp.email
          if (wp?.name) user.displayName = wp.name
          if (wp?.avatar_urls) user.avatar_urls = wp.avatar_urls
          if (wp?.url) user.url = wp.url
          if (wp?.description) user.description = wp.description
          if (wp?.nickname) user.nickname = wp.nickname
          if (wp?.locale) user.locale = wp.locale
          // Prefer profile_fields; keep meta for legacy UIs
          if (wp?.profile_fields && typeof wp.profile_fields === 'object') user.profile_fields = wp.profile_fields
          if (wp?.meta && typeof wp.meta === 'object') user.meta = wp.meta
        }
      } catch {
        // ignore enrichment failures; return base user
      }
    }
    // Compute gravatar fallback if avatar not present but email exists
    if (!user.avatar_urls && user.email) {
      const md5 = createHash('md5').update(String(user.email).trim().toLowerCase()).digest('hex')
      const g = (s: number) => `https://secure.gravatar.com/avatar/${md5}?s=${s}&d=identicon`
      user.avatar_urls = { '24': g(24), '48': g(48), '96': g(96), '128': g(128) }
    }
  // Do not synthesize socials anymore; FE derives from user.profile_fields (or meta fallback). Provide website fallback separately.
  if (user.url) user.website = user.url
    return new Response(JSON.stringify({ user }), { status: 200, headers: { 'Content-Type': 'application/json' } })
  } catch {
    return new Response(JSON.stringify({ error: 'Unauthorized' }), { status: 401 })
  }
}


// ==== FILE: app\api\auth\register\route.ts ====
import { NextResponse } from 'next/server'
import { z } from 'zod'

import { wpFetch } from '../../../../src/lib/fetcher'
import { logWPError } from '../../../../src/lib/log'
import { CSRF_COOKIE } from '../../../../src/lib/csrf'

const bodySchema = z.object({ email: z.string().email(), password: z.string().min(6), username: z.string().optional() })

export async function POST(req: Request) {
  const origin = req.headers.get('origin')
  // same-origin only
  if (origin && origin !== process.env.NEXT_PUBLIC_SITE_URL) return NextResponse.json({ message: 'Forbidden' }, { status: 403 })

  const headerCsrf = req.headers.get('x-csrf-token') || undefined
  const cookie = req.headers.get('cookie') || ''
  // simple double-submit check
  if (!cookie.includes(`${CSRF_COOKIE}=`) || !headerCsrf) return NextResponse.json({ message: 'Invalid CSRF' }, { status: 403 })

  const payload = await req.json().catch(() => null)
  const parsed = bodySchema.safeParse(payload)
  if (!parsed.success) return NextResponse.json({ message: 'Invalid input', details: parsed.error.format() }, { status: 400 })

  try {
    const res = await wpFetch('/wp-json/fe-auth/v1/register', { method: 'POST', body: parsed.data })
    return NextResponse.json(res, { status: 201 })
  } catch (err: any) {
    // log WP errors for diagnostics
    logWPError('register', { status: err.status, statusText: err.message, body: err.details && typeof err.details === 'string' ? String(err.details).slice(0, 2000) : JSON.stringify(err.details || '').slice(0, 2000) })
    return NextResponse.json({ message: err.message ?? 'Error', details: err.details }, { status: err.status ?? 500 })
  }
}


// ==== FILE: app\api\core\endpoints\route.ts ====
import { fetchWithAuth } from '@/lib/fetchWithAuth'

export const runtime = 'nodejs'
export const dynamic = 'force-dynamic'
const WP = (process.env.WP_URL || '').replace(/\/$/, '')

export async function GET(req: Request) {
  if (!WP) return Response.json([], { status: 200 })
  // Generic discovery: list all WP REST routes; restrict to fe-* namespaces
  const res = await fetchWithAuth(req, `${WP}/wp-json`)
  try {
    const j = await res.json() as any
    const out: { method: string; route: string }[] = []
    if (j && j.routes) {
      for (const [route, meta] of Object.entries(j.routes as any)) {
        const item = meta as any
        const methods: string[] = item?.methods || []
        methods.forEach(m => out.push({ method: m, route: `/api${route}`.replace(/^\/+/, '/') }))
      }
    }
    return Response.json(out)
  } catch {
    return Response.json([], { status: 200 })
  }
}


// ==== FILE: app\api\csrf\route.ts ====
import { NextResponse } from 'next/server'
import { cookies } from 'next/headers'

import { CSRF_COOKIE, generateCsrfToken } from '../../../src/lib/csrf'

export async function GET() {
  const store = await cookies()
  const existing = (store as any).get?.(CSRF_COOKIE)
  if (existing?.value) {
    return NextResponse.json({ token: existing.value }, { status: 200 })
  }
  const token = generateCsrfToken()
  const res = NextResponse.json({ token }, { status: 200 })
  res.headers.append('Set-Cookie', `${CSRF_COOKIE}=${token}; Path=/; Max-Age=${60 * 60 * 24 * 7}; SameSite=Lax`)
  return res
}


// ==== FILE: app\api\media-cache\route.ts ====
import { NextRequest } from 'next/server'

import { cacheImage } from '@/lib/mediaCache'

export const runtime = 'nodejs'

export async function GET(req: NextRequest) {
  const url = req.nextUrl.searchParams.get('url')
  if (!url) return Response.json({ error: 'missing url' }, { status: 400 })
  try {
    const local = await cacheImage(url)
    return Response.json({ url: local })
  } catch (e: any) {
    return Response.json({ error: String(e?.message || e) }, { status: 502 })
  }
}


// ==== FILE: app\api\media-cache\image\route.ts ====
import { NextRequest } from 'next/server'

import { cacheImage } from '@/lib/mediaCache'

export const runtime = 'nodejs'

export async function GET(req: NextRequest) {
  const url = req.nextUrl.searchParams.get('url')
  if (!url) return new Response('missing url', { status: 400 })
  try {
    const local = await cacheImage(url)
    return new Response(null, { status: 302, headers: { Location: local, 'Cache-Control': 'public, max-age=31536000, immutable' } })
  } catch {
    return new Response('bad upstream', { status: 502 })
  }
}


// ==== FILE: app\api\metrics\route.ts ====
import { fetchWithAuth } from '@/lib/fetchWithAuth'

export const runtime = 'nodejs'
export const dynamic = 'force-dynamic'

const WP = (process.env.WP_URL || '').replace(/\/$/, '')

export async function GET(req: Request) {
  if (!WP) return Response.json({ error: 'WP_URL env required' }, { status: 500 })
  return fetchWithAuth(req, `${WP}/wp-json/fe-metrics/v1/metrics`)
}

export async function POST(req: Request) {
  if (!WP) return Response.json({ error: 'WP_URL env required' }, { status: 500 })
  const body = await req.text()
  return fetchWithAuth(req, `${WP}/wp-json/fe-metrics/v1/metrics`, { method: 'POST', body, headers: { 'Content-Type': 'application/json' } })
}


// ==== FILE: app\api\metrics\layout\route.ts ====
import { fetchWithAuth } from '@/lib/fetchWithAuth'

export const runtime = 'nodejs'
export const dynamic = 'force-dynamic'
const WP = (process.env.WP_URL || '').replace(/\/$/, '')

export async function GET(req: Request) {
  if (!WP) return Response.json({ error: 'WP_URL env required' }, { status: 500 })
  return fetchWithAuth(req, `${WP}/wp-json/fe-metrics/v1/layout`)
}

export async function POST(req: Request) {
  if (!WP) return Response.json({ error: 'WP_URL env required' }, { status: 500 })
  const body = await req.text()
  return fetchWithAuth(req, `${WP}/wp-json/fe-metrics/v1/layout`, { method: 'POST', body, headers: { 'Content-Type': 'application/json' } })
}

export async function DELETE(req: Request) {
  if (!WP) return Response.json({ error: 'WP_URL env required' }, { status: 500 })
  return fetchWithAuth(req, `${WP}/wp-json/fe-metrics/v1/layout`, { method: 'DELETE' })
}


// ==== FILE: app\api\metrics\layout\default\route.ts ====
import { fetchWithAuth } from '@/lib/fetchWithAuth'

export const runtime = 'nodejs'
export const dynamic = 'force-dynamic'
const WP = (process.env.WP_URL || '').replace(/\/$/, '')

export async function POST(req: Request) {
  if (!WP) return Response.json({ error: 'WP_URL env required' }, { status: 500 })
  const body = await req.text()
  return fetchWithAuth(req, `${WP}/wp-json/fe-metrics/v1/layout/default`, { method: 'POST', body, headers: { 'Content-Type': 'application/json' } })
}


// ==== FILE: app\api\metrics\variables\route.ts ====
import { fetchWithAuth } from '@/lib/fetchWithAuth'

export const runtime = 'nodejs'
export const dynamic = 'force-dynamic'
const WP = (process.env.WP_URL || '').replace(/\/$/, '')

export async function GET(_req: Request) {
  // Virtual vars can be enriched on FE; for now proxy a WP endpoint if present, else return a basic set
  if (WP) {
    try { return await fetchWithAuth(_req, `${WP}/wp-json/fe-metrics/v1/variables`) } catch {
      // TODO: implement metrics variable upstream fallback logging
    }
  }
  return Response.json([
    { name: 'views', endpoint: '/api/analytics/views' },
    { name: 'sessions', endpoint: '/api/analytics/sessions' },
    { name: 'comments', endpoint: '/api/wp/comments' },
    { name: 'users', endpoint: '/api/wp/users' },
  ])
}


// ==== FILE: app\api\metrics\[id]\route.ts ====
import { fetchWithAuth } from '@/lib/fetchWithAuth'

export const runtime = 'nodejs'
export const dynamic = 'force-dynamic'
const WP = (process.env.WP_URL || '').replace(/\/$/, '')

export async function GET(req: Request, { params }: { params: { id: string } }) {
  if (!WP) return Response.json({ error: 'WP_URL env required' }, { status: 500 })
  return fetchWithAuth(req, `${WP}/wp-json/fe-metrics/v1/metrics/${params.id}`)
}

export async function PUT(req: Request, { params }: { params: { id: string } }) {
  if (!WP) return Response.json({ error: 'WP_URL env required' }, { status: 500 })
  const body = await req.text()
  return fetchWithAuth(req, `${WP}/wp-json/fe-metrics/v1/metrics/${params.id}`, { method: 'PUT', body, headers: { 'Content-Type': 'application/json' } })
}

export async function DELETE(req: Request, { params }: { params: { id: string } }) {
  if (!WP) return Response.json({ error: 'WP_URL env required' }, { status: 500 })
  return fetchWithAuth(req, `${WP}/wp-json/fe-metrics/v1/metrics/${params.id}`, { method: 'DELETE' })
}


// ==== FILE: app\api\metrics\[id]\eval\route.ts ====
import { fetchWithAuth } from '@/lib/fetchWithAuth'

export const runtime = 'nodejs'
export const dynamic = 'force-dynamic'
const WP = (process.env.WP_URL || '').replace(/\/$/, '')

export async function GET(req: Request, { params }: { params: { id: string } }) {
  if (!WP) return Response.json({ error: 'WP_URL env required' }, { status: 500 })
  return fetchWithAuth(req, `${WP}/wp-json/fe-metrics/v1/metrics/${params.id}/eval`)
}


// ==== FILE: app\api\revalidate\route.ts ====
import { revalidateTag } from 'next/cache'
// import { NextResponse } from 'next/server' // Unused import

export async function POST(req: Request) {
  let body: unknown = {}
  try { body = await req.json() } catch (_e: unknown) { /* ignore */ }
  const url = new URL(req.url)
  const b = body as Record<string, any>
  const secret = url.searchParams.get('secret') || b?.secret
  if (secret !== process.env.NEXT_REVALIDATE_SECRET) return new Response('Forbidden', { status: 403 })

  const { slug, page, taxonomy, all } = b || {}
  const revalidated: string[] = []

  try {
    // Prefer tag-based revalidation if available
    if (typeof revalidateTag === 'function') {
      if (all) {
        // broad sweep
        revalidateTag('wp:posts')
        revalidated.push('/')
        revalidated.push('/blogs')
      }
      // always refresh list on demand
      revalidateTag('wp:posts')
      revalidated.push('/')
      if (slug) {
        revalidateTag(`wp:post:${slug}`)
        revalidated.push(`/blogs/${slug}`)
      }
      if (page) {
        revalidateTag(`wp:page:${page}`)
        revalidated.push(`/pages/${page}`)
      }
      if (taxonomy) {
        // optional future taxonomy tagging, kept for parity
        revalidateTag(`wp:tax:${taxonomy}`)
      }
      return new Response(JSON.stringify({ revalidated, now: Date.now() }), { status: 200, headers: { 'Content-Type': 'application/json' } })
    }

    // Fallback: return the list for an external revalidator to act on
    revalidated.push('/')
    revalidated.push('/blogs')
    if (slug) revalidated.push(`/blogs/${slug}`)
  return new Response(JSON.stringify({ revalidated, now: Date.now() }), { status: 200, headers: { 'Content-Type': 'application/json' } })
  } catch (e: unknown) {
    const msg = (e && typeof e === 'object' && 'message' in e) ? (e as any).message : String(e)
  return new Response(JSON.stringify({ message: msg || 'fail', error: String(e) }), { status: 500, headers: { 'Content-Type': 'application/json' } })
  }
}


// ==== FILE: app\api\roles\matrix\route.ts ====
import { NextRequest } from 'next/server'
import { cookies } from 'next/headers'

import { verifySession } from '@/lib/jwt'

export const runtime = 'nodejs'
export const dynamic = 'force-dynamic'

// Minimal roles matrix focused on editing capabilities
// This can be extended or wired to WP capabilities if needed
export async function GET(req: NextRequest) {
  const cookieStore = await cookies()
  const sessionCookie = cookieStore.get(process.env.SESSION_COOKIE_NAME ?? 'session')
  let roles: string[] = []
  if (sessionCookie?.value) {
    try {
      const claims: any = await verifySession(sessionCookie.value)
      roles = (claims?.roles as any) || []
    } catch {}
  }
  const matrix = {
    roles,
    can: {
      posts: {
        create: roles.some(r => ['author','editor','administrator'].includes(r)),
        edit: roles.some(r => ['author','editor','administrator'].includes(r)),
        delete: roles.some(r => ['editor','administrator'].includes(r)),
        publish: roles.some(r => ['editor','administrator'].includes(r)),
        requestPublish: roles.some(r => ['author','editor','administrator'].includes(r)),
      }
    }
  }
  return Response.json(matrix, { headers: { 'Cache-Control': 'no-store' } })
}


// ==== FILE: app\api\test\route.ts ====
export const runtime = 'nodejs'

export async function GET() {
  return Response.json({ status: 'ok' })
}


// ==== FILE: app\api\test-wp\route.ts ====
export async function GET() {
  try {
    console.log('Testing WordPress connection...')
    
    // Test basic WordPress REST API
    const wpUrl = process.env.WP_URL || 'http://example.com'
    console.log('WordPress URL:', wpUrl)
    
    const testResponse = await fetch(`${wpUrl}/wp-json/wp/v2/posts?per_page=1`, {
      method: 'GET',
      headers: {
        'User-Agent': 'Next.js/15.3.3'
      }
    })
    
    console.log('Basic API Response:', testResponse.status, testResponse.statusText)
    
    if (!testResponse.ok) {
      const errorText = await testResponse.text()
      console.log('Basic API Error:', errorText)
      return new Response(JSON.stringify({ 
        error: 'WordPress basic API failed', 
        status: testResponse.status,
        statusText: testResponse.statusText,
        details: errorText
      }), { 
        status: 500, 
        headers: { 'Content-Type': 'application/json' } 
      })
    }
    
    const basicData = await testResponse.json()
    console.log('Basic API Success, posts count:', Array.isArray(basicData) ? basicData.length : 'not array')
    
    // Test JWT endpoint availability
    const jwtResponse = await fetch(`${wpUrl}/wp-json/jwt-auth/v1/token`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'User-Agent': 'Next.js/15.3.3'
      },
      body: JSON.stringify({ username: 'test', password: 'test' })
    })
    
    console.log('JWT Response:', jwtResponse.status, jwtResponse.statusText)
    const jwtData = await jwtResponse.json()
    console.log('JWT Response Data:', jwtData)
    
    return new Response(JSON.stringify({ 
      success: true,
      wpUrl,
      basicApiStatus: testResponse.status,
      jwtApiStatus: jwtResponse.status,
      jwtResponse: jwtData,
      message: 'WordPress connection test completed'
    }), { 
      status: 200, 
      headers: { 'Content-Type': 'application/json' } 
    })
    
  } catch (error: any) {
    console.error('WordPress connection test failed:', error)
    return new Response(JSON.stringify({ 
      error: 'Connection test failed', 
      details: error.message,
      stack: error.stack
    }), { 
      status: 500, 
      headers: { 'Content-Type': 'application/json' } 
    })
  }
}


// ==== FILE: app\api\wp\bookmarks\route.ts ====
export const dynamic = 'force-dynamic'
export const runtime = 'nodejs'

import { fetchWithAuth, MissingWpTokenError } from '@/lib/fetchWithAuth'

function getWpBase() {
  const WP = process.env.WP_URL || process.env.NEXT_PUBLIC_WP_URL
  if (!WP) throw new Error('WP_URL env required')
  return WP.replace(/\/$/, '')
}

export async function GET(req: Request) {
  try {
    const { searchParams } = new URL(req.url)
    const postId = searchParams.get('postId') || searchParams.get('post_id')
    const expand = searchParams.get('expand')
    const base = getWpBase()
    if (postId) {
      const url = new URL('/wp-json/fe-auth/v1/bookmarks/check', base)
      url.searchParams.set('post_id', String(postId))
      return await fetchWithAuth(req, url.toString())
    }
    const url = new URL('/wp-json/fe-auth/v1/bookmarks', base)
    if (expand) url.searchParams.set('expand', expand)
    return await fetchWithAuth(req, url.toString())
  } catch (e: any) {
    if (e instanceof MissingWpTokenError) {
      return new Response(JSON.stringify({ error: 'unauthorized', message: 'Login required to use bookmarks' }), { status: 401, headers: { 'Content-Type': 'application/json' } })
    }
    console.error('bookmarks.GET unexpected error:', e)
    return new Response(JSON.stringify({ error: 'server_error', detail: String(e?.message || e) }), { status: 500, headers: { 'Content-Type': 'application/json' } })
  }
}

export async function POST(req: Request) {
  try {
    let body: any
    try { body = await req.json() } catch { body = null }
    const postId = Number(body?.postId ?? body?.post_id ?? 0)
    if (!postId || !Number.isFinite(postId)) {
      return new Response(JSON.stringify({ error: 'postId required' }), { status: 400, headers: { 'Content-Type': 'application/json' } })
    }
    const base = getWpBase()
    const url = new URL('/wp-json/fe-auth/v1/bookmarks/toggle', base)
    return await fetchWithAuth(req, url.toString(), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ post_id: postId }),
    })
  } catch (e: any) {
    if (e instanceof MissingWpTokenError) {
      return new Response(JSON.stringify({ error: 'unauthorized', message: 'Login required to save bookmarks' }), { status: 401, headers: { 'Content-Type': 'application/json' } })
    }
    console.error('bookmarks.POST unexpected error:', e)
    return new Response(JSON.stringify({ error: 'server_error', detail: String(e?.message || e) }), { status: 500, headers: { 'Content-Type': 'application/json' } })
  }
}


// ==== FILE: app\api\wp\comments\route.ts ====
// Define Next.js route config locally so it's recognized (avoid re-exporting these)
export const runtime = 'nodejs'
export const dynamic = 'force-dynamic'

// Re-export handlers from the shared implementation
export { GET, POST } from '../../../../src/app/api/wp/comments/route'


// ==== FILE: app\api\wp\comments\bulk\route.ts ====
import { fetchWithAuth } from '@/lib/fetchWithAuth'
import { apiMap } from '@/lib/wpAPIMap'
import { requireAccess } from '@/lib/requireAccess'

export const runtime = 'nodejs'

export async function POST(req: Request) {
  await requireAccess({ path: '/api/wp/comments/[id]', method: 'PATCH', action: 'moderate' })
  // Proxy to MU endpoint defined in apiMap.comments.bulk
  return fetchWithAuth(req, apiMap.comments.bulk, { method: 'POST', body: await req.text(), headers: { 'Content-Type': 'application/json' } })
}


// ==== FILE: app\api\wp\media\route.ts ====
import { fetchWithAuth } from '@/lib/fetchWithAuth'

export const runtime = 'nodejs'
export const dynamic = 'force-dynamic'
const WP = (process.env.WP_URL || '').replace(/\/$/, '')

export async function GET(req: Request) {
  if (!WP) return Response.json({ error: 'WP_URL env required' }, { status: 500 })
  const url = new URL(`${WP}/wp-json/fe-media/v1/media`)
  const inUrl = new URL(req.url)
  inUrl.searchParams.forEach((v, k) => url.searchParams.set(k, v))
  return fetchWithAuth(req, url.toString())
}

export async function POST(req: Request) {
  if (!WP) return Response.json({ error: 'WP_URL env required' }, { status: 500 })
  // Pass through multipart form-data
  const body = await req.arrayBuffer()
  const headers: HeadersInit = { 'Content-Type': req.headers.get('content-type') || 'application/octet-stream' }
  return fetchWithAuth(req, `${WP}/wp-json/fe-media/v1/media`, { method: 'POST', body: body as any, headers })
}


// ==== FILE: app\api\wp\media\count\route.ts ====
import { getWpTokenFromRequest } from '@/lib/fetchWithAuth'

export const runtime = 'nodejs'
export const dynamic = 'force-dynamic'

export async function GET(req: Request) {
  const WP = process.env.WP_URL
  if (!WP) return Response.json({ error: 'WP_URL env required' }, { status: 500 })
  const inUrl = new URL(req.url)
  const mediaType = inUrl.searchParams.get('media_type') || ''
  const u = new URL('/wp-json/wp/v2/media', WP)
  u.searchParams.set('per_page', '1')
  if (mediaType) u.searchParams.set('media_type', mediaType)

  const token = await getWpTokenFromRequest(req)
  const headers: HeadersInit = {
    'User-Agent': 'techoblivion-fe/1.0',
    'Accept': 'application/json',
  }
  if (token) (headers as any).Authorization = `Bearer ${token}`

  const res = await fetch(u.toString(), { cache: 'no-store', headers })
  const total = res.headers.get('x-wp-total')
  return Response.json({ count: total ? Number(total) : (res.ok ? 0 : null) }, { status: res.ok ? 200 : res.status })
}


// ==== FILE: app\api\wp\media\[...slug]\route.ts ====
import type { NextRequest } from 'next/server'
export const runtime = 'nodejs'
export const dynamic = 'force-dynamic'

export async function GET(_req: NextRequest, { params }: { params: { slug?: string[]; path?: string[] } }) {
  const segs = (params?.slug ?? params?.path ?? []) as string[]
  if (!Array.isArray(segs) || segs.length === 0) {
    return new Response('Bad path', { status: 400 })
  }
  const WP = (process.env.WP_URL || 'http://example.com').replace(/\/+$/, '')
  let origin = `${WP}/${segs.join('/')}`
  if (segs[0] === 'absolute') {
    const encoded = segs.slice(1).join('/')
    try {
      const full = decodeURIComponent(encoded)
      const u = new URL(full)
      if (u.protocol === 'http:' || u.protocol === 'https:') origin = full
    } catch {}
  }

  const headers: Record<string, string> = {
    Accept: 'image/*,*/*;q=0.8',
    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.0.0 Safari/537.36',
    Referer: 'http://example.com/',
  }
  let upstream: Response
  try {
    upstream = await fetch(origin, { cache: 'no-store', headers })
  } catch (err: any) {
    return placeholder('upstream-fetch-error')
  }
  if (!upstream.ok) {
    return upstream.status === 404 ? new Response('Not found', { status: 404 }) : placeholder(`upstream-status-${upstream.status}`)
  }
  const ct = upstream.headers.get('content-type')?.toLowerCase() ?? ''
  const ab = await upstream.arrayBuffer()
  if (!ct.startsWith('image/')) {
    return placeholder('bad-content-type', { 'X-Upstream-Content-Type': ct || 'unknown' })
  }
  return new Response(ab, { headers: { 'Content-Type': ct || 'application/octet-stream', 'Cache-Control': 'public, max-age=31536000, immutable' } })
}

function placeholder(reason: string, extra?: Record<string, string>) {
  const b64 = 'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAwMBA6m+Vb8AAAAASUVORK5CYII='
  const body = Buffer.from(b64, 'base64')
  return new Response(body, { status: 200, headers: { 'Content-Type': 'image/png', 'Cache-Control': 'public, max-age=300', 'X-Proxy-Status': reason, ...(extra || {}) } })
}


// ==== FILE: app\api\wp\media\[id]\route.ts ====
import { fetchWithAuth } from '@/lib/fetchWithAuth'

export const runtime = 'nodejs'
export const dynamic = 'force-dynamic'
const WP = (process.env.WP_URL || '').replace(/\/$/, '')

export async function DELETE(req: Request, { params }: { params: { id: string } }) {
  if (!WP) return Response.json({ error: 'WP_URL env required' }, { status: 500 })
  return fetchWithAuth(req, `${WP}/wp-json/fe-media/v1/media/${params.id}`, { method: 'DELETE' })
}


// ==== FILE: app\api\wp\popular\route.ts ====
import { NextRequest, NextResponse } from 'next/server'

export const dynamic = 'force-dynamic'
export const runtime = 'nodejs'

type PopularItem = { id: number } | { post_id: number }

export async function GET(req: NextRequest) {
  const WP = process.env.WP_URL || process.env.NEXT_PUBLIC_WP_URL
  if (!WP) return NextResponse.json({ error: 'WP_URL missing' }, { status: 500 })

  const { searchParams } = new URL(req.url)
  const range = (searchParams.get('range') || 'month').toLowerCase() // day|week|month|all
  const limit = Math.min(Math.max(Number(searchParams.get('limit') || 6), 1), 12)

  // Try WordPress Popular Posts REST API first
  const base = new URL('/wp-json/wordpress-popular-posts', WP.replace(/\/$/, ''))
  const wppUrl = new URL('/v1/popular-posts', base)
  wppUrl.searchParams.set('range', ['day','week','month','all'].includes(range) ? range : 'month')
  wppUrl.searchParams.set('limit', String(limit))

  let ids: number[] = []
  try {
    const wppRes = await fetch(wppUrl.toString(), { headers: { Accept: 'application/json' }, next: { revalidate: 600 } })
    if (wppRes.ok) {
      const items = (await wppRes.json()) as PopularItem[]
      ids = (items || []).map((i: any) => Number(i.id ?? i.post_id)).filter((n) => Number.isFinite(n))
    }
  } catch {}

  // Fallback: empty or failed -> use latest posts as a reasonable default
  let posts: any[] = []
  try {
    if (ids.length) {
      const detailsUrl = new URL('/wp-json/wp/v2/posts', WP)
      detailsUrl.searchParams.set('include', ids.join(','))
      detailsUrl.searchParams.set('_embed', '1')
      detailsUrl.searchParams.set('per_page', String(limit))
      const res = await fetch(detailsUrl.toString(), { headers: { Accept: 'application/json' }, next: { revalidate: 600 } })
      if (res.ok) {
        posts = await res.json()
        // Keep the order of ids from WPP
        const order = new Map(ids.map((id, idx) => [id, idx]))
        posts.sort((a, b) => (order.get(a.id) ?? 0) - (order.get(b.id) ?? 0))
      }
    } else {
      const latestUrl = new URL('/wp-json/wp/v2/posts', WP)
      latestUrl.searchParams.set('_embed', '1')
      latestUrl.searchParams.set('per_page', String(limit))
      const res = await fetch(latestUrl.toString(), { headers: { Accept: 'application/json' }, next: { revalidate: 300 } })
      if (res.ok) posts = await res.json()
    }
  } catch (e) {
    return NextResponse.json({ error: 'Upstream error', detail: String(e) }, { status: 502 })
  }

  const simplified = (posts as any[]).map((p) => ({
    id: p.id,
    slug: p.slug,
    title: p.title?.rendered || p.title || '',
    excerpt: (p.excerpt?.rendered || '').replace(/<[^>]+>/g, ''),
    featuredImage: p._embedded?.['wp:featuredmedia']?.[0]?.source_url || p.featured_media_url || p.jetpack_featured_media_url || '',
    authorName: p._embedded?.author?.[0]?.name || '',
    date: p.date || '',
  }))
  return NextResponse.json(simplified, { status: 200, headers: { 'Cache-Control': 'public, max-age=300, stale-while-revalidate=600' } })
}


// ==== FILE: app\api\wp\posts\route.ts ====
// Define Next.js route config locally so it's recognized
export const runtime = 'nodejs'
export const dynamic = 'force-dynamic'

// Re-export handlers from the shared implementation
export { GET, POST, PATCH } from '../../../../src/app/api/wp/posts/route'

import { NextRequest } from 'next/server'

export async function DELETE(req: NextRequest) {
	const upstream = process.env.WP_URL || process.env.WP_BASE
	if (!upstream) return new Response(JSON.stringify({ error: 'WP_URL/WP_BASE env required' }), { status: 500 })
	const url = new URL(req.url)
	const id = url.searchParams.get('id')
	if (!id) return new Response(JSON.stringify({ error: 'Missing id' }), { status: 400 })

	// Forward Authorization if present, else fallback
	const authHeader = req.headers.get('authorization') || (process.env.WP_AUTH_TOKEN ? `Bearer ${process.env.WP_AUTH_TOKEN}` : undefined)
	const controller = new AbortController()
	const to = setTimeout(() => controller.abort(), 10_000)
	try {
		const res = await fetch(new URL(`/wp-json/wp/v2/posts/${id}`, upstream), {
			method: 'DELETE',
			headers: { ...(authHeader ? { Authorization: authHeader } : {}), 'Content-Type': 'application/json' },
			signal: controller.signal,
		})
		const text = await res.text()
		return new Response(text, { status: res.status, headers: { 'Content-Type': res.headers.get('Content-Type') || 'application/json' } })
	} catch (e: any) {
		const msg = e?.name === 'AbortError' ? 'Upstream timeout' : (e?.message || 'Upstream error')
		return new Response(JSON.stringify({ error: msg }), { status: 504 })
	} finally {
		clearTimeout(to)
	}
}


// ==== FILE: app\api\wp\posts\count\route.ts ====
import { getWpTokenFromRequest } from '@/lib/fetchWithAuth'

export const runtime = 'nodejs'
export const dynamic = 'force-dynamic'

export async function GET(req: Request) {
  const WP = process.env.WP_URL
  if (!WP) return Response.json({ error: 'WP_URL env required' }, { status: 500 })
  const inUrl = new URL(req.url)
  const status = inUrl.searchParams.get('status') || ''
  const u = new URL('/wp-json/wp/v2/posts', WP)
  u.searchParams.set('per_page', '1')
  if (status) u.searchParams.set('status', status)

  // Include auth when available; required for non-public statuses like draft/pending
  const token = await getWpTokenFromRequest(req)
  const headers: HeadersInit = {
    'User-Agent': 'techoblivion-fe/1.0',
    'Accept': 'application/json',
  }
  if (token) (headers as any).Authorization = `Bearer ${token}`
  if (!token && status && status !== 'publish') {
    return Response.json({ error: 'unauthorized', message: 'Login required for non-public post statuses' }, { status: 401 })
  }

  const res = await fetch(u.toString(), { cache: 'no-store', headers })
  const total = res.headers.get('x-wp-total')
  return Response.json({ count: total ? Number(total) : (res.ok ? 0 : null) }, { status: res.ok ? 200 : res.status })
}


// ==== FILE: app\api\wp\related\route.ts ====
import { NextRequest, NextResponse } from 'next/server'

export const dynamic = 'force-dynamic'

export async function GET(req: NextRequest) {
  const WP = process.env.WP_URL ?? ''
  if (!WP) return NextResponse.json({ error: 'WP_URL missing' }, { status: 500 })

  const { searchParams } = new URL(req.url)
  const categories = searchParams.get('categories') || ''
  const tags = searchParams.get('tags') || ''
  const exclude = searchParams.get('exclude') || ''
  const per_page = searchParams.get('per_page') || '5'

  const url = new URL('/wp-json/wp/v2/posts', WP)
  url.searchParams.set('_embed', '1')
  if (categories) url.searchParams.set('categories', categories)
  if (tags) url.searchParams.set('tags', tags)
  if (exclude) url.searchParams.set('exclude', exclude)
  url.searchParams.set('per_page', per_page)

  const res = await fetch(url.toString(), {
    headers: { 'Accept': 'application/json', 'User-Agent': 'techoblivion-proxy/1.0 (+https://techoblivion.in)' },
    next: { revalidate: Number(process.env.WP_CACHE_TTL || 300) },
  })
  if (!res.ok) {
    const body = await res.text()
    return NextResponse.json({ error: 'Upstream error', status: res.status, message: body }, { status: 502 })
  }
  const data = await res.json()
  const simplified = (data as any[]).map(p => ({ id: p.id, slug: p.slug, title: { rendered: p.title?.rendered || '' } }))
  return NextResponse.json(simplified, { status: 200 })
}


// ==== FILE: app\api\wp\search\route.ts ====
import { NextRequest, NextResponse } from 'next/server'

export const dynamic = 'force-dynamic'

export async function GET(req: NextRequest) {
  const WP = process.env.WP_URL ?? ''
  if (!WP) return NextResponse.json({ error: 'WP_URL missing' }, { status: 500 })
  const { searchParams } = new URL(req.url)
  const q = searchParams.get('q') || ''
  if (!q) return NextResponse.json([], { status: 200 })

  const url = new URL('/wp-json/wp/v2/posts', WP)
  url.searchParams.set('_embed', '0')
  url.searchParams.set('search', q)
  url.searchParams.set('per_page', '10')
  const res = await fetch(url.toString(), {
    headers: { 'Accept': 'application/json', 'User-Agent': 'techoblivion-proxy/1.0 (+https://techoblivion.in)' },
    next: { revalidate: Number(process.env.WP_CACHE_TTL || 300) },
  })
  if (!res.ok) {
    const body = await res.text().catch(() => '')
    return NextResponse.json({ error: 'Upstream error', status: res.status, message: body }, { status: 502 })
  }
  const data = await res.json()
  return NextResponse.json(data, { status: 200 })
}


// ==== FILE: app\api\wp\site-health\background-updates\route.ts ====
import { apiMap } from '@/lib/wpAPIMap'
import { fetchWithAuth } from '@/lib/fetchWithAuth'

export const runtime = 'nodejs'

export async function GET(req: Request) {
  return fetchWithAuth(req, apiMap.siteHealth.backgroundUpdates)
}


// ==== FILE: app\api\wp\site-health\directory-sizes\route.ts ====
import { apiMap } from '@/lib/wpAPIMap'
import { fetchWithAuth } from '@/lib/fetchWithAuth'

export const runtime = 'nodejs'

export async function GET(req: Request) {
  return fetchWithAuth(req, apiMap.siteHealth.directorySizes)
}


// ==== FILE: app\api\wp\track-view\route.ts ====
export const dynamic = 'force-dynamic'
export const runtime = 'nodejs'

export async function POST(req: Request) {
  const WP = process.env.WP_URL || process.env.NEXT_PUBLIC_WP_URL
  if (!WP) return new Response(JSON.stringify({ error: 'WP_URL env required' }), { status: 500 })
  let body: any
  try { body = await req.json() } catch { body = null }
  const postId = Number(body?.postId ?? body?.post_id ?? 0)
  if (!postId || !Number.isFinite(postId)) {
    return new Response(JSON.stringify({ error: 'postId required' }), { status: 400 })
  }
  const url = new URL('/wp-json/fe-auth/v1/track-view', WP.replace(/\/$/, ''))
  try {
    const incomingCookies = req.headers.get('cookie') || ''
    const ua = req.headers.get('user-agent') || 'techoblivion-next-proxy'
    const ip = (req.headers.get('x-forwarded-for') || '').split(',')[0]?.trim()
    const r = await fetch(url.toString(), {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Accept: 'application/json',
        // Forward cookies to allow WP to detect logged-in users
        ...(incomingCookies ? { cookie: incomingCookies } : {}),
        'User-Agent': ua,
        ...(ip ? { 'X-Forwarded-For': ip } : {}),
      },
      cache: 'no-store',
      body: JSON.stringify({ post_id: postId })
    })
    const text = await r.text()
    if (!r.ok) {
      return new Response(text || JSON.stringify({ error: 'wp error' }), { status: r.status })
    }
    return new Response(text || '{}', { status: 200, headers: { 'Content-Type': 'application/json' } })
  } catch (e: any) {
    return new Response(JSON.stringify({ error: 'upstream error', detail: String(e) }), { status: 502 })
  }
}


// ==== FILE: app\api\wp\users\route.ts ====
export const runtime = 'nodejs'
export const dynamic = 'force-dynamic'

import { createHmac } from 'crypto'

type LiteUser = {
  id: number
  slug: string
  name?: string
  description?: string
  avatar_urls?: Record<string, string>
  social?: { twitter: string | null; linkedin: string | null; github: string | null }
}

function normalizeUrl(u?: string | null): string | null {
  if (!u) return null
  const s = String(u).trim()
  if (!s) return null
  if (/^https?:\/\//i.test(s)) return s
  return `https://${s}`
}

function deriveSocial(u: unknown): { twitter: string | null; linkedin: string | null; github: string | null } {
  if (u && typeof u === 'object') {
    const obj = u as Record<string, unknown>
    const social = obj.social
    if (social && typeof social === 'object') {
      const s = social as Record<string, unknown>
      return {
        twitter: normalizeUrl(typeof s.twitter === 'string' ? s.twitter : null),
        linkedin: normalizeUrl(typeof s.linkedin === 'string' ? s.linkedin : null),
        github: normalizeUrl(typeof s.github === 'string' ? s.github : null),
      }
    }
    const pf = typeof obj.profile_fields === 'object' && obj.profile_fields
      ? (obj.profile_fields as Record<string, unknown>)
      : null
    const get = (k: string) => (pf && typeof pf[k] === 'string') ? (pf[k] as string) : undefined
    const tw = (typeof obj.twitter_url === 'string' ? obj.twitter_url : undefined) || get('twitter_url') || get('twitter') || get('x')
    const ln = (typeof obj.linkedin_url === 'string' ? obj.linkedin_url : undefined) || get('linkedin_url') || get('linkedin')
    const gh = (typeof obj.github_url === 'string' ? obj.github_url : undefined) || get('github_url') || get('github')
    return { twitter: normalizeUrl(tw || null), linkedin: normalizeUrl(ln || null), github: normalizeUrl(gh || null) }
  }
  return { twitter: null, linkedin: null, github: null }
}

function sanitize(u: unknown): LiteUser {
  const obj = (u && typeof u === 'object') ? (u as Record<string, unknown>) : {}
  const idRaw = obj.id
  const slugRaw = (obj.slug ?? obj.user_nicename)
  const nameRaw = (obj.name ?? obj.display_name)
  const descRaw = obj.description
  const avatarRaw = obj.avatar_urls
  return {
    id: Number(typeof idRaw === 'number' ? idRaw : parseInt(String(idRaw ?? 0), 10) || 0),
    slug: String(typeof slugRaw === 'string' ? slugRaw : ''),
    name: typeof nameRaw === 'string' ? nameRaw : '',
    description: typeof descRaw === 'string' ? descRaw : '',
    avatar_urls: (avatarRaw && typeof avatarRaw === 'object') ? (avatarRaw as Record<string, string>) : {},
    social: deriveSocial(u),
  }
}

function chunk<T>(arr: T[], size = 100): T[][] {
  const out: T[][] = []
  for (let i = 0; i < arr.length; i += size) out.push(arr.slice(i, i + size))
  return out
}

// Fallback utilities for general /api/wp/users queries (search, paging, etc.)
type AnyObj = Record<string, unknown>
function signProxy(method: string, path: string, body: string, secret: string) {
  const ts = String(Math.floor(Date.now() / 1000))
  const base = `${method.toUpperCase()}\n${path}\n${ts}\n${body || ''}`
  const sig = createHmac('sha256', secret).update(base).digest('base64')
  return { ts, sign: sig }
}
function authHeader() {
  const user = process.env.WP_API_USER
  const appPass = process.env.WP_API_APP_PASSWORD
  if (!user || !appPass) return undefined
  const token = Buffer.from(`${user}:${appPass}`).toString('base64')
  return `Basic ${token}`
}
function sanitizeUser(u: AnyObj) {
  return {
    id: u?.id,
    slug: u?.slug,
    name: u?.name ?? u?.display_name,
    display_name: u?.display_name,
    description: u?.description ?? '',
    avatar_urls: u?.avatar_urls ?? {},
    url: u?.url ?? '',
    social: deriveSocial(u),
  }
}

export async function GET(req: Request) {
  const WP = process.env.WP_URL || process.env.NEXT_PUBLIC_WP_URL
  if (!WP) return new Response(JSON.stringify({ error: 'WP_URL env required' }), { status: 500 })

  const url = new URL(req.url)
  const includeParam = url.searchParams.get('include') || ''
  const ids = includeParam
    .split(',')
    .map(s => parseInt(s, 10))
    .filter(n => Number.isFinite(n) && n > 0)

  // If include[] requested, serve minimal fast list
  if (ids.length > 0) {
    const base = WP.replace(/\/$/, '')
    const perPage = 100
    const idChunks = chunk(ids, perPage)

  const results: unknown[] = []
    await Promise.all(idChunks.map(async (group) => {
      const u = new URL('/wp-json/wp/v2/users', base)
      group.forEach(id => u.searchParams.append('include[]', String(id)))
      u.searchParams.set('per_page', String(perPage))
      u.searchParams.set('context', 'view')
      u.searchParams.set('_fields', 'id,slug,name,description,avatar_urls,social')
      const res = await fetch(u.toString(), { cache: 'no-store' })
      if (res.ok) {
        const arr = await res.json().then(x => Array.isArray(x) ? x : []).catch(() => [])
        results.push(...arr)
      }
    }))

  const map = new Map<number, unknown>((results as Array<Record<string, unknown>>).map((u) => [Number(u.id), u]))
    const ordered = ids.map(id => map.get(id)).filter(Boolean)
    const out = ordered.map(sanitize)
    return new Response(JSON.stringify(out), { status: 200, headers: { 'Content-Type': 'application/json' } })
  }

  // Otherwise, preserve existing generic behavior (search, paging, etc.)
  const base = WP.replace(/\/$/, '')
  const urlIn = new URL(req.url)
  const allowed = new Set([
    'context', 'search', 'slug', 'page', 'per_page', 'include', 'exclude', 'orderby', 'order'
  ])
  const qEntries: [string, string][] = []
  urlIn.searchParams.forEach((v, k) => {
    if (allowed.has(k)) qEntries.push([k, v])
  })
  if (!qEntries.find(([k]) => k === 'context')) qEntries.push(['context', 'view'])

  const secret = process.env.FE_PROXY_SECRET || ''
  const path = 'wp/v2/users'
  let upstreamTried: string | undefined
  if (secret) {
    try {
      const proxy = new URL('/wp-json/fe-auth/v1/proxy', base)
      proxy.searchParams.set('path', path)
      for (const [k, v] of qEntries) proxy.searchParams.set(`query[${k}]`, v)
      const { ts, sign } = signProxy('GET', path, '', secret)
      const pres = await fetch(proxy.toString(), { headers: { 'x-fe-ts': ts, 'x-fe-sign': sign }, cache: 'no-store' })
      upstreamTried = proxy.toString()
      if (pres.ok) {
        const arr = await pres.json().catch(() => null)
        const list = Array.isArray(arr) ? arr : []
        return new Response(JSON.stringify(list.map(sanitizeUser)), {
          status: 200,
          headers: { 'Content-Type': 'application/json', 'X-Upstream-Url': upstreamTried }
        })
      }
      if ([400, 401, 404].includes(pres.status)) {
        return new Response(JSON.stringify([]), {
          status: 200,
          headers: { 'Content-Type': 'application/json', 'X-Upstream-Url': upstreamTried }
        })
      }
    } catch (_) {
      // fall through
    }
  }

  const direct = new URL('/wp-json/wp/v2/users', base)
  for (const [k, v] of qEntries) direct.searchParams.set(k, v)
  const headers: HeadersInit = {}
  const basic = authHeader()
  if (basic) {
    // HeadersInit can be a Headers, array, or record; we use a record here
    (headers as Record<string, string>).Authorization = basic
  }
  const dres = await fetch(direct.toString(), { headers, cache: 'no-store' })
  upstreamTried = direct.toString()
  if (!dres.ok) {
    if ([400, 401, 404].includes(dres.status)) {
      return new Response(JSON.stringify([]), {
        status: 200,
        headers: { 'Content-Type': 'application/json', 'X-Upstream-Url': upstreamTried }
      })
    }
    return new Response(JSON.stringify({ error: `Upstream ${dres.status}` }), { status: 502, headers: { 'X-Upstream-Url': upstreamTried! } })
  }
  const data = await dres.json().catch(() => null)
  const list = Array.isArray(data) ? data : []
  return new Response(JSON.stringify(list.map(sanitizeUser)), {
    status: 200,
    headers: { 'Content-Type': 'application/json', 'X-Upstream-Url': upstreamTried }
  })
}


// ==== FILE: app\api\wp\users\avatar\route.ts ====
import { cookies } from 'next/headers'

import { verifySession } from '@/lib/jwt'

export const runtime = 'nodejs'
export const dynamic = 'force-dynamic'

export async function POST(req: Request) {
  const WP = process.env.WP_URL
  if (!WP) return new Response(JSON.stringify({ error: 'WP_URL env required' }), { status: 500 })

  const cookieStore = await cookies()
  const sessionCookie = cookieStore.get(process.env.SESSION_COOKIE_NAME ?? 'session')
  if (!sessionCookie?.value) return new Response(JSON.stringify({ error: 'Unauthorized' }), { status: 401 })

  let claims: any
  try { claims = await verifySession(sessionCookie.value) } catch { return new Response(JSON.stringify({ error: 'Unauthorized' }), { status: 401 }) }
  const wpToken = claims?.wpToken
  if (!wpToken) return new Response(JSON.stringify({ error: 'Unauthorized' }), { status: 401 })

  // Parse form-data
  const form = await req.formData()
  const file = form.get('file') as File | null
  if (!file) return new Response(JSON.stringify({ error: 'Missing file' }), { status: 400 })

  const arrayBuf = await file.arrayBuffer()
  const filename = (file as any).name || 'avatar.jpg'
  const contentType = file.type || 'application/octet-stream'

  // Upload to WP Media Library
  const mediaUrl = new URL('/wp-json/wp/v2/media', WP)
  const uploadRes = await fetch(mediaUrl, {
    method: 'POST',
    headers: {
      Authorization: `Bearer ${wpToken}`,
      'Content-Type': contentType,
      'Content-Disposition': `attachment; filename="${filename}"`,
    },
    // Use ArrayBuffer directly to satisfy fetch BodyInit
    body: arrayBuf,
  })
  if (!uploadRes.ok) {
    const text = await uploadRes.text().catch(() => '')
    return new Response(JSON.stringify({ error: 'Upload failed', detail: text.slice(0, 1000) }), { status: uploadRes.status })
  }
  const media = await uploadRes.json()

  // Best-effort: try to set a local avatar via common plugin meta
  let avatarSet = false
  try {
    const userPatchUrl = new URL('/wp-json/wp/v2/users/me', WP)
    const patchRes = await fetch(userPatchUrl, {
      method: 'POST', // WP REST Users supports POST for update
      headers: {
        Authorization: `Bearer ${wpToken}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        meta: {
          // Simple Local Avatars plugin support (if registered in REST):
          simple_local_avatar: { media_id: media?.id },
          // WP User Avatar (deprecated) possible key:
          wp_user_avatar: media?.id,
        },
      }),
    })
    avatarSet = patchRes.ok
  } catch {
    // ignore and fall back to returning the uploaded image
  }

  return new Response(
    JSON.stringify({ id: media?.id, url: media?.source_url, setInProfile: avatarSet }),
    { status: 200, headers: { 'Content-Type': 'application/json' } }
  )
}


// ==== FILE: app\api\wp\users\bulk-delete\route.ts ====
import { fetchWithAuth } from '@/lib/fetchWithAuth'
import { apiMap } from '@/lib/wpAPIMap'
import { requireAccess } from '@/lib/requireAccess'

export const runtime = 'nodejs'

export async function POST(req: Request) {
  await requireAccess({ path: '/api/wp/users/[id]', method: 'DELETE', action: 'delete' })
  // Expect body: { ids: number[] }
  const body = await req.text()
  // No WP bulk endpoint by default; this is placeholder returning 501 unless MU endpoint exists.
  const target = (apiMap as any)?.users?.bulkDelete as string | undefined
  if (!target) return new Response(JSON.stringify({ error: 'Not implemented' }), { status: 501 })
  return fetchWithAuth(req, target, { method: 'POST', body, headers: { 'Content-Type': 'application/json' } })
}


// ==== FILE: app\api\wp\users\count\route.ts ====
import { getWpTokenFromRequest } from '@/lib/fetchWithAuth'

export const runtime = 'nodejs'
export const dynamic = 'force-dynamic'

export async function GET(req: Request) {
  const WP = process.env.WP_URL
  if (!WP) return Response.json({ error: 'WP_URL env required' }, { status: 500 })
  const token = await getWpTokenFromRequest(req)
  if (!token) return Response.json({ error: 'unauthorized', message: 'Login required' }, { status: 401 })

  const u = new URL('/wp-json/wp/v2/users', WP)
  u.searchParams.set('per_page', '1')
  u.searchParams.set('context', 'edit')
  u.searchParams.set('_fields', 'id')
  const res = await fetch(u.toString(), { cache: 'no-store', headers: { Authorization: `Bearer ${token}`, Accept: 'application/json' } })
  const total = res.headers.get('x-wp-total')
  return Response.json({ count: total ? Number(total) : (res.ok ? 0 : null) }, { status: res.ok ? 200 : res.status })
}


// ==== FILE: app\api\wp\users\me\route.ts ====
import { verifySession } from '@/lib/jwt'

export const runtime = 'nodejs'
export const dynamic = 'force-dynamic'

export async function GET(req: Request) {
  const WP = process.env.WP_URL
  if (!WP) return new Response(JSON.stringify({ error: 'config', message: 'WP_URL env required' }), { status: 500 })

  // Extract session token from cookie header (align with /api/auth/me)
  const cookieHeader = req.headers.get('cookie') || ''
  const match = cookieHeader.match(new RegExp(`${process.env.SESSION_COOKIE_NAME || 'session'}=([^;]+)`))
  const token = match?.[1]
  if (!token) return new Response(JSON.stringify({ error: 'unauthorized', message: 'Missing session cookie' }), { status: 401, headers: { 'Content-Type': 'application/json' } })

  let claims: any
  try { claims = await verifySession(token) } catch {
    return new Response(JSON.stringify({ error: 'unauthorized', message: 'Invalid session token' }), { status: 401, headers: { 'Content-Type': 'application/json' } })
  }
  const wpToken = claims?.wpToken
  if (!wpToken) return new Response(JSON.stringify({ error: 'unauthorized', message: 'Missing wpToken in session' }), { status: 401, headers: { 'Content-Type': 'application/json' } })

  // Include profile_fields exposed by FE Auth Bridge plugin (and meta for backward compat)
  const fields = 'id,slug,name,email,roles,avatar_urls,description,url,locale,nickname,profile_fields,meta'
  // Try MU plugin proxy first
  const proxyUrl = new URL('/wp-json/fe-auth/v1/proxy', WP)
  proxyUrl.searchParams.set('path', 'wp/v2/users/me')
  proxyUrl.searchParams.set('context', 'edit')
  proxyUrl.searchParams.set('_fields', fields)
  let res = await fetch(proxyUrl, {
    headers: {
      Authorization: `Bearer ${wpToken}`,
      // Some proxies read cookies; pass token also as cookie for compatibility
      Cookie: `Authorization=Bearer ${wpToken}`,
    },
    cache: 'no-store',
  })
  if (!res.ok) {
    // Fallback to direct WP REST
    const url = new URL('/wp-json/wp/v2/users/me', WP)
    url.searchParams.set('context', 'edit')
    url.searchParams.set('_fields', fields)
    res = await fetch(url, { headers: { Authorization: `Bearer ${wpToken}` }, cache: 'no-store' })
  }
  const text = await res.text()
  return new Response(text, { status: res.status, headers: { 'Content-Type': res.headers.get('Content-Type') || 'application/json' } })
}

export async function POST(req: Request) {
  const WP = process.env.WP_URL
  if (!WP) return new Response(JSON.stringify({ error: 'WP_URL env required' }), { status: 500 })

  const cookieHeader = req.headers.get('cookie') || ''
  const match = cookieHeader.match(new RegExp(`${process.env.SESSION_COOKIE_NAME || 'session'}=([^;]+)`))
  const token = match?.[1]
  if (!token) return new Response(JSON.stringify({ error: 'Unauthorized', message: 'Missing session cookie' }), { status: 401 })

  let claims: any
  try { claims = await verifySession(token) } catch { return new Response(JSON.stringify({ error: 'Unauthorized', message: 'Invalid session token' }), { status: 401 }) }
  const wpToken = claims?.wpToken
  if (!wpToken) return new Response(JSON.stringify({ error: 'Unauthorized', message: 'Missing wpToken in session' }), { status: 401 })

  let body: any = {}
  try { body = await req.json() } catch { body = {} }

  // Only allow a safe subset to pass through
  // Allow profile_fields to pass through to WP (plugin will handle persistence). Keep meta for backward compat.
  const allowed = ['name','nickname','email','url','description','locale','profile_fields','meta']
  const patch: Record<string, any> = {}
  for (const k of allowed) if (k in body) patch[k] = body[k]

  // Try MU plugin proxy first
  const proxyUrl = new URL('/wp-json/fe-auth/v1/proxy', WP)
  proxyUrl.searchParams.set('path', 'wp/v2/users/me')
  let res = await fetch(proxyUrl, {
    method: 'POST',
    headers: {
      Authorization: `Bearer ${wpToken}`,
      'Content-Type': 'application/json',
      Cookie: `Authorization=Bearer ${wpToken}`,
    },
    body: JSON.stringify(patch),
  })
  if (!res.ok) {
    const url = new URL('/wp-json/wp/v2/users/me', WP)
    res = await fetch(url, {
      method: 'POST',
      headers: {
        Authorization: `Bearer ${wpToken}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(patch),
    })
  }

  const text = await res.text()
  return new Response(text, { status: res.status, headers: { 'Content-Type': res.headers.get('Content-Type') || 'application/json' } })
}

export async function PUT(req: Request) {
  // Mirror POST but with PUT method; forward meta too
  const WP = process.env.WP_URL
  if (!WP) return new Response(JSON.stringify({ error: 'WP_URL env required' }), { status: 500 })

  const cookieHeader = req.headers.get('cookie') || ''
  const match = cookieHeader.match(new RegExp(`${process.env.SESSION_COOKIE_NAME || 'session'}=([^;]+)`))
  const token = match?.[1]
  if (!token) return new Response(JSON.stringify({ error: 'Unauthorized', message: 'Missing session cookie' }), { status: 401 })

  let claims: any
  try { claims = await verifySession(token) } catch { return new Response(JSON.stringify({ error: 'Unauthorized', message: 'Invalid session token' }), { status: 401 }) }
  const wpToken = claims?.wpToken
  if (!wpToken) return new Response(JSON.stringify({ error: 'Unauthorized', message: 'Missing wpToken in session' }), { status: 401 })

  let body: any = {}
  try { body = await req.json() } catch { body = {} }
  const allowed = ['name','nickname','email','url','description','locale','profile_fields','meta']
  const patch: Record<string, any> = {}
  for (const k of allowed) if (k in body) patch[k] = body[k]

  // Try MU plugin proxy first
  const proxyUrl = new URL('/wp-json/fe-auth/v1/proxy', WP)
  proxyUrl.searchParams.set('path', 'wp/v2/users/me')
  let res = await fetch(proxyUrl, {
    method: 'PUT',
    headers: {
      Authorization: `Bearer ${wpToken}`,
      'Content-Type': 'application/json',
      Cookie: `Authorization=Bearer ${wpToken}`,
    },
    body: JSON.stringify(patch),
  })
  if (!res.ok) {
    const url = new URL('/wp-json/wp/v2/users/me', WP)
    res = await fetch(url, {
      method: 'PUT',
      headers: {
        Authorization: `Bearer ${wpToken}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(patch),
    })
  }

  const text = await res.text()
  return new Response(text, { status: res.status, headers: { 'Content-Type': res.headers.get('Content-Type') || 'application/json' } })
}


// ==== FILE: app\api\wp\users\[slug]\route.ts ====
export const runtime = 'nodejs'
export const dynamic = 'force-dynamic'

type PublicUser = {
  id: number
  name?: string
  slug: string
  description?: string
  avatar_urls?: Record<string, string>
  profile_fields?: Record<string, unknown> | null
  recent_posts?: any[]
  recent_comments?: any[]
  social?: { twitter: string | null; linkedin: string | null; github: string | null }
}

function normalizeUrl(u?: string | null): string | null {
  if (!u) return null
  const s = String(u).trim()
  if (!s) return null
  if (/^https?:\/\//i.test(s)) return s
  return `https://${s}`
}

function deriveSocial(u: any): { twitter: string | null; linkedin: string | null; github: string | null } {
  // Prefer explicit social object if backend/plugin supplies it
  if (u && typeof u.social === 'object' && u.social) {
    return {
      twitter: normalizeUrl((u.social as any).twitter ?? null),
      linkedin: normalizeUrl((u.social as any).linkedin ?? null),
      github: normalizeUrl((u.social as any).github ?? null),
    }
  }
  const pf = (u && typeof u.profile_fields === 'object') ? (u.profile_fields as Record<string, unknown>) : null
  const get = (k: string) => (pf && typeof pf[k] === 'string') ? (pf[k] as string) : undefined
  // Primary keys from user_meta
  const tw = (u?.twitter_url as string) || get('twitter_url') || get('twitter') || get('x')
  const ln = (u?.linkedin_url as string) || get('linkedin_url') || get('linkedin')
  const gh = (u?.github_url as string) || get('github_url') || get('github')
  return { twitter: normalizeUrl(tw || null), linkedin: normalizeUrl(ln || null), github: normalizeUrl(gh || null) }
}

function sanitize(u: any): PublicUser {
  const mapPost = (p: any) => ({
    id: Number(p?.id ?? 0),
    title: String(p?.title ?? p?.title?.rendered ?? ''),
    slug: String(p?.slug ?? ''),
    date: String(p?.date ?? p?.date_gmt ?? ''),
    link: String(p?.link ?? ''),
    content_raw: String(p?.content_raw ?? p?.content?.raw ?? ''),
    content_rendered: String(p?.content_rendered ?? p?.content?.rendered ?? ''),
  })
  const mapComment = (c: any) => ({
    id: Number(c?.id ?? 0),
    post: Number(c?.post ?? c?.post_id ?? 0),
    date: String(c?.date ?? c?.date_gmt ?? ''),
    link: String(c?.link ?? c?.permalink ?? ''),
    content_raw: String(c?.content_raw ?? c?.content?.raw ?? ''),
    content_rendered: String(c?.content_rendered ?? c?.content?.rendered ?? ''),
  })
  return {
    id: Number(u?.id ?? 0),
    name: u?.name ?? u?.display_name,
    slug: String(u?.slug ?? ''),
    description: u?.description ?? '',
    avatar_urls: u?.avatar_urls ?? {},
    profile_fields: u?.profile_fields ?? null,
    recent_posts: Array.isArray(u?.recent_posts) ? u.recent_posts.map(mapPost) : [],
    recent_comments: Array.isArray(u?.recent_comments) ? u.recent_comments.map(mapComment) : [],
  social: deriveSocial(u),
  }
}

export async function GET(request: Request, context: { params: Promise<{ slug: string }> }) {
  const { slug } = await context.params
  const WP = process.env.WP_URL || process.env.NEXT_PUBLIC_WP_URL
  if (!WP) return new Response(JSON.stringify({ error: 'WP_URL env required' }), { status: 500 })

  const base = WP.replace(/\/$/, '')
  const url = new URL(`/wp-json/fe-auth/v1/public-user/${encodeURIComponent(slug)}`, base)
  // forward optional compact flag
  const inUrl = new URL(request.url)
  const compact = inUrl.searchParams.get('compact')
  if (compact != null) url.searchParams.set('compact', compact)

  const revalidate = Number(process.env.PROFILE_CACHE_SECONDS || '0')
  const fetchOpts: RequestInit = revalidate > 0
    ? ({ next: { revalidate } } as any)
    : { cache: 'no-store' }

  try {
    const res = await fetch(url.toString(), fetchOpts)
    if (res.status === 404) {
      return new Response('null', { status: 404, headers: { 'Content-Type': 'application/json' } })
    }
    if (!res.ok) {
      // Mask upstream errors
      return new Response('null', { status: 404, headers: { 'Content-Type': 'application/json' } })
    }
    const data = await res.json().catch(() => null)
    if (!data || typeof data !== 'object') {
      return new Response('null', { status: 404, headers: { 'Content-Type': 'application/json' } })
    }
    const out = sanitize(data)
    if (!out.slug) {
      return new Response('null', { status: 404, headers: { 'Content-Type': 'application/json' } })
    }
    return new Response(JSON.stringify(out), { status: 200, headers: { 'Content-Type': 'application/json' } })
  } catch (e) {
    return new Response('null', { status: 404, headers: { 'Content-Type': 'application/json' } })
  }
}


// ==== FILE: app\api\_debug\route.ts ====
export const runtime = 'nodejs'

export async function GET() {
  return Response.json({ ok: true, time: new Date().toISOString() })
}


// ==== FILE: app\blog\loading.tsx ====
import React from 'react'

import FeedSkeleton from '@/components/feed-skeleton'

// Minimal loading UI for the /blog index route
export default function Loading() {
  return (
    <div className="container mx-auto px-4 py-12">
      <div className="text-center mb-12">
        <div className="h-8 w-64 mx-auto bg-muted rounded animate-pulse" />
        <div className="mt-3 h-4 w-80 mx-auto bg-muted rounded animate-pulse" />
      </div>
      <FeedSkeleton layout="grid" count={6} />
    </div>
  )
}


// ==== FILE: app\blog\page.tsx ====

import React, { Suspense } from 'react'
import { Search, Clock, Flame } from 'lucide-react'

import Feed from '@/components/feed'
import FeedSkeleton from '@/components/feed-skeleton'
import { Input } from '@/components/ui/input'
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'

export const dynamic = 'force-static'

export default async function BlogIndexPage() {
  return (
    <div className="container mx-auto px-4 py-12">
      <div className="text-center mb-12">
        <h1 className="text-4xl font-bold tracking-tight">Articles & Insights</h1>
        <p className="text-muted-foreground mt-2 max-w-2xl mx-auto">
          Explore the latest in web development, AI, and technology.
        </p>
      </div>

      {/* Sticky search + filters */}
      <div className="sticky top-16 z-30 mb-8 border-y bg-background/80 backdrop-blur supports-[backdrop-filter]:bg-background/60">
        <div className="py-3">
          <div className="grid grid-cols-1 gap-3 sm:grid-cols-2 lg:grid-cols-4 items-center">
            {/* Search */}
            <div className="lg:col-span-2 relative">
              <Search className="pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-muted-foreground" />
              <Input aria-label="Search articles" placeholder="Search articles by keyword..." className="pl-10" />
            </div>
            {/* Category filter */}
            <Select>
              <SelectTrigger aria-label="Filter by category">
                <SelectValue placeholder="Filter by category" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="all">All Categories</SelectItem>
                <SelectItem value="ai">AI</SelectItem>
                <SelectItem value="web-dev">Web Development</SelectItem>
                <SelectItem value="react">React</SelectItem>
              </SelectContent>
            </Select>
            {/* Sort filter with icons */}
            <Select>
              <SelectTrigger aria-label="Sort by">
                <SelectValue placeholder="Sort by" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="latest">
                  <span className="flex items-center gap-2"><Clock className="h-4 w-4" /> Latest</span>
                </SelectItem>
                <SelectItem value="popular">
                  <span className="flex items-center gap-2"><Flame className="h-4 w-4" /> Popular</span>
                </SelectItem>
              </SelectContent>
            </Select>
          </div>
        </div>
      </div>
      
      <Suspense fallback={<FeedSkeleton layout="grid" count={6} />}>
        {/* Server component fetch with skeleton fallback */}
        <Feed layout="grid" postCount={6} />
      </Suspense>
      
    </div>
  )
}


// ==== FILE: app\blog\[slug]\loading.tsx ====
import React from 'react'

import { Skeleton } from '@/components/ui/skeleton'

export default function BlogPostLoading() {
  return (
    <div className="container mx-auto px-4 py-12 max-w-7xl">
      <header className="text-center mb-8 relative">
        <div className="absolute top-0 right-0">
          <Skeleton className="h-10 w-24" />
        </div>
        <Skeleton className="h-10 w-2/3 mx-auto mb-4" />
        <div className="flex justify-center items-center gap-4 text-muted-foreground text-sm">
          <div className="flex items-center gap-2">
            <Skeleton className="h-6 w-6 rounded-full" />
            <Skeleton className="h-4 w-24" />
          </div>
          <span>‚Ä¢</span>
          <Skeleton className="h-4 w-24" />
          <span>‚Ä¢</span>
          <Skeleton className="h-4 w-16" />
        </div>
      </header>

      <div className="relative w-full max-w-4xl mx-auto mb-12">
        <Skeleton className="h-64 w-full rounded-lg" />
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
        <aside className="lg:col-span-3 lg:sticky top-8 self-start hidden lg:block">
          <div className="p-4 border-l-4 border-primary bg-secondary/50 rounded-r-lg">
            <Skeleton className="h-6 w-40 mb-4" />
            <div className="space-y-2">
              <Skeleton className="h-4 w-56" />
              <Skeleton className="h-4 w-48" />
              <Skeleton className="h-4 w-60" />
            </div>
          </div>
        </aside>

        <article className="lg:col-span-6">
          <div className="prose dark:prose-invert max-w-none mx-auto">
            <div className="space-y-3">
              {Array.from({ length: 8 }).map((_, i) => (
                <Skeleton key={i} className="h-4 w-full" />
              ))}
            </div>
          </div>
        </article>

        <aside className="lg:col-span-3 lg:sticky top-8 self-start">
          <div className="bg-card p-6 rounded-lg shadow-lg">
            <Skeleton className="h-6 w-40 mb-4" />
            <div className="space-y-2">
              <Skeleton className="h-4 w-56" />
              <Skeleton className="h-4 w-48" />
              <Skeleton className="h-4 w-60" />
            </div>
          </div>
        </aside>
      </div>

      <div className="my-12">
        <Skeleton className="h-px w-full" />
      </div>

      <div className="max-w-4xl mx-auto">
        <div className="bg-card/50 p-6 rounded-lg flex flex-col sm:flex-row items-start gap-6">
          <Skeleton className="h-20 w-20 rounded-full" />
          <div className="flex-1 space-y-3">
            <Skeleton className="h-4 w-24" />
            <Skeleton className="h-6 w-48" />
            <Skeleton className="h-4 w-full" />
          </div>
        </div>
      </div>

      <div className="my-12">
        <Skeleton className="h-px w-full" />
      </div>

      <div className="max-w-4xl mx-auto">
        <div className="flex items-center gap-6 mb-8">
          <Skeleton className="h-10 w-28" />
          <Skeleton className="h-6 w-40" />
        </div>
        <div className="space-y-6">
          <div className="grid gap-4">
            <Skeleton className="h-24 w-full" />
            <div className="flex justify-end">
              <Skeleton className="h-10 w-32" />
            </div>
          </div>
          <div className="flex items-start gap-4">
            <Skeleton className="h-10 w-10 rounded-full" />
            <div className="flex-1 space-y-2">
              <Skeleton className="h-4 w-32" />
              <Skeleton className="h-4 w-3/4" />
            </div>
          </div>
        </div>
      </div>
    </div>
  )
}


// ==== FILE: app\blog\[slug]\page.tsx ====
import React from 'react'
import Head from 'next/head'
import { Metadata } from 'next'
import Image from 'next/image'
import Link from 'next/link'
import hljs from 'highlight.js'
import { Twitter, Linkedin, Github, Clock, Eye } from 'lucide-react'
import { Suspense } from 'react'
import { notFound } from 'next/navigation'

import { getArticleSchema, getBreadcrumbSchema } from '@/lib/generateSchema'
import 'highlight.js/styles/github-dark.css'

import RelatedPostsSidebar from '@/components/RelatedPostsSidebar'
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar'
import { Separator } from '@/components/ui/separator'
import { Badge } from '@/components/ui/badge'
import { Accordion, AccordionContent, AccordionItem, AccordionTrigger } from '@/components/ui/accordion'
import { getPostBySlug, type PostDetail } from '@/lib/wp'
import { getOrBuildToc } from '@/lib/toc'
import TableOfContents from '@/components/toc/TableOfContents'
import type { TocItem as HtmlTocItem } from '@/lib/toc'
import { autoLinkFirst, type AutoLinkTarget } from '@/lib/autolink'
import { sanitizeWP } from '@/lib/sanitize'
import PostActions from '@/components/post-actions'
import CommentsSection from '@/components/comments-section'
import ReadingProgress from '@/components/reading-progress'
import FloatingActions from '@/components/floating-actions'
import ContentDecorators from '@/components/content-decorators'
import ReaderToolbar from '@/components/reader-toolbar'
import ReaderToolbarPortal from '@/components/reader-toolbar-portal'
import BackToTopCenter from '@/components/back-to-top-center'
import { getLatestByAuthor } from '@/lib/wp-author'
import ViewsCounter from '@/components/views-counter'
import ErrorBoundary from '@/components/error-boundary'
import MarkdownRenderer from '@/components/markdown/MarkdownRenderer'
import { extractTocFromMarkdown } from '@/lib/toc-md'
import { decodeEntities } from '@/lib/entities'

// ToolbarPortal moved to component file

// Enhanced recommendation type with more metadata
type EnhancedRecommendation = {
  id: number
  slug: string
  title: string
  excerpt?: string
  featuredImage?: string
  authorName?: string
  date?: string
  readingTime?: string
}

type PageParams = { params: { slug: string } }
type PageProps = { params: { slug: string }, searchParams?: Record<string, string | string[] | undefined> }

export async function generateMetadata({ params }: PageParams): Promise<Metadata> {
    const { slug } = params
    const post = await getPostBySlug(slug)
  if (!post) return { title: 'Post not found' }
  return { title: post.seo?.title || post.title, description: post.seo?.description }
}

export default async function PostPage({ params, searchParams }: PageProps) {
    const { slug } = params
        let post: PostDetail | null = null
        try {
            post = await getPostBySlug(slug)
        } catch (e) {
            console.error('Failed to load post', e)
            post = null
        }
        if (!post) notFound()

    const rawHtml = post.contentHtml || ''
    const safeHtml = sanitizeWP(rawHtml)

    // Simple reading time based on words/minute
  const wordsPerMinute = 225
  const wordCount = safeHtml.replace(/<[^>]+>/g, '').split(/\s+/).filter(Boolean).length
  const readingTimeMinutes = Math.max(1, Math.ceil(wordCount / wordsPerMinute))
  const readingTime = `${readingTimeMinutes} min read`

    // üîß FIX: Process content in correct order BEFORE TOC generation
    const highlightedContent = safeHtml.replace(/<pre><code class="language-([a-z0-9_-]+)">([\s\S]*?)<\/code><\/pre>/gi, (match, lang, code) => {
        try {
            const highlighted = hljs.highlight(code, { language: lang }).value
            return `<pre><code class="hljs language-${lang}">${highlighted}</code></pre>`
        } catch {
            return match
        }
    })

    // üîß FIX: Inject heading IDs BEFORE TOC generation
    const contentWithHeadingIds = highlightedContent.replace(/<h([23])(\s[^>]*)?>([\s\S]*?)<\/h\1>/gi, (m, level, attrs = '', inner) => {
        if (/\sid=/i.test(attrs)) return m
        const text = decodeEntities(inner.replace(/<[^>]+>/g, '')).toLowerCase()
        const slug = text.replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '')
        const attrsOut = attrs ? `${attrs} id="${slug}"` : ` id="${slug}"`
        return `<h${level}${attrsOut}>${inner}</h${level}>`
    })

        // Generate TOC (legacy for anchors), and markdown items for new TOC component
        let tableOfContents: HtmlTocItem[] = []
        const mdItems = (post as any).content_raw ? extractTocFromMarkdown((post as any).content_raw as string, { minDepth: 1, maxDepth: 6 }) : []
        if ((post as any).content_raw) {
            const mdToc = mdItems
            tableOfContents = mdToc
                .filter(i => i.depth === 2 || i.depth === 3)
                .map(i => ({ level: (i.depth as 2 | 3), text: decodeEntities(i.value), slug: i.id }))
        } else {
            tableOfContents = await getOrBuildToc(Number(post.id), contentWithHeadingIds)
        }

    // Auto-linking: only first occurrence per target
    const autoLinkTargets: AutoLinkTarget[] = []
    const contentLinked = autoLinkFirst(contentWithHeadingIds, autoLinkTargets)

    // üöÄ ENHANCED: Better recommendations with more metadata
    let recommended: EnhancedRecommendation[] = []
    // Try to infer author id from categories/tags data model; fallback 0 (no fetch)
    const authorId = (post as any).author ?? 0
    const latestByAuthor = authorId ? await getLatestByAuthor(Number(authorId), Number(post.id), 3) : []
    try {
        const cats = (post.categories || []).map(c => c.id).join(',')
        const tags = (post.tags || []).map(t => t.id).join(',')
        const qs = new URLSearchParams()
        if (cats) qs.set('categories', cats)
        if (tags) qs.set('tags', tags)
        qs.set('exclude', String(post.id))
        qs.set('per_page', '4') // Get one extra for better selection
        const origin = process.env.NEXT_PUBLIC_SITE_URL || process.env.SITE_URL || ''
        const url = `${origin || ''}/api/wp/related?${qs.toString()}`
        const r = await fetch(url, { 
            headers: { Accept: 'application/json' }, 
            cache: 'no-store',
            next: { revalidate: 300 } // Cache for 5 minutes
        })
        if (r.ok) {
            const data = (await r.json()) as any[]
            recommended = (data || []).slice(0, 3).map(d => {
                // Calculate reading time for each recommendation
                const content = d.content?.rendered || d.excerpt?.rendered || ''
                const words = content.replace(/<[^>]+>/g, '').split(/\s+/).filter(Boolean).length
                const recReadingTime = Math.max(1, Math.ceil(words / wordsPerMinute))
                
                return {
                    id: d.id,
                    slug: d.slug,
                    title: d.title?.rendered || '',
                    excerpt: d.excerpt?.rendered?.replace(/<[^>]+>/g, '').substring(0, 120) + '...' || '',
                    featuredImage: d.featured_media_url || d.jetpack_featured_media_url || '',
                    authorName: d.author_info?.display_name || '',
                    date: d.date || '',
                    readingTime: `${recReadingTime} min read`
                }
            })
        }
    } catch (error) {
        console.warn('Failed to fetch recommendations:', error)
        // Fallback recommendations could be hardcoded popular posts
    }

    // Popular posts by views (cached)
    let popular: EnhancedRecommendation[] = []
    try {
        const origin = process.env.NEXT_PUBLIC_SITE_URL || process.env.SITE_URL || ''
        const url = `${origin || ''}/api/wp/popular?limit=6`
        const r = await fetch(url, { headers: { Accept: 'application/json' }, next: { revalidate: 600 } })
        if (r.ok) {
            const data = (await r.json()) as any[]
            popular = (data || []).map(d => ({
                id: d.id,
                slug: d.slug,
                title: d.title?.rendered || d.title || '',
                excerpt: (d.excerpt || '').substring(0, 120) + (d.excerpt && d.excerpt.length > 120 ? '...' : ''),
                featuredImage: d.featuredImage || d.featured_media_url || d.jetpack_featured_media_url || '',
                authorName: d.authorName || '',
                date: d.date || '',
            }))
        }
    } catch (e) {
        console.warn('Failed to fetch popular posts:', e)
    }

    // Recent posts (chronological)
    let recent: EnhancedRecommendation[] = []
    try {
        const origin = process.env.NEXT_PUBLIC_SITE_URL || process.env.SITE_URL || ''
        const url = `${origin || ''}/api/wp/posts?per_page=6&_embed=1`
        const r = await fetch(url, { headers: { Accept: 'application/json' }, next: { revalidate: 120 } })
        if (r.ok) {
            const data = (await r.json()) as any[]
            recent = (data || []).map((p) => ({
                id: p.id,
                slug: p.slug,
                title: p.title?.rendered || '',
                excerpt: (p.excerpt?.rendered || '').replace(/<[^>]+>/g, '').substring(0, 120) + '...',
                featuredImage: p._embedded?.['wp:featuredmedia']?.[0]?.source_url || p.featured_media_url || p.jetpack_featured_media_url || '',
                authorName: p._embedded?.author?.[0]?.name || '',
                date: p.date || '',
            }))
        }
    } catch (e) {
        console.warn('Failed to fetch recent posts:', e)
    }

    const floatImage = typeof searchParams?.floatImage === 'string' 
        ? ['1','true','yes','on'].includes(String(searchParams?.floatImage).toLowerCase())
        : false

    return (
        <>
            <Head>
                <script
                    type="application/ld+json"
                    dangerouslySetInnerHTML={{ __html: JSON.stringify(getArticleSchema(post)) }}
                />
                <script
                    type="application/ld+json"
                    dangerouslySetInnerHTML={{ __html: JSON.stringify(getBreadcrumbSchema(post)) }}
                />
            </Head>
            {/* Top-center reader pill (Zoom + theme), positioned respecting header */}
            <ReaderToolbarPortal />
            {/* Center back-to-top pill */}
            <BackToTopCenter />

            {/* üöÄ NEW: Reading Progress Bar */}
            <ReadingProgress />

            <div className="container mx-auto px-4 py-10 max-w-[90rem] 2xl:max-w-[96rem]">
                {/* üöÄ ENHANCED: Breadcrumb Navigation */}
                <nav className="mb-4 text-sm text-muted-foreground">
                    <Link href="/" className="hover:text-foreground">Home</Link>
                    <span className="mx-1">‚Ä∫</span>
                    <Link href="/blog" className="hover:text-foreground">Blog</Link>
                    {post.categories?.[0] && (
                        <>
                            <span className="mx-1">‚Ä∫</span>
                            <Link href={`/categories/${post.categories[0].slug}`} className="hover:text-foreground">
                                {post.categories[0].name}
                            </Link>
                        </>
                    )}
                    <span className="mx-1">‚Ä∫</span>
                    <span className="text-foreground">{post.title}</span>
                </nav>

                {/* Header */}
                <header className="relative mb-6">
                    {/* Actions pinned on desktop */}
                    <div className="hidden lg:block absolute right-0 top-0">
                        <PostActions postId={Number(post.id)} slug={post.slug} title={post.title} />
                    </div>
                    <div className="max-w-3xl mx-auto text-center">
                        <h1 className="text-3xl md:text-5xl font-bold tracking-tight mb-6 break-words leading-snug">
                            {post.title}
                        </h1>

                        <div className="flex flex-wrap items-center justify-center gap-3 text-muted-foreground text-sm">
                            {/* Categories as badges */}
                            <div className="flex flex-wrap gap-2 justify-center">
                                {(post.categories && post.categories.length > 0) ? (
                                    post.categories.map(c => (
                                        <Badge key={c.id} variant="secondary" className="hover:bg-primary hover:text-primary-foreground transition-colors">
                                            <Link href={`/categories/${c.slug}`}>{c.name}</Link>
                                        </Badge>
                                    ))
                                ) : null}
                            </div>
                            {post.categories?.length ? <span className="hidden sm:inline">‚Ä¢</span> : null}
                            <div className="flex items-center gap-2">
                                <Avatar className="h-7 w-7">
                                    <AvatarImage src={post.authorAvatar || ''} alt={post.authorName || 'Author'} />
                                    <AvatarFallback>{(post.authorName || 'A').charAt(0)}</AvatarFallback>
                                </Avatar>
                                <span className="truncate">{post.authorName || 'Unknown'}</span>
                            </div>
                            <span className="hidden sm:inline">‚Ä¢</span>
                            <span>{new Date(post.date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</span>
                            <span className="hidden sm:inline">‚Ä¢</span>
                            <span className="inline-flex items-center gap-1">
                                <Clock className="h-3 w-3" />
                                {readingTime}
                            </span>
                            <span className="hidden sm:inline">‚Ä¢</span>
                            <span className="inline-flex items-center gap-1">
                                <Eye className="h-3 w-3" />
                                <ViewsCounter postId={Number(post.id)} />
                            </span>
                        </div>
                        {/* Actions inline on mobile */}
                        <div className="mt-3 lg:hidden flex justify-center">
                            <PostActions postId={Number(post.id)} slug={post.slug} title={post.title} />
                        </div>
                    </div>
                </header>

                <FloatingActions title={post.title} postId={Number(post.id)} />
                

        {/* Featured banner */}
    {post.featuredImage ? (
        <div className={`mb-10 lg:w-1/2 mx-auto ${floatImage ? 'lg:hidden' : ''}`}>
        <div className="relative aspect-video w-full overflow-hidden rounded-lg shadow-md">
                            <Image
                                src={post.featuredImage}
                                alt={post.title}
                                fill
                sizes="(max-width: 1024px) 100vw, 50vw"
                                className="object-cover"
                                priority={false}
                                quality={70}
                            />
                        </div>
                    </div>
                ) : null}

                                {/* Mobile/Tablet TOC (use markdown items or HTML fallback) */}
                                {(() => {
                                        const itemsForTOC = (mdItems && mdItems.length > 0)
                                                ? mdItems
                                                : (tableOfContents || []).map(i => ({ id: i.slug, value: i.text, depth: i.level }))
                                        return itemsForTOC.length > 0 ? (
                                                                    <div className="lg:hidden mb-6">
                                                                        <TableOfContents items={itemsForTOC as unknown as any[]} />
                                                                    </div>
                                        ) : null
                                })()}

                                <div className="grid grid-cols-1 lg:grid-cols-[280px_minmax(0,1fr)_320px] gap-8">
                    {/* üîß FIX: Sticky TOC with better positioning */}
                                                            <aside className="self-start hidden lg:block print:hidden" style={{ position: 'sticky', top: 'calc(var(--header-height) + 16px)' }}>
                        {(() => {
                            const itemsForTOC = (mdItems && mdItems.length > 0)
                                ? mdItems
                                : (tableOfContents || []).map(i => ({ id: i.slug, value: i.text, depth: i.level }))
                            return itemsForTOC.length > 0 ? (
                            <div className="lg:sticky top-20"> {/* Reduced from top-24 to top-20 */}
                                <h2 className="mb-3 text-sm font-semibold uppercase tracking-wider text-muted-foreground">
                                    On this page
                                </h2>
                                <TableOfContents items={itemsForTOC as unknown as any[]} />
                            </div>
                            ) : null
                        })()}
                    </aside>

                                        <article className="min-w-0">
                        {/* Meta info bar removed to avoid duplication */}

                                                                                                {/* Optional float image on desktop */}
                                                                                                {floatImage && post.featuredImage ? (
                                                                                                    <figure className="hidden lg:block float-left mr-6 mb-4 w-[320px] xl:w-[360px]">
                                                                                                        <div className="relative w-full aspect-[4/5] overflow-hidden rounded-lg shadow-md">
                                                                                                            <Image src={post.featuredImage} alt={post.title} fill sizes="360px" className="object-cover" />
                                                                                                        </div>
                                                                                                    </figure>
                                                                                                ) : null}

                        { (post as any).content_raw ? (
                                                    <MarkdownRenderer
                            markdown={decodeEntities((post as any).content_raw as string)}
                                                                                                                className="wp-content prose prose-lg dark:prose-invert max-w-[70ch] w-full min-w-0 mx-auto leading-7 [&>h1]:text-3xl [&>h1]:font-bold [&>h1]:mb-4 [&>h2]:text-2xl [&>h2]:font-semibold [&>h2]:mb-2 [&>h2]:scroll-mt-24 [&>h3]:text-xl [&>h3]:font-medium [&>h3]:mb-2 [&>h3]:scroll-mt-24 [&>p]:mb-3 [&>figure]:my-5 [&>figure>img]:rounded-lg [&>figure>img]:shadow-md [&>figure>figcaption]:mt-2 [&>figure>figcaption]:text-center [&>img]:rounded-lg [&>img]:shadow-md [&>img]:my-3 [&>img]:mx-auto [&>img]:max-w-full [&>ul]:mb-3 [&>ol]:mb-3 [&>li]:mb-1 [&>blockquote]:border-l-4 [&>blockquote]:border-primary [&>blockquote]:pl-4 [&>blockquote]:italic [&>blockquote]:my-4 [&>blockquote]:bg-secondary/30 [&>blockquote]:rounded-r-lg [&>pre]:relative [&>pre]:group"
                                                    />
                                                ) : (
                                                    <div
                                                                                                                className="wp-content prose prose-lg dark:prose-invert max-w-[70ch] w-full min-w-0 mx-auto leading-7 [&>h1]:text-3xl [&>h1]:font-bold [&>h1]:mb-4 [&>h2]:text-2xl [&>h2]:font-semibold [&>h2]:mb-2 [&>h2]:scroll-mt-24 [&>h3]:text-xl [&>h3]:font-medium [&>h3]:mb-2 [&>h3]:scroll-mt-24 [&>p]:mb-3 [&>figure]:my-5 [&>figure>img]:rounded-lg [&>figure>img]:shadow-md [&>figure>figcaption]:mt-2 [&>figure>figcaption]:text-center [&>img]:rounded-lg [&>img]:shadow-md [&>img]:my-3 [&>img]:mx-auto [&>img]:max-w-full [&>ul]:mb-3 [&>ol]:mb-3 [&>li]:mb-1 [&>blockquote]:border-l-4 [&>blockquote]:border-primary [&>blockquote]:pl-4 [&>blockquote]:italic [&>blockquote]:my-4 [&>blockquote]:bg-secondary/30 [&>blockquote]:rounded-r-lg [&>pre]:relative [&>pre]:group"
                                                        dangerouslySetInnerHTML={{ __html: decodeEntities(contentLinked) }}
                                                    />
                                                )}
                        {/* Client decorators for anchors, code copy, quote share */}
                        <ContentDecorators selector=".wp-content" />

                        {/* Tags hidden on post view */}
                    </article>

                                        {/* Enhanced Right sidebar: Related, Recommended, Popular, Recent, Author latest */}
                                        <aside className="self-start">
                                                <div className="bg-card p-6 rounded-lg shadow-lg">
                                                        <ErrorBoundary fallback={<div className="text-sm text-muted-foreground">Failed to load related posts.</div>}>
                                                                <RelatedPostsSidebar
                                                                                currentPostId={Number(post.id)}
                                                                                currentPostCategories={post.categories?.map(c => ({ id: c.id, name: c.name || '', slug: c.slug || '' }))}
                                                                                currentPostTags={post.tags?.map(t => ({ id: t.id, name: t.name || '', slug: t.slug || '' }))}
                                                                />
                                                        </ErrorBoundary>
                                                </div>

                                                {/* Recommended Posts */}
                                                {recommended.length > 0 && (
                                                    <div className="mt-6 bg-card p-6 rounded-lg shadow-lg">
                                                        <h3 className="text-sm font-semibold uppercase tracking-wider text-muted-foreground mb-3">Recommended Posts</h3>
                                                        <ul className="space-y-4">
                                                            {recommended.map(r => (
                                                                <li key={r.id}>
                                                                    <Link href={`/blog/${r.slug}`} className="group flex gap-3">
                                                                        {r.featuredImage ? (
                                                                            <div className="relative w-20 h-16 flex-shrink-0 overflow-hidden rounded">
                                                                                <Image src={r.featuredImage} alt={r.title} fill className="object-cover transition-transform group-hover:scale-105" />
                                                                            </div>
                                                                        ) : null}
                                                                        <div className="min-w-0">
                                                                            <div className="text-sm font-medium group-hover:text-primary line-clamp-2">{r.title}</div>
                                                                            {r.excerpt ? <div className="text-xs text-muted-foreground line-clamp-2 mt-1">{r.excerpt}</div> : null}
                                                                        </div>
                                                                    </Link>
                                                                </li>
                                                            ))}
                                                        </ul>
                                                    </div>
                                                )}

                                                {/* Popular Posts */}
                                                {popular.length > 0 && (
                                                    <div className="mt-6 bg-card p-6 rounded-lg shadow-lg">
                                                        <h3 className="text-sm font-semibold uppercase tracking-wider text-muted-foreground mb-3">Popular Posts</h3>
                                                        <ul className="space-y-4">
                                                            {popular.map(p => (
                                                                <li key={p.id}>
                                                                    <Link href={`/blog/${p.slug}`} className="group flex gap-3">
                                                                        {p.featuredImage ? (
                                                                            <div className="relative w-20 h-16 flex-shrink-0 overflow-hidden rounded">
                                                                                <Image src={p.featuredImage} alt={p.title} fill className="object-cover transition-transform group-hover:scale-105" />
                                                                            </div>
                                                                        ) : null}
                                                                        <div className="min-w-0">
                                                                            <div className="text-sm font-medium group-hover:text-primary line-clamp-2">{p.title}</div>
                                                                            {p.excerpt ? <div className="text-xs text-muted-foreground line-clamp-2 mt-1">{p.excerpt}</div> : null}
                                                                        </div>
                                                                    </Link>
                                                                </li>
                                                            ))}
                                                        </ul>
                                                    </div>
                                                )}

                                                {/* Recent Posts */}
                                                {recent.length > 0 && (
                                                    <div className="mt-6 bg-card p-6 rounded-lg shadow-lg">
                                                        <h3 className="text-sm font-semibold uppercase tracking-wider text-muted-foreground mb-3">Recent Posts</h3>
                                                        <ul className="space-y-4">
                                                            {recent.map(p => (
                                                                <li key={p.id}>
                                                                    <Link href={`/blog/${p.slug}`} className="group flex gap-3">
                                                                        {p.featuredImage ? (
                                                                            <div className="relative w-20 h-16 flex-shrink-0 overflow-hidden rounded">
                                                                                <Image src={p.featuredImage} alt={p.title} fill className="object-cover transition-transform group-hover:scale-105" />
                                                                            </div>
                                                                        ) : null}
                                                                        <div className="min-w-0">
                                                                            <div className="text-sm font-medium group-hover:text-primary line-clamp-2">{p.title}</div>
                                                                            {p.excerpt ? <div className="text-xs text-muted-foreground line-clamp-2 mt-1">{p.excerpt}</div> : null}
                                                                        </div>
                                                                    </Link>
                                                                </li>
                                                            ))}
                                                        </ul>
                                                    </div>
                                                )}

                                                {/* Author's latest posts */}
                                                {Array.isArray(latestByAuthor) && latestByAuthor.length > 0 && (
                                                        <div className="mt-6 bg-card p-6 rounded-lg shadow-lg">
                                                                <h3 className="text-sm font-semibold uppercase tracking-wider text-muted-foreground mb-3">More from the author</h3>
                                                                <ul className="space-y-3">
                                                                        {latestByAuthor.map((p: any) => (
                                                                                <li key={p.id}>
                                                                                        <Link href={`/blog/${p.slug}`} className="text-sm hover:underline line-clamp-2">{p.title?.rendered || p.title}</Link>
                                                                                </li>
                                                                        ))}
                                                                </ul>
                                                        </div>
                                                )}
                                        </aside>
                </div>

                <Separator className="my-12" />

                {/* üöÄ ENHANCED: Author box with more details */}
                <div className="max-w-4xl mx-auto">
                    <div className="bg-card/50 p-6 rounded-lg border flex flex-col sm:flex-row items-start gap-6">
                        <Avatar className="h-24 w-24 ring-2 ring-primary/20">
                            <AvatarImage src={post.authorAvatar || ''} alt={post.authorName || 'Author'} />
                            <AvatarFallback className="text-2xl font-bold">{(post.authorName || 'A').charAt(0)}</AvatarFallback>
                        </Avatar>
                        <div className="flex-1">
                            <h3 className="text-sm font-semibold text-muted-foreground mb-1">WRITTEN BY</h3>
                            <h2 className="text-2xl font-bold mb-2">{post.authorName || 'Unknown'}</h2>
                            <p className="text-muted-foreground mb-4">
                                An avid writer and technologist sharing insights on modern development practices. 
                                {/* This could be pulled from author bio field */}
                            </p>
                            <div className="flex items-center gap-4 mb-4">
                                <a href={post.seo?.twitterImage ? post.seo?.canonical || '#' : '#'} aria-label="Twitter" className="text-muted-foreground hover:text-blue-500 transition-colors">
                                    <Twitter className="h-5 w-5" />
                                </a>
                                <a href={post.seo?.canonical || '#'} aria-label="LinkedIn" className="text-muted-foreground hover:text-blue-600 transition-colors">
                                    <Linkedin className="h-5 w-5" />
                                </a>
                                <a href={post.authorName ? `https://github.com/${encodeURIComponent(post.authorName.replace(/\s+/g,'').toLowerCase())}` : '#'} aria-label="GitHub" className="text-muted-foreground hover:text-gray-900 dark:hover:text-white transition-colors">
                                    <Github className="h-5 w-5" />
                                </a>
                            </div>
                            <div className="flex items-center gap-4">
                                <Link href="/profile" className="text-sm text-primary hover:underline font-medium">
                                    View full profile ‚Üí
                                </Link>
                                <button className="text-sm bg-primary text-primary-foreground px-4 py-1 rounded-full hover:bg-primary/90 transition-colors">
                                    + Follow
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <Separator className="my-12" />

                {/* Comments section */
                }
                <div className="max-w-4xl mx-auto">
                                        <Suspense fallback={<div className="text-sm text-muted-foreground">Loading comments...</div>}> 
                                            <CommentsSection postId={Number(post.id)} />
                                        </Suspense>
                </div>

                {/* Bottom explore sections moved to right sidebar per layout spec */}
            </div>

        </>
    );
}

// ==== FILE: app\blogs\page.tsx ====
import React from 'react'
import Image from 'next/image'

import { getPosts, PostSummary } from '@/lib/wp'
import { logWPError } from '@/lib/log'

export default async function BlogsPage() {
  let items: PostSummary[] = []
  try {
    const res = await getPosts({ page: 1, perPage: 10 })
    items = res.items
  } catch (err: unknown) {
    // Log upstream WP error and continue with empty list so build/prerender succeeds
    const status = (err && typeof err === 'object' && 'status' in err) ? (err as any).status : undefined
    const statusText = (err && typeof err === 'object' && 'message' in err) ? (err as any).message : String(err)
    logWPError('blogs-page-getPosts', { status, statusText, body: typeof err === 'string' ? err : JSON.stringify(err) })
    items = []
  }

  return (
    <main>
      <h1>Blogs</h1>
      {items.length === 0 ? (
        <div>No posts available.</div>
      ) : (
        <ul>
          {items.map(p => (
            <li key={p.id}>
              <a href={`/blogs/${p.slug}`} dangerouslySetInnerHTML={{ __html: p.title }} />
              {p.featuredImage && (
                <div style={{ maxWidth: 240 }}>
                  <Image src={p.featuredImage} alt="" width={240} height={140} style={{ objectFit: 'cover' }} />
                </div>
              )}
              <div dangerouslySetInnerHTML={{ __html: p.excerptHtml ?? '' }} />
            </li>
          ))}
        </ul>
      )}
    </main>
  )
}


// ==== FILE: app\blogs\[slug]\page.tsx ====
import React from 'react'
import Image from 'next/image'
import { notFound } from 'next/navigation'

import { getPostBySlug, PostDetail } from '@/lib/wp'
import { logWPError } from '@/lib/log'

type Props = { params: { slug: string } }

export default async function PostPage({ params }: Props) {
  let post: PostDetail | null = null
  try {
    post = await getPostBySlug(params.slug)
  } catch (err: unknown) {
    const msg = err && typeof err === 'object' && 'message' in err ? (err as any).message : String(err)
    logWPError('post-page-getPost', { status: (err as any)?.status, statusText: msg, body: typeof err === 'string' ? err : JSON.stringify(err) })
    // If upstream is down, treat as not found to avoid build failure
    return notFound()
  }

  if (!post) return notFound()

  return (
    <main>
      <h1 dangerouslySetInnerHTML={{ __html: post.title }} />
      {post.featuredImage && (
        <div style={{ maxWidth: 800 }}>
          <Image src={post.featuredImage} alt="" width={800} height={450} style={{ objectFit: 'cover' }} />
        </div>
      )}
      <article dangerouslySetInnerHTML={{ __html: post.contentHtml }} />
    </main>
  )
}


// ==== FILE: app\bookmarks\page.tsx ====
import { Suspense } from 'react'
import Link from 'next/link'

export const dynamic = 'force-dynamic'
export const runtime = 'nodejs'

async function getBookmarks(cookiesHeader?: string) {
  try {
    const r = await fetch(`${process.env.NEXT_PUBLIC_SITE_URL || ''}/api/wp/bookmarks?expand=1`, {
      cache: 'no-store',
      headers: cookiesHeader ? { cookie: cookiesHeader } : undefined,
    })
    if (!r.ok) return null
    return await r.json()
  } catch { return null }
}

export default async function BookmarksPage() {
  // Forward cookies so upstream sees the logged-in session
  const cookie = (await import('next/headers')).cookies
  const jar = await cookie()
  const sessionName = process.env.SESSION_COOKIE_NAME || 'session'
  const c = jar.get(sessionName)?.value
  const header = c ? `${sessionName}=${c}` : undefined
  const data = await getBookmarks(header)
  const items = Array.isArray(data?.items) ? data.items as Array<any> : []
  return (
    <div className="container mx-auto px-4 py-10 max-w-4xl">
      <h1 className="text-2xl font-semibold mb-6">Bookmarks</h1>
      {data === null ? (
        <div className="text-muted-foreground">Login required to view your bookmarks.</div>
      ) : items.length === 0 ? (
        <div className="text-muted-foreground">You haven't saved any bookmarks yet.</div>
      ) : (
        <ul className="space-y-4">
          {items.map(it => (
            <li key={it.id} className="rounded-2xl border p-4 hover:bg-muted/30 transition">
              <div className="flex items-center justify-between gap-3">
                <div>
                  <a href={it.link} className="font-medium hover:underline" target="_blank" rel="noopener noreferrer">{it.title || `Post #${it.id}`}</a>
                  <div className="text-xs text-muted-foreground mt-1">{new Date(it.date).toLocaleString()} ¬∑ {it.slug}</div>
                </div>
                <div className="text-xs text-muted-foreground">{typeof it.count === 'number' ? `${it.count} saved` : ''}</div>
              </div>
            </li>
          ))}
        </ul>
      )}
      <div className="mt-8 text-sm text-muted-foreground">Bookmarks are private and stored to your account.</div>
      <div className="mt-6">
        <Link href="/" className="text-primary hover:underline">Back to Home</Link>
      </div>
    </div>
  )
}


// ==== FILE: app\categories\[slug]\page.tsx ====
import React, { Suspense } from 'react'
import { Search } from 'lucide-react'

import Feed from '@/components/feed'
import FeedSkeleton from '@/components/feed-skeleton'
import { Input } from '@/components/ui/input'
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'
import { Button } from '@/components/ui/button'

export default async function CategoryPage({ params }: { params: { slug: string } }) {
  const { slug } = params
  
  return (
    <div className="container mx-auto px-4 py-12">
      <div className="text-center mb-12">
        <h1 className="text-4xl font-bold tracking-tight">Category: <span className="capitalize">{slug.replace(/-/g, ' ')}</span></h1>
        <p className="text-muted-foreground mt-2 max-w-2xl mx-auto">
          Browsing all articles filed under this category.
        </p>
      </div>

      <div className="mb-8 p-4 border rounded-lg bg-card/50">
        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 items-center">
          <div className="md:col-span-2">
            <div className="relative">
              <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-muted-foreground" />
              <Input placeholder="Search within this category..." className="pl-10" />
            </div>
          </div>
          <Select>
            <SelectTrigger>
              <SelectValue placeholder="Sort by" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="latest">Latest</SelectItem>
              <SelectItem value="oldest">Oldest</SelectItem>
              <SelectItem value="popular">Popular</SelectItem>
            </SelectContent>
          </Select>
          <Button className="w-full">Apply Filters</Button>
        </div>
      </div>
      
      <Suspense fallback={<FeedSkeleton layout="grid" count={6} />}>
        <Feed layout="grid" postCount={6} />
      </Suspense>
      
    </div>
  )
}


// ==== FILE: app\contact\page.tsx ====
"use client";
import { useState } from "react";

import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";

export default function ContactPage() {
  const [copied, setCopied] = useState(false)
  const email = 'info@techoblivion.in'
  const copyEmail = async () => {
    try {
      await navigator.clipboard.writeText(email)
      setCopied(true)
      setTimeout(() => setCopied(false), 1500)
    } catch {}
  }
  return (
    <div className="container mx-auto px-4 py-12 max-w-2xl">
      <div className="text-center mb-12">
        <h1 className="text-4xl font-bold tracking-tight">Get in touch</h1>
        <p className="text-muted-foreground mt-2">Prefer email? Shoot me a message.</p>
        <div className="mt-6 inline-flex items-center gap-3 rounded-lg border bg-card/50 px-4 py-3">
          <div className="text-left">
            <div className="text-xs uppercase text-muted-foreground">Email</div>
            <div className="font-medium">{email}</div>
          </div>
          <div className="flex items-center gap-2">
            <Button type="button" variant="outline" size="sm" onClick={copyEmail}>{copied ? 'Copied' : 'Copy'}</Button>
            <Button asChild size="sm"><a href={`mailto:${email}`}>Open mail app</a></Button>
          </div>
        </div>
        <p className="mt-2 text-xs text-muted-foreground">I usually respond within a day.</p>
      </div>
      <div className="bg-card/50 p-8 rounded-lg shadow-lg">
        <form className="grid gap-6" onSubmit={(e) => {
          e.preventDefault();
          const fd = new FormData(e.currentTarget as HTMLFormElement);
          const name = String(fd.get('name') || '');
          const fromEmail = String(fd.get('email') || '');
          const subject = String(fd.get('subject') || '');
          const message = String(fd.get('message') || '');
          const body = `${message}\n\n---\nFrom: ${name || 'Anonymous'}${fromEmail ? ` <${fromEmail}>` : ''}`;
          const url = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
          window.location.href = url;
        }}>
          <div className="grid md:grid-cols-2 gap-6">
            <div className="space-y-2">
              <Label htmlFor="name">Name</Label>
              <Input id="name" name="name" placeholder="Your name" />
            </div>
            <div className="space-y-2">
              <Label htmlFor="email">Email</Label>
              <Input id="email" name="email" type="email" placeholder="your.email@example.com" />
            </div>
          </div>
          <div className="space-y-2">
            <Label htmlFor="subject">Subject</Label>
            <Input id="subject" name="subject" placeholder="What's this about?" />
          </div>
          <div className="space-y-2">
            <Label htmlFor="message">Message</Label>
            <Textarea id="message" name="message" placeholder="Your message..." rows={6} />
          </div>
          <Button type="submit" size="lg" className="w-full">Open mail app to send</Button>
        </form>
      </div>
    </div>
  )
}


// ==== FILE: app\dashboard\FullDashboardPage.tsx ====
import React, { Suspense } from 'react'

import { Card } from '@/components/ui/card'
import DashboardClientShell from '@/components/dashboard/DashboardClientShell'

export default function DashboardFullPage() {
  return (
    <div className="container mx-auto p-4 space-y-4">
      <div className="text-2xl font-semibold">Unified Dashboard</div>
      <Suspense fallback={<Card className="p-4">Loading‚Ä¶</Card>}>
        <DashboardClientShell />
      </Suspense>
    </div>
  )
}


// ==== FILE: app\dashboard\page.tsx ====

import React from 'react'
import Link from 'next/link'

import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import DashboardClientShell from '@/components/dashboard/DashboardClientShell'

export default async function DashboardPage() {
  // Dummy user data for design purposes, replacing the authentication check.
  const user = {
    displayName: "Jane Doe",
    username: "janedoe",
    email: "jane.doe@example.com",
    id: "12345",
    roles: ["subscriber", "editor"],
  };

  return (
    <div className="container mx-auto px-4 py-12 max-w-4xl">
      <div className="mb-8">
        <h1 className="text-3xl font-bold">Dashboard</h1>
        <p className="text-muted-foreground">Welcome back, {user.displayName}!</p>
      </div>
      
      <Card className="bg-card/50">
        <CardHeader>
          <CardTitle>Account Information</CardTitle>
          <CardDescription>Your personal and account details.</CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <p className="text-sm font-medium text-muted-foreground">Display Name</p>
              <p>{user.displayName}</p>
            </div>
            <div>
              <p className="text-sm font-medium text-muted-foreground">Username</p>
              <p>{user.username}</p>
            </div>
             <div>
              <p className="text-sm font-medium text-muted-foreground">Email</p>
              <p>{user.email}</p>
            </div>
            <div>
              <p className="text-sm font-medium text-muted-foreground">User ID</p>
              <p>{user.id}</p>
            </div>
            <div>
              <p className="text-sm font-medium text-muted-foreground">Roles</p>
              <p className="capitalize">{(user.roles || []).join(', ') || 'Subscriber'}</p>
            </div>
          </div>
        </CardContent>
      </Card>

      <div className="mt-8 flex flex-col sm:flex-row gap-4">
        <Button asChild>
            <Link href="/">Back to Home</Link>
        </Button>
        <form action="/api/auth/logout" method="POST">
            <Button type="submit" variant="destructive">
            Logout
            </Button>
        </form>
      </div>

      <div className="mt-12 space-y-4">
        <h2 className="text-xl font-semibold">Unified Dashboard</h2>
  <DashboardClientShell />
      </div>
    </div>
  )
}


// ==== FILE: app\dashboard\full\page.tsx ====
export { default } from '../FullDashboardPage'


// ==== FILE: app\dashboard\posts\page.tsx ====
import Link from "next/link";
import { Edit, Trash2, PlusCircle } from "lucide-react";

import { Button } from "@/components/ui/button";
import { Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle } from "@/components/ui/card";
import { dummyPosts } from "@/data/dummy-posts";

export default function DashboardPostsPage() {
  const userPosts = dummyPosts.slice(0, 3); // Placeholder for user-specific posts

  return (
    <div className="container mx-auto px-4 py-12">
      <div className="flex justify-between items-center mb-8">
        <div>
          <h1 className="text-3xl font-bold">Your Posts</h1>
          <p className="text-muted-foreground">Manage your articles and drafts.</p>
        </div>
        <Button asChild>
          <Link href="/editor/new">
            <PlusCircle className="mr-2 h-4 w-4" />
            New Post
          </Link>
        </Button>
      </div>

      <div className="grid gap-6">
        {userPosts.length > 0 ? (
          userPosts.map((post) => (
            <Card key={post.id} className="bg-card/50">
              <CardHeader>
                <CardTitle>{post.title}</CardTitle>
                <CardDescription>
                  Published on {new Date(post.date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
                </CardDescription>
              </CardHeader>
              <CardContent>
                <p className="text-sm text-muted-foreground line-clamp-2">{post.excerpt}</p>
              </CardContent>
              <CardFooter className="flex justify-end gap-2">
                <Button variant="outline" size="sm" asChild>
                  <Link href={`/editor/${post.id}`}>
                    <Edit className="mr-2 h-4 w-4" />
                    Edit
                  </Link>
                </Button>
                <Button variant="destructive" size="sm">
                  <Trash2 className="mr-2 h-4 w-4" />
                  Delete
                </Button>
              </CardFooter>
            </Card>
          ))
        ) : (
          <div className="text-center py-12 border-2 border-dashed rounded-lg">
            <h2 className="text-xl font-semibold">No posts yet!</h2>
            <p className="text-muted-foreground mt-2">Start creating your first article.</p>
            <Button asChild className="mt-4">
              <Link href="/editor/new">Create a Post</Link>
            </Button>
          </div>
        )}
      </div>
    </div>
  );
}


// ==== FILE: app\dashboard\settings\page.tsx ====
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";

export default function DashboardSettingsPage() {
  return (
    <div className="container mx-auto px-4 py-12 max-w-2xl">
      <h1 className="text-3xl font-bold mb-2">Account Settings</h1>
      <p className="text-muted-foreground mb-8">Update your profile, email, and password.</p>
      
      <div className="space-y-8">
        <section className="border rounded-lg p-6 bg-card/80">
          <h2 className="text-xl font-semibold mb-4">Profile Information</h2>
          <form className="space-y-4">
            <div>
              <Label htmlFor="displayName">Display Name</Label>
              <Input id="displayName" placeholder="Your display name" />
            </div>
            <div>
              <Label htmlFor="email">Email Address</Label>
              <Input id="email" type="email" placeholder="your.email@example.com" />
            </div>
            <Button>Update Profile</Button>
          </form>
        </section>

        <section className="border rounded-lg p-6 bg-card/80">
          <h2 className="text-xl font-semibold mb-4">Change Password</h2>
          <form className="space-y-4">
            <div>
              <Label htmlFor="currentPassword">Current Password</Label>
              <Input id="currentPassword" type="password" />
            </div>
            <div>
              <Label htmlFor="newPassword">New Password</Label>
              <Input id="newPassword" type="password" />
            </div>
            <div>
              <Label htmlFor="confirmPassword">Confirm New Password</Label>
              <Input id="confirmPassword" type="password" />
            </div>
            <Button>Change Password</Button>
          </form>
        </section>
      </div>
    </div>
  )
}


// ==== FILE: app\editor\layout.tsx ====
export { default } from '../../src/app/editor/layout'
export * from '../../src/app/editor/layout'


// ==== FILE: app\editor\page.tsx ====
export { default } from '../../src/app/editor/page'
export * from '../../src/app/editor/page'


// ==== FILE: app\editor\new\page.tsx ====
export { default } from '../../../src/app/editor/new/page'
export * from '../../../src/app/editor/new/page'

    

// ==== FILE: app\editor\[id]\page.tsx ====
export { default } from '../../../src/app/editor/[id]/page'
export * from '../../../src/app/editor/[id]/page'

    

// ==== FILE: app\forgot-password\page.tsx ====

import Link from "next/link";

import { Button } from "@/components/ui/button";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";

export default function ForgotPasswordPage() {
  return (
    <div className="min-h-screen bg-background flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
      <Card className="w-full max-w-md">
        <CardHeader className="text-center">
          <CardTitle className="text-2xl font-bold">Reset Your Password</CardTitle>
          <CardDescription>Enter your email and we‚Äôll send reset instructions.</CardDescription>
        </CardHeader>
        <CardContent>
          <form className="space-y-6">
            <div className="space-y-2">
              <Label htmlFor="email">Email</Label>
              <Input id="email" type="email" placeholder="your.email@example.com" required />
            </div>
            <Button type="submit" className="w-full">Send Reset Link</Button>
          </form>
          <div className="mt-4 text-center text-sm">
            <Link href="/login" className="underline text-muted-foreground hover:text-foreground">
              Back to login
            </Link>
          </div>
        </CardContent>
      </Card>
    </div>
  )
}


// ==== FILE: app\login\page.tsx ====

"use client"
import React, { useState, useEffect } from 'react'
import Link from 'next/link'

import { Button } from '@/components/ui/button'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Alert, AlertDescription } from '@/components/ui/alert'

export default function LoginPage() {
  const [isLoading, setIsLoading] = useState(false)
  const [error, setError] = useState('')
  const [checkingAuth, setCheckingAuth] = useState(true)
  const [csrf, setCsrf] = useState('')

  useEffect(() => {
    // Check if user is already logged in
    const checkAuth = async () => {
      try {
        const res = await fetch('/api/auth/me')
        if (res.ok) {
          // User is already logged in, redirect to homepage
          window.location.href = '/'
          return
        }
      } catch (error) {
        // Not logged in, continue to show login form
      } finally {
        setCheckingAuth(false)
      }
    }

    // Ensure CSRF token exists
    const ensureCsrf = async () => {
      try {
        const existing = getCsrfCookie()
        if (existing) {
          setCsrf(existing)
          return
        }
        const res = await fetch('/api/csrf')
        if (res.ok) {
          const j = await res.json()
          setCsrf(j.token)
        }
      } catch {}
    }

    ensureCsrf()
    checkAuth()
  }, [])

  async function onSubmit(e: React.FormEvent) {
    e.preventDefault()
    setIsLoading(true)
    setError('')
    
    const form = e.target as HTMLFormElement
    const data = Object.fromEntries(new FormData(form) as any)
    
    try {
      const res = await fetch('/api/auth/login', { 
        method: 'POST', 
        headers: { 
          'content-type': 'application/json', 
          'x-csrf-token': csrf || getCsrfCookie() 
        }, 
        body: JSON.stringify({ 
          identifier: data.identifier, 
          password: data.password 
        }) 
      })
      
      if (res.status === 401) {
        const json = await res.json()
        setError(json.message || 'Invalid credentials')
        return
      }
      
      if (!res.ok) {
        const json = await res.json()
        throw new Error(json.error || 'Login failed')
      }
      
      // Success - redirect to homepage
      const params = new URLSearchParams(window.location.search)
      const next = params.get('next') || '/'
      window.location.href = next
      
    } catch (err: any) {
      setError(err.message || 'Login error occurred')
    } finally {
      setIsLoading(false)
    }
  }

  function getCsrfCookie() {
    if (typeof document === 'undefined') return ''
    return document.cookie.split('; ').find(c => c.startsWith('csrf='))?.split('=')[1] || ''
  }

  // Show loading while checking if user is already authenticated
  if (checkingAuth) {
    return (
      <div className="min-h-screen bg-background flex items-center justify-center">
        <div className="text-lg">Checking authentication...</div>
      </div>
    )
  }

  return (
    <div className="min-h-screen bg-background flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
      <Card className="w-full max-w-md">
        <CardHeader className="text-center">
          <CardTitle className="text-2xl font-bold">Sign in to your account</CardTitle>
          <CardDescription>Enter your WordPress credentials to continue.</CardDescription>
        </CardHeader>
        <CardContent>
          {error && (
            <Alert variant="destructive" className="mb-4" role="alert" aria-live="assertive">
              <AlertDescription>{error}</AlertDescription>
            </Alert>
          )}
          <form className="space-y-6" onSubmit={onSubmit}>
            <div className="space-y-2">
              <Label htmlFor="identifier">Username or Email</Label>
              <Input id="identifier" name="identifier" type="text" placeholder="you@example.com or username" autoComplete="username" required />
            </div>
            <div className="space-y-2">
              <Label htmlFor="password">Password</Label>
              <Input id="password" name="password" type="password" autoComplete="current-password" required />
            </div>
            <div className="flex items-center justify-between">
              <div className="text-sm">
                <Link href="/forgot-password" className="underline text-muted-foreground hover:text-foreground">
                  Forgot your password?
                </Link>
              </div>
            </div>
            <Button type="submit" className="w-full" disabled={isLoading} aria-busy={isLoading}>
              {isLoading ? 'Signing in‚Ä¶' : 'Sign in'}
            </Button>
          </form>
           <div className="mt-4 text-center text-sm">
            Don&apos;t have an account?{' '}
            <Link href="/signup" className="underline">
              Sign up
            </Link>
          </div>
        </CardContent>
      </Card>
    </div>
  )
}


// ==== FILE: app\privacy\page.tsx ====
import NoCopy from "@/components/NoCopy";

export default function PrivacyPage() {
  return (
  <NoCopy>
  <div className="container mx-auto px-4 py-12 max-w-3xl">
      <header className="mb-8">
        <h1 className="text-3xl font-bold tracking-tight">Privacy Policy</h1>
        <p className="text-sm text-muted-foreground mt-2">Last updated: {new Date().toLocaleDateString()}</p>
      </header>

      <section className="prose max-w-none prose-headings:text-foreground prose-p:text-foreground prose-li:text-foreground prose-a:text-primary dark:prose-invert bg-card/50 p-6 rounded-lg border">
        <p>
          At <strong>Tech Oblivion</strong> (accessible at
          {" "}
          <a className="underline" href="https://techoblivion.in" target="_blank" rel="noopener noreferrer">https://techoblivion.in</a>), we value your privacy and are committed to protecting the personal information you share with us. This Privacy Policy explains what information we collect, how we use it, and your rights regarding your data.
        </p>

        <h2>Information We Collect</h2>
        <ul>
          <li>
            <strong>Personal Information:</strong> When you log in to our website, we may collect your name, email address, and phone number.
          </li>
          <li>
            <strong>Analytics Data:</strong> We use Google Analytics and similar tools to collect information about how visitors interact with our site, such as pages viewed, time spent, and referral sources.
          </li>
          <li>
            <strong>Future Features:</strong> If we introduce newsletters or other sign-up features in the future, additional information may be collected with your consent.
          </li>
        </ul>

        <h2>Cookies and Tracking</h2>
        <p>
          We currently do not use cookies or any cookie-based tracking on our website.
        </p>

        <h2>Use of Information</h2>
        <ul>
          <li>Provide you with access to our site features and login services.</li>
          <li>Improve the content, performance, and security of our website.</li>
          <li>Analyze traffic and user behavior through analytics tools.</li>
          <li>Display embedded third-party content (e.g., YouTube videos) and provide relevant ads or affiliate links.</li>
        </ul>

        <h2>Third-Party Services</h2>
        <p>Our website may include third-party integrations such as:</p>
        <ul>
          <li>Google Analytics (for site traffic analysis)</li>
          <li>YouTube embeds (for video content)</li>
          <li>Advertising and affiliate links (for monetization and recommendations)</li>
        </ul>
        <p>
          These services may collect and use data according to their own privacy policies. We encourage you to review their policies when interacting with their content.
        </p>

        <h2>Children‚Äôs Privacy</h2>
        <p>
          Our website is not directed at children under the age of 13. We do not knowingly collect personal information from children under 13. If you believe a child has provided us with personal information, please contact us and we will take steps to remove such information.
        </p>

        <h2>Data Security</h2>
        <p>
          We take reasonable measures to protect your personal data from unauthorized access, misuse, or disclosure. However, please note that no system is completely secure, and we cannot guarantee absolute security of your data.
        </p>

        <h2>Your Rights</h2>
        <ul>
          <li>Request access to the information we hold about you.</li>
          <li>Request correction or deletion of your data.</li>
          <li>Opt out of future communications (if any newsletters or similar services are introduced).</li>
        </ul>

        <h2>Contact Us</h2>
        <p>
          If you have any questions about this Privacy Policy or how we handle your data, please contact us at:
        </p>
        <p>
          <span role="img" aria-label="email">üìß</span> <a className="underline" href="mailto:info@techoblivion.in">info@techoblivion.in</a>
        </p>

        <p className="mt-8 text-sm text-muted-foreground">
          By using our website, you consent to this Privacy Policy.
        </p>
      </section>
    </div>
  </NoCopy>
  )
}


// ==== FILE: app\profile\page.tsx ====

import { Twitter, Linkedin, Github } from "lucide-react";

import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { Button } from "@/components/ui/button";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";

export default function ProfilePage() {
  // Placeholder data
  const user = {
    name: "Jane Doe",
    username: "janedoe",
    avatar: "https://i.pravatar.cc/150?u=a042581f4e29026704d",
    bio: "Senior software engineer specializing in frontend technologies and AI integration. Passionate about building beautiful, performant user interfaces.",
    followers: 120,
    following: 75,
  };

  return (
    <div className="container mx-auto px-4 py-12 max-w-4xl">
      <div className="flex flex-col md:flex-row items-center md:items-start gap-8 mb-8 bg-card/50 p-8 rounded-lg">
        <Avatar className="h-32 w-32">
          <AvatarImage src={user.avatar} alt={user.name} />
          <AvatarFallback>{user.name.charAt(0)}</AvatarFallback>
        </Avatar>
        <div className="text-center md:text-left flex-grow">
          <h1 className="text-3xl font-bold">{user.name}</h1>
          <p className="text-muted-foreground">@{user.username}</p>
          <p className="mt-4 text-muted-foreground max-w-lg">{user.bio}</p>
          {/* Followers/following removed */}
          <div className="flex items-center gap-6 mt-4 justify-center md:justify-start">
            <Button>Follow</Button>
             <div className="flex gap-4">
                <a href="#" className="text-muted-foreground hover:text-foreground"><Twitter /></a>
                <a href="#" className="text-muted-foreground hover:text-foreground"><Linkedin /></a>
                <a href="#" className="text-muted-foreground hover:text-foreground"><Github /></a>
            </div>
          </div>
        </div>
      </div>

      <Tabs defaultValue="activity">
        <TabsList>
          <TabsTrigger value="activity">Recent Activity</TabsTrigger>
        </TabsList>
        <TabsContent value="activity" className="mt-4">
          <div className="border-2 border-dashed rounded-lg p-8 text-center">
            <p className="text-muted-foreground">User's recent activities (e.g., posts, comments) will be displayed here.</p>
          </div>
        </TabsContent>
  {/* Followers/Following tabs removed */}
      </Tabs>
    </div>
  )
}

    

// ==== FILE: app\profile\[username]\page.tsx ====
import { Twitter, Linkedin, Github, Edit3 } from "lucide-react";
import { notFound } from "next/navigation";
import Link from "next/link";

import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { Button } from "@/components/ui/button";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { decodeEntities } from "@/lib/text";
import { getSessionUser } from "@/lib/auth";
import { getUserBySlug } from "@/lib/wp-public";

export default async function PublicProfilePage(props: { params: Promise<{ username: string }> }) {
  const { username } = await props.params
  const viewingUser = await getSessionUser().catch(() => null)
  const user = await getUserBySlug(username)
  if (!user) notFound()
  const isSelf = !!(viewingUser && String((viewingUser as any).wpUserId ?? (viewingUser as any).id) === String(user.id))

  // Map WP user fields to UI
  const nameRaw = user.name || username
  const name = decodeEntities(String(nameRaw))
  const avatar = user.avatar_urls?.['96'] || user.avatar_urls?.['48'] || user.avatar_urls?.['24'] || `https://i.pravatar.cc/150?u=${username}`
  // Bio comes from WP 'description' field in the FE plugin payload
  const bio = decodeEntities(String(user.description || ""))
  const pf = (user.profile_fields && typeof user.profile_fields === 'object') ? (user.profile_fields as Record<string, unknown>) : null
  function getPFString(key: string): string | undefined {
    if (!pf) return undefined
    const v = pf[key]
    if (typeof v === 'string') return v
    return undefined
  }
  function getPFArray(key: string): string[] | undefined {
    if (!pf) return undefined
    const v = pf[key]
    if (Array.isArray(v)) return v.map(String)
    if (typeof v === 'string') return v.split(',').map(s => s.trim()).filter(Boolean)
    return undefined
  }
  function ensureUrl(u?: string) {
    if (!u) return undefined
    const s = u.trim()
    if (!s) return undefined
    if (/^https?:\/\//i.test(s)) return s
    return `https://${s}`
  }
  const social = {
    twitter: ensureUrl(getPFString('twitter') || getPFString('x') || getPFString('twitter_url')),
    linkedin: ensureUrl(getPFString('linkedin') || getPFString('linkedin_url')),
    github: ensureUrl(getPFString('github') || getPFString('github_url')),
  }
  const rolesList = getPFArray('roles') || getPFArray('role') || getPFArray('roles_display')

  // Determine if we should show authored posts. Hide for plain subscribers/readers
  const userHasRecentPosts = Array.isArray((user as any)?.recent_posts) && (user as any).recent_posts.length > 0
  const showPostsTab = userHasRecentPosts
  const defaultTab = showPostsTab ? 'posts' : 'comments'

  // Server-side fetch of posts and comments authored by this user
  type WPPost = { id: number; slug: string; title?: { rendered?: string }; excerpt?: { rendered?: string }; date?: string }
  type WPComment = { id: number; post: number; content?: { rendered?: string }; date?: string }
  const SITE = process.env.NEXT_PUBLIC_SITE_URL || 'http://localhost:3000'
  const postsJson: WPPost[] = showPostsTab ? await (async () => {
    const postsRes = await fetch(new URL(`/api/wp/posts?author=${encodeURIComponent(String(user.id))}&per_page=9`, SITE).toString(), { cache: 'no-store' })
    return postsRes.ok ? await postsRes.json() : []
  })() : []
  const commentsRes = await fetch(new URL(`/api/wp/comments?author=${encodeURIComponent(String(user.id))}&status=approve&per_page=20&orderby=date&order=desc`, SITE).toString(), { cache: 'no-store' })
  const commentsJson: WPComment[] = commentsRes.ok ? await commentsRes.json() : []

  const stripTags = (html?: string) => decodeEntities(String(html || '').replace(/<[^>]*>/g, '').replace(/\s+/g, ' ').trim())

  const posts = postsJson.map(p => ({
    id: p.id,
    slug: p.slug,
    title: decodeEntities(String(p.title?.rendered || 'Untitled')),
    excerpt: stripTags(p.excerpt?.rendered),
    date: p.date,
  }))

  // Resolve comment post titles/slugs in one fetch
  const postIds = Array.from(new Set(commentsJson.map(c => c.post).filter(Boolean)))
  const postMap = new Map<number, { slug: string; title: string }>()
  if (postIds.length) {
    const include = postIds.join(',')
    const incRes = await fetch(new URL(`/api/wp/posts?include=${include}&per_page=${Math.min(100, postIds.length)}`, SITE).toString(), { cache: 'no-store' })
    if (incRes.ok) {
      const arr: WPPost[] = await incRes.json()
      for (const p of arr) {
        postMap.set(p.id, { slug: p.slug, title: decodeEntities(String(p.title?.rendered || 'Untitled')) })
      }
    }
  }
  const comments = commentsJson.map(c => ({
    id: c.id,
    postSlug: postMap.get(c.post)?.slug || String(c.post),
    postTitle: postMap.get(c.post)?.title || 'View post',
    content: stripTags(c.content?.rendered),
    date: c.date,
  }))

  return (
    <div className="container mx-auto px-4 py-10 max-w-6xl">
      {/* Profile header */}
      <Card className="mb-8">
        <CardContent className="p-8">
          <div className="flex flex-col items-center text-center gap-6 md:flex-row md:text-left">
            <Avatar className="h-28 w-28">
              <AvatarImage src={avatar} alt={name} />
              <AvatarFallback>{name.charAt(0)}</AvatarFallback>
            </Avatar>
            <div className="flex-1">
              <h1 className="text-3xl font-bold">{name}</h1>
              {rolesList && rolesList.length > 0 && (
                <p className="text-sm text-muted-foreground mt-1">{rolesList.join(', ')}</p>
              )}
              <p className="text-muted-foreground">@{username}</p>
              <p className="mt-3 text-muted-foreground max-w-2xl">{bio || '‚Äî'}</p>
              <div className="mt-4 flex items-center gap-6 flex-wrap">
                {isSelf && (
                  <Button asChild>
                    <Link href="/account"><Edit3 className="mr-2 h-4 w-4" /> Edit profile</Link>
                  </Button>
                )}
                <div className="flex gap-4">
                  {social.twitter && <a href={social.twitter} target="_blank" rel="noopener noreferrer" className="text-muted-foreground hover:text-foreground" aria-label="Twitter"><Twitter /></a>}
                  {social.linkedin && <a href={social.linkedin} target="_blank" rel="noopener noreferrer" className="text-muted-foreground hover:text-foreground" aria-label="LinkedIn"><Linkedin /></a>}
                  {social.github && <a href={social.github} target="_blank" rel="noopener noreferrer" className="text-muted-foreground hover:text-foreground" aria-label="GitHub"><Github /></a>}
                </div>
              </div>
            </div>
          </div>
        </CardContent>
      </Card>

      {/* Tabs */}
      <Tabs defaultValue={defaultTab}>
        <TabsList>
          {showPostsTab && <TabsTrigger value="posts">Posts</TabsTrigger>}
          <TabsTrigger value="comments">Comments</TabsTrigger>
        </TabsList>

        {/* Posts Tab */}
  {showPostsTab && (
  <TabsContent value="posts" className="mt-6">
          {posts.length === 0 ? (
            <div className="rounded-lg border border-dashed p-8 text-center text-muted-foreground">No posts yet.</div>
          ) : (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              {posts.map(p => (
                <Card key={p.id} className="transition hover:shadow-md">
                  <CardHeader>
                    <CardTitle className="line-clamp-2 text-lg">{p.title}</CardTitle>
                    {p.date && <CardDescription>{new Date(p.date).toLocaleDateString()}</CardDescription>}
                  </CardHeader>
                  <CardContent>
                    {p.excerpt ? (
                      <p className="line-clamp-3 text-sm text-muted-foreground">{p.excerpt}</p>
                    ) : (
                      <p className="text-sm text-muted-foreground">No summary available.</p>
                    )}
                    <div className="mt-4">
                      <Link className="text-primary hover:underline" href={`/blog/${p.slug}`}>Read more ‚Üí</Link>
                    </div>
                  </CardContent>
                </Card>
              ))}
            </div>
          )}
  </TabsContent>
  )}

        {/* Comments Tab */}
        <TabsContent value="comments" className="mt-6">
          <Card>
            <CardContent className="p-0">
              <div className="max-h-96 overflow-y-auto divide-y">
                {comments.length === 0 ? (
                  <div className="p-8 text-center text-muted-foreground">No comments yet.</div>
                ) : comments.map(c => (
                  <div key={c.id} className="p-6">
                    <p className="text-sm">{c.content}</p>
                    <div className="mt-2 text-sm text-muted-foreground">
                      On <Link href={`/blog/${c.postSlug}`} className="underline">{c.postTitle}</Link>
                      {c.date ? <> ‚Ä¢ {new Date(c.date).toLocaleDateString()}</> : null}
                    </div>
                  </div>
                ))}
              </div>
            </CardContent>
          </Card>
        </TabsContent>

        {/* About Tab */}
        <TabsContent value="about" className="mt-6">
          <Card>
            <CardContent className="p-6">
              {(() => {
                const entries = Object.entries(user.profile_fields ?? {}).filter(([_, v]) => {
                  if (v === null || v === undefined) return false
                  if (typeof v === 'string') return v.trim().length > 0
                  if (Array.isArray(v)) return v.length > 0
                  if (typeof v === 'object') return Object.keys(v as any).length > 0
                  return true
                })
                return (
                  <div className="space-y-6">
                    {bio && (
                      <div>
                        <h3 className="font-semibold mb-1">Bio</h3>
                        <p className="text-muted-foreground">{bio}</p>
                      </div>
                    )}
                    {entries.length > 0 ? (
                      <div>
                        <h3 className="font-semibold mb-2">Profile</h3>
                        <dl className="grid grid-cols-1 gap-2">
                          {entries.map(([k, v]) => (
                            <div key={k} className="flex gap-2 text-sm">
                              <dt className="min-w-24 text-muted-foreground capitalize">{k}</dt>
                              <dd className="flex-1 break-words">
                                {typeof v === 'string' || typeof v === 'number' || typeof v === 'boolean'
                                  ? String(v)
                                  : Array.isArray(v)
                                  ? v.join(', ')
                                  : v === null
                                  ? '‚Äî'
                                  : JSON.stringify(v)}
                              </dd>
                            </div>
                          ))}
                        </dl>
                      </div>
                    ) : (
                      !bio ? <div className="text-muted-foreground">This user hasn‚Äôt filled out their profile yet.</div> : null
                    )}
                  </div>
                )
              })()}
            </CardContent>
          </Card>
        </TabsContent>
      </Tabs>
    </div>
  )
}

// ==== FILE: app\register\page.tsx ====

"use client"
import React, { useState } from 'react'
import Link from 'next/link';

import { Button } from '@/components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';

export default function RegisterPage() {
  const [status, setStatus] = useState<'idle'|'pending'|'error'|'success'>('idle')
  const [error, setError] = useState('');

  async function onSubmit(e: React.FormEvent) {
    e.preventDefault()
    setStatus('pending')
    setError('')
    const form = e.target as HTMLFormElement
    const data = Object.fromEntries(new FormData(form) as any)
    try {
      const res = await fetch('/api/auth/register', { method: 'POST', headers: { 'content-type': 'application/json', 'x-csrf-token': getCsrfCookie() }, body: JSON.stringify({ email: data.email, password: data.password, username: data.username }) })
      const json = await res.json()
      if (res.status === 201 && json.status === 'pending_verification') {
        setStatus('success')
        return
      }
      setError(json.message || 'An unknown error occurred.');
      setStatus('error')
    } catch (err: any) {
      setError('Failed to connect to the server.');
      setStatus('error')
    }
  }

  function getCsrfCookie() {
    if (typeof document === 'undefined') return ''
    return document.cookie.split('; ').find(c => c.startsWith('csrf='))?.split('=')[1] || ''
  }

  return (
    <div className="min-h-screen bg-background flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
       <Card className="w-full max-w-md">
        <CardHeader className="text-center">
          <CardTitle className="text-2xl font-bold">Create an account</CardTitle>
          <CardDescription>Sign up to start writing and engaging.</CardDescription>
        </CardHeader>
        <CardContent>
          {status === 'success' ? (
             <Alert variant="default">
              <AlertTitle>Registration Successful!</AlertTitle>
              <AlertDescription>
                Please check your inbox to verify your account.
              </AlertDescription>
            </Alert>
          ) : (
            <>
              {status === 'error' && (
                <Alert variant="destructive" className="mb-4">
                  <AlertDescription>{error}</AlertDescription>
                </Alert>
              )}
              <form className="space-y-6" onSubmit={onSubmit}>
                <div className="space-y-2">
                  <Label htmlFor="email">Email</Label>
                  <Input id="email" name="email" type="email" placeholder="your.email@example.com" required />
                </div>
                <div className="space-y-2">
                  <Label htmlFor="username">Username (Optional)</Label>
                  <Input id="username" name="username" type="text" placeholder="your_username" />
                </div>
                <div className="space-y-2">
                  <Label htmlFor="password">Password</Label>
                  <Input id="password" name="password" type="password" required />
                </div>
                <Button type="submit" className="w-full" disabled={status === 'pending'}>
                  {status === 'pending' ? 'Creating account...' : 'Create Account'}
                </Button>
              </form>
            </>
          )}
          <div className="mt-4 text-center text-sm">
            Already have an account?{' '}
            <Link href="/login" className="underline">
              Sign in
            </Link>
          </div>
        </CardContent>
      </Card>
    </div>
  )
}


// ==== FILE: app\robots.txt\route.ts ====
import { NextResponse } from 'next/server'

import { getSettings } from '@/lib/settings'

export const dynamic = 'force-dynamic'

export async function GET() {
  const settings = await getSettings()
  if (settings.robotsCustom && settings.robotsCustom.trim()) {
    return new NextResponse(settings.robotsCustom, { headers: { 'Content-Type': 'text/plain' } })
  }
  const SITE = settings.siteUrl || process.env.NEXT_PUBLIC_SITE_URL || 'http://example.com'
  const body = `User-agent: *\nAllow: /\nSitemap: ${SITE.replace(/\/$/, '')}/sitemap.xml\n`
  return new NextResponse(body, { headers: { 'Content-Type': 'text/plain' } })
}


// ==== FILE: app\search\page.tsx ====
import Link from 'next/link'
import { dehydrate, HydrationBoundary, QueryClient, useQuery } from '@tanstack/react-query'
import { Suspense } from 'react'
import { cookies } from 'next/headers'
import { notFound } from 'next/navigation'

type SearchItem = {
  id: number
  slug: string
  title: { rendered: string }
  excerpt: { rendered: string }
}
async function fetchSearch(q: string, cookieHeader: string) {
  const base = (process.env.NEXT_PUBLIC_SITE_URL || '')
  const r = await fetch(`${base}/api/wp/search?q=${encodeURIComponent(q)}`, {
    headers: { Accept: 'application/json', ...(cookieHeader ? { cookie: cookieHeader } : {}) },
    cache: 'no-store',
  })
  if (!r.ok) throw new Error('Failed')
  return (await r.json()) as SearchItem[]
}

function Client({ q }: { q: string }) {
  const query = useQuery({
    queryKey: ['search', q],
    queryFn: async () => fetchSearch(q, ''),
    enabled: !!q,
  })
  const results = query.data || []
  return (
    <div className="container mx-auto px-4 py-8">
      <h1 className="text-2xl font-bold mb-4">Search Results</h1>
      {q ? <p>You searched for: <span className="font-medium">{q}</span></p> : <p>Please enter a search query.</p>}
      <div className="mt-8">
        {query.isLoading && <p>Loading‚Ä¶</p>}
        {query.isError && <p className="text-red-500">Failed to load search results</p>}
        {!query.isLoading && !query.isError && results.length > 0 ? (
          <ul>
            {results.map((result) => (
              <li key={result.id} className="border-b pb-4 mb-4">
                <h2 className="text-xl font-semibold mb-2">
                  <Link href={`/blog/${result.slug}`}>{result.title?.rendered || 'Untitled'}</Link>
                </h2>
                {result.excerpt?.rendered && (
                  <div dangerouslySetInnerHTML={{ __html: result.excerpt.rendered }} />
                )}
              </li>
            ))}
          </ul>
        ) : (!query.isLoading && q) && <p>No results found for "{q}".</p>}
      </div>
    </div>
  )
}

export default async function SearchResultsPage({ searchParams }: { searchParams?: { q?: string } }) {
  const q = (searchParams?.q || '').trim()
  const cookieHeader = cookies().toString()
  const qc = new QueryClient()
  if (q) {
    await qc.prefetchQuery({ queryKey: ['search', q], queryFn: () => fetchSearch(q, cookieHeader) })
  }
  return (
    <HydrationBoundary state={dehydrate(qc)}>
      <Suspense fallback={<div className="container mx-auto px-4 py-8">Loading‚Ä¶</div>}>
        <Client q={q} />
      </Suspense>
    </HydrationBoundary>
  )
}

// ==== FILE: app\signup\page.tsx ====

import Link from "next/link";

import { Button } from "@/components/ui/button";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";

export default function SignupPage() {
  return (
    <div className="min-h-screen bg-background flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
      <Card className="w-full max-w-md">
        <CardHeader className="text-center">
          <CardTitle className="text-2xl font-bold">Create an account</CardTitle>
          <CardDescription>Sign up to start writing and engaging.</CardDescription>
        </CardHeader>
        <CardContent>
          <form className="space-y-6">
            <div className="space-y-2">
              <Label htmlFor="email">Email</Label>
              <Input id="email" type="email" placeholder="your.email@example.com" required />
            </div>
             <div className="space-y-2">
              <Label htmlFor="username">Username</Label>
              <Input id="username" type="text" placeholder="your_username" required />
            </div>
            <div className="space-y-2">
              <Label htmlFor="password">Password</Label>
              <Input id="password" type="password" required />
            </div>
            <Button type="submit" className="w-full">Create Account</Button>
          </form>
          <div className="mt-4 text-center text-sm">
            Already have an account?{' '}
            <Link href="/login" className="underline">
              Sign in
            </Link>
          </div>
        </CardContent>
      </Card>
    </div>
  )
}


// ==== FILE: app\sitemap.xml\route.ts ====
import { NextRequest, NextResponse } from 'next/server'

import { getSettings } from '@/lib/settings'

export const dynamic = 'force-dynamic'

export async function GET(req: NextRequest) {
  const WP = process.env.WP_URL ?? 'http://example.com'
  const settings = await getSettings()
  const SITE = settings.siteUrl || process.env.NEXT_PUBLIC_SITE_URL || 'http://example.com'
  if (!WP) return new NextResponse('WP_URL missing', { status: 500 })

  const url = new URL('/wp-json/wp/v2/posts', WP)
  url.searchParams.set('per_page', '100')
  url.searchParams.set('_fields', 'slug,modified')

  const res = await fetch(url.toString(), { headers: { Accept: 'application/json' }, next: { revalidate: 3600, tags: ['sitemap'] } })
  if (!res.ok) return new NextResponse('Upstream error', { status: 502 })
  const posts = (await res.json()) as Array<{ slug: string; modified?: string }>

  const items = posts
    .map(p => `<url><loc>${SITE.replace(/\/$/, '')}/blog/${p.slug}</loc>${p.modified ? `<lastmod>${new Date(p.modified).toISOString()}</lastmod>` : ''}</url>`)  
    .join('')
  const xml = `<?xml version="1.0" encoding="UTF-8"?>\n<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">${items}</urlset>`
  return new NextResponse(xml, { headers: { 'Content-Type': 'application/xml' } })
}


// ==== FILE: app\tags\[slug]\page.tsx ====
import React, { Suspense } from 'react'
import { Search } from 'lucide-react'

import Feed from '@/components/feed'
import FeedSkeleton from '@/components/feed-skeleton'
import { Input } from '@/components/ui/input'
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'
import { Button } from '@/components/ui/button'

export default async function TagPage({ params }: { params: { slug: string } }) {
  const { slug } = params
  
  return (
    <div className="container mx-auto px-4 py-12">
      <div className="text-center mb-12">
        <h1 className="text-4xl font-bold tracking-tight">Tag: <span className="capitalize">{slug.replace(/-/g, ' ')}</span></h1>
        <p className="text-muted-foreground mt-2 max-w-2xl mx-auto">
          Browsing all articles tagged with "{slug}".
        </p>
      </div>

      <div className="mb-8 p-4 border rounded-lg bg-card/50">
        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 items-center">
          <div className="md:col-span-2">
            <div className="relative">
              <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-muted-foreground" />
              <Input placeholder="Search within this tag..." className="pl-10" />
            </div>
          </div>
          <Select>
            <SelectTrigger>
              <SelectValue placeholder="Sort by" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="latest">Latest</SelectItem>
              <SelectItem value="oldest">Oldest</SelectItem>
              <SelectItem value="popular">Popular</SelectItem>
            </SelectContent>
          </Select>
          <Button className="w-full">Apply Filters</Button>
        </div>
      </div>
      
      <Suspense fallback={<FeedSkeleton layout="grid" count={6} />}>
        <Feed layout="grid" postCount={6} />
      </Suspense>
      
    </div>
  )
}


// ==== FILE: app\terms\page.tsx ====
import NoCopy from "@/components/NoCopy";

export default function TermsPage() {
  return (
  <NoCopy>
  <div className="container mx-auto px-4 py-12 max-w-3xl">
      <header className="mb-8">
        <h1 className="text-3xl font-bold tracking-tight">Terms of Service (ToS)</h1>
        <p className="text-sm text-muted-foreground mt-2">Last updated: 8/30/2025</p>
      </header>

      <section className="prose max-w-none prose-headings:text-foreground prose-p:text-foreground prose-li:text-foreground prose-a:text-primary dark:prose-invert bg-card/50 p-6 rounded-lg border">
        <p>
          Welcome to <strong>Tech Oblivion</strong> (accessible at <a className="underline" href="https://techoblivion.in" target="_blank" rel="noopener noreferrer">https://techoblivion.in</a>). By accessing or using our website, you agree to these Terms of Service. Please read them carefully, because by visiting or using our services, you are entering into a binding agreement with us.
        </p>

        <h2>1. Use of the Website</h2>
        <ul>
          <li>You may use our website and services only for lawful purposes and in accordance with these Terms.</li>
          <li>You agree not to engage in any activity that could harm, disable, overburden, or impair our site.</li>
          <li>You may not attempt to gain unauthorized access to our systems or interfere with the security features of the website.</li>
        </ul>

        <h2>2. Accounts and Login</h2>
        <ul>
          <li>Some parts of the site may require login or account creation. You agree to provide accurate and up-to-date information.</li>
          <li>You are responsible for maintaining the confidentiality of your login credentials and for all activities that occur under your account.</li>
          <li>We reserve the right to suspend or terminate accounts that violate these Terms or our Privacy Policy.</li>
        </ul>

        <h2>3. Intellectual Property</h2>
        <ul>
          <li>All content on this site‚Äîincluding text, graphics, logos, and other materials‚Äîis owned by or licensed to Tech Oblivion, unless stated otherwise.</li>
          <li>You may not copy, distribute, or use our content for commercial purposes without prior written consent.</li>
          <li>Third-party content (such as YouTube embeds) remains the property of their respective owners.</li>
        </ul>

        <h2>4. Third-Party Links and Content</h2>
        <ul>
          <li>Our site may include links, ads, or embedded content from third parties (e.g., YouTube, affiliate partners).</li>
          <li>We are not responsible for the content, privacy policies, or practices of third-party services. Your interactions with them are at your own risk.</li>
        </ul>

        <h2>5. Disclaimers</h2>
        <ul>
          <li>Our website is provided ‚Äúas is‚Äù and ‚Äúas available‚Äù without warranties of any kind, whether express or implied.</li>
          <li>We do not guarantee that the website will always be available, secure, or error-free.</li>
          <li>Any use of information from this site is at your own discretion and risk.</li>
        </ul>

        <h2>6. Limitation of Liability</h2>
        <ul>
          <li>To the maximum extent permitted by law, Tech Oblivion shall not be held liable for any indirect, incidental, or consequential damages resulting from your use of the website.</li>
          <li>This includes but is not limited to loss of data, loss of profits, or business interruptions.</li>
        </ul>

        <h2>7. Termination</h2>
        <ul>
          <li>We may suspend or terminate access to the site if you violate these Terms or engage in activities that may harm the website or its users.</li>
          <li>Termination does not affect provisions such as Intellectual Property, Disclaimers, and Limitation of Liability, which survive termination.</li>
        </ul>

        <h2>8. Changes to the Terms</h2>
        <ul>
          <li>We may update these Terms of Service from time to time. Any changes will be posted on this page with a new ‚ÄúLast Updated‚Äù date.</li>
          <li>Continued use of the website after changes means you accept the updated Terms.</li>
        </ul>

        <h2>9. Governing Law</h2>
        <p>These Terms are governed by and construed under the laws of India, without regard to its conflict of law principles.</p>

        <h2>10. Contact Us</h2>
        <p>
          For questions about these Terms, reach out at: <span role="img" aria-label="email">üìß</span>{' '}
          <a className="underline" href="mailto:info@techoblivion.in">info@techoblivion.in</a>
        </p>
      </section>
    </div>
  </NoCopy>
  )
}


// ==== FILE: app\user\[slug]\page.tsx ====
import Image from 'next/image'
import { notFound } from 'next/navigation'
import type { Metadata } from 'next'

import ProfilePage from '@/components/profile/ProfilePage'

export const runtime = 'nodejs'
export const dynamic = 'force-dynamic'

// Types for the public user API
export interface PublicUserProfile {
  id: number
  name: string
  slug: string
  description?: string
  avatar_urls?: Record<string, string>
  profile_fields?: Record<string, string | number | boolean | null>
  recent_posts: Array<{
    id: number
    title: string
    slug: string
    date: string
    link: string
    content_raw: string
    content_rendered: string
  }>
  recent_comments: Array<{
    id: number
    post: number
    date: string
    link: string
    content_raw: string
    content_rendered: string
  }>
}

async function fetchPublicUser(slug: string): Promise<PublicUserProfile | null> {
  const baseUrl = process.env.NEXT_PUBLIC_SITE_URL || ''
  // Use internal Next API which proxies to MU endpoint
  const url = `${baseUrl}/api/wp/users/${encodeURIComponent(slug)}`
  try {
    const res = await fetch(url, { cache: 'no-store' })
    if (!res.ok) return null
    const data = (await res.json()) as PublicUserProfile | null
    return data
  } catch {
    return null
  }
}

export async function generateMetadata({ params }: { params: Promise<{ slug: string }> }): Promise<Metadata> {
  const { slug } = await params
  const user = await fetchPublicUser(slug)
  if (!user) return { title: 'Profile', description: 'User profile' }
  const avatar = user.avatar_urls ? (user.avatar_urls['512'] || user.avatar_urls['256'] || user.avatar_urls['96'] || Object.values(user.avatar_urls)[0]) : undefined
  const title = `Profile of ${user.name}`
  const description = user.description || `View ${user.name}'s profile, posts, and comments.`
  return {
    title,
    description,
    openGraph: {
      title,
      description,
      images: avatar ? [{ url: avatar }] : undefined,
      type: 'profile'
    },
    twitter: {
      card: 'summary',
      title,
      description,
      images: avatar ? [avatar] : undefined
    }
  }
}

export default async function UserProfilePage({ params }: { params: Promise<{ slug: string }> }) {
  const { slug } = await params
  const user = await fetchPublicUser(slug)
  if (!user) return notFound()
  return <ProfilePage user={user} />
}


// ==== FILE: app\wp\users\[slug]\page.tsx ====
import { notFound } from "next/navigation";
import { headers } from "next/headers";
import Link from "next/link";

import { getSessionUser } from "@/lib/auth";
import { Button } from "@/components/ui/button";

export const dynamic = "force-dynamic";

export default async function UserProfilePage({ params }: { params: { slug: string } }) {
  const hdrs = await headers();
  const host = hdrs.get("x-forwarded-host") || hdrs.get("host") || "";
  const proto = hdrs.get("x-forwarded-proto") || "http";
  const origin = (process.env.NEXT_PUBLIC_SITE_URL || `${proto}://${host}`).replace(/\/$/, "");
  const cookie = hdrs.get('cookie') || ''

  const res = await fetch(`${origin}/api/wp/users/${encodeURIComponent(params.slug)}`, {
    cache: "no-store",
  headers: Object.assign({ Accept: 'application/json' } as HeadersInit, cookie ? { cookie } : {}),
  });
  if (!res.ok) return notFound();
  const user = await res.json();

  const me = await getSessionUser().catch(() => null);
  const isSelf = !!(me && String(me.wpUserId ?? me.id) === String(user.id));

  return (
    <div className="max-w-2xl mx-auto p-6">
      <div className="flex items-center gap-4">
        {user.avatar_urls?.["96"] && (
          // eslint-disable-next-line @next/next/no-img-element
          <img
            src={user.avatar_urls["96"]}
            alt={user.name}
            className="w-20 h-20 rounded-full"
          />
        )}
        <div className="flex-1">
          <div className="flex items-center gap-3">
            <h1 className="text-2xl font-bold">{user.name}</h1>
            {isSelf ? (
              <Button size="sm" asChild>
                <Link href="/account">Edit profile</Link>
              </Button>
            ) : null}
          </div>
          <p className="text-muted-foreground">@{user.slug}</p>
        </div>
      </div>
      {user.description && (
        <p className="mt-4 text-sm text-foreground/90">{user.description}</p>
      )}
    </div>
  );
}


// ==== FILE: src\ai\dev.ts ====
// Flows will be imported for their side effects in this file.


// ==== FILE: src\ai\genkit.ts ====
import {genkit} from 'genkit';
import {googleAI} from '@genkit-ai/googleai';

export const ai = genkit({
  plugins: [googleAI()],
  model: 'googleai/gemini-2.5-flash',
});


// ==== FILE: src\app\error.tsx ====
export { default } from './(root-error)/error'


// ==== FILE: src\app\layout.tsx ====
import type { Metadata } from 'next';
import { Inter } from 'next/font/google';

import './globals.css';
import { ThemeProvider } from '@/components/theme-provider';
import { Header } from '@/components/header';
import { Toaster } from '@/components/ui/toaster';
import { getSettings } from '@/lib/settings'
import Footer from '@/components/Footer';
import { ReactQueryProvider } from '@/components/providers/react-query'

const inter = Inter({ subsets: ['latin'], variable: '--font-inter' });

// Note: We use generateMetadata for dynamic site settings; avoid exporting both metadata and generateMetadata.

export default async function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  const settings = await getSettings()
  return (
    <html lang="en" suppressHydrationWarning>
      <body className={`${inter.variable} font-body antialiased`}>
        <ThemeProvider attribute="class" defaultTheme="system" enableSystem>
          <div className="flex min-h-screen flex-col">
            {/* Skip link for keyboard users */}
            <a href="#main-content" className="skip-link">Skip to content</a>
            <Header />
            <ReactQueryProvider>
              <main id="main-content" className="flex-grow">{children}</main>
            </ReactQueryProvider>
            <Footer />
          </div>
          <Toaster />
        </ThemeProvider>
      </body>
    </html>
  );
}

export async function generateMetadata(): Promise<Metadata> {
  // Helpers
  const toAbsoluteBase = (s?: string) => {
    const v = (s || '').trim()
    if (!v) return 'http://localhost:3000'
    if (/^https?:\/\//i.test(v)) return v
    return `https://${v.replace(/^\/+/, '')}`
  }
  const rewriteIfWP = (url?: string) => {
    if (!url) return url
    const WP = process.env.WP_URL || ''
    if (!WP) return url
    try {
      const u = new URL(url)
      if (u.host === new URL(WP).host) {
        return `/api/wp/media${u.pathname}${u.search}`
      }
      return url
    } catch {
      return url
    }
  }

  const envBase = toAbsoluteBase(process.env.NEXT_PUBLIC_SITE_URL || process.env.SITE_URL)
  try {
    const settings = await getSettings()
    const base = toAbsoluteBase(settings.siteUrl || envBase)
    const title = settings.siteTitle || 'Tech Oblivion'
    const description = settings.defaultDescription || 'Technology with purpose'
    const ogImage = rewriteIfWP(settings.defaultOgImage || undefined)
    const twImage = rewriteIfWP(settings.defaultTwitterImage || ogImage || undefined)

    return {
      title,
      description,
      metadataBase: new URL(base),
      openGraph: {
        type: 'website',
        title,
        description,
        url: base,
        images: ogImage ? [ogImage] : undefined,
      },
      twitter: {
        card: 'summary_large_image',
        title,
        description,
        images: twImage ? [twImage] : undefined,
      },
    }
  } catch {
    // Ensure metadataBase is still set to avoid localhost warnings elsewhere.
    return {
      metadataBase: new URL(envBase),
    }
  }
}


// ==== FILE: src\app\page.tsx ====
import Head from "next/head"
import Link from "next/link"
import { PlayCircle, Send, BookOpen, Rss, Edit } from "lucide-react"

import Feed from "@/components/feed"
import { getWebSiteSchema, getVideoSchema, getFAQSchema } from "@/lib/generateSchema"
import { Button } from "@/components/ui/button"
import { Separator } from "@/components/ui/separator"
import HomeLatestVideoSection from "@/components/HomeLatestVideoSection"
import { Marquee } from "@/components/marquee"

export default function Home() {
  const summary = 'Latest updates from our blog.'
  // Example FAQ data; replace with real data if available
  const faqs = [
    { question: "What is Tech.Oblivion?", answer: "A modern tech blog and community for web, AI, and engineering." },
    { question: "How can I contribute?", answer: "Join as an author or participate in the community Discord." }
  ]

  return (
    <>
      <Head>
        <script
          type="application/ld+json"
          dangerouslySetInnerHTML={{ __html: JSON.stringify(getWebSiteSchema()) }}
        />
  {/* VideoObject schema can be injected in the client component if needed */}
        {faqs.length > 0 && (
          <script
            type="application/ld+json"
            dangerouslySetInnerHTML={{ __html: JSON.stringify(getFAQSchema(faqs)) }}
          />
        )}
      </Head>
      <main className="container mx-auto px-4 pt-6 pb-16">
      {/* HERO */}
      <section className="text-center py-10">
        <h1 className="text-4xl md:text-5xl font-bold leading-tight">
          Technology with Purpose
        </h1>
        <p className="text-lg md:text-xl text-muted-foreground mt-2 max-w-2xl mx-auto">
          Modern web, AI, and practical engineering. Insights that matter.
        </p>
        <div className="mt-6 flex justify-center gap-4 flex-wrap">
          <Button size="lg" asChild>
            <Link href="/blog"><BookOpen className="mr-2 h-4 w-4" /> Read Blog</Link>
          </Button>
          <Button size="lg" asChild>
            <a href="https://discord.gg/gMz8jgA9SC" target="_blank"><Send className="mr-2 h-4 w-4" /> Join Discord</a>
          </Button>
        </div>
      </section>

      {/* LATEST */}
      <section className="grid md:grid-cols-2 gap-8 items-stretch mb-14">
  <HomeLatestVideoSection />
        <div className="flex flex-col space-y-4">
          <h2 className="text-2xl font-semibold">Latest Articles</h2>
          <Feed layout="list" postCount={3} />
        </div>
      </section>

      <Separator className="my-12" />

      {/* CONTENT HUBS */}
      <section className="mb-14">
        <h2 className="text-3xl font-bold text-center mb-8">Editor‚Äôs Picks</h2>
        <Feed layout="grid" postCount={3} />
      </section>
      <section className="mb-14">
        <h2 className="text-3xl font-bold text-center mb-8">Trending Now</h2>
        <Feed layout="grid" postCount={3} />
      </section>

      {/* COMMUNITY */}
      <section className="mb-16 text-center">
        <h2 className="text-3xl font-bold mb-4">Join the Community</h2>
        <p className="text-muted-foreground mb-6 max-w-2xl mx-auto">
          Connect with like-minded developers, share projects, and stay updated.
        </p>
        <div className="flex justify-center gap-4 flex-wrap">
          <Button asChild><a href="https://discord.gg/gMz8jgA9SC" target="_blank"><Send className="mr-2 h-4 w-4" /> Discord</a></Button>
          <Button asChild><a href="https://www.youtube.com/@tech.oblivion" target="_blank"><Rss className="mr-2 h-4 w-4" /> YouTube</a></Button>
        </div>
      </section>

      {/* FAQ */}
      <section className="max-w-3xl mx-auto mb-16">
        <h2 className="text-3xl font-bold text-center mb-8">FAQ</h2>
        {/* keep Accordion, add FAQPage schema separately */}
      </section>

      {/* CTA */}
      <section className="bg-card/50 rounded-lg p-10 text-center">
        <h2 className="text-3xl font-bold mb-4">Become an Open Author</h2>
        <p className="max-w-xl mx-auto mb-6 text-muted-foreground">
          Got an idea worth sharing? Join as a writer and inspire the community.
        </p>
        <Button size="lg" asChild>
          <Link href="/contact">Get Started <Edit className="ml-2 h-4 w-4" /></Link>
        </Button>
      </section>
    </main>
    </>
  )
}


// ==== FILE: src\app\(root-error)\error.tsx ====
"use client";
import { useEffect } from 'react';

export default function GlobalError({ error }: { error: Error & { digest?: string } }) {
  useEffect(() => {
    console.error('[GlobalError]', { message: error.message, digest: (error as any).digest });
  }, [error]);

  return (
    <html>
      <body>
        <h2>Something went wrong.</h2>
        <p>Digest: {(error as any).digest || 'n/a'}</p>
      </body>
    </html>
  );
}


// ==== FILE: src\app\account\page.tsx ====
"use client";
import { useEffect, useState } from "react"

import { Card, CardContent } from "@/components/ui/card"
import { Button } from "@/components/ui/button"
import { Label } from "@/components/ui/label"
import { Input } from "@/components/ui/input"
import { Textarea } from "@/components/ui/textarea"
import { useToast } from "@/hooks/use-toast"

type Me = {
  id: number | string
  username: string
  name?: string
  email?: string
  roles?: string[]
  description?: string
  avatar_urls?: Record<string, string>
  url?: string
  locale?: string
  nickname?: string
  profile_fields?: Record<string, string>
}

export default function AccountCenter() {
  const { toast } = useToast()
  const [me, setMe] = useState<Me | null>(null)
  const [loading, setLoading] = useState(true)
  const [saving, setSaving] = useState(false)

  useEffect(() => {
    (async () => {
      try {
        const r = await fetch("/api/auth/me", { cache: "no-store" })
        if (r.ok) {
          const data = await r.json()
          if (data?.user) setMe(data.user)
        }
      } finally {
        setLoading(false)
      }
    })()
  }, [])

  const isAdmin = !!me?.roles?.includes("administrator")

  if (loading) return <div className="p-6">Loading‚Ä¶</div>
  if (!me) return <div className="p-6">Please log in.</div>

  // --- sections ---
  const ProfileSection = (
    <form
      onSubmit={async (e: React.FormEvent<HTMLFormElement>) => {
        e.preventDefault()
        const fd = new FormData(e.currentTarget)
        const payload: any = {
          name: String(fd.get('name') || ''),
          nickname: String(fd.get('nickname') || ''),
          email: String(fd.get('email') || ''),
          url: String(fd.get('url') || ''),
          description: String(fd.get('description') || ''),
        }
        // prune empty strings so WP doesn't clear unintentionally
        Object.keys(payload).forEach((k) => { if (payload[k] === '') delete payload[k] })
        setSaving(true)
        try {
          const r = await fetch('/api/wp/users/me', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          })
          if (!r.ok) {
            const t = await r.text().catch(() => '')
            throw new Error(t || 'Update failed')
          }
          toast({ title: 'Profile updated' })
          // refresh local user state
          try {
            const r2 = await fetch('/api/auth/me', { cache: 'no-store' })
            if (r2.ok) {
              const d2 = await r2.json().catch(() => ({} as any))
              if (d2?.user) setMe(d2.user)
            }
          } catch {}
        } catch (err: any) {
          toast({ title: 'Update failed', description: err?.message || String(err), variant: 'destructive' })
        } finally {
          setSaving(false)
        }
      }}
      className="space-y-4"
    >
      <div>
        <Label htmlFor="name">Display Name</Label>
        <Input id="name" name="name" defaultValue={me.name} />
      </div>
      <div>
        <Label htmlFor="nickname">Nickname</Label>
        <Input id="nickname" name="nickname" defaultValue={me.nickname} />
      </div>
      <div>
        <Label htmlFor="email">Email</Label>
        <Input id="email" name="email" type="email" defaultValue={me.email} />
      </div>
      <div>
        <Label htmlFor="url">Website</Label>
        <Input id="url" name="url" type="url" defaultValue={me.url} />
      </div>
      <div>
        <Label htmlFor="description">Bio</Label>
        <Textarea id="description" name="description" defaultValue={me.description} />
      </div>
      <Button type="submit" disabled={saving}>
        {saving ? "Saving‚Ä¶" : "Save Changes"}
      </Button>
    </form>
  )

  const AdminSection = (
    <div>
      <h2 className="text-xl font-semibold mb-2">Admin Tools</h2>
      <div className="flex gap-2">
        <Button asChild><a href="/admin">Dashboard</a></Button>
        <Button variant="outline" asChild><a href="/admin/posts">Posts</a></Button>
      </div>
    </div>
  )

  return (
    <div className="max-w-3xl mx-auto p-6">
      <h1 className="text-2xl font-bold mb-4">Account</h1>
      <Card>
        <CardContent className="p-6">
          {ProfileSection}
        </CardContent>
      </Card>

      {isAdmin && (
        <Card className="mt-6">
          <CardContent className="p-6">
            {AdminSection}
          </CardContent>
        </Card>
      )}
    </div>
  )
}


// ==== FILE: src\app\account\avatar\page.tsx ====
"use client"
import { useEffect, useState } from 'react'

import { Card, CardContent } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { useToast } from '@/hooks/use-toast'

type Me = { avatar_urls?: Record<string, string> }

export default function AccountAvatarPage() {
  const { toast } = useToast()
  const [me, setMe] = useState<Me | null>(null)
  const [file, setFile] = useState<File | null>(null)
  const [loading, setLoading] = useState(true)
  const [uploading, setUploading] = useState(false)

  useEffect(() => {
    ;(async () => {
      try {
        const r = await fetch('/api/auth/me', { cache: 'no-store' })
        if (r.ok) {
          const data = await r.json()
          if (data?.user) setMe(data.user)
        }
      } finally {
        setLoading(false)
      }
    })()
  }, [])

  const upload = async () => {
    if (!file) return
    setUploading(true)
    try {
      const fd = new FormData()
      fd.append('file', file)
      const r = await fetch('/api/wp/users/avatar', { method: 'POST', body: fd })
      if (!r.ok) throw new Error(await r.text())
      toast({ title: 'Avatar updated' })
      // refresh local me
      const r2 = await fetch('/api/auth/me', { cache: 'no-store' })
      const d2 = await r2.json().catch(() => ({}))
      if (d2?.user) setMe(d2.user)
    } catch (e: any) {
      toast({ title: 'Upload failed', description: e?.message || String(e), variant: 'destructive' })
    } finally {
      setUploading(false)
    }
  }

  if (loading) return <div className="p-6">Loading‚Ä¶</div>
  if (!me) return <div className="p-6">Please log in.</div>

  const preview = me.avatar_urls?.['128'] || me.avatar_urls?.['96'] || me.avatar_urls?.['48']

  return (
    <div className="p-6">
      <h1 className="mb-4 text-2xl font-semibold">Avatar</h1>
      <Card>
        <CardContent className="p-6 grid gap-4 max-w-xl">
          {preview && (
            <img src={preview} alt="Current avatar" className="h-24 w-24 rounded-full object-cover" />
          )}
          <input
            type="file"
            accept="image/*"
            onChange={(e) => setFile(e.target.files?.[0] || null)}
          />
          <div>
            <Button disabled={!file || uploading} onClick={upload}>
              {uploading ? 'Uploading‚Ä¶' : 'Upload'}
            </Button>
          </div>
        </CardContent>
      </Card>
    </div>
  )
}


// ==== FILE: src\app\account\profile\page.tsx ====
"use client"
import { useEffect, useState } from "react"

import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { Textarea } from "@/components/ui/textarea"
import { useToast } from "@/hooks/use-toast"

type Me = {
  id: number | string
  username: string
  name?: string
  email?: string
  description?: string
  url?: string
  locale?: string
  nickname?: string
  website?: string
  profile_fields?: Record<string, string>
}

export default function AccountProfilePage() {
  const { toast } = useToast()
  const [me, setMe] = useState<Me | null>(null)
  const [saving, setSaving] = useState(false)
  const [loading, setLoading] = useState(true)
  const allowedKeys = ["insta", "fb", "youtube", "github", "linked"] as const
  const [fields, setFields] = useState<Record<string, string>>({})

  useEffect(() => {
    ;(async () => {
      try {
        const r = await fetch("/api/auth/me", { cache: "no-store" })
        if (r.ok) {
          const data = await r.json()
          if (data?.user) {
            setMe(data.user)
            const profile =
              data.user.profile_fields && typeof data.user.profile_fields === "object"
                ? (data.user.profile_fields as Record<string, any>)
                : {}
            const init: Record<string, string> = {}
            allowedKeys.forEach((k) => {
              const v = profile[k]
              init[k] = typeof v === "string" ? v : ""
            })
            setFields(init)
          }
        }
      } finally {
        setLoading(false)
      }
    })()
  }, [])

  const onSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault()
    if (!me) return
    const fd = new FormData(e.currentTarget)
    const payload: any = {
      name: String(fd.get("name") || ""),
      nickname: String(fd.get("nickname") || ""),
      email: String(fd.get("email") || ""),
      url: String(fd.get("url") || ""),
      description: String(fd.get("description") || ""),
      locale: String(fd.get("locale") || ""),
      profile_fields: Object.fromEntries(
        Object.entries(fields)
          .filter(([k]) => (allowedKeys as readonly string[]).includes(k))
          .map(([k, v]) => [k, String(v ?? "").trim()])
          .filter(([, v]) => v.length > 0)
      ),
    }
    Object.keys(payload).forEach((k) => {
      if (payload[k] === "") delete payload[k]
    })

    setSaving(true)
    try {
      const r = await fetch("/api/wp/users/me", {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      })
      if (!r.ok) {
        const t = await r.text().catch(() => "")
        throw new Error(t || "Update failed")
      }
      toast({ title: "Profile updated" })
    } catch (err: any) {
      toast({
        title: "Update failed",
        description: err?.message || String(err),
        variant: "destructive",
      })
    } finally {
      setSaving(false)
    }
  }

  if (loading) return <div className="p-6">Loading‚Ä¶</div>
  if (!me) return <div className="p-6">Please log in.</div>

  return (
    <div className="p-6 max-w-3xl mx-auto">
      <Card className="shadow-lg border rounded-2xl">
        <CardHeader>
          <CardTitle className="text-2xl font-bold">Edit Profile</CardTitle>
          <p className="text-sm text-muted-foreground">
            Keep your profile up to date. People see this info across your account.
          </p>
        </CardHeader>
        <CardContent>
          <form onSubmit={onSubmit} className="grid gap-6">
            <div className="grid gap-2">
              <Label htmlFor="name">Display name</Label>
              <Input
                id="name"
                name="name"
                defaultValue={me.name || me.nickname || (me as any).displayName}
                placeholder="e.g. John Doe"
              />
            </div>
            <div className="grid gap-2">
              <Label htmlFor="nickname">Nickname</Label>
              <Input
                id="nickname"
                name="nickname"
                defaultValue={me.nickname}
                placeholder="e.g. Johnny"
              />
            </div>
            <div className="grid gap-2">
              <Label htmlFor="email">Email</Label>
              <Input id="email" name="email" type="email" defaultValue={me.email} />
            </div>
            <div className="grid gap-2">
              <Label htmlFor="url">Website</Label>
              <Input id="url" name="url" type="url" defaultValue={me.url} />
            </div>
            <div className="grid gap-2">
              <Label htmlFor="locale">Locale</Label>
              <Input id="locale" name="locale" placeholder="en_US" defaultValue={me.locale} />
            </div>
            <div className="grid gap-2">
              <Label htmlFor="description">Bio</Label>
              <Textarea
                id="description"
                name="description"
                rows={4}
                defaultValue={me.description}
                placeholder="Write a short bio about yourself..."
              />
            </div>

            <fieldset className="grid gap-4 rounded-lg border p-4">
              <legend className="text-lg font-semibold px-1">Profile links</legend>
              <p className="text-sm text-muted-foreground">
                Add your social links (optional).
              </p>
              {[
                { key: "insta", label: "Instagram", ph: "https://instagram.com/yourhandle" },
                { key: "fb", label: "Facebook", ph: "https://facebook.com/yourpage" },
                { key: "youtube", label: "YouTube", ph: "https://youtube.com/@yourchannel" },
                { key: "github", label: "GitHub", ph: "https://github.com/yourname" },
                { key: "linked", label: "LinkedIn", ph: "https://linkedin.com/in/yourname" },
              ].map(({ key, label, ph }) => (
                <div key={key} className="flex items-center gap-2">
                  <Label className="w-28 shrink-0">{label}</Label>
                  <Input
                    placeholder={ph}
                    value={fields[key] || ""}
                    onChange={(e) => setFields((p) => ({ ...p, [key]: e.target.value }))}
                  />
                </div>
              ))}
            </fieldset>

            <div className="flex justify-end">
              <Button type="submit" disabled={saving} className="w-40">
                {saving ? "Saving‚Ä¶" : "Save changes"}
              </Button>
            </div>
          </form>
        </CardContent>
      </Card>
    </div>
  )
}


// ==== FILE: src\app\admin\layout.tsx ====
import { ReactNode } from 'react'
import { redirect } from 'next/navigation'

import { getSessionUser } from '@/lib/auth'

export default async function AdminLayout({ children }: { children: ReactNode }) {
  const user = await getSessionUser()
  if (!user) redirect('/login')
  const allowed = user.roles?.some(r => ['administrator'].includes(r))
  if (!allowed) redirect('/')
  return <>{children}</>
}


// ==== FILE: src\app\api\auth\login\route.ts ====
// Duplicate handler removed. Use app/api/auth/login/route.ts


// ==== FILE: src\app\api\auth\logout\route.ts ====
// Duplicate of app/api/auth/logout/route.ts; removed to avoid route conflicts.


// ==== FILE: src\app\api\auth\me\route.ts ====
// Duplicate handler removed. Use app/api/auth/me/route.ts


// ==== FILE: src\app\api\media-cache\route.ts ====
import { NextRequest } from 'next/server'

import { cacheImage } from '@/lib/mediaCache'

export const runtime = 'nodejs'

export async function GET(req: NextRequest) {
  const url = req.nextUrl.searchParams.get('url')
  if (!url) return Response.json({ error: 'missing url' }, { status: 400 })
  try {
    const local = await cacheImage(url)
    return Response.json({ url: local })
  } catch (e: any) {
    return Response.json({ error: String(e?.message || e) }, { status: 502 })
  }
}


// ==== FILE: src\app\api\media-cache\image\route.ts ====
import { NextRequest } from 'next/server'

import { cacheImage } from '@/lib/mediaCache'

export const runtime = 'nodejs'

export async function GET(req: NextRequest) {
  const url = req.nextUrl.searchParams.get('url')
  if (!url) return new Response('missing url', { status: 400 })
  try {
    const local = await cacheImage(url)
    // Redirect to the static file under /public/media-cache
    return new Response(null, {
      status: 302,
      headers: {
        Location: local,
        'Cache-Control': 'public, max-age=31536000, immutable',
      },
    })
  } catch (e: any) {
    return new Response('bad upstream', { status: 502 })
  }
}


// ==== FILE: src\app\api\test\route.ts ====
export async function GET() {
  return new Response('Hello from test route', {
    status: 200,
    headers: {
      'Content-Type': 'text/plain',
    },
  });
}


// ==== FILE: src\app\api\wp\categories\route.ts ====
import { NextRequest } from 'next/server'
import { cookies } from 'next/headers'

import { verifySession } from '@/lib/jwt'

export const runtime = 'nodejs'
export const dynamic = 'force-dynamic'

async function fetchAllCategories(WP: string, qs: URLSearchParams) {
  // Aggregate across all pages
  const firstUrl = new URL('/wp-json/wp/v2/categories', WP)
  qs.forEach((v, k) => firstUrl.searchParams.set(k, v))
  if (!firstUrl.searchParams.has('per_page')) firstUrl.searchParams.set('per_page', '100')
  if (!firstUrl.searchParams.has('hide_empty')) firstUrl.searchParams.set('hide_empty', '0')
  if (!firstUrl.searchParams.has('orderby')) firstUrl.searchParams.set('orderby', 'name')
  if (!firstUrl.searchParams.has('order')) firstUrl.searchParams.set('order', 'asc')
  firstUrl.searchParams.set('page', '1')

  const out: any[] = []
  let page = 1
  let totalPages = 1
  do {
    firstUrl.searchParams.set('page', String(page))
    const res = await fetch(firstUrl.toString(), { cache: 'no-store' })
    if (!res.ok) throw new Error(`Upstream ${res.status}`)
    const cur = await res.json()
    out.push(...cur)
    totalPages = Number(res.headers.get('X-WP-TotalPages') || '1')
    page += 1
  } while (page <= totalPages)
  return out
}

export async function GET(req: NextRequest) {
  const WP = process.env.WP_URL
  if (!WP) return new Response('WP_URL env required', { status: 500 })
  const url = new URL(req.url)
  try {
    const data = await fetchAllCategories(WP, url.searchParams)
    return Response.json(data, { headers: { 'Cache-Control': 'public, max-age=300' } })
  } catch (e: any) {
    return new Response(e.message || 'Upstream error', { status: 502 })
  }
}

export async function POST(req: NextRequest) {
  const WP = process.env.WP_URL
  if (!WP) return new Response('WP_URL env required', { status: 500 })
  const cookieStore = await cookies()
  const token = cookieStore.get(process.env.SESSION_COOKIE_NAME ?? 'session')?.value
  if (!token) return new Response('Unauthorized', { status: 401 })
  let claims: any
  try { claims = await verifySession(token) } catch { return new Response('Unauthorized', { status: 401 }) }
  const roles: string[] = (claims.roles as any) || []
  if (!roles.some(r => ['contributor','author','editor','administrator'].includes(r))) {
    return new Response('Forbidden', { status: 403 })
  }
  const wpToken = (claims as any).wpToken
  if (!wpToken) return new Response('Missing upstream token', { status: 401 })

  const bodyText = await req.text()
  const res = await fetch(new URL('/wp-json/wp/v2/categories', WP), {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${wpToken}` },
    body: bodyText,
  })
  const text = await res.text()
  return new Response(text, { status: res.status, headers: { 'Content-Type': res.headers.get('Content-Type') || 'application/json' } })
}


// ==== FILE: src\app\api\wp\comments\route.ts ====
export const runtime = 'nodejs'
export const dynamic = 'force-dynamic'

import { createHmac } from 'crypto'

import type { NextRequest } from 'next/server'
import { cookies } from 'next/headers'

import { verifySession } from '@/lib/jwt'

export async function GET(req: NextRequest) {
  const WP = process.env.WP_URL
  if (!WP) return new Response('WP_URL env required', { status: 500 })

  const incoming = new URL(req.url)
  const id = incoming.searchParams.get('id')
  
  // Build query with sensible defaults
  const search = new URLSearchParams(incoming.search)
  if (!search.has('per_page')) search.set('per_page', '20')
  if (!search.has('orderby')) search.set('orderby', 'date')
  if (!search.has('order')) search.set('order', 'desc')

  // Try MU proxy first when available
  const secret = process.env.FE_PROXY_SECRET || ''
  const path = 'wp/v2/comments'
  if (secret) {
    const proxy = new URL('/wp-json/fe-auth/v1/proxy', WP)
    proxy.searchParams.set('path', path)
    search.forEach((v, k) => proxy.searchParams.set(`query[${k}]`, v))
    const ts = String(Math.floor(Date.now() / 1000))
    const base = `GET\n${path}\n${ts}\n`
    const sign = createHmac('sha256', secret).update(base).digest('base64')
    const res = await fetch(proxy.toString(), { headers: { 'x-fe-ts': ts, 'x-fe-sign': sign }, cache: 'no-store' })
    if (res.ok) {
      const text = await res.text()
      return new Response(text, { status: 200, headers: { 'Content-Type': res.headers.get('Content-Type') || 'application/json', 'Cache-Control': 'public, max-age=60', 'X-Upstream': 'proxy', 'X-Upstream-Url': proxy.toString() } })
    }
  }

  const out = id ? new URL(`/wp-json/wp/v2/comments/${id}`, WP) : new URL('/wp-json/wp/v2/comments', WP)
  if (!id) search.forEach((v, k) => out.searchParams.set(k, v))
  const authHeader = req.headers.get('authorization')
  const res = await fetch(out.toString(), { cache: 'no-store', headers: { ...(authHeader ? { Authorization: authHeader } : {}) } })
  if (!res.ok) {
    if (res.status === 404 || res.status === 400) {
      return Response.json([], { status: 200, headers: { 'Cache-Control': 'public, max-age=30', 'X-Upstream-Status': String(res.status), 'X-Upstream-Url': out.toString() } })
    }
    return new Response('Upstream error', { status: res.status })
  }

  const text = await res.text()
  return new Response(text, { status: 200, headers: { 'Content-Type': 'application/json', 'Cache-Control': 'public, max-age=60', 'X-Upstream-Url': out.toString() } })
}

// Create a comment (requires authenticated user)
export async function POST(req: NextRequest) {
  const WP = process.env.WP_URL
  if (!WP) return new Response('WP_URL env required', { status: 500 })

  // Require authenticated session
  const cookieStore = await cookies()
  const sessionCookie = cookieStore.get(process.env.SESSION_COOKIE_NAME ?? 'session')
  if (!sessionCookie?.value) return new Response('Unauthorized', { status: 401 })
  let claims: any
  try { claims = await verifySession(sessionCookie.value) } catch { return new Response('Unauthorized', { status: 401 }) }
  const wpToken = (claims as any).wpToken
  if (!wpToken) return new Response('Missing upstream token', { status: 401 })

  // Parse and validate body
  let body: any = {}
  try { body = await req.json() } catch { body = {} }
  const content = (body?.content ?? '').toString().trim()
  const postId = Number(body?.postId)
  const parent = body?.parent ? Number(body.parent) : undefined
  if (!content || !postId) return new Response('content and postId are required', { status: 400 })

  // Forward to WP REST API
  const wpRes = await fetch(new URL('/wp-json/wp/v2/comments', WP), {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${wpToken}` },
    body: JSON.stringify({ content, post: postId, parent }),
    cache: 'no-store',
  } as RequestInit)
  const text = await wpRes.text()
  return new Response(text, { status: wpRes.status, headers: { 'Content-Type': wpRes.headers.get('Content-Type') || 'application/json' } })
}


// ==== FILE: src\app\api\wp\media\list\route.ts ====
import { NextRequest } from 'next/server'

export const runtime = 'nodejs'

export async function GET(req: NextRequest) {
  const WP = process.env.WP_URL
  if (!WP) return Response.json({ error: 'WP_URL not configured' }, { status: 500 })

  const url = new URL('/wp-json/wp/v2/media', WP)
  const search = req.nextUrl.searchParams
  for (const [k, v] of search.entries()) url.searchParams.set(k, v)
  if (!url.searchParams.has('per_page')) url.searchParams.set('per_page', '20')

  const res = await fetch(url.toString(), {
    next: { revalidate: Number(process.env.WP_CACHE_TTL || 300) },
    headers: {
      'User-Agent': 'techoblivion-proxy/1.0 (+https://techoblivion.in)',
      'Accept': 'application/json',
      'Referer': WP,
    },
  })

  if (!res.ok) {
    const body = await res.text()
    return Response.json({ error: 'upstream', status: res.status, body: body.slice(0, 2000) }, { status: 502 })
  }
  const data = await res.json()
  return Response.json({ items: data }, { status: 200 })
}


// ==== FILE: src\app\api\wp\media\[...path]\route.ts ====
import { NextRequest } from 'next/server';

export const runtime = 'nodejs';
export const dynamic = 'force-dynamic';

export async function GET(_req: NextRequest, { params }: { params: { path: string[] } }) {
  const path = params.path.join('/');
  const origin = `https://techoblivion.in/${path}`;

  const res = await fetch(origin, { cache: 'no-store' });
  if (!res.ok) return new Response('Not found', { status: res.status });

  const ct = res.headers.get('content-type') || 'application/octet-stream';
  const ab = await res.arrayBuffer();
  
  return new Response(ab, {
    headers: {
      'Content-Type': ct,
      'Cache-Control': 'public, max-age=31536000, immutable',
    },
  });
}

// ==== FILE: src\app\api\wp\media\[...slug]\route.ts ====
import type { NextRequest } from 'next/server';
export const runtime = 'nodejs';
export const dynamic = 'force-dynamic';

export async function GET(_req: NextRequest, {
  params,
}: { params: { slug?: string[]; path?: string[] } }) {
  const segs = (params?.slug ?? params?.path ?? []) as string[];
  if (!Array.isArray(segs) || segs.length === 0) {
    return new Response('Bad path', { status: 400 });
  }

  const WP = (process.env.WP_URL || 'http://example.com').replace(/\/+$/, '');
  let origin = `${WP}/${segs.join('/')}`;
  // Support absolute fetches: /api/wp/media/absolute/<encodeURIComponent(full_url)>
  if (segs[0] === 'absolute') {
    const encoded = segs.slice(1).join('/');
    try {
      const full = decodeURIComponent(encoded);
      const u = new URL(full);
      if (u.protocol === 'http:' || u.protocol === 'https:') {
        origin = full;
      }
    } catch (e) {
      // fallthrough; will attempt default WP-based origin which may 404
    }
  }

  // Use browser-like headers to avoid hotlink protection and misclassification.
  const headers: Record<string, string> = {
    Accept: 'image/*,*/*;q=0.8',
    'User-Agent':
      'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.0.0 Safari/537.36',
    Referer: 'http://example.com/',
  };

  let upstream: Response;
  try {
    upstream = await fetch(origin, { cache: 'no-store', headers });
  } catch (err: any) {
    console.error('[media-proxy] fetch error', { origin, err: String(err) });
    return placeholderResponse('upstream-fetch-error');
  }

  if (!upstream.ok) {
    console.warn('[media-proxy] upstream not ok', { origin, status: upstream.status });
    return upstream.status === 404
      ? new Response('Not found', { status: 404 })
      : placeholderResponse(`upstream-status-${upstream.status}`);
  }

  const ct = upstream.headers.get('content-type')?.toLowerCase() ?? '';
  const ab = await upstream.arrayBuffer();

  // Some hosts return HTML (403/maintenance pages) with content-type text/html. Guard that.
  const isImage = ct.startsWith('image/');
  if (!isImage) {
    // Try to sniff the first few bytes to see if it's HTML regardless of content-type.
    const head = new Uint8Array(ab.slice(0, 64));
    const asText = safeDecode(head);
    const seemsHtml = /<(!doctype\s+html|html|body)[^>]*>/i.test(asText);
    console.warn('[media-proxy] non-image upstream', { origin, ct, seemsHtml });
    // Serve a tiny transparent PNG placeholder to avoid browser errors, with a short cache.
    return placeholderResponse('bad-content-type', {
      'X-Upstream-Content-Type': ct || 'unknown',
    });
  }

  return new Response(ab, {
    headers: {
      'Content-Type': ct || 'application/octet-stream',
      'Cache-Control': 'public, max-age=31536000, immutable',
    },
  });
}

// Return a 1x1 transparent PNG with short cache, including a diagnostic header.
function placeholderResponse(reason: string, extraHeaders?: Record<string, string>) {
  const pngBase64 =
    'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAwMBA6m+Vb8AAAAASUVORK5CYII=';
  const body = Buffer.from(pngBase64, 'base64');
  return new Response(body, {
    status: 200,
    headers: {
      'Content-Type': 'image/png',
      'Cache-Control': 'public, max-age=300',
      'X-Proxy-Status': reason,
      ...(extraHeaders ?? {}),
    },
  });
}

function safeDecode(bytes: Uint8Array): string {
  try {
    return new TextDecoder('utf-8', { fatal: false }).decode(bytes);
  } catch {
    return '';
  }
}


// ==== FILE: src\app\api\wp\media\_debug\route.ts ====
export const runtime = 'nodejs';
export async function GET() {
  return Response.json({ ok: true, where: '/api/wp/media/_debug' });
}


// ==== FILE: src\app\api\wp\posts\route.ts ====
import { createHmac } from 'crypto'

import { NextRequest } from 'next/server'
import { cookies } from 'next/headers'

import { verifySession } from '@/lib/jwt';

export const runtime = 'nodejs';
export const dynamic = 'force-dynamic';

type SessionClaims = {
  roles?: string[]
  wpToken?: string
  wpUserId?: string | number
}

export async function GET(req: NextRequest) {
  const WP = process.env.WP_URL
  if (!WP) return new Response('WP_URL env required', { status: 500 })
  const incoming = new URL(req.url);
  
  // Prepare defaults and normalized params
  const search = new URLSearchParams(incoming.search)
  const id = search.get('id')
  if (search.has('perPage')) {
    search.set('per_page', search.get('perPage')!)
    search.delete('perPage')
  }
  if (!search.has('_embed')) search.set('_embed', '1')
  if (!search.has('per_page')) search.set('per_page', '10')

  // Try MU proxy first if configured (helps on locked-down sites)
  const secret = process.env.FE_PROXY_SECRET || ''
  const path = 'wp/v2/posts'
  if (secret) {
    const proxy = new URL('/wp-json/fe-auth/v1/proxy', WP)
    proxy.searchParams.set('path', path)
    // forward query params under query[...]
    search.forEach((v, k) => proxy.searchParams.set(`query[${k}]`, v))
    const ts = String(Math.floor(Date.now() / 1000))
    const base = `GET\n${path}\n${ts}\n`
    const sign = createHmac('sha256', secret).update(base).digest('base64')
    const res = await fetch(proxy.toString(), { headers: { 'x-fe-ts': ts, 'x-fe-sign': sign }, cache: 'no-store' })
    if (res.ok) {
      const text = await res.text()
      return new Response(text, { status: 200, headers: { 'Content-Type': res.headers.get('Content-Type') || 'application/json', 'Cache-Control': 'public, max-age=60', 'X-Upstream': 'proxy', 'X-Upstream-Url': proxy.toString() } })
    }
    // fall through to direct
  }

  const out = id ? new URL(`/wp-json/wp/v2/posts/${id}`, WP) : new URL('/wp-json/wp/v2/posts', WP)
  if (!id) search.forEach((v, k) => out.searchParams.set(k, v))
  // Forward Authorization header if present
  let authHeader = req.headers.get('authorization') || undefined
  // If fetching a single post without Authorization, attempt to use session wpToken (to allow drafts access)
  if (id && !authHeader) {
    try {
      const cookieStore = await cookies()
      const sessionCookie = cookieStore.get(process.env.SESSION_COOKIE_NAME ?? 'session')
      if (sessionCookie?.value) {
        const claims = (await verifySession(sessionCookie.value)) as unknown as SessionClaims
        if (claims?.wpToken) authHeader = `Bearer ${claims.wpToken}`
      }
    } catch {
      // TODO: implement better logging for session parse errors
    }
  }
  const res = await fetch(out, { cache: 'no-store', headers: { ...(authHeader ? { Authorization: authHeader } : {}) } })
  if (!res.ok) {
    if (res.status === 404 || res.status === 400) {
      return Response.json([], { status: 200, headers: { 'Cache-Control': 'public, max-age=30', 'X-Upstream-Status': String(res.status), 'X-Upstream-Url': out.toString() } })
    }
    return new Response('Upstream error', { status: res.status })
  }
  return Response.json(await res.json(), { headers: { 'Cache-Control': 'public, max-age=60', 'X-Upstream-Url': out.toString() } })
}

// Create a post (requires at least 'author' role)
export async function POST(req: NextRequest) {
  const WP = process.env.WP_URL
  if (!WP) return new Response('WP_URL env required', { status: 500 })
  const cookieStore = await cookies()
  const sessionCookie = cookieStore.get(process.env.SESSION_COOKIE_NAME ?? 'session')
  if (!sessionCookie?.value) return new Response('Unauthorized', { status: 401 })
  let claims: SessionClaims
  try { claims = (await verifySession(sessionCookie.value)) as unknown as SessionClaims } catch { return new Response('Unauthorized', { status: 401 }) }
  const roles: string[] = Array.isArray(claims.roles) ? claims.roles : []
  if (!roles.some(r => ['author','editor','administrator'].includes(r))) {
    return new Response('Forbidden', { status: 403 })
  }
  const wpToken = claims.wpToken
  if (!wpToken) return new Response('Missing upstream token', { status: 401 })

  // Parse body; if tags are names, resolve to IDs
  const raw = await req.text()
  let bodyJson: unknown
  try { bodyJson = raw ? JSON.parse(raw) : {} } catch { bodyJson = {} }
  if (
    bodyJson &&
    typeof bodyJson === 'object' &&
    'tags' in (bodyJson as Record<string, unknown>) &&
    Array.isArray((bodyJson as { tags: unknown[] }).tags) &&
    (bodyJson as { tags: unknown[] }).tags.length > 0 &&
    typeof (bodyJson as { tags: unknown[] }).tags[0] === 'string'
  ) {
    try {
      const names: string[] = (bodyJson as { tags: string[] }).tags
      const resolveRes = await fetch(new URL('/api/wp/tags/resolve', process.env.NEXT_PUBLIC_SITE_URL || 'http://localhost'), {
        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ names }), cache: 'no-store'
      })
      if (resolveRes.ok) {
        const j = await resolveRes.json()
  ;(bodyJson as { tags: unknown }).tags = Array.isArray(j?.ids) ? j.ids : []
      }
    } catch {
      // TODO: handle tag resolve errors gracefully
    }
  }
  const res = await fetch(new URL('/wp-json/wp/v2/posts', WP), {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${wpToken}` },
    body: JSON.stringify(bodyJson ?? {}),
  })
  const text = await res.text()
  return new Response(text, { status: res.status, headers: { 'Content-Type': res.headers.get('Content-Type') || 'application/json' } })
}

// Update a post (requires capability: own post for authors; any for editor/admin)
export async function PATCH(req: NextRequest) {
  const WP = process.env.WP_URL
  if (!WP) return new Response('WP_URL env required', { status: 500 })
  const incoming = new URL(req.url)
  const id = incoming.searchParams.get('id')
  if (!id) return new Response('Missing id', { status: 400 })

  const cookieStore = await cookies()
  const sessionCookie = cookieStore.get(process.env.SESSION_COOKIE_NAME ?? 'session')
  if (!sessionCookie?.value) return new Response('Unauthorized', { status: 401 })
  let claims: SessionClaims
  try { claims = (await verifySession(sessionCookie.value)) as unknown as SessionClaims } catch { return new Response('Unauthorized', { status: 401 }) }
  const roles: string[] = Array.isArray(claims.roles) ? claims.roles : []
  if (!roles.some(r => ['author','editor','administrator'].includes(r))) {
    return new Response('Forbidden', { status: 403 })
  }
  const wpToken = claims.wpToken
  if (!wpToken) return new Response('Missing upstream token', { status: 401 })

  // Optional: ownership check for authors by fetching the post first
  if (roles.includes('author') && !roles.some(r => ['editor','administrator'].includes(r))) {
    const postRes = await fetch(new URL(`/wp-json/wp/v2/posts/${id}`, WP), { headers: { Authorization: `Bearer ${wpToken}` } })
    if (postRes.ok) {
      const post = await postRes.json()
  if ((post as Record<string, unknown>)?.author && String((post as Record<string, unknown>).author) !== String(claims.wpUserId)) {
        return new Response('Forbidden', { status: 403 })
      }
    }
  }

  const raw = await req.text()
  let bodyJson: unknown
  try { bodyJson = raw ? JSON.parse(raw) : {} } catch { bodyJson = {} }
  if (
    bodyJson &&
    typeof bodyJson === 'object' &&
    'tags' in (bodyJson as Record<string, unknown>) &&
    Array.isArray((bodyJson as { tags: unknown[] }).tags) &&
    (bodyJson as { tags: unknown[] }).tags.length > 0 &&
    typeof (bodyJson as { tags: unknown[] }).tags[0] === 'string'
  ) {
    try {
      const names: string[] = (bodyJson as { tags: string[] }).tags
      const resolveRes = await fetch(new URL('/api/wp/tags/resolve', process.env.NEXT_PUBLIC_SITE_URL || 'http://localhost'), {
        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ names }), cache: 'no-store'
      })
      if (resolveRes.ok) {
        const j = await resolveRes.json()
  ;(bodyJson as { tags: unknown }).tags = Array.isArray(j?.ids) ? j.ids : []
      }
    } catch {
      // TODO: handle tag resolve errors gracefully
    }
  }
  const res = await fetch(new URL(`/wp-json/wp/v2/posts/${id}`, WP), {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${wpToken}` },
    body: JSON.stringify(bodyJson ?? {}),
  })
  const text = await res.text()
  return new Response(text, { status: res.status, headers: { 'Content-Type': res.headers.get('Content-Type') || 'application/json' } })
}

// Delete a post
export async function DELETE(req: NextRequest) {
  const WP = process.env.WP_URL
  if (!WP) return new Response('WP_URL env required', { status: 500 })
  const incoming = new URL(req.url)
  const id = incoming.searchParams.get('id')
  if (!id) return new Response('Missing id', { status: 400 })

  const cookieStore = await cookies()
  const sessionCookie = cookieStore.get(process.env.SESSION_COOKIE_NAME ?? 'session')
  if (!sessionCookie?.value) return new Response('Unauthorized', { status: 401 })
  let claims: SessionClaims
  try { claims = (await verifySession(sessionCookie.value)) as unknown as SessionClaims } catch { return new Response('Unauthorized', { status: 401 }) }
  const roles: string[] = Array.isArray(claims.roles) ? claims.roles : []
  if (!roles.some(r => ['editor','administrator'].includes(r))) {
    return new Response('Forbidden', { status: 403 })
  }
  const wpToken = claims.wpToken
  if (!wpToken) return new Response('Missing upstream token', { status: 401 })

  const controller = new AbortController()
  const to = setTimeout(() => controller.abort(), 10_000)
  try {
    const res = await fetch(new URL(`/wp-json/wp/v2/posts/${id}`, WP), {
      method: 'DELETE',
      headers: { Authorization: `Bearer ${wpToken}` },
      signal: controller.signal,
    })
    const text = await res.text()
    return new Response(text, { status: res.status, headers: { 'Content-Type': res.headers.get('Content-Type') || 'application/json' } })
  } catch (e: unknown) {
    const err = e as { name?: string; message?: string }
    const msg = err?.name === 'AbortError' ? 'Upstream timeout' : (err?.message || 'Upstream error')
    return new Response(JSON.stringify({ error: msg }), { status: 504, headers: { 'Content-Type': 'application/json' } })
  } finally {
    clearTimeout(to)
  }
}


// ==== FILE: src\app\api\wp\related\route.ts ====
import { NextRequest } from 'next/server'

export const runtime = 'nodejs'
export const dynamic = 'force-dynamic'

export async function GET(req: NextRequest) {
  const WP = process.env.WP_URL
  if (!WP) return new Response('WP_URL env required', { status: 500 })

  const incoming = new URL(req.url)
  const out = new URL('/wp-json/wp/v2/posts', WP)
  // pass through known filters
  const pass = ['categories','tags','exclude','per_page','page','_embed']
  for (const k of pass) {
    const v = incoming.searchParams.get(k)
    if (v) out.searchParams.set(k, v)
  }
  if (!out.searchParams.has('_embed')) out.searchParams.set('_embed', '1')
  if (!out.searchParams.has('per_page')) out.searchParams.set('per_page', '5')

  const res = await fetch(out.toString(), { cache: 'no-store' })
  if (!res.ok) return new Response('Upstream error', { status: res.status })
  const arr = await res.json()
  const simplified = Array.isArray(arr) ? arr.map((p: any) => ({
    id: p.id,
    slug: p.slug,
    title: p.title?.rendered,
    date: p.date,
    featuredImage: p._embedded?.['wp:featuredmedia']?.[0]?.source_url ?? null,
  })) : []
  return Response.json(simplified, { headers: { 'Cache-Control': 'public, max-age=60' } })
}


// ==== FILE: src\app\api\wp\tags\route.ts ====
import { NextRequest } from 'next/server'
import { cookies } from 'next/headers'

import { verifySession } from '@/lib/jwt'

export const runtime = 'nodejs'
export const dynamic = 'force-dynamic'

async function fetchAllTags(WP: string, qs: URLSearchParams) {
  const firstUrl = new URL('/wp-json/wp/v2/tags', WP)
  qs.forEach((v, k) => firstUrl.searchParams.set(k, v))
  if (!firstUrl.searchParams.has('per_page')) firstUrl.searchParams.set('per_page', '100')
  if (!firstUrl.searchParams.has('orderby')) firstUrl.searchParams.set('orderby', 'name')
  if (!firstUrl.searchParams.has('order')) firstUrl.searchParams.set('order', 'asc')
  firstUrl.searchParams.set('page', '1')

  const out: any[] = []
  let page = 1
  let totalPages = 1
  do {
    firstUrl.searchParams.set('page', String(page))
    const res = await fetch(firstUrl.toString(), { cache: 'no-store' })
    if (!res.ok) throw new Error(`Upstream ${res.status}`)
    const cur = await res.json()
    out.push(...cur)
    totalPages = Number(res.headers.get('X-WP-TotalPages') || '1')
    page += 1
  } while (page <= totalPages)
  return out
}

export async function GET(req: NextRequest) {
  const WP = process.env.WP_URL
  if (!WP) return new Response('WP_URL env required', { status: 500 })
  const url = new URL(req.url)
  try {
    const data = await fetchAllTags(WP, url.searchParams)
    return Response.json(data, { headers: { 'Cache-Control': 'public, max-age=300' } })
  } catch (e: any) {
    return new Response(e.message || 'Upstream error', { status: 502 })
  }
}

export async function POST(req: NextRequest) {
  const WP = process.env.WP_URL
  if (!WP) return new Response('WP_URL env required', { status: 500 })
  const cookieStore = await cookies()
  const token = cookieStore.get(process.env.SESSION_COOKIE_NAME ?? 'session')?.value
  if (!token) return new Response('Unauthorized', { status: 401 })
  let claims: any
  try { claims = await verifySession(token) } catch { return new Response('Unauthorized', { status: 401 }) }
  const roles: string[] = (claims.roles as any) || []
  if (!roles.some(r => ['contributor','author','editor','administrator'].includes(r))) {
    return new Response('Forbidden', { status: 403 })
  }
  const wpToken = (claims as any).wpToken
  if (!wpToken) return new Response('Missing upstream token', { status: 401 })

  const bodyText = await req.text()
  const res = await fetch(new URL('/wp-json/wp/v2/tags', WP), {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${wpToken}` },
    body: bodyText,
  })
  const text = await res.text()
  return new Response(text, { status: res.status, headers: { 'Content-Type': res.headers.get('Content-Type') || 'application/json' } })
}


// ==== FILE: src\app\api\wp\tags\resolve\route.ts ====
import { NextRequest } from 'next/server'
import { cookies } from 'next/headers'

import { verifySession } from '@/lib/jwt'

export const runtime = 'nodejs'
export const dynamic = 'force-dynamic'

export async function POST(req: NextRequest) {
  const WP = process.env.WP_URL
  if (!WP) return new Response('WP_URL env required', { status: 500 })
  const cookieStore = await cookies()
  const token = cookieStore.get(process.env.SESSION_COOKIE_NAME ?? 'session')?.value
  if (!token) return new Response('Unauthorized', { status: 401 })
  let claims: any
  try { claims = await verifySession(token) } catch { return new Response('Unauthorized', { status: 401 }) }
  const roles: string[] = (claims.roles as any) || []
  if (!roles.some(r => ['contributor','author','editor','administrator'].includes(r))) {
    return new Response('Forbidden', { status: 403 })
  }
  const wpToken = (claims as any).wpToken
  if (!wpToken) return new Response('Missing upstream token', { status: 401 })

  let body: any
  try { body = await req.json() } catch { return new Response('Bad JSON', { status: 400 }) }
  const names: string[] = Array.isArray(body?.names) ? body.names : []
  if (!names.length) return new Response(JSON.stringify({ ids: [] }), { status: 200, headers: { 'Content-Type': 'application/json' } })

  const ids: number[] = []
  for (const raw of names) {
    const name = String(raw).trim()
    if (!name) continue
    // Search existing tag by name
    const searchUrl = new URL('/wp-json/wp/v2/tags', WP)
    searchUrl.searchParams.set('search', name)
    searchUrl.searchParams.set('per_page', '10')
    const searchRes = await fetch(searchUrl.toString(), { cache: 'no-store' })
    let found: any = null
    if (searchRes.ok) {
      const arr = await searchRes.json()
      found = (arr || []).find((t: any) => String(t.name).toLowerCase() === name.toLowerCase())
    }
    if (found?.id) {
      ids.push(found.id)
      continue
    }
    // Create if missing
    const createRes = await fetch(new URL('/wp-json/wp/v2/tags', WP), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${wpToken}` },
      body: JSON.stringify({ name }),
    })
    if (!createRes.ok) {
      // Skip silently, or collect error? We'll skip to not block entire request.
      continue
    }
    const created = await createRes.json()
    if (created?.id) ids.push(created.id)
  }

  return new Response(JSON.stringify({ ids }), { status: 200, headers: { 'Content-Type': 'application/json' } })
}


// ==== FILE: src\app\api\wp\users\me\route.ts ====
import { cookies } from 'next/headers'

import { verifySession } from '@/lib/jwt'

export const runtime = 'nodejs'
export const dynamic = 'force-dynamic'

export async function GET() {
  const WP = process.env.WP_URL
  if (!WP) return new Response('WP_URL env required', { status: 500 })

  const cookieStore = await cookies()
  const sessionCookie = cookieStore.get(process.env.SESSION_COOKIE_NAME ?? 'session')
  if (!sessionCookie?.value) return new Response('Unauthorized', { status: 401 })

  let claims: any
  try { claims = await verifySession(sessionCookie.value) } catch { return new Response('Unauthorized', { status: 401 }) }
  const wpToken = claims?.wpToken
  if (!wpToken) return new Response('Unauthorized', { status: 401 })

  const res = await fetch(new URL('/wp-json/wp/v2/users/me', WP), { headers: { Authorization: `Bearer ${wpToken}` }, cache: 'no-store' })
  const text = await res.text()
  return new Response(text, { status: res.status, headers: { 'Content-Type': res.headers.get('Content-Type') || 'application/json' } })
}


// ==== FILE: src\app\api\_debug\route.ts ====
export const runtime = 'nodejs';
export async function GET() {
  return Response.json({ ok: true });
}


// ==== FILE: src\app\dashboard\layout.tsx ====
import { ReactNode } from 'react'
import { redirect } from 'next/navigation'

import { getSessionUser } from '@/lib/auth'

export default async function DashboardLayout({ children }: { children: ReactNode }) {
  const user = await getSessionUser()
  if (!user) redirect('/login?next=/dashboard')
  const allowed = Array.isArray(user.roles) && user.roles.some(r => (
    ['subscriber','contributor','author','editor','administrator'] as const
  ).includes(r as any))
  if (!allowed) redirect('/')
  return <>{children}</>
}


// ==== FILE: src\app\editor\layout.tsx ====
import { ReactNode } from 'react'
import { redirect } from 'next/navigation'

import { getSessionUser } from '@/lib/auth'

export default async function EditorLayout({ children }: { children: ReactNode }) {
  const user = await getSessionUser()
  if (!user) redirect('/login?next=/editor')
  const allowed = user.roles?.some(r => ['contributor','author','editor','administrator'].includes(r))
  if (!allowed) {
    // Soft deny to home for now
    redirect('/')
  }
  return <>{children}</>
}


// ==== FILE: src\app\editor\page.tsx ====
import { redirect } from 'next/navigation'

export default function EditorIndexPage() {
  redirect('/editor/new')
}


// ==== FILE: src\app\editor\new\page.tsx ====

'use client';

import { Upload, Bold, Italic, Link as LinkIcon, List, ListOrdered, Code, Strikethrough, Quote, Image as ImageIcon, Type, Minus, Info, Bot } from "lucide-react";
import React, { useState, useEffect } from "react";

import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Label } from "@/components/ui/label";
import { Card, CardContent, CardFooter } from "@/components/ui/card";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from "@/components/ui/tooltip";
import { Separator } from "@/components/ui/separator";
import { Alert, AlertDescription, AlertTitle } from "@/components/ui/alert";
import { Accordion, AccordionContent, AccordionItem, AccordionTrigger } from "@/components/ui/accordion";
import { RoleGate } from "@/hooks/useRoleGate";
import { fetchAllCategories, buildCategoryTree, type WpCategory, fetchAllTags, createCategory } from '@/lib/taxonomy-client'
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription, DialogTrigger } from "@/components/ui/dialog";

const EditorToolbar = () => (
    <div className="flex items-center gap-1 border-b p-2 flex-wrap">
      <TooltipProvider>
        <Tooltip>
          <TooltipTrigger asChild>
            <Button variant="outline" size="icon" className="h-8 w-8">
              <Bold className="h-4 w-4" />
            </Button>
          </TooltipTrigger>
          <TooltipContent>
            <p>Bold (Ctrl+B)</p>
          </TooltipContent>
        </Tooltip>
        <Tooltip>
          <TooltipTrigger asChild>
            <Button variant="outline" size="icon" className="h-8 w-8">
              <Italic className="h-4 w-4" />
            </Button>
          </TooltipTrigger>
          <TooltipContent>
            <p>Italic (Ctrl+I)</p>
          </TooltipContent>
        </Tooltip>
        <Tooltip>
          <TooltipTrigger asChild>
            <Button variant="outline" size="icon" className="h-8 w-8">
              <Strikethrough className="h-4 w-4" />
            </Button>
          </TooltipTrigger>
          <TooltipContent>
            <p>Strikethrough</p>
          </TooltipContent>
        </Tooltip>
        <Separator orientation="vertical" className="h-6 mx-1" />
        <Tooltip>
          <TooltipTrigger asChild>
            <Button variant="outline" size="icon" className="h-8 w-8">
                <Type className="h-4 w-4" />
            </Button>
          </TooltipTrigger>
          <TooltipContent>
            <p>Heading</p>
          </TooltipContent>
        </Tooltip>
        <Tooltip>
          <TooltipTrigger asChild>
            <Button variant="outline" size="icon" className="h-8 w-8">
              <List className="h-4 w-4" />
            </Button>
          </TooltipTrigger>
          <TooltipContent>
            <p>Bulleted List</p>
          </TooltipContent>
        </Tooltip>
         <Tooltip>
          <TooltipTrigger asChild>
            <Button variant="outline" size="icon" className="h-8 w-8">
              <ListOrdered className="h-4 w-4" />
            </Button>
          </TooltipTrigger>
          <TooltipContent>
            <p>Numbered List</p>
          </TooltipContent>
        </Tooltip>
        <Tooltip>
          <TooltipTrigger asChild>
            <Button variant="outline" size="icon" className="h-8 w-8">
              <Quote className="h-4 w-4" />
            </Button>
          </TooltipTrigger>
          <TooltipContent>
            <p>Blockquote</p>
          </TooltipContent>
        </Tooltip>
        <Tooltip>
          <TooltipTrigger asChild>
            <Button variant="outline" size="icon" className="h-8 w-8">
              <Minus className="h-4 w-4" />
            </Button>
          </TooltipTrigger>
          <TooltipContent>
            <p>Horizontal Rule</p>
          </TooltipContent>
        </Tooltip>
         <Separator orientation="vertical" className="h-6 mx-1" />
         <Tooltip>
          <TooltipTrigger asChild>
            <Button variant="outline" size="icon" className="h-8 w-8">
              <LinkIcon className="h-4 w-4" />
            </Button>
          </TooltipTrigger>
          <TooltipContent>
            <p>Link (Ctrl+K)</p>
          </TooltipContent>
        </Tooltip>
        <Tooltip>
          <TooltipTrigger asChild>
            <Button variant="outline" size="icon" className="h-8 w-8">
              <ImageIcon className="h-4 w-4" />
            </Button>
          </TooltipTrigger>
          <TooltipContent>
            <p>Image</p>
          </TooltipContent>
        </Tooltip>
        <Tooltip>
          <TooltipTrigger asChild>
            <Button variant="outline" size="icon" className="h-8 w-8">
              <Code className="h-4 w-4" />
            </Button>
          </TooltipTrigger>
          <TooltipContent>
            <p>Code Block</p>
          </TooltipContent>
        </Tooltip>
      </TooltipProvider>
    </div>
  );

const SeoPreview = ({ title, description, slug }: { title: string, description: string, slug: string }) => {
    const siteUrl = "https://tech.oblivion"; // This could be fetched from settings
    const fullUrl = `${siteUrl}/blog/${slug || 'new-post-slug'}`;

    return (
        <div className="p-4 border rounded-lg bg-background/50">
            <h3 className="text-blue-600 text-lg truncate">{title || "Meta Title Preview"}</h3>
            <p className="text-green-700 text-sm truncate">{fullUrl}</p>
            <p className="text-gray-600 dark:text-gray-400 text-sm line-clamp-2">{description || "This is how your meta description will appear in search results."}</p>
        </div>
    );
};

export default function EditorNewPage() {
  const [post, setPost] = useState({
    title: "",
    content: "",
    tags: "",
    category: "",
    status: "Draft",
    seoTitle: "",
    seoDescription: "",
    focusKeyword: "",
    slug: "",
  });

  const [wordCount, setWordCount] = useState(0);
  const [readingTime, setReadingTime] = useState(0);
  const [saving, setSaving] = useState(false)
  const [error, setError] = useState<string | null>(null)
  const [categories, setCategories] = useState<WpCategory[]>([])
  const [categoryTree, setCategoryTree] = useState<any[]>([])
  const [tagsList, setTagsList] = useState<string[]>([])
  const [catDialogOpen, setCatDialogOpen] = useState(false)
  const [newCat, setNewCat] = useState<{ name: string; slug: string; parent: string }>({ name: '', slug: '', parent: '' })
  const [creatingCat, setCreatingCat] = useState(false)
  const [catError, setCatError] = useState<string | null>(null)

  useEffect(() => {
    const words = post.content.trim().split(/\s+/).filter(Boolean);
    const count = words.length;
    setWordCount(count);
    setReadingTime(Math.ceil(count / 225));
  }, [post.content]);

  useEffect(() => {
    // Load taxonomies
    (async () => {
      try {
        const cats = await fetchAllCategories()
        setCategories(cats)
        setCategoryTree(buildCategoryTree(cats))
      } catch (e) {
        console.error('Failed to load categories', e)
      }
      try {
        const tags = await fetchAllTags()
        setTagsList(tags.map(t => t.name))
      } catch (e) {
        console.error('Failed to load tags', e)
      }
    })()
  }, [])

  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>) => {
    const { name, value } = e.target;
    setPost(prev => ({ ...prev, [name]: value }));
  };

  async function refreshCategories(selectId?: number) {
    try {
      const cats = await fetchAllCategories()
      setCategories(cats)
      const tree = buildCategoryTree(cats)
      setCategoryTree(tree)
      if (selectId) setPost(p => ({ ...p, category: String(selectId) }))
    } catch (e) {
      console.error('Failed to refresh categories', e)
    }
  }

  async function onCreateCategory() {
    setCreatingCat(true); setCatError(null)
    try {
      if (!newCat.name.trim()) throw new Error('Name is required')
      const payload: any = { name: newCat.name.trim() }
      if (newCat.slug.trim()) payload.slug = newCat.slug.trim()
      if (newCat.parent) payload.parent = Number(newCat.parent)
      const res = await createCategory(payload)
      const id = res?.id
      await refreshCategories(id)
      setCatDialogOpen(false)
      setNewCat({ name: '', slug: '', parent: '' })
    } catch (e: any) {
      setCatError(e.message || 'Failed to create category')
    } finally { setCreatingCat(false) }
  }

  function toWpStatus(ui: string, override?: 'draft'|'publish'|'pending') {
    if (override) return override
    const l = (ui || '').toLowerCase()
    if (l.includes('publish')) return 'publish'
    if (l.includes('pending')) return 'pending'
    return 'draft'
  }

  async function createPost(statusOverride?: 'draft'|'publish'|'pending') {
    setSaving(true); setError(null)
    try {
  const body: any = {
        title: post.title?.trim() || 'Untitled',
        content: post.content || '',
        status: toWpStatus(post.status, statusOverride),
        slug: post.slug?.trim() || undefined,
      }
  if (post.category) body.categories = [Number(post.category)].filter(Boolean)
  if (post.tags) body.tags = post.tags.split(',').map(s => s.trim()).filter(Boolean)
      const res = await fetch('/api/wp/posts', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      })
      if (!res.ok) {
        const t = await res.text()
        throw new Error(`Failed to save (${res.status}): ${t.slice(0,200)}`)
      }
      const created = await res.json()
      const id = created?.id || created?.data?.id
      if (id) {
        window.location.href = `/editor/${id}`
      } else {
        // Fallback to success toast
        alert('Post saved successfully')
      }
    } catch (e: any) {
      setError(e.message || 'Failed to save')
    } finally { setSaving(false) }
  }
  
  return (
    <div className="container mx-auto px-4 py-12">
      <div className="flex justify-between items-center mb-8">
        <h1 className="text-3xl font-bold">Create New Post</h1>
        <div className="flex gap-2">
          <RoleGate action="draft" as="span">
            <Button variant="outline" disabled={saving} onClick={() => createPost('draft')}>{saving ? 'Saving‚Ä¶' : 'Save Draft'}</Button>
          </RoleGate>
          <RoleGate action="publishOwn" as="span">
            <Button disabled={saving} onClick={() => createPost('publish')}>{saving ? 'Saving‚Ä¶' : 'Publish'}</Button>
          </RoleGate>
        </div>
      </div>
    {error && <div className="mb-4 text-sm text-red-600">{error}</div>}
      
      <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
        <div className="lg:col-span-8 space-y-6">
          <Card>
            <CardContent className="p-0">
              <div className="space-y-4">
                <div>
                  <Label htmlFor="title" className="sr-only">Title</Label>
                  <Input 
                    id="title" 
                    name="title"
                    value={post.title}
                    onChange={handleInputChange}
                    placeholder="Post Title" 
                    className="text-2xl font-bold h-auto p-4 border-none focus-visible:ring-0 shadow-none border-b rounded-none" 
                  />
                </div>
                <EditorToolbar />
                <div>
                  <Label htmlFor="content" className="sr-only">Body</Label>
                  <Textarea 
                    id="content" 
                    name="content"
                    value={post.content}
                    onChange={handleInputChange}
                    rows={20} 
                    placeholder="Start with an engaging intro to hook your readers..."
                    className="border-none focus-visible:ring-0 shadow-none text-base p-4"
                  />
                </div>
              </div>
            </CardContent>
            <CardFooter className="p-2 border-t text-sm text-muted-foreground">
                <p>{wordCount} words</p>
                <Separator orientation="vertical" className="h-4 mx-2" />
                <p>{readingTime} min read</p>
            </CardFooter>
          </Card>
        </div>
        
        <aside className="lg:col-span-4 space-y-6 lg:sticky top-20 self-start">
           <div className="space-y-6">
            <Accordion type="multiple" defaultValue={['publish', 'seo']} className="w-full">
              <AccordionItem value="publish">
                <AccordionTrigger className="font-semibold px-4 py-3 bg-card rounded-t-lg border">Publish</AccordionTrigger>
                <AccordionContent className="bg-card rounded-b-lg border border-t-0">
                  <div className="p-4 space-y-4">
                    <div>
                      <Label htmlFor="status">Status</Label>
                      <Select value={post.status} onValueChange={(value) => setPost(p => ({...p, status: value}))}>
                        <SelectTrigger id="status">
                          <SelectValue placeholder="Select status" />
                        </SelectTrigger>
                        <SelectContent>
                          <SelectItem value="Published">Published</SelectItem>
                          <SelectItem value="Draft">Draft</SelectItem>
                          <SelectItem value="Pending Review">Pending Review</SelectItem>
                        </SelectContent>
                      </Select>
                    </div>
              <div className="sticky bottom-0 bg-card/80 backdrop-blur py-2">
                <RoleGate action="publishOwn" as="span">
                  <Button className="w-full" disabled={saving} onClick={() => createPost(toWpStatus(post.status) as any)}>{saving ? 'Saving‚Ä¶' : 'Publish'}</Button>
                </RoleGate>
              </div>
                  </div>
                </AccordionContent>
              </AccordionItem>
              
              <AccordionItem value="taxonomy">
                <AccordionTrigger className="font-semibold px-4 py-3 bg-card rounded-t-lg border">Categories & Tags</AccordionTrigger>
                <AccordionContent className="bg-card rounded-b-lg border border-t-0">
                  <div className="p-4 grid gap-4">
                    <div>
                      <Label htmlFor="category">Category</Label>
                      <div className="flex items-center gap-2">
                      <Select value={post.category} onValueChange={(value) => setPost(p => ({...p, category: value}))}>
                        <SelectTrigger id="category">
                          <SelectValue placeholder="Select category" />
                        </SelectTrigger>
                        <SelectContent>
                          {categoryTree.length === 0 ? (
                            <SelectItem value="" disabled>No categories yet</SelectItem>
                          ) : (
                            categoryTree.map((node) => (
                              <CategoryOptions key={node.id} node={node} level={0} />
                            ))
                          )}
                        </SelectContent>
                      </Select>
                        <Dialog open={catDialogOpen} onOpenChange={setCatDialogOpen}>
                          <DialogTrigger asChild>
                            <Button type="button" variant="outline" size="sm">New Category</Button>
                          </DialogTrigger>
                          <DialogContent>
                            <DialogHeader>
                              <DialogTitle>Create Category</DialogTitle>
                              <DialogDescription>Add a new category. You can assign a parent for hierarchy.</DialogDescription>
                            </DialogHeader>
                            <div className="grid gap-3 py-2">
                              <div>
                                <Label htmlFor="newCatName">Name</Label>
                                <Input id="newCatName" value={newCat.name} onChange={(e) => setNewCat({ ...newCat, name: e.target.value })} placeholder="e.g., Technology" />
                              </div>
                              <div>
                                <Label htmlFor="newCatSlug">Slug (optional)</Label>
                                <Input id="newCatSlug" value={newCat.slug} onChange={(e) => setNewCat({ ...newCat, slug: e.target.value })} placeholder="technology" />
                              </div>
                              <div>
                                <Label htmlFor="newCatParent">Parent (optional)</Label>
                                <Select value={newCat.parent} onValueChange={(v) => setNewCat({ ...newCat, parent: v })}>
                                  <SelectTrigger id="newCatParent">
                                    <SelectValue placeholder="None" />
                                  </SelectTrigger>
                                  <SelectContent>
                                    <SelectItem value="">None</SelectItem>
                                    {categoryTree.map((node) => (
                                      <CategoryOptions key={node.id} node={node} level={0} />
                                    ))}
                                  </SelectContent>
                                </Select>
                              </div>
                              {catError && <p className="text-sm text-red-600" role="alert">{catError}</p>}
                            </div>
                            <DialogFooter>
                              <Button type="button" variant="outline" onClick={() => setCatDialogOpen(false)}>Cancel</Button>
                              <Button type="button" onClick={onCreateCategory} disabled={creatingCat}>{creatingCat ? 'Creating‚Ä¶' : 'Create'}</Button>
                            </DialogFooter>
                          </DialogContent>
                        </Dialog>
                      </div>
                      <p className="text-xs text-muted-foreground mt-1">Supports parent ‚Üí child hierarchy like WordPress</p>
                    </div>
                    <div>
                      <Label htmlFor="tags">Tags</Label>
                      <Input id="tags" name="tags" value={post.tags} onChange={handleInputChange} placeholder="Comma-separated tags" />
                       <div className="flex flex-wrap gap-2 mt-2">
                        {/* Example tags would appear here as they are added */}
                      </div>
                      {tagsList.length === 0 && (
                        <p className="text-xs text-muted-foreground">No tag suggestions yet.</p>
                      )}
                    </div>
                  </div>
                </AccordionContent>
              </AccordionItem>

              <AccordionItem value="image">
                <AccordionTrigger className="font-semibold px-4 py-3 bg-card rounded-t-lg border">Featured Image</AccordionTrigger>
                <AccordionContent className="bg-card rounded-b-lg border border-t-0">
                  <div className="p-4">
                    <div className="border-2 border-dashed rounded-lg p-6 text-center cursor-pointer hover:border-primary">
                      <Upload className="mx-auto h-8 w-8 text-muted-foreground" />
                      <p className="mt-2 text-sm text-muted-foreground">Click or drag to upload</p>
                    </div>
                  </div>
                </AccordionContent>
              </AccordionItem>

              <AccordionItem value="seo">
                <AccordionTrigger className="font-semibold px-4 py-3 bg-card rounded-t-lg border">SEO Settings</AccordionTrigger>
                <AccordionContent className="bg-card rounded-b-lg border border-t-0">
                  <div className="p-4 grid gap-4">
                    <SeoPreview title={post.seoTitle} description={post.seoDescription} slug={post.slug} />
                    <div>
                      <Label htmlFor="seoTitle">Meta Title</Label>
                      <Input id="seoTitle" name="seoTitle" value={post.seoTitle} onChange={handleInputChange} placeholder="Title for search engines" />
                    </div>
                    <div>
                      <Label htmlFor="seoDescription">Meta Description</Label>
                      <Textarea id="seoDescription" name="seoDescription" value={post.seoDescription} onChange={handleInputChange} rows={3} placeholder="Description for search engines" />
                    </div>
                    <div>
                      <Label htmlFor="focusKeyword">Focus Keyword</Label>
                      <Input id="focusKeyword" name="focusKeyword" value={post.focusKeyword} onChange={handleInputChange} placeholder="Main keyword for this post" />
                    </div>
                  </div>
                </AccordionContent>
              </AccordionItem>

              <AccordionItem value="linking">
                 <AccordionTrigger className="font-semibold px-4 py-3 bg-card rounded-t-lg border">Auto Internal Linking</AccordionTrigger>
                  <AccordionContent className="bg-card rounded-b-lg border border-t-0">
                      <div className="p-4 space-y-2">
                           <Label htmlFor="linkingKeywords">Focus Linking Keywords</Label>
                            <Textarea id="linkingKeywords" rows={4} placeholder="Enter keywords, one per line, to find linking opportunities." />
                            <Button variant="outline" className="w-full"><Bot className="mr-2 h-4 w-4" /> Generate Link Suggestions</Button>
                      </div>
                  </AccordionContent>
              </AccordionItem>
              
              <AccordionItem value="checklist">
                 <AccordionTrigger className="font-semibold px-4 py-3 bg-card rounded-t-lg border">SEO Checklist</AccordionTrigger>
                  <AccordionContent className="bg-card rounded-b-lg border border-t-0">
                       <Alert className="m-4">
                        <Info className="h-4 w-4" />
                        <AlertTitle>Pre-Publish Checks</AlertTitle>
                        <AlertDescription>
                            <ul className="list-disc pl-4 text-xs space-y-1 mt-2">
                                <li><strong>Title Length:</strong> 50-60 characters recommended.</li>
                                <li><strong>Meta Description:</strong> 150-160 characters recommended.</li>
                                <li><strong>Focus Keyword:</strong> Included in title, meta, and first paragraph.</li>
                                <li><strong>Featured Image:</strong> Set and has alt text.</li>
                                <li><strong>Internal Links:</strong> At least 1-2 relevant internal links.</li>
                            </ul>
                        </AlertDescription>
                      </Alert>
                  </AccordionContent>
              </AccordionItem>
            </Accordion>
           </div>
        </aside>
      </div>
    </div>
  )
}

function CategoryOptions({ node, level }: { node: any; level: number }) {
  const pad = '‚Äî'.repeat(level)
  return (
    <>
      <SelectItem value={String(node.id)}>{pad ? `${pad} ` : ''}{node.name}</SelectItem>
      {node.children?.map((child: any) => (
        <CategoryOptions key={child.id} node={child} level={level + 1} />
      ))}
    </>
  )
}


// ==== FILE: src\app\editor\[id]\page.tsx ====

'use client';

import { Upload, X, Bold, Italic, Link as LinkIcon, List, ListOrdered, Code, Strikethrough, Quote, Image as ImageIcon, Type, Minus, Info, Bot } from "lucide-react";
import React, { useState, useEffect } from "react";
import Link from "next/link";

import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Label } from "@/components/ui/label";
import { Card, CardContent, CardFooter } from "@/components/ui/card";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Badge } from "@/components/ui/badge";
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from "@/components/ui/tooltip";
import { Separator } from "@/components/ui/separator";
import { Alert, AlertDescription, AlertTitle } from "@/components/ui/alert";
import { Accordion, AccordionContent, AccordionItem, AccordionTrigger } from "@/components/ui/accordion";
import { RoleGate } from "@/hooks/useRoleGate";


const EditorToolbar = () => (
    <div className="flex items-center gap-1 border-b p-2 flex-wrap">
      <TooltipProvider>
        <Tooltip>
          <TooltipTrigger asChild>
            <Button variant="outline" size="icon" className="h-8 w-8">
              <Bold className="h-4 w-4" />
            </Button>
          </TooltipTrigger>
          <TooltipContent>
            <p>Bold (Ctrl+B)</p>
          </TooltipContent>
        </Tooltip>
        <Tooltip>
          <TooltipTrigger asChild>
            <Button variant="outline" size="icon" className="h-8 w-8">
              <Italic className="h-4 w-4" />
            </Button>
          </TooltipTrigger>
          <TooltipContent>
            <p>Italic (Ctrl+I)</p>
          </TooltipContent>
        </Tooltip>
        <Tooltip>
          <TooltipTrigger asChild>
            <Button variant="outline" size="icon" className="h-8 w-8">
              <Strikethrough className="h-4 w-4" />
            </Button>
          </TooltipTrigger>
          <TooltipContent>
            <p>Strikethrough</p>
          </TooltipContent>
        </Tooltip>
        <Separator orientation="vertical" className="h-6 mx-1" />
        <Tooltip>
          <TooltipTrigger asChild>
            <Button variant="outline" size="icon" className="h-8 w-8">
                <Type className="h-4 w-4" />
            </Button>
          </TooltipTrigger>
          <TooltipContent>
            <p>Heading</p>
          </TooltipContent>
        </Tooltip>
        <Tooltip>
          <TooltipTrigger asChild>
            <Button variant="outline" size="icon" className="h-8 w-8">
              <List className="h-4 w-4" />
            </Button>
          </TooltipTrigger>
          <TooltipContent>
            <p>Bulleted List</p>
          </TooltipContent>
        </Tooltip>
         <Tooltip>
          <TooltipTrigger asChild>
            <Button variant="outline" size="icon" className="h-8 w-8">
              <ListOrdered className="h-4 w-4" />
            </Button>
          </TooltipTrigger>
          <TooltipContent>
            <p>Numbered List</p>
          </TooltipContent>
        </Tooltip>
        <Tooltip>
          <TooltipTrigger asChild>
            <Button variant="outline" size="icon" className="h-8 w-8">
              <Quote className="h-4 w-4" />
            </Button>
          </TooltipTrigger>
          <TooltipContent>
            <p>Blockquote</p>
          </TooltipContent>
        </Tooltip>
        <Tooltip>
          <TooltipTrigger asChild>
            <Button variant="outline" size="icon" className="h-8 w-8">
              <Minus className="h-4 w-4" />
            </Button>
          </TooltipTrigger>
          <TooltipContent>
            <p>Horizontal Rule</p>
          </TooltipContent>
        </Tooltip>
         <Separator orientation="vertical" className="h-6 mx-1" />
         <Tooltip>
          <TooltipTrigger asChild>
            <Button variant="outline" size="icon" className="h-8 w-8">
              <LinkIcon className="h-4 w-4" />
            </Button>
          </TooltipTrigger>
          <TooltipContent>
            <p>Link (Ctrl+K)</p>
          </TooltipContent>
        </Tooltip>
        <Tooltip>
          <TooltipTrigger asChild>
            <Button variant="outline" size="icon" className="h-8 w-8">
              <ImageIcon className="h-4 w-4" />
            </Button>
          </TooltipTrigger>
          <TooltipContent>
            <p>Image</p>
          </TooltipContent>
        </Tooltip>
        <Tooltip>
          <TooltipTrigger asChild>
            <Button variant="outline" size="icon" className="h-8 w-8">
              <Code className="h-4 w-4" />
            </Button>
          </TooltipTrigger>
          <TooltipContent>
            <p>Code Block</p>
          </TooltipContent>
        </Tooltip>
      </TooltipProvider>
    </div>
  );

const SeoPreview = ({ title, description, slug }: { title: string, description: string, slug: string }) => {
    const siteUrl = "https://tech.oblivion"; // This could be fetched from settings
    const fullUrl = `${siteUrl}/blog/${slug}`;

    return (
        <div className="p-4 border rounded-lg bg-background/50">
            <h3 className="text-blue-600 text-lg truncate">{title || "Meta Title Preview"}</h3>
            <p className="text-green-700 text-sm truncate">{fullUrl}</p>
            <p className="text-gray-600 dark:text-gray-400 text-sm line-clamp-2">{description || "This is how your meta description will appear in search results."}</p>
        </div>
    );
};


export default function EditorEditPage({ params }: { params: { id: string } }) {
  const { id } = params;
  // Dummy post data, in a real app this would be fetched
  const [post, setPost] = useState({
    title: `Sample Post Title for ID ${id}`,
    content: `This is the existing content for the post. It can be a long-form text with multiple paragraphs...`,
    tags: "Next.js, Tailwind, AI",
    category: "Web Development",
    status: "Published",
    seoTitle: "Best Sample Post Title Ever | SEO Version",
    seoDescription: "An optimized meta description for the sample post to attract more clicks from search engines.",
    focusKeyword: "Sample Post",
    slug: `sample-post-for-id-${id}`,
  });
  
  const [wordCount, setWordCount] = useState(0);
  const [readingTime, setReadingTime] = useState(0);
  const [saving, setSaving] = useState(false)
  const [error, setError] = useState<string | null>(null)

  useEffect(() => {
    const words = post.content.trim().split(/\s+/).filter(Boolean);
    const count = words.length;
    setWordCount(count);
    setReadingTime(Math.ceil(count / 225)); // Average reading speed
  }, [post.content]);

  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>) => {
    const { name, value } = e.target;
    setPost(prev => ({ ...prev, [name]: value }));
  };

  async function updatePost() {
    setSaving(true); setError(null)
    try {
      const body = {
        title: post.title?.trim() || undefined,
        content: post.content || undefined,
        // Map UI status to WP status
        status: (post.status || '').toLowerCase().includes('publish') ? 'publish' : ((post.status || '').toLowerCase().includes('pending') ? 'pending' : 'draft'),
        slug: post.slug?.trim() || undefined,
      }
      const res = await fetch(`/api/wp/posts?id=${encodeURIComponent(id)}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      })
      if (!res.ok) {
        const t = await res.text()
        throw new Error(`Failed to update (${res.status}): ${t.slice(0,200)}`)
      }
      alert('Post updated')
    } catch (e: any) {
      setError(e.message || 'Failed to update')
    } finally { setSaving(false) }
  }

  return (
    <div className="container mx-auto px-4 py-12">
      <div className="flex justify-between items-center mb-8">
        <h1 className="text-3xl font-bold">Edit Post</h1>
        <div className="flex gap-2">
          <Button variant="outline">Preview</Button>
          <RoleGate action="draft" as="span">
            <Button disabled={saving} onClick={updatePost}>{saving ? 'Saving‚Ä¶' : 'Update Post'}</Button>
          </RoleGate>
        </div>
      </div>
    {error && <div className="mb-4 text-sm text-red-600">{error}</div>}
      
      <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
        <div className="lg:col-span-8 space-y-6">
          <Card>
            <CardContent className="p-0">
              <div className="space-y-4">
                <div>
                  <Label htmlFor="title" className="sr-only">Title</Label>
                  <Input 
                    id="title" 
                    name="title"
                    value={post.title} 
                    onChange={handleInputChange}
                    placeholder="Post Title" 
                    className="text-2xl font-bold h-auto p-4 border-none focus-visible:ring-0 shadow-none border-b rounded-none" 
                  />
                </div>
                 <EditorToolbar />
                <div>
                  <Label htmlFor="content" className="sr-only">Body</Label>
                  <Textarea 
                    id="content" 
                    name="content"
                    value={post.content} 
                    onChange={handleInputChange}
                    rows={20} 
                    placeholder="Start with an engaging intro to hook your readers..."
                    className="border-none focus-visible:ring-0 shadow-none text-base p-4"
                  />
                </div>
              </div>
            </CardContent>
            <CardFooter className="p-2 border-t text-sm text-muted-foreground">
                <p>{wordCount} words</p>
                <Separator orientation="vertical" className="h-4 mx-2" />
                <p>{readingTime} min read</p>
            </CardFooter>
          </Card>
        </div>
        
        <aside className="lg:col-span-4 space-y-6 lg:sticky top-20 self-start">
          <div className="space-y-6">
            <Accordion type="multiple" defaultValue={['publish', 'seo']} className="w-full">
              <AccordionItem value="publish">
                <AccordionTrigger className="font-semibold px-4 py-3 bg-card rounded-t-lg border">Publish</AccordionTrigger>
                <AccordionContent className="bg-card rounded-b-lg border border-t-0">
                  <div className="p-4 space-y-4">
                    <div>
                      <Label htmlFor="status">Status</Label>
                      <Select value={post.status} onValueChange={(value) => setPost(p => ({...p, status: value}))}>
                        <SelectTrigger id="status">
                          <SelectValue placeholder="Select status" />
                        </SelectTrigger>
                        <SelectContent>
                          <SelectItem value="Published">Published</SelectItem>
                          <SelectItem value="Draft">Draft</SelectItem>
                          <SelectItem value="Pending Review">Pending Review</SelectItem>
                        </SelectContent>
                      </Select>
                    </div>
              <div className="sticky bottom-0 bg-card/80 backdrop-blur py-2">
                <RoleGate action="draft" as="span">
                  <Button className="w-full" disabled={saving} onClick={updatePost}>{saving ? 'Saving‚Ä¶' : 'Update'}</Button>
                </RoleGate>
              </div>
                  </div>
                </AccordionContent>
              </AccordionItem>

              <AccordionItem value="taxonomy">
                <AccordionTrigger className="font-semibold px-4 py-3 bg-card rounded-t-lg border">Categories & Tags</AccordionTrigger>
                <AccordionContent className="bg-card rounded-b-lg border border-t-0">
                  <div className="p-4 grid gap-4">
                    <div>
                      <Label htmlFor="category">Category</Label>
                      <Input id="category" name="category" value={post.category} onChange={handleInputChange} placeholder="e.g., Technology" />
                    </div>
                    <div>
                      <Label htmlFor="tags">Tags</Label>
                      <Input id="tags" name="tags" value={post.tags} onChange={handleInputChange} placeholder="Comma-separated tags" />
                      <div className="flex flex-wrap gap-2 mt-2">
                        {post.tags.split(',').map(tag => tag.trim() && (
                          <Badge key={tag} variant="secondary">{tag.trim()} <Button variant="ghost" size="icon" className="h-4 w-4 ml-1 p-0"><X className="h-3 w-3"/></Button></Badge>
                        ))}
                      </div>
                    </div>
                  </div>
                </AccordionContent>
              </AccordionItem>

              <AccordionItem value="image">
                <AccordionTrigger className="font-semibold px-4 py-3 bg-card rounded-t-lg border">Featured Image</AccordionTrigger>
                <AccordionContent className="bg-card rounded-b-lg border border-t-0">
                  <div className="p-4">
                    <div className="border-2 border-dashed rounded-lg p-6 text-center cursor-pointer hover:border-primary">
                      <Upload className="mx-auto h-8 w-8 text-muted-foreground" />
                      <p className="mt-2 text-sm text-muted-foreground">Click or drag to upload</p>
                    </div>
                  </div>
                </AccordionContent>
              </AccordionItem>

              <AccordionItem value="seo">
                <AccordionTrigger className="font-semibold px-4 py-3 bg-card rounded-t-lg border">SEO Settings</AccordionTrigger>
                <AccordionContent className="bg-card rounded-b-lg border border-t-0">
                  <div className="p-4 grid gap-4">
                    <SeoPreview title={post.seoTitle} description={post.seoDescription} slug={post.slug} />
                    <div>
                      <Label htmlFor="seoTitle">Meta Title</Label>
                      <Input id="seoTitle" name="seoTitle" value={post.seoTitle} onChange={handleInputChange} placeholder="Title for search engines" />
                    </div>
                    <div>
                      <Label htmlFor="seoDescription">Meta Description</Label>
                      <Textarea id="seoDescription" name="seoDescription" value={post.seoDescription} onChange={handleInputChange} rows={3} placeholder="Description for search engines" />
                    </div>
                    <div>
                      <Label htmlFor="focusKeyword">Focus Keyword</Label>
                      <Input id="focusKeyword" name="focusKeyword" value={post.focusKeyword} onChange={handleInputChange} placeholder="Main keyword for this post" />
                    </div>
                  </div>
                </AccordionContent>
              </AccordionItem>
              
              <AccordionItem value="linking">
                 <AccordionTrigger className="font-semibold px-4 py-3 bg-card rounded-t-lg border">Auto Internal Linking</AccordionTrigger>
                  <AccordionContent className="bg-card rounded-b-lg border border-t-0">
                      <div className="p-4 space-y-2">
                           <Label htmlFor="linkingKeywords">Focus Linking Keywords</Label>
                            <Textarea id="linkingKeywords" rows={4} placeholder="Enter keywords, one per line, to find linking opportunities." />
                            <Button variant="outline" className="w-full"><Bot className="mr-2 h-4 w-4" /> Generate Link Suggestions</Button>
                      </div>
                  </AccordionContent>
              </AccordionItem>

              <AccordionItem value="checklist">
                 <AccordionTrigger className="font-semibold px-4 py-3 bg-card rounded-t-lg border">SEO Checklist</AccordionTrigger>
                  <AccordionContent className="bg-card rounded-b-lg border border-t-0">
                       <Alert className="m-4">
                        <Info className="h-4 w-4" />
                        <AlertTitle>Pre-Publish Checks</AlertTitle>
                        <AlertDescription>
                            <ul className="list-disc pl-4 text-xs space-y-1 mt-2">
                                <li><strong>Title Length:</strong> 50-60 characters recommended.</li>
                                <li><strong>Meta Description:</strong> 150-160 characters recommended.</li>
                                <li><strong>Focus Keyword:</strong> Included in title, meta, and first paragraph.</li>
                                <li><strong>Featured Image:</strong> Set and has alt text.</li>
                                <li><strong>Internal Links:</strong> At least 1-2 relevant internal links.</li>
                            </ul>
                        </AlertDescription>
                      </Alert>
                  </AccordionContent>
              </AccordionItem>
            </Accordion>
          </div>
        </aside>
      </div>
    </div>
  )
}


// ==== FILE: src\app\login\page.tsx ====
'use client'

import { useEffect, useState } from 'react'

export default function LoginPage() {
  const [identifier, setIdentifier] = useState('')
  const [password, setPassword] = useState('')
  const [error, setError] = useState<string | null>(null)
  const [loading, setLoading] = useState(false)
  const [nextUrl, setNextUrl] = useState<string | null>(null)

  useEffect(() => {
    try {
      const u = new URL(window.location.href)
      const n = u.searchParams.get('next')
      if (n) setNextUrl(n)
    } catch {}
    // If already logged in, bounce early
    ;(async () => {
      try {
        const r = await fetch('/api/auth/me', { cache: 'no-store' })
        if (r.ok) {
          const d = await r.json()
          if (d?.user) {
            window.location.href = nextUrl || '/account'
          }
        }
      } catch {}
    })()
  }, [])

  const onSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    setError(null)
    setLoading(true)
    try {
      const res = await fetch('/api/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ identifier, password }),
      })
      if (!res.ok) {
        const j = await res.json().catch(() => ({}))
        throw new Error(j?.message || 'Login failed')
      }
  window.location.href = nextUrl || '/account'
    } catch (e: any) {
      setError(e.message)
    } finally { setLoading(false) }
  }

  return (
    <div className="container mx-auto px-4 py-10 max-w-md">
      <h1 className="text-2xl font-semibold mb-6">Login</h1>
      <form onSubmit={onSubmit} className="space-y-4">
        <div>
          <label className="block text-sm mb-1">Username or Email</label>
          <input className="w-full border rounded px-3 py-2" value={identifier} onChange={e => setIdentifier(e.target.value)} />
        </div>
        <div>
          <label className="block text-sm mb-1">Password</label>
          <input type="password" className="w-full border rounded px-3 py-2" value={password} onChange={e => setPassword(e.target.value)} />
        </div>
        {error && <p className="text-sm text-red-600">{error}</p>}
        <button disabled={loading} className="bg-primary text-primary-foreground px-4 py-2 rounded w-full">{loading ? 'Signing in‚Ä¶' : 'Sign In'}</button>
      </form>
    </div>
  )
}


// ==== FILE: src\app\test\page.tsx ====
'use client'

import { useEffect, useState } from 'react'

import type { WordPressPost } from '@/lib/wordpress-client'

export default function TestPage() {
  const [posts, setPosts] = useState<WordPressPost[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    const fetchPosts = async () => {
      try {
        setLoading(true)
        const res = await fetch('/api/wp/posts?per_page=3&_embed=1')
        if (!res.ok) throw new Error(`Failed: ${res.status}`)
        const items: WordPressPost[] = await res.json()
        setPosts(items)
        setError(null)
      } catch (err) {
        setError(err instanceof Error ? err.message : 'Failed to fetch posts')
      } finally {
        setLoading(false)
      }
    }

    fetchPosts();
  }, []);

  if (loading) {
    return (
      <div className="container mx-auto p-8">
        <h1 className="text-2xl font-bold mb-4">WordPress Direct Connection Test</h1>
        <p>Loading posts...</p>
      </div>
    );
  }

  if (error) {
    return (
      <div className="container mx-auto p-8">
        <h1 className="text-2xl font-bold mb-4">WordPress Direct Connection Test</h1>
        <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
          <strong>Error:</strong> {error}
        </div>
      </div>
    );
  }

  return (
    <div className="container mx-auto p-8">
      <h1 className="text-2xl font-bold mb-4">WordPress Direct Connection Test</h1>
      <p className="mb-4 text-green-600">‚úÖ Successfully connected to WordPress!</p>
      
      <div className="grid gap-4">
        {posts.map((post) => (
          <div key={post.id} className="border p-4 rounded-lg">
            <h2 className="text-xl font-semibold mb-2">
              {post.title.rendered}
            </h2>
            <p className="text-gray-600 mb-2">
              Posted: {new Date(post.date).toLocaleDateString()}
            </p>
            <div className="text-sm text-gray-500">
              {post.excerpt.rendered.replace(/<[^>]+>/g, '').slice(0, 200)}...
            </div>
            {post._embedded?.['wp:featuredmedia']?.[0] && (
              <div className="mt-2">
                <img 
                  src={post._embedded['wp:featuredmedia'][0].source_url}
                  alt={post._embedded['wp:featuredmedia'][0].alt_text || post.title.rendered}
                  className="w-32 h-32 object-cover rounded"
                />
              </div>
            )}
          </div>
        ))}
      </div>
    </div>
  );
}


// ==== FILE: src\components\author-activity.tsx ====
"use client"

import { useEffect, useState } from 'react'
import Link from 'next/link'
import { ArrowUpRight } from 'lucide-react'

import ClientImage from '@/components/ui/client-image'
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card'
import { decodeEntities, htmlToText } from '@/lib/text'

type WPPost = any
type WPComment = any

export default function AuthorActivity({ authorId }: { authorId: number }) {
  const [posts, setPosts] = useState<WPPost[]>([])
  const [comments, setComments] = useState<WPComment[]>([])
  const [postIndex, setPostIndex] = useState<Record<number, { slug?: string; title?: string }>>({})
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    let active = true
    ;(async () => {
      setLoading(true)
      try {
        const [pRes, cRes] = await Promise.all([
          fetch(`/api/wp/posts?author=${authorId}&_embed=1&per_page=6`, { cache: 'no-store' }),
          fetch(`/api/wp/comments?user_id=${authorId}&per_page=6&order=desc&orderby=date&_embed=1`, { cache: 'no-store' }),
        ])
        const p = pRes.ok ? await pRes.json() : []
        const c = cRes.ok ? await cRes.json() : []
        if (!active) return
        setPosts(Array.isArray(p) ? p : [])
        const clist = Array.isArray(c) ? c : []
        setComments(clist)

        // Resolve post titles/slugs for comments via a single include query
        const ids = Array.from(new Set((clist || []).map((cm: any) => Number(cm?.post)).filter(Boolean)))
        if (ids.length) {
          try {
            const inc = await fetch(`/api/wp/posts?include=${ids.join(',')}&per_page=${ids.length}`, { cache: 'no-store' })
            if (inc.ok) {
              const plist = await inc.json()
              const idx: Record<number, { slug?: string; title?: string }> = {}
              if (Array.isArray(plist)) {
                for (const it of plist) {
                  if (it?.id) idx[Number(it.id)] = { slug: it.slug, title: decodeEntities(it?.title?.rendered || it?.title || '') }
                }
              }
              if (active) setPostIndex(idx)
            }
          } catch {}
        } else {
          if (active) setPostIndex({})
        }
      } catch {
        if (!active) return
        setPosts([])
        setComments([])
        setPostIndex({})
      } finally {
        if (active) setLoading(false)
      }
    })()
    return () => { active = false }
  }, [authorId])

  return (
    <div className="grid md:grid-cols-2 gap-6">
      <div>
        <h2 className="text-xl font-semibold mb-3">Recent Posts</h2>
        {loading && posts.length === 0 ? (
          <div className="border-2 border-dashed rounded-lg p-6 text-center text-muted-foreground">Loading‚Ä¶</div>
        ) : posts.length === 0 ? (
          <div className="border-2 border-dashed rounded-lg p-6 text-center text-muted-foreground">No posts yet.</div>
        ) : (
          <div className="space-y-4">
            {posts.slice(0, 6).map((p: any) => (
              <Card key={p.id} className="bg-card/50">
                <CardHeader className="p-4 pb-2">
                  <CardTitle className="text-base"><Link href={`/blog/${p.slug}`}>{decodeEntities(p.title?.rendered || p.title || '')}</Link></CardTitle>
                  <CardDescription>{new Date(p.date).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}</CardDescription>
                </CardHeader>
                <CardContent className="p-4 pt-0">
                  <div className="flex gap-3">
                    <div className="relative w-20 h-14 flex-shrink-0">
                      <ClientImage src={p._embedded?.['wp:featuredmedia']?.[0]?.source_url || '/favicon.ico'} alt={decodeEntities(p.title?.rendered || p.title || '')} fill className="object-cover rounded" sizes="80px" />
                    </div>
                    <p className="text-sm text-muted-foreground line-clamp-3">{htmlToText(p.excerpt?.rendered || '').slice(0, 160)}</p>
                  </div>
                </CardContent>
              </Card>
            ))}
          </div>
        )}
      </div>
      <div>
        <h2 className="text-xl font-semibold mb-3">Recent Comments</h2>
        {loading && comments.length === 0 ? (
          <div className="border-2 border-dashed rounded-lg p-6 text-center text-muted-foreground">Loading‚Ä¶</div>
        ) : comments.length === 0 ? (
          <div className="border-2 border-dashed rounded-lg p-6 text-center text-muted-foreground">No comments yet.</div>
        ) : (
          <div className="space-y-4">
            {comments.slice(0, 6).map((c: any) => {
              const meta = postIndex[Number(c.post)] || {}
              const postTitle = meta.title || `Post #${c.post}`
              const href = meta.slug ? `/blog/${meta.slug}` : undefined
              const full = htmlToText(c?.content?.rendered || '').trim()
              const heading = full.slice(0, 120)
              const rest = full.length > 120 ? full.slice(120, 320) : ''
              return (
                <Card key={c.id} className="bg-card/60 border-l-4 border-primary">
                  <CardHeader className="p-4 pb-2 flex flex-row items-start justify-between gap-3">
                    <div className="min-w-0">
                      <div className="flex items-center gap-2 mb-1">
                        <span className="inline-block text-[10px] uppercase tracking-wide text-primary/90 bg-primary/10 rounded px-1.5 py-0.5">Recent</span>
                        <CardDescription className="mt-0">{new Date(c.date).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}</CardDescription>
                      </div>
                      <CardTitle className="text-base">
                        {heading || '‚Äî'}
                      </CardTitle>
                      <CardDescription className="truncate">
                        {href ? <Link href={href} className="hover:underline">On: {postTitle}</Link> : <>On: {postTitle}</>}
                      </CardDescription>
                    </div>
                    {href && (
                      <Link href={`${href}#comment-${c.id}`} aria-label={`View on ${postTitle}`} className="text-muted-foreground hover:text-foreground flex-shrink-0 mt-1">
                        <ArrowUpRight className="h-4 w-4" />
                      </Link>
                    )}
                  </CardHeader>
                  {rest && (
                    <CardContent className="p-4 pt-0 text-sm text-foreground/80">{rest}</CardContent>
                  )}
                </Card>
              )
            })}
          </div>
        )}
      </div>
    </div>
  )
}


// ==== FILE: src\components\AuthorsList.tsx ====
"use client";

import React, { useEffect, useState } from "react";
import Link from "next/link";

import { getUsers } from "@/lib/wp";

type AvatarUrls = Record<string, string>;
type ProfileFields = Record<string, unknown> | null | undefined;

type Author = {
  id: number | string;
  name: string;
  slug: string;
  description?: string;
  avatar_urls?: AvatarUrls;
  profile_fields?: ProfileFields;
};

export default function AuthorsList() {
  const [authors, setAuthors] = useState<Author[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    let cancelled = false;

  async function load() {
      setLoading(true);
      setError(null);
      try {
        const users = await getUsers({ context: "view" });
        const mapped: Author[] = (users || []).map((u) => ({
          id: u.id,
          name: u.name || u.display_name || u.slug || String(u.id),
          slug: u.slug || String(u.id),
          description: u.description || "",
          avatar_urls: u.avatar_urls || {},
          profile_fields: undefined,
        }));
        if (!cancelled) setAuthors(mapped);
      } catch (e: any) {
        if (!cancelled) setError(e?.message || "Failed to load authors");
      } finally {
        if (!cancelled) setLoading(false);
      }
    }

    load();
    return () => {
      cancelled = true;
    };
  }, []);

  if (loading) {
    return (
      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        {Array.from({ length: 6 }).map((_, i) => (
          <div key={i} className="rounded-2xl border bg-card shadow-sm p-6 animate-pulse">
            <div className="flex items-center gap-4">
              <div className="h-16 w-16 rounded-full bg-muted" />
              <div className="flex-1">
                <div className="h-4 w-32 bg-muted rounded mb-2" />
                <div className="h-3 w-48 bg-muted rounded" />
              </div>
            </div>
            <div className="mt-4 space-y-2">
              <div className="h-3 w-full bg-muted rounded" />
              <div className="h-3 w-5/6 bg-muted rounded" />
            </div>
          </div>
        ))}
      </div>
    );
  }

  if (error) {
    return (
      <div className="rounded-2xl border bg-destructive/10 text-destructive p-6">
        <div className="font-semibold mb-1">Failed to load authors</div>
        <div className="text-sm opacity-80">{error}</div>
      </div>
    );
  }

  return (
    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
      {authors.map((a) => {
        const avatar = a.avatar_urls?.["96"] || a.avatar_urls?.["48"] || a.avatar_urls?.["24"] || "";
        return (
          <article key={a.id} className="rounded-2xl border bg-card shadow-sm p-6 flex flex-col">
            <div className="flex items-center gap-4">
              <img
                src={avatar}
                alt={a.name}
                className="h-16 w-16 rounded-full object-cover border"
                loading="lazy"
                decoding="async"
              />
              <div>
                <h3 className="text-lg font-semibold leading-tight">
                  <Link href={`/profile/${encodeURIComponent(a.slug)}`} className="hover:underline">
                    {a.name}
                  </Link>
                </h3>
                <p className="text-sm text-muted-foreground">@{a.slug}</p>
              </div>
            </div>

            {a.description && (
              <p className="mt-4 text-sm leading-6 text-muted-foreground">
                {a.description}
              </p>
            )}

            {a.profile_fields && typeof a.profile_fields === "object" && (
              <div className="mt-4 text-sm">
                <div className="text-muted-foreground mb-2 font-medium">Profile</div>
                <dl className="grid grid-cols-1 gap-2">
                  {Object.entries(a.profile_fields).map(([k, v]) => (
                    <div key={k} className="flex gap-2">
                      <dt className="min-w-20 text-muted-foreground capitalize">{k}</dt>
                      <dd className="flex-1 break-words">
                        {typeof v === "string" || typeof v === "number" || typeof v === "boolean"
                          ? String(v)
                          : Array.isArray(v)
                          ? v.join(", ")
                          : v === null
                          ? "‚Äî"
                          : JSON.stringify(v)}
                      </dd>
                    </div>
                  ))}
                </dl>
              </div>
            )}
          </article>
        );
      })}
    </div>
  );
}


// ==== FILE: src\components\back-to-top-center.tsx ====
"use client"
import { useEffect, useState } from 'react'
import { ArrowUp } from 'lucide-react'

export default function BackToTopCenter({ threshold = 400 }: { threshold?: number }) {
  const [visible, setVisible] = useState(false)

  useEffect(() => {
    const onScroll = () => setVisible(window.scrollY > threshold)
    onScroll()
    window.addEventListener('scroll', onScroll, { passive: true })
    return () => window.removeEventListener('scroll', onScroll)
  }, [threshold])

  if (!visible) return null

  return (
    <button
      type="button"
      aria-label="Back to top"
      className="fixed bottom-6 left-1/2 -translate-x-1/2 z-[68] px-3 py-1.5 rounded-full border bg-card/90 backdrop-blur shadow text-sm inline-flex items-center gap-1 hover:bg-card"
      onClick={() => { try { window.scrollTo({ top: 0, behavior: 'smooth' }) } catch { window.scrollTo(0,0) } }}
    >
      <ArrowUp className="h-4 w-4" />
      Top
    </button>
  )
}


// ==== FILE: src\components\Category.tsx ====
import Link from 'next/link';
import React from 'react';

interface CategoryProps {
  category: {
    id: number;
    name: string;
    slug: string;
  };
}

const Category: React.FC<CategoryProps> = ({ category }) => {
  return (
    <Link href={`/category/${category.slug}`}>
      {category.name}
    </Link>
  );
};

export default Category;

// ==== FILE: src\components\client-feed.tsx ====
"use client"

import { useState, useEffect } from 'react'

import { cn } from '@/lib/utils'
import { htmlToText } from '@/lib/text'
// Use internal API to avoid direct browser calls to WordPress
import type { WordPressPost } from '@/lib/wordpress-client'

import { PostCard } from './post-card'

type Post = {
  id: string
  title: string
  author: string
  avatar: string
  imageUrl: string
  imageHint: string
  excerpt: string
  slug: string
}

export function ClientFeed({ layout = 'list', perPage = 4 }: { layout?: 'list' | 'grid', perPage?: number }) {
  const [posts, setPosts] = useState<Post[]>([])
  const [page, setPage] = useState(1)
  const [loading, setLoading] = useState(false)

  useEffect(() => { loadPage(1) }, [])

  async function loadPage(p: number) {
    setLoading(true)
    try {
      const params = new URLSearchParams({ page: String(p), per_page: String(perPage), _embed: '1' })
      const res = await fetch(`/api/wp/posts?${params.toString()}`)
      if (!res.ok) throw new Error(`Failed to load posts: ${res.status}`)
      const posts: WordPressPost[] = await res.json()
      const mapped = posts.map((post: WordPressPost) => ({
        id: String(post.id),
        title: post.title.rendered,
        author: 'Tech Oblivion',
        avatar: '/favicon.ico',
        imageUrl: post._embedded?.['wp:featuredmedia']?.[0]?.source_url || '/favicon.ico',
        imageHint: post._embedded?.['wp:featuredmedia']?.[0]?.alt_text || post.title.rendered,
  excerpt: htmlToText(post.excerpt.rendered).slice(0,240),
        slug: post.slug,
      }))
      if (p === 1) setPosts(mapped)
      else setPosts(prev => [...prev, ...mapped])
      setPage(p)
    } catch (e) {
      console.error('Error loading posts:', e)
    } finally { setLoading(false) }
  }

  const wrapperClass = cn(
    'grid gap-6',
    layout === 'grid' ? 'grid-cols-1 sm:grid-cols-2 lg:grid-cols-3' : 'grid-cols-1'
  )

  return (
    <>
      <div className={wrapperClass}>
        {posts.map(p => <PostCard key={p.id} post={p as any} layout={layout as any} />)}
      </div>
      <div className="flex justify-center mt-6">
        <button className="btn" onClick={() => loadPage(page + 1)} disabled={loading}>{loading ? 'Loading...' : 'Load more'}</button>
      </div>
    </>
  )
}


// ==== FILE: src\components\Comment.tsx ====
import React from 'react';

interface CommentProps {
  comment: {
    author_name: string;
    content: {
      rendered: string;
    };
  };
}

const Comment: React.FC<CommentProps> = ({ comment }) => {
  return (
    <div className="comment">
      <p><strong>{comment.author_name}</strong></p>
      <div dangerouslySetInnerHTML={{ __html: comment.content.rendered }} />
    </div>
  );
};

export default Comment;

// ==== FILE: src\components\CommentFormGate.tsx ====
"use client"
import Link from 'next/link'

import { Button } from '@/components/ui/button'
import { Textarea } from '@/components/ui/textarea'
import { RoleGate, useRoleGate } from '@/hooks/useRoleGate'

export default function CommentFormGate() {
  const { allowed, reason } = useRoleGate('comment')
  return (
    <form className="grid gap-4">
      <Textarea placeholder={allowed ? "Write a comment..." : "Log in to comment."} rows={4} disabled={!allowed} />
      {!allowed && (
        <div className="text-sm text-muted-foreground">{reason} <Link href="/login" className="underline">Log in</Link></div>
      )}
      <RoleGate action="comment" as="span">
        <Button className="justify-self-end">Post Comment</Button>
      </RoleGate>
    </form>
  )
}


// ==== FILE: src\components\comments-section.tsx ====
"use client"
import { useEffect, useMemo, useState } from 'react'
import Link from 'next/link'

import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar'
import { Button } from '@/components/ui/button'
import { Textarea } from '@/components/ui/textarea'
import { RoleGate, useRoleGate } from '@/hooks/useRoleGate'
import { Input } from '@/components/ui/input'
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'
// Removed likes UI per requirements

type Comment = {
  id: string | number
  author: { name: string; avatar?: string; id?: number; slug?: string }
  content: string
  createdAt: string
  replies?: Comment[]
}

export default function CommentsSection({ postId }: { postId: number }) {
  const [comments, setComments] = useState<Comment[]>([])
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)
  const { allowed } = useRoleGate('comment')
  const [content, setContent] = useState('')
  const [submitting, setSubmitting] = useState(false)
  const [sort, setSort] = useState<'new' | 'old'>('new')
  const [query, setQuery] = useState('')

  function mapWpToComment(wpc: unknown): Comment {
    const obj = (wpc && typeof wpc === 'object') ? (wpc as Record<string, unknown>) : {}
    const name = (typeof obj.author_name === 'string' ? obj.author_name : (obj.author && typeof obj.author === 'object' && typeof (obj.author as Record<string, unknown>).name === 'string' ? (obj.author as Record<string, unknown>).name : 'Anonymous')) as string
    const avatars = (obj.author_avatar_urls && typeof obj.author_avatar_urls === 'object' ? obj.author_avatar_urls as Record<string | number, unknown> : {})
    const avatar = String(avatars['48'] || avatars[48] || avatars['96'] || avatars[96] || avatars['24'] || avatars[24] || '')
    const contentField = (obj.content && typeof obj.content === 'object' ? (obj.content as Record<string, unknown>).rendered : obj.content)
    const contentHtml = typeof contentField === 'string' ? contentField : ''
    const contentText = typeof contentHtml === 'string' ? contentHtml.replace(/<[^>]*>/g, '').trim() : ''
    const createdAt = String(obj.date || obj.date_gmt || new Date().toISOString())
    return {
      id: (obj.id as string | number | undefined) ?? (obj.comment_ID as string | number | undefined) ?? String(Math.random()),
      author: { name, avatar, id: typeof obj.author === 'number' ? (obj.author as number) : undefined },
      content: contentText,
      createdAt,
    }
  }

  useEffect(() => {
    let cancelled = false
    async function load() {
      setLoading(true)
      setError(null)
      try {
        // Placeholder: try API if exists; otherwise empty list
        const r = await fetch(`/api/wp/comments?post=${postId}`, { cache: 'no-store' })
        if (!cancelled && r.ok) {
          const data = await r.json().catch(() => [])
          const arr = Array.isArray(data) ? data : []
          // Enrich with author slugs in a single batch
          const mapped = arr.map(mapWpToComment)
          const ids = Array.from(new Set(mapped.map(c => c.author?.id).filter(Boolean))) as number[]
          if (ids.length) {
            try {
              const site = (process.env.NEXT_PUBLIC_SITE_URL || '').replace(/\/$/, '') || ''
              const url = `${site}/api/wp/users?include=${ids.join(',')}&per_page=${Math.min(ids.length, 100)}`
              const ur = await fetch(url, { cache: 'no-store' })
              if (ur.ok) {
        const users = await ur.json().catch(() => []) as Array<Record<string, unknown>>
                const map = new Map<number, string>()
        users.forEach(u => { if (typeof u.id === 'number' && typeof u.slug === 'string') map.set(Number(u.id), String(u.slug)) })
                setComments(mapped.map(c => ({
                  ...c,
                  author: { ...c.author, slug: c.author?.id ? map.get(c.author.id) : undefined }
                })))
              } else {
                setComments(mapped)
              }
      } catch {
              setComments(mapped)
            }
          } else {
            setComments(mapped)
          }
        } else if (!cancelled) {
          setComments([])
        }
    } catch {
        if (!cancelled) setComments([])
      } finally {
        if (!cancelled) setLoading(false)
      }
    }
    load()
    return () => { cancelled = true }
  }, [postId])

  const filteredSorted = useMemo(() => {
    let arr = comments
    if (query.trim()) {
      const q = query.toLowerCase()
      arr = arr.filter(c => (c.author?.name || '').toLowerCase().includes(q) || (c.content || '').toLowerCase().includes(q))
    }
    const s = [...arr].sort((a,b) => (new Date(a.createdAt).getTime() - new Date(b.createdAt).getTime()))
    return sort === 'new' ? s.reverse() : s
  }, [comments, sort, query])

  async function onSubmit(e: React.FormEvent) {
    e.preventDefault()
    if (!content.trim()) return
    setSubmitting(true)
    try {
      const r = await fetch('/api/wp/comments', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ postId, content })
      })
      if (r.ok) {
        setContent('')
        // Reload comments after successful post
        const j = await r.json().catch(() => null)
        // Optimistic: prepend new comment if returned, else refetch
        if (j && j.id) {
          setComments(prev => [{ id: j.id, author: { name: j.author_name || 'You', avatar: j.author_avatar_urls?.['48'] || '' }, content: (j.content?.rendered || '').replace(/<[^>]*>/g, '').trim(), createdAt: j.date || new Date().toISOString() }, ...prev])
        } else {
          // best-effort refetch
          try {
            const rr = await fetch(`/api/wp/comments?post=${postId}`, { cache: 'no-store' })
            const data = await rr.json().catch(() => [])
            const arr = Array.isArray(data) ? data : []
            setComments(arr.map((d: unknown) => mapWpToComment(d)))
          } catch {
            // TODO: implement fetch error handling
          }
        }
      }
    } finally {
      setSubmitting(false)
    }
  }

  return (
    <Card>
      <CardHeader className="flex gap-3">
        <div className="flex-1">
          <CardTitle>Comments {comments.length ? `(${comments.length})` : ''}</CardTitle>
        </div>
        <div className="flex items-center gap-2">
          <Input value={query} onChange={e=>setQuery(e.target.value)} placeholder="Search comments" className="w-40 md:w-64" />
          <Select value={sort} onValueChange={(v)=>setSort(v as 'new' | 'old')}>
            <SelectTrigger className="w-[140px]">
              <SelectValue placeholder="Sort" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="new">Newest first</SelectItem>
              <SelectItem value="old">Oldest first</SelectItem>
            </SelectContent>
          </Select>
        </div>
      </CardHeader>
      <CardContent className="space-y-6">
        {/* Composer */}
        <RoleGate action="comment" disabledClassName="opacity-60">
          {allowed ? (
            <form className="grid gap-3" onSubmit={onSubmit}>
              <Textarea placeholder="Write a comment..." rows={4} value={content} onChange={e=>setContent(e.target.value)} />
              <div className="flex items-center justify-end gap-2">
                <Button type="submit" disabled={submitting || !content.trim()}>{submitting ? 'Posting‚Ä¶' : 'Post Comment'}</Button>
              </div>
            </form>
          ) : (
            <div className="text-sm text-muted-foreground">
              <Link className="text-primary hover:underline" href="/login">Log in</Link> to comment.
            </div>
          )}
        </RoleGate>

        {/* List */}
        {loading ? (
          <div className="text-sm text-muted-foreground">Loading comments‚Ä¶</div>
        ) : comments.length === 0 ? (
          <div className="text-sm text-muted-foreground">No comments yet.</div>
        ) : (
          <div className="space-y-6">
            {filteredSorted.map((c) => (
              <CommentItem key={c.id} c={c} />
            ))}
          </div>
        )}
      </CardContent>
    </Card>
  )
}

function CommentItem({ c }: { c: Comment }) {
  return (
    <div className="flex items-start gap-3">
      <Avatar className="h-8 w-8">
  <AvatarImage src={c.author?.avatar || ''} alt={c.author?.name || 'Author'} />
  <AvatarFallback>{(c.author?.name || 'A').split(' ').map(n => (n?.[0] || '')).join('').slice(0,2) || 'A'}</AvatarFallback>
      </Avatar>
      <div className="flex-1">
        <div className="flex items-center gap-2 text-sm font-medium">
          {c.author?.slug ? (
            <Link href={`/profile/${encodeURIComponent(c.author.slug)}`} className="hover:underline">{c.author?.name || 'Anonymous'}</Link>
          ) : (
            <span>{c.author?.name || 'Anonymous'}</span>
          )}
          <span className="text-xs text-muted-foreground">¬∑ {new Date(c.createdAt).toLocaleString()}</span>
        </div>
        <div className="text-sm text-foreground mt-1">{c.content}</div>
        <div className="mt-2 flex items-center gap-4 text-xs text-muted-foreground">
          <button className="hover:text-foreground" type="button">Reply</button>
        </div>
        {c.replies && c.replies.length > 0 && (
          <div className="mt-3 space-y-4 border-l pl-3">
            {c.replies.map(r => (
              <CommentItem key={r.id} c={r} />
            ))}
          </div>
        )}
      </div>
    </div>
  )
}


// ==== FILE: src\components\content-decorators.tsx ====
"use client"
import { useEffect } from 'react'

import { useToast } from '@/hooks/use-toast'

export default function ContentDecorators({ selector = '.wp-content' }: { selector?: string }) {
  const { toast } = useToast()
  useEffect(() => {
    const root = document.querySelector(selector)
    if (!root) return
    let lastToast = 0
    const canToast = () => {
      const now = Date.now()
      if (now - lastToast < 1200) return false
      lastToast = now
      return true
    }

    // Decorate headings with anchor link buttons + subtle transition
    root.querySelectorAll('h2[id], h3[id]').forEach((h) => {
      const el = h as HTMLElement
      if (el.querySelector('.para-anchor')) return
      el.classList.add('group','transition-colors','duration-200')
      const btn = document.createElement('button')
      btn.className = 'para-anchor opacity-0 group-hover:opacity-100 ml-2 text-xs text-muted-foreground hover:text-foreground'
      btn.title = 'Copy link to this section'
      btn.innerHTML = '<svg class="inline h-3 w-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 1 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>'
      btn.addEventListener('click', () => {
        const url = new URL(window.location.href)
        url.hash = `#${el.id}`
        navigator.clipboard.writeText(url.toString())
  if (canToast()) toast({ title: 'Link copied', description: 'Section URL copied to clipboard.' })
      })
      const span = document.createElement('span')
      span.className = 'group'
      while (el.firstChild) span.appendChild(el.firstChild)
      el.appendChild(span)
      el.appendChild(btn)
    })

    // Add copy button to code blocks
    root.querySelectorAll('pre').forEach((pre) => {
      const el = pre as HTMLElement
      if (el.querySelector('.code-copy')) return
      const btn = document.createElement('button')
      btn.className = 'code-copy absolute top-2 right-2 rounded bg-black/40 text-white px-2 py-1 text-xs hover:bg-black/60'
      btn.textContent = 'Copy'
      btn.addEventListener('click', () => {
        const code = el.querySelector('code')
        const text = code?.textContent || ''
        navigator.clipboard.writeText(text)
  if (canToast()) toast({ title: 'Code copied' })
      })
      el.style.position = 'relative'
      el.appendChild(btn)

      // Add language label if available from code class
      const codeEl = el.querySelector('code') as HTMLElement | null
      const klass = codeEl?.className || ''
      let lang = ''
      const m = klass.match(/language-([a-z0-9_+-]+)/i)
      if (m) lang = m[1]
      if (lang && !el.querySelector('.code-lang')) {
        const badge = document.createElement('span')
        badge.className = 'code-lang absolute top-2 left-2 rounded bg-black/30 text-white/90 px-2 py-0.5 text-[10px] uppercase tracking-wide'
        badge.textContent = lang
        el.appendChild(badge)
      }
    })

    // Add share/copy for blockquotes
    root.querySelectorAll('blockquote').forEach((bq) => {
      const el = bq as HTMLElement
      if (el.querySelector('.quote-copy')) return
      const wrap = document.createElement('div')
      wrap.className = 'relative'
      el.parentElement?.insertBefore(wrap, el)
      wrap.appendChild(el)
      const btn = document.createElement('button')
      btn.className = 'quote-copy absolute top-2 right-2 rounded bg-primary text-primary-foreground px-2 py-1 text-xs hover:bg-primary/90'
      btn.textContent = 'Share'
      btn.addEventListener('click', () => {
        const text = el.textContent?.trim() || ''
        const url = new URL(window.location.href)
        navigator.clipboard.writeText(`${text}\n\n${url.toString()}`)
  if (canToast()) toast({ title: 'Quote copied', description: 'Quote + link copied to clipboard.' })
      })
      wrap.appendChild(btn)
    })

    // Highlight active heading within content (mirror TOC)
    const headings = Array.from(root.querySelectorAll('h2[id], h3[id]')) as HTMLElement[]
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          const el = entry.target as HTMLElement
          if (entry.isIntersecting) {
            el.classList.add('heading-active')
          } else {
            el.classList.remove('heading-active')
          }
        })
      },
      { rootMargin: '-40% 0px -50% 0px', threshold: [0, 1] }
    )
    headings.forEach((h) => observer.observe(h))

    // Style internal vs external links inside content (no underline, subtle hover)
    root.querySelectorAll('a[href]').forEach((a) => {
      const el = a as HTMLAnchorElement
      const href = el.getAttribute('href') || ''
      el.classList.add('no-underline','hover:underline','transition-colors')
      try {
        const u = new URL(href, window.location.origin)
        const isExternal = u.origin !== window.location.origin
        if (isExternal) {
          el.classList.add('text-primary')
          el.setAttribute('target','_blank')
          el.setAttribute('rel','noopener noreferrer')
        } else {
          el.classList.add('text-foreground')
        }
      } catch {
        // Leave relative hash/mailto etc with basic style
        el.classList.add('text-foreground')
      }
    })

    return () => { observer.disconnect() }
  }, [selector])

  return null
}


// ==== FILE: src\components\error-boundary.tsx ====
"use client"
import React from 'react'

type Props = { children: React.ReactNode, fallback?: React.ReactNode }

export default class ErrorBoundary extends React.Component<Props, { hasError: boolean }> {
  constructor(props: Props) {
    super(props)
    this.state = { hasError: false }
  }
  static getDerivedStateFromError() {
    return { hasError: true }
  }
  componentDidCatch(error: Error, info: React.ErrorInfo) {
    console.error('ErrorBoundary caught', error, info)
  }
  render() {
    if (this.state.hasError) return this.props.fallback ?? <div className="text-sm text-destructive">Something went wrong.</div>
    return this.props.children
  }
}


// ==== FILE: src\components\feed-skeleton.tsx ====
import React from 'react'

import { cn } from '@/lib/utils'

import { PostCardSkeleton } from './post-card-skeleton'

export default function FeedSkeleton({ layout = 'grid', count = 6 }: { layout?: 'grid' | 'list'; count?: number }) {
  const wrapperClass = cn(
    'grid gap-6',
    layout === 'grid' ? 'grid-cols-1 sm:grid-cols-2 lg:grid-cols-3' : 'grid-cols-1'
  )

  return (
    <div className={wrapperClass} aria-busy="true" aria-live="polite">
      {Array.from({ length: count }).map((_, i) => (
        <PostCardSkeleton key={i} />
      ))}
    </div>
  )
}


// ==== FILE: src\components\feed.tsx ====

import { Info } from "lucide-react";

import { cn } from "@/lib/utils";
import { htmlToText } from "@/lib/text";
import { getPosts } from "@/lib/wp";

import { PostCard } from "./post-card";

type FeedProps = {
  layout?: 'grid' | 'list';
  postCount?: number;
};

export default async function Feed({ layout = 'grid', postCount = 6 }: FeedProps) {
  const { items } = await getPosts({ page: 1, perPage: postCount });

  const wrapperClass = cn(
    "grid gap-6",
    layout === 'grid' ? "grid-cols-1 sm:grid-cols-2 lg:grid-cols-3" : "grid-cols-1"
  );

  return (
    <div className={wrapperClass}>
      {items.length === 0 ? (
        <div className="col-span-full border rounded-md p-6 text-center text-sm text-muted-foreground">
          <div className="mx-auto mb-2 inline-flex h-8 w-8 items-center justify-center rounded-full bg-muted">
            <Info className="h-4 w-4" />
          </div>
          <p className="mb-1 font-medium text-foreground">Nothing here yet</p>
          <p>Posts will appear once published. Please check back soon.</p>
        </div>
      ) : (
        items.map((p) => (
          <PostCard
            key={p.id}
            layout={layout as any}
            post={{
              id: String(p.id),
              title: p.title,
              author: p.authorName || 'Unknown',
              avatar: p.authorAvatar || '/favicon.ico',
              imageUrl: p.featuredImage || '/favicon.ico',
              imageHint: 'featured image',
              excerpt: htmlToText(p.excerptHtml || '').slice(0, 180),
              slug: p.slug,
              date: p.date,
            }}
          />
        ))
      )}
    </div>
  );
}


// ==== FILE: src\components\floating-actions.tsx ====
"use client"
import { useEffect, useState } from 'react'
import { Share2, Bookmark, BookmarkCheck, Printer } from 'lucide-react'

import { Button } from '@/components/ui/button'
import { RoleGate, useRoleGate } from '@/hooks/useRoleGate'
import { useToast } from '@/hooks/use-toast'

export default function FloatingActions({ title, postId }: { title: string; postId?: number }) {
  const url = typeof window !== 'undefined' ? window.location.href : ''
  const { allowed } = useRoleGate('bookmark')
  const { toast } = useToast()
  const [bookmarkState, setBookmarkState] = useState<{ bookmarked: boolean; count: number } | null>(null)
  const [busy, setBusy] = useState(false)
  async function share() {
    try {
      if (navigator.share) {
        await navigator.share({ title, url })
      } else {
        await navigator.clipboard.writeText(url)
        toast({ title: 'Link copied', description: 'Post URL copied to clipboard.' })
      }
    } catch {}
  }
  function printPage() { try { window.print() } catch {} }

  useEffect(() => {
    let cancelled = false
    if (!postId) return
    ;(async () => {
      try {
        const r = await fetch(`/api/wp/bookmarks?postId=${encodeURIComponent(String(postId))}`, { cache: 'no-store' })
        if (!r.ok) return
        const j = await r.json().catch(() => null)
        if (!cancelled && j && typeof j === 'object') setBookmarkState({ bookmarked: !!j.bookmarked, count: Number(j.count || 0) })
      } catch {}
    })()
    return () => { cancelled = true }
  }, [postId])

  async function bookmark() {
    if (!allowed || !postId || busy) return
    setBusy(true)
    try {
      const r = await fetch('/api/wp/bookmarks', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ postId }),
      })
      if (r.status === 401) {
        toast({ title: 'Login required', description: 'Please log in to bookmark.', variant: 'destructive' })
        return
      }
      if (!r.ok) throw new Error('Failed to update')
      const j = await r.json().catch(() => null)
      if (j && typeof j === 'object') {
        setBookmarkState({ bookmarked: !!j.bookmarked, count: Number(j.count || 0) })
        toast({ title: j.bookmarked ? 'Saved' : 'Removed', description: j.bookmarked ? 'Added to your bookmarks.' : 'Removed from your bookmarks.' })
      }
    } catch (e: any) {
      toast({ title: 'Error', description: e?.message || 'Could not update bookmark', variant: 'destructive' })
    } finally { setBusy(false) }
  }

  return (
    <div className="fixed bottom-6 right-6 z-[70] flex flex-col gap-2 items-center">
      <Button size="icon" variant="secondary" className="shadow" onClick={share} aria-label="Share">
        <Share2 className="h-4 w-4" />
      </Button>
      <RoleGate action="bookmark" disabledClassName="opacity-50">
        <Button size="icon" variant="secondary" className="shadow" aria-label="Bookmark" onClick={bookmark} disabled={busy}>
          {bookmarkState?.bookmarked ? <BookmarkCheck className="h-4 w-4" /> : <Bookmark className="h-4 w-4" />}
        </Button>
      </RoleGate>
      <Button size="icon" variant="secondary" className="shadow" onClick={printPage} aria-label="Print">
        <Printer className="h-4 w-4" />
      </Button>
    </div>
  )
}


// ==== FILE: src\components\Footer.tsx ====
import React from 'react';
import Link from 'next/link';
import { Send, Rss, BookOpen } from 'lucide-react';

const Footer: React.FC = () => {
  const currentYear = new Date().getFullYear();

  return (
    <footer className="bg-card/50 mt-12">
      <div className="container mx-auto px-4 py-8">
        <div className="grid grid-cols-1 md:grid-cols-3 gap-8 text-center md:text-left">
          <div>
            <h3 className="font-bold text-lg mb-4">tech.oblivion</h3>
            <p className="text-muted-foreground">Technology with purpose. Exploring the future of web development and AI.</p>
          </div>
          <div>
            <h3 className="font-semibold mb-4">Quick Links</h3>
            <ul className="space-y-2">
              <li><Link href="/about" className="text-muted-foreground hover:text-foreground">About Us</Link></li>
              <li><Link href="/contact" className="text-muted-foreground hover:text-foreground">Contact</Link></li>
              <li><Link href="/privacy" className="text-muted-foreground hover:text-foreground">Privacy Policy</Link></li>
              <li><Link href="/terms" className="text-muted-foreground hover:text-foreground">Terms of Service</Link></li>
            </ul>
          </div>
          <div>
            <h3 className="font-semibold mb-4">Connect</h3>
            <div className="flex justify-center md:justify-start space-x-4">
              <a aria-label="Join our Discord" href="https://discord.gg/gMz8jgA9SC" target="_blank" rel="noopener noreferrer" className="inline-flex items-center gap-2 text-muted-foreground hover:text-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 rounded-md px-1">
                <Send className="h-4 w-4" /> <span className="sr-only">Discord</span>
              </a>
              <a aria-label="Subscribe to our channel" href="https://www.youtube.com/@tech.oblivion" target="_blank" rel="noopener noreferrer" className="inline-flex items-center gap-2 text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 rounded-md px-1">
                <Rss className="h-4 w-4" /> <span className="sr-only">YouTube</span>
              </a>
              <a aria-label="Read our blog" href="/blog" className="inline-flex items-center gap-2 text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 rounded-md px-1">
                <BookOpen className="h-4 w-4" /> <span className="sr-only">Blog</span>
              </a>
            </div>
          </div>
        </div>
        <div className="text-center text-muted-foreground mt-8 border-t border-border pt-6">
          <p>&copy; {currentYear} tech.oblivion. All rights reserved.</p>
        </div>
      </div>
    </footer>
  );
};

export default Footer;


// ==== FILE: src\components\header.tsx ====

"use client";

import Link from "next/link";
import { usePathname } from "next/navigation";
import { useState, useEffect } from "react";
import { Menu, ChevronDown } from "lucide-react";

import { Button } from "@/components/ui/button";
import { Sheet, SheetContent, SheetTrigger } from "@/components/ui/sheet";
import { RoleGate } from "@/hooks/useRoleGate";

import { ThemeToggle } from "./theme-toggle";
import { DropdownMenu, DropdownMenuTrigger, DropdownMenuContent, DropdownMenuItem, DropdownMenuSub, DropdownMenuSubTrigger, DropdownMenuSubContent, DropdownMenuPortal } from "./ui/dropdown-menu";

const navLinks = [
  { href: "/", label: "Home" },
  { href: "/blog", label: "Articles" },
  { href: "/about", label: "About" },
  { href: "/contact", label: "Contact" },
  { href: "/profile", label: "Profile" },
];

interface User {
  id?: number | string
  username: string
  email: string
  displayName: string
  roles?: string[]
  profile_fields?: Record<string,string>
}

export function Header() {
  const pathname = usePathname();
  const [user, setUser] = useState<User | null>(null);
  const [isLoading, setIsLoading] = useState(true);

  useEffect(() => {
    const checkAuth = async () => {
      try {
  const res = await fetch('/api/auth/me', { cache: 'no-store' });
        if (res.ok) {
          const data = await res.json();
          setUser(data.user);
        }
      } catch (error) {
        console.error('Auth check failed:', error);
      } finally {
        setIsLoading(false);
      }
    };

    checkAuth();
  }, []);

  const handleLogout = async () => {
    try {
      // Use GET redirect so the server clears cookie and navigates in one step
      window.location.href = '/api/auth/logout?redirect=/';
    } catch (error) {
      console.error('Logout failed:', error);
    }
  };

  const isPostDetail = (() => {
    const p = pathname || '/'
    const parts = p.split('/').filter(Boolean)
    return parts.length === 2 && parts[0] === 'blog'
  })()
  return (
    <header className="sticky top-0 z-50 w-full border-b border-border/40 bg-background/95 py-4 backdrop-blur supports-[backdrop-filter]:bg-background/60">
      <div className="container mx-auto px-4 flex items-center justify-between">
        <div className="mr-4 flex items-center">
          <Link href="/" className="flex items-center gap-2 font-bold">
            <span className="font-bold">
              tech.oblivion
            </span>
          </Link>
        </div>

  <nav className="hidden md:flex items-center gap-6 text-sm" aria-label="Main">
      {navLinks.map((link) => {
        const computedHref = link.label === "Profile"
          ? (user?.username ? `/profile/${encodeURIComponent(user.username)}` : "/profile")
          : link.href;
        return (
          <Link
            key={link.label}
            href={computedHref}
            className="text-muted-foreground transition-colors hover:text-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 rounded"
            aria-current={pathname === computedHref ? 'page' : undefined}
          >
            {link.label}
          </Link>
        );
      })}
      {user && (
        <Link
          href="/bookmarks"
          className="text-muted-foreground transition-colors hover:text-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 rounded"
        >
          Bookmarks
        </Link>
      )}
            <DropdownMenu>
              <DropdownMenuTrigger asChild>
                <Button variant="ghost" className="text-sm text-muted-foreground hover:text-foreground px-0 focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2" aria-haspopup="menu" aria-expanded={undefined}>
                  More <ChevronDown className="ml-1 h-4 w-4" />
                </Button>
              </DropdownMenuTrigger>
              <DropdownMenuContent align="end">
                <RoleGate action="admin" as="div">
                  <DropdownMenuSub>
                    <DropdownMenuSubTrigger>Admin</DropdownMenuSubTrigger>
                    <DropdownMenuPortal>
                      <DropdownMenuSubContent>
                        <DropdownMenuItem asChild><Link href="/admin">Dashboard</Link></DropdownMenuItem>
                        <DropdownMenuItem asChild><Link href="/admin/posts">Posts</Link></DropdownMenuItem>
                        <DropdownMenuItem asChild><Link href="/admin/users">Users</Link></DropdownMenuItem>
                        <DropdownMenuItem asChild><Link href="/admin/comments">Comments</Link></DropdownMenuItem>
                        <DropdownMenuItem asChild><Link href="/admin/settings">Settings</Link></DropdownMenuItem>
                      </DropdownMenuSubContent>
                    </DropdownMenuPortal>
                  </DropdownMenuSub>
                </RoleGate>
                <RoleGate action="draft" as="div">
                  <DropdownMenuSub>
                    <DropdownMenuSubTrigger>Dashboard</DropdownMenuSubTrigger>
                    <DropdownMenuPortal>
                      <DropdownMenuSubContent>
                        <DropdownMenuItem asChild><Link href="/account">My Account</Link></DropdownMenuItem>
                        <DropdownMenuItem asChild><Link href="/editor">My Posts</Link></DropdownMenuItem>
                        <DropdownMenuItem asChild><Link href="/account">Settings</Link></DropdownMenuItem>
                      </DropdownMenuSubContent>
                    </DropdownMenuPortal>
                  </DropdownMenuSub>
                </RoleGate>
              </DropdownMenuContent>
            </DropdownMenu>
        </nav>

        <div className="flex items-center gap-4">
          {!isLoading && (
            <>
              {user ? (
                <DropdownMenu>
                  <DropdownMenuTrigger asChild>
                    <Button variant="ghost" aria-label="User menu">
                      {(() => {
                        const uname = user.username || ''
                        const dname = user.displayName || ''
                        // If short username (<=10), show full
                        if (uname && uname.length <= 10) return `Hi, ${uname}`
                        // If displayName is long, use first + last initial
                        if (dname && dname.trim().includes(' ')) {
                          const parts = dname.trim().split(/\s+/)
                          const first = parts[0]
                          const last = parts[parts.length - 1]
                          return `Hi, ${first} ${last?.charAt(0) || ''}.`
                        }
                        // Else show first two chars of username
                        return `Hi, ${(uname || dname).slice(0, 2)}`
                      })()}
                    </Button>
                  </DropdownMenuTrigger>
                  <DropdownMenuContent align="end">
                    <DropdownMenuItem>
                      <Link href="/account">Account</Link>
                    </DropdownMenuItem>
                    <DropdownMenuItem>
                      <Link href="/account">Account Center</Link>
                    </DropdownMenuItem>
                    <DropdownMenuItem>
                      <Link href={user?.username ? `/profile/${encodeURIComponent(user.username)}` : "/profile"}>Public Profile</Link>
                    </DropdownMenuItem>
                    <DropdownMenuItem>
                      <button onClick={handleLogout}>Logout</button>
                    </DropdownMenuItem>
                  </DropdownMenuContent>
                </DropdownMenu>
              ) : (
                <Link href="/login">
                  <Button variant="ghost">Login</Button>
                </Link>
              )}
            </>
          )}

          {!isPostDetail && <ThemeToggle />}
           <Sheet>
            <SheetTrigger asChild>
              <Button
                variant="ghost"
                size="icon"
                className="md:hidden"
                aria-label="Toggle navigation"
>
                <Menu className="h-5 w-5" />
              </Button>
            </SheetTrigger>
            <SheetContent side="right">
              <nav className="grid gap-6 text-lg font-medium">
                <Link
                  href="/"
                  className="flex items-center gap-2 text-lg font-semibold"
                >
                  <span>tech.oblivion</span>
                </Link>
                {navLinks.map((link) => {
                  const computedHref = link.label === "Profile"
                    ? (user?.username ? `/profile/${encodeURIComponent(user.username)}` : "/profile")
                    : link.href;
                  return (
                    <Link
                      key={link.label}
                      href={computedHref}
                      className="text-muted-foreground hover:text-foreground"
                    >
                      {link.label}
                    </Link>
                  );
                })}
                {user && (
                  <Link href="/bookmarks" className="text-muted-foreground hover:text-foreground">Bookmarks</Link>
                )}
                 <RoleGate action="admin" as="div">
                   <Link href="/admin" className="text-muted-foreground hover:text-foreground">Admin</Link>
                 </RoleGate>
                 <RoleGate action="draft" as="div">
                   <Link href="/account" className="text-muted-foreground hover:text-foreground">Account</Link>
                 </RoleGate>
                {!isLoading && (
                  <>
                    {user ? (
                      <>
                        <div className="text-muted-foreground">
                          Welcome, {user.username}
                        </div>
                        <RoleGate action="draft" as="div">
                          <Link href="/account" className="text-muted-foreground hover:text-foreground">
                            Dashboard
                          </Link>
                        </RoleGate>
                        <Link href="/account" className="text-muted-foreground hover:text-foreground">
                          Account Center
                        </Link>
                        <a href="/api/auth/logout?redirect=/" className="text-left text-muted-foreground hover:text-foreground">
                          Logout
                        </a>
                      </>
                    ) : (
                      <Link href="/login" className="text-muted-foreground hover:text-foreground">
                        Login
                      </Link>
                    )}
                  </>
                )}
              </nav>
            </SheetContent>
          </Sheet>
        </div>
      </div>
    </header>
  );
}


// ==== FILE: src\components\HomeLatestVideoSection.tsx ====
"use client";
import LatestVideoPlayer from "@/components/LatestVideoPlayer";

export default function HomeLatestVideoSection() {
  return (
    <div className="flex flex-col space-y-4">
      <h2 className="text-2xl font-semibold">Latest Video</h2>
  <LatestVideoPlayer />
    </div>
  );
}


// ==== FILE: src\components\LatestVideoFrame.tsx ====
"use client";
import { useEffect, useState } from "react";

export default function LatestVideoFrame() {
  const [videoId, setVideoId] = useState<string | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    let cancelled = false;
    async function fetchLatestVideo() {
      setLoading(true);
      try {
        const res = await fetch("/api/latest-youtube-video");
        if (!res.ok) throw new Error("Failed to fetch");
        const data = await res.json();
        if (!cancelled) setVideoId(data.videoId || null);
      } catch {
        if (!cancelled) setVideoId(null);
      } finally {
        if (!cancelled) setLoading(false);
      }
    }
    fetchLatestVideo();
    return () => { cancelled = true; };
  }, []);

  if (loading) return (
    <div className="absolute inset-0 bg-black/40 flex items-center justify-center">
      <span className="text-white/80">Loading...</span>
    </div>
  );

  if (!videoId) return (
    <div className="absolute inset-0 bg-black/40 flex items-center justify-center">
      <span className="text-white/80">No video found</span>
    </div>
  );

  return (
    <iframe
      src={`https://www.youtube.com/embed/${videoId}`}
      className="w-full h-full"
      allowFullScreen
      title="Latest YouTube Video"
    />
  );
}


// ==== FILE: src\components\LatestVideoPlayer.tsx ====
"use client";
import { useEffect, useState } from "react";
import dynamic from "next/dynamic";

export default function LatestVideoPlayer() {
  const [video, setVideo] = useState<{ id: string; title: string; thumbnail: string } | null>(null);
  const [loading, setLoading] = useState(true);
  const [playing, setPlaying] = useState(false);

  useEffect(() => {
    let cancelled = false;
    async function fetchLatestVideo() {
      setLoading(true);
      try {
        const res = await fetch("/api/latest-youtube-video");
        if (!res.ok) throw new Error("Failed to fetch");
        const data = await res.json();
        if (data.videoId) {
          // Fetch video details from YouTube oEmbed (for title & thumbnail)
          const oembed = await fetch(`https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${data.videoId}&format=json`);
          const meta = oembed.ok ? await oembed.json() : {};
          if (!cancelled) setVideo({
            id: data.videoId,
            title: meta.title || "",
            thumbnail: meta.thumbnail_url || `https://i.ytimg.com/vi/${data.videoId}/hqdefault.jpg`
          });
        } else if (!cancelled) setVideo(null);
      } catch {
        if (!cancelled) setVideo(null);
      } finally {
        if (!cancelled) setLoading(false);
      }
    }
    fetchLatestVideo();
    return () => { cancelled = true; };
  }, []);

  if (loading) return (
    <div className="aspect-video w-full bg-black/40 flex items-center justify-center rounded-lg">
      <span className="text-white/80">Loading...</span>
    </div>
  );
  if (!video) return (
    <div className="aspect-video w-full bg-black/40 flex items-center justify-center rounded-lg">
      <span className="text-white/80">No video found</span>
    </div>
  );

  return (
    <div className="w-full">
      <div className="relative aspect-video rounded-lg overflow-hidden">
        {!playing && (
          <button
            className="absolute inset-0 flex items-center justify-center w-full h-full bg-black/40 hover:bg-black/60 transition"
            onClick={() => setPlaying(true)}
            aria-label="Play video"
          >
            <img
              src={video.thumbnail}
              alt={video.title}
              className="w-full h-full object-cover absolute inset-0 z-0"
            />
            <svg className="z-10" width="64" height="64" viewBox="0 0 64 64" fill="none">
              <circle cx="32" cy="32" r="32" fill="rgba(0,0,0,0.6)" />
              <polygon points="26,20 48,32 26,44" fill="#fff" />
            </svg>
          </button>
        )}
        {playing && (
          <iframe
            src={`https://www.youtube.com/embed/${video.id}?autoplay=1&rel=0`}
            className="absolute inset-0 w-full h-full"
            frameBorder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
            allowFullScreen
            title={video.title || "YouTube video player"}
          />
        )}
      </div>
      <div className="mt-3 text-lg font-semibold text-center text-foreground">
        {video.title}
      </div>
    </div>
  );
}


// ==== FILE: src\components\marquee.tsx ====
import { cn } from '@/lib/utils';

export function Marquee({
  className,
  children,
}: {
  className?: string;
  children: React.ReactNode;
}) {
  return (
    <div
      className={cn(
        'relative flex w-full flex-row items-center overflow-x-hidden',
        className
      )}
    >
      <div className="animate-marquee flex min-w-full flex-shrink-0 flex-row items-center">
        {children}
      </div>
      <div className="animate-marquee flex min-w-full flex-shrink-0 flex-row items-center">
        {children}
      </div>
    </div>
  );
}


// ==== FILE: src\components\NoCopy.tsx ====
"use client";

import React, { useEffect, useRef } from "react";

type NoCopyProps = {
  children?: React.ReactNode;
  // If true, also blocks common keyboard shortcuts like Ctrl/Cmd+C, A, S, P, U
  includeShortcuts?: boolean;
  // Optional aria label to indicate protected content
  ariaLabel?: string;
};

export default function NoCopy({
  children,
  includeShortcuts = true,
  ariaLabel = "Content protected",
}: NoCopyProps) {
  const containerRef = useRef<HTMLDivElement | null>(null);

  useEffect(() => {
    const el = containerRef.current;
    if (!el) return;

    const block = (e: Event) => {
      e.preventDefault();
      e.stopPropagation();
    };

    const onKeyDown = (e: KeyboardEvent) => {
      const key = e.key.toLowerCase();
      const ctrl = e.ctrlKey || e.metaKey;
      // Block common shortcuts: copy, cut, paste, select all, save, print, view source
      if (
        (ctrl && ["c", "x", "v", "a", "s", "p", "u"].includes(key)) ||
        key === "printscreen"
      ) {
        e.preventDefault();
        e.stopPropagation();
      }
    };

    // Attach listeners only within the protected container
    el.addEventListener("copy", block);
    el.addEventListener("cut", block);
    el.addEventListener("paste", block);
    el.addEventListener("contextmenu", block);
    el.addEventListener("dragstart", block);
    el.addEventListener("selectstart", block);
    if (includeShortcuts) {
      el.addEventListener("keydown", onKeyDown, true);
    }

    // Also attach document-level listeners while this component is mounted
    // to catch actions when focus is outside the container but still on this page.
    document.addEventListener("copy", block, true);
    document.addEventListener("cut", block, true);
    document.addEventListener("paste", block, true);
    document.addEventListener("contextmenu", block, true);
    document.addEventListener("dragstart", block, true);
    document.addEventListener("selectstart", block, true);
    if (includeShortcuts) {
      document.addEventListener("keydown", onKeyDown, true);
    }

    return () => {
      el.removeEventListener("copy", block);
      el.removeEventListener("cut", block);
      el.removeEventListener("paste", block);
      el.removeEventListener("contextmenu", block);
      el.removeEventListener("dragstart", block);
      el.removeEventListener("selectstart", block);
      if (includeShortcuts) {
        el.removeEventListener("keydown", onKeyDown, true);
      }

      document.removeEventListener("copy", block, true);
      document.removeEventListener("cut", block, true);
      document.removeEventListener("paste", block, true);
      document.removeEventListener("contextmenu", block, true);
      document.removeEventListener("dragstart", block, true);
      document.removeEventListener("selectstart", block, true);
      if (includeShortcuts) {
        document.removeEventListener("keydown", onKeyDown, true);
      }
    };
  }, [includeShortcuts]);

  return (
    <div
      ref={containerRef}
      className="select-none"
      aria-label={ariaLabel}
      onContextMenu={(e) => {
        e.preventDefault();
        e.stopPropagation();
      }}
    >
      {children}
    </div>
  );
}


// ==== FILE: src\components\post-actions.tsx ====
"use client"
import Link from 'next/link'
import { Edit, Share2, MoreVertical, Clipboard } from 'lucide-react'

import { Button } from '@/components/ui/button'
import { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger } from '@/components/ui/dropdown-menu'
import { RoleGate } from '@/hooks/useRoleGate'
import { useToast } from '@/hooks/use-toast'

type Props = {
  postId: number
  slug: string
  title: string
}

export default function PostActions({ postId, slug, title }: Props) {
  const { toast } = useToast()
  async function handleShare() {
    const url = typeof window !== 'undefined' ? window.location.href : `${slug}`
    try {
      if (navigator.share) {
        await navigator.share({ title, url })
        return
      }
    } catch {}
    try {
      await navigator.clipboard.writeText(url)
      toast({ title: 'Link copied', description: 'Post URL copied to clipboard.' })
      // Fallback: no-op
    } catch {}
  }

  return (
    <DropdownMenu>
      <DropdownMenuTrigger asChild>
        <Button variant="outline" size="icon" aria-label="Post actions">
          <MoreVertical className="h-4 w-4" />
        </Button>
      </DropdownMenuTrigger>
      <DropdownMenuContent align="end" className="w-44">
  <RoleGate action="admin" as="div">
          <DropdownMenuItem asChild>
            <Link href={`/editor/${postId}`} className="cursor-pointer">
              <Edit className="h-4 w-4" />
              <span>Edit</span>
            </Link>
          </DropdownMenuItem>
        </RoleGate>
        <DropdownMenuItem onClick={handleShare} className="cursor-pointer">
          <Share2 className="h-4 w-4" />
          <span>Share...</span>
        </DropdownMenuItem>
        <DropdownMenuItem
          onClick={async () => {
            const url = typeof window !== 'undefined' ? window.location.href : `${slug}`
            try { await navigator.clipboard.writeText(url); toast({ title: 'Link copied' }) } catch {}
          }}
          className="cursor-pointer"
        >
          <Clipboard className="h-4 w-4" />
          <span>Copy link</span>
        </DropdownMenuItem>
      </DropdownMenuContent>
    </DropdownMenu>
  )
}


// ==== FILE: src\components\post-author.tsx ====
"use client"
import Link from 'next/link'
import { Twitter, Linkedin, Github } from 'lucide-react'

import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar'

type PostAuthorProps = {
  authorName?: string
  authorAvatar?: string
  canonicalUrl?: string | null
  bio?: string | null
  profileSlug?: string | null
  twitterUrl?: string | null
  linkedinUrl?: string | null
  githubUrl?: string | null
}

export default function PostAuthor({ authorName, authorAvatar, canonicalUrl, bio, profileSlug, twitterUrl, linkedinUrl, githubUrl }: PostAuthorProps) {
  const name = authorName || 'Unknown'
  const avatar = authorAvatar || ''
  const canonical = canonicalUrl || '#'

  // Basic heuristic for GitHub profile based on author name, same as inline behavior
  const ghUser = name.replace(/\s+/g, '').toLowerCase()
  const ghHeuristic = name ? `https://github.com/${encodeURIComponent(ghUser)}` : '#'
  const gh = githubUrl || ghHeuristic

  return (
    <div className="bg-card/50 p-6 rounded-lg border flex flex-col sm:flex-row items-start gap-6">
      <Avatar className="h-24 w-24 ring-2 ring-primary/20">
        <AvatarImage src={avatar} alt={name || 'Author'} />
        <AvatarFallback className="text-2xl font-bold">{(name || 'A').charAt(0)}</AvatarFallback>
      </Avatar>
      <div className="flex-1">
        <h3 className="text-sm font-semibold text-muted-foreground mb-1">WRITTEN BY</h3>
        <h2 className="text-2xl font-bold mb-2">{name}</h2>
        <p className="text-muted-foreground mb-4">
          {bio || 'An avid writer and technologist sharing insights on modern development practices.'}
        </p>
        {(twitterUrl || linkedinUrl || gh) && (
          <div className="flex items-center gap-4 mb-4">
            {twitterUrl && (
              <a href={twitterUrl} target="_blank" rel="noopener noreferrer" aria-label="Twitter" className="text-muted-foreground hover:text-blue-500 transition-colors">
                <Twitter className="h-5 w-5" />
              </a>
            )}
            {linkedinUrl && (
              <a href={linkedinUrl} target="_blank" rel="noopener noreferrer" aria-label="LinkedIn" className="text-muted-foreground hover:text-blue-600 transition-colors">
                <Linkedin className="h-5 w-5" />
              </a>
            )}
            {gh && (
              <a href={gh} target="_blank" rel="noopener noreferrer" aria-label="GitHub" className="text-muted-foreground hover:text-gray-900 dark:hover:text-white transition-colors">
                <Github className="h-5 w-5" />
              </a>
            )}
          </div>
        )}
        <div className="flex items-center gap-4">
          <Link href={profileSlug ? `/profile/${encodeURIComponent(profileSlug)}` : '/profile'} className="text-sm text-primary hover:underline font-medium">
            View full profile ‚Üí
          </Link>
          <button className="text-sm bg-primary text-primary-foreground px-4 py-1 rounded-full hover:bg-primary/90 transition-colors">
            + Follow
          </button>
        </div>
      </div>
    </div>
  )
}


// ==== FILE: src\components\post-card-skeleton.tsx ====
import {
  Card,
  CardContent,
  CardFooter,
  CardHeader,
} from "@/components/ui/card";
import { Skeleton } from "@/components/ui/skeleton";

export function PostCardSkeleton() {
  return (
    <Card className="overflow-hidden">
      <CardHeader className="p-0">
        <Skeleton className="h-48 w-full" />
      </CardHeader>
      <CardContent className="p-6">
        <Skeleton className="mb-4 h-6 w-3/4" />
        <Skeleton className="h-4 w-full" />
        <Skeleton className="mt-2 h-4 w-5/6" />
      </CardContent>
      <CardFooter>
        <div className="flex items-center space-x-4">
          <Skeleton className="h-10 w-10 rounded-full" />
          <div className="space-y-2">
            <Skeleton className="h-4 w-[100px]" />
          </div>
        </div>
      </CardFooter>
    </Card>
  );
}


// ==== FILE: src\components\post-card.tsx ====
import Link from "next/link";

import ClientImage from "@/components/ui/client-image";
import {
  Card,
  CardContent,
  CardFooter,
  CardHeader,
  CardTitle,
  CardDescription,
} from "@/components/ui/card";
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { cn } from "@/lib/utils";

export type Post = {
  id: string;
  title: string;
  author: string;
  avatar: string;
  imageUrl: string;
  imageHint: string;
  excerpt: string;
  slug: string;
  date: string;
};

type PostCardProps = {
  post: Post;
  layout?: 'grid' | 'list';
};

export function PostCard({ post, layout = 'grid' }: PostCardProps) {

  if (layout === 'list') {
    return (
      <article aria-labelledby={`post-title-${post.id}`}>
        <Link href={`/blog/${post.slug}`} className="block">
          <Card className="flex flex-col sm:flex-row overflow-hidden border-none shadow-none items-start cursor-pointer hover:bg-card p-2 rounded-lg transition-all duration-300 hover:-translate-y-1 hover:shadow-lg dark:hover:shadow-primary/20">
            <div className="relative aspect-video sm:aspect-square h-24 w-full sm:w-24 flex-shrink-0">
              <ClientImage
                src={post.imageUrl}
                alt={`Image for ${post.title}`}
                fill
                className="object-cover rounded-md"
                sizes="(max-width: 640px) 100vw, 96px"
                loading="lazy"
                data-ai-hint={post.imageHint}
              />
            </div>
            <div className="flex flex-col p-4">
               <CardTitle id={`post-title-${post.id}`} className="text-md leading-tight">
                {post.title}
              </CardTitle>
               <p className="text-xs text-muted-foreground mt-2 line-clamp-2">
                {post.excerpt}
              </p>
              <div className="flex items-center space-x-3 mt-3">
                <Avatar className="h-6 w-6">
                  <AvatarImage src={post.avatar} alt={post.author} />
                  <AvatarFallback>
                    {post.author
                      .split(" ")
                      .map((n) => n[0])
                      .join("")}
                  </AvatarFallback>
                </Avatar>
                <div>
                  <p className="text-xs font-medium leading-none">{post.author}</p>
                  <p className="text-xs text-muted-foreground">
                    {new Date(post.date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
                  </p>
                </div>
              </div>
          </div>
        </Card>
        </Link>
      </article>
    );
  }

  return (
    <article aria-labelledby={`post-title-${post.id}`}>
      <Link href={`/blog/${post.slug}`} className="block h-full">
        <Card className="flex h-full flex-col overflow-hidden border-none shadow-none cursor-pointer bg-card hover:bg-card/90 p-2 rounded-lg transition-all duration-300 hover:-translate-y-1 hover:shadow-lg dark:hover:shadow-primary/20">
          <CardHeader className="p-0">
            <div className="relative aspect-[3/2] w-full">
              <ClientImage
                src={post.imageUrl}
                alt={`Image for ${post.title}`}
                fill
                className="object-cover rounded-md"
                sizes="(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw"
                loading="lazy"
                data-ai-hint={post.imageHint}
              />
            </div>
          </CardHeader>
          <CardContent className="flex-grow p-4">
            <CardTitle id={`post-title-${post.id}`} className="text-xl line-clamp-2">
              {post.title}
            </CardTitle>
            <CardDescription className="mt-2 line-clamp-3">{post.excerpt}</CardDescription>
          </CardContent>
          <CardFooter className="p-4">
            <div className="flex items-center space-x-3">
              <Avatar>
                <AvatarImage src={post.avatar} alt={post.author} />
                <AvatarFallback>
                  {post.author
                    .split(" ")
                    .map((n) => n[0])
                    .join("")}
                </AvatarFallback>
              </Avatar>
              <div>
                <p className="text-sm font-medium leading-none">{post.author}</p>
                <p className="text-xs text-muted-foreground">
                   {new Date(post.date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
                </p>
              </div>
            </div>
          </CardFooter>
        </Card>
      </Link>
    </article>
  );
}


// ==== FILE: src\components\reader-toolbar-portal.tsx ====
"use client"
import React from 'react'

import ReaderToolbar from '@/components/reader-toolbar'

export default function ReaderToolbarPortal() {
  const [collapsed, setCollapsed] = React.useState(false)
  // no persistence across pages; default expanded on each post load
  return (
    <div className="fixed bottom-6 left-1/2 -translate-x-1/2 z-[72] print:hidden">
      {!collapsed ? (
        <div className="flex items-center gap-2">
          <ReaderToolbar />
          <button
            type="button"
            aria-label="Hide reader toolbar"
            onClick={() => setCollapsed(true)}
            className="rounded-full border bg-card/80 backdrop-blur px-2 py-1 text-xs shadow"
            title="Hide"
          >
            ‚ñæ
          </button>
        </div>
      ) : (
        <button
          type="button"
          aria-label="Show reader toolbar"
          onClick={() => setCollapsed(false)}
          className="rounded-full border bg-card/80 backdrop-blur px-2 py-1 text-xs shadow"
          title="Show reader toolbar"
        >
          ‚ñ¥
        </button>
      )}
    </div>
  )
}


// ==== FILE: src\components\reader-toolbar.tsx ====
"use client"
import { Moon, Sun, Plus, Minus, RotateCcw } from 'lucide-react'
import { useTheme } from 'next-themes'
import { useEffect, useRef, useState } from 'react'

export default function ReaderToolbar() {
  const { theme, setTheme } = useTheme()
  const [scale, setScale] = useState<number>(100)
  const [editing, setEditing] = useState(false)
  const [draft, setDraft] = useState('100')
  const lastClickRef = useRef<number>(0)

  useEffect(() => {
    const s = Number(localStorage.getItem('reader:scale') || '100')
    setScale(isNaN(s) ? 100 : s)
    setDraft(String(isNaN(s) ? 100 : s))
  }, [])
  useEffect(() => {
    const s = Math.max(80, Math.min(160, scale))
    document.documentElement.style.setProperty('--reader-scale', String(s))
    localStorage.setItem('reader:scale', String(s))
  }, [scale])

  function commitDraft() {
    const n = Number(draft)
    if (!isNaN(n)) {
      setScale(Math.max(80, Math.min(160, n)))
    }
    setEditing(false)
  }

  function cancelEdit() {
    setDraft(String(scale))
    setEditing(false)
  }

  function handleLabelClick() {
    const now = Date.now()
    if (now - lastClickRef.current < 250) {
      // double click within window ‚Üí reset
      setScale(100)
      setDraft('100')
      lastClickRef.current = 0
      return
    }
    lastClickRef.current = now
    // enter edit mode on single click
    setEditing(true)
  }

  return (
    <div className="flex items-center gap-2 rounded-full bg-card/70 backdrop-blur px-3 py-1.5 border shadow">
  <button className="p-1.5 hover:text-primary" aria-label="Decrease font size" onClick={()=>setScale(Math.max(80, scale-10))}><Minus className="h-4 w-4"/></button>
      {editing ? (
        <input
          className="w-14 text-xs text-center bg-transparent outline-none border-b border-border focus:border-primary rounded-none"
          value={draft}
          onChange={(e)=>setDraft(e.target.value.replace(/[^0-9]/g,''))}
          onBlur={commitDraft}
          onKeyDown={(e)=>{
            if (e.key === 'Enter') commitDraft();
            else if (e.key === 'Escape') cancelEdit();
          }}
          autoFocus
        />
      ) : (
        <span
          className="text-xs w-12 text-center tabular-nums cursor-text select-none"
          title="Click to edit, double-click to reset"
          onClick={handleLabelClick}
        >
          {scale}%
        </span>
      )}
      <button className="p-1.5 hover:text-primary" aria-label="Increase font size" onClick={()=>setScale(Math.min(160, scale+10))}><Plus className="h-4 w-4"/></button>
      <button className="p-1.5 hover:text-primary" title="Reset to 100%" aria-label="Reset zoom" onClick={()=>{ setScale(100); setDraft('100') }}>
        <RotateCcw className="h-4 w-4"/>
      </button>
      <span className="mx-1 h-4 w-px bg-border"/>
      <button
        className={`p-1.5 rounded ${theme==='light' ? 'text-primary bg-primary/10' : 'hover:text-primary'}`}
        aria-label="Light mode"
        aria-pressed={theme==='light'}
        onClick={()=>setTheme('light')}
      >
        <Sun className="h-4 w-4"/>
      </button>
      <button
        className={`p-1.5 rounded ${theme==='dark' ? 'text-primary bg-primary/10' : 'hover:text-primary'}`}
        aria-label="Dark mode"
        aria-pressed={theme==='dark'}
        onClick={()=>setTheme('dark')}
      >
        <Moon className="h-4 w-4"/>
      </button>
    </div>
  )
}


// ==== FILE: src\components\reading-progress.tsx ====
"use client"
import { useEffect, useState } from 'react'

export default function ReadingProgress({ targetSelector = '.wp-content' }: { targetSelector?: string }) {
  const [progress, setProgress] = useState(0)
  const [top, setTop] = useState<number>(0)

  useEffect(() => {
    function update() {
      const el = document.querySelector<HTMLElement>(targetSelector)
      if (!el) { setProgress(0); return }
      const rect = el.getBoundingClientRect()
      const total = el.scrollHeight - window.innerHeight
      const scrolled = window.scrollY - (el.offsetTop || 0)
      const value = total > 0 ? Math.min(100, Math.max(0, (scrolled / total) * 100)) : 0
      setProgress(value)
    }
    update()
    window.addEventListener('scroll', update, { passive: true })
    window.addEventListener('resize', update)
    return () => {
      window.removeEventListener('scroll', update)
      window.removeEventListener('resize', update)
    }
  }, [targetSelector])

  useEffect(() => {
    const computeTop = () => {
      const header = document.querySelector('header') as HTMLElement | null
      const h = header ? header.getBoundingClientRect().height : 0
      setTop(h)
    }
    computeTop()
    window.addEventListener('resize', computeTop)
    return () => window.removeEventListener('resize', computeTop)
  }, [])

  return (
    <div style={{ top }} className="fixed left-0 right-0 z-40 h-1 bg-transparent">
      <div className="h-1 bg-primary transition-[width] duration-150 ease-out" style={{ width: `${progress}%` }} />
    </div>
  )
}


// ==== FILE: src\components\RelatedPostsSidebar.tsx ====
"use client";
import React, { useEffect, useState } from 'react';
import Link from 'next/link';
// Use browser fetch directly to avoid any base URL issues in client

interface Term {
  id: number;
  name: string;
  slug: string;
}

interface RelatedPost {
  id: number;
  slug: string;
  title: {
    rendered: string;
  };
}

interface RelatedPostsSidebarProps {
  currentPostCategories?: Term[];
  currentPostTags?: Term[];
  currentPostId: number;
}

const RelatedPostsSidebar: React.FC<RelatedPostsSidebarProps> = ({
  currentPostCategories,
  currentPostTags,
  currentPostId,
}) => {
  const [relatedPosts, setRelatedPosts] = useState<RelatedPost[]>([]);
  const [heading, setHeading] = useState<'Related Posts' | 'Recent Posts'>('Related Posts');
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    const fetchRelatedPosts = async () => {
      setLoading(true);
      setError(null);
      try {
        // Build query parameters based on categories and tags
  const categoryIds = (currentPostCategories ?? []).map((cat) => cat.id).join(',');
  const tagIds = (currentPostTags ?? []).map((tag) => tag.id).join(',');

  let url = '/api/wp/related';
        const params = new URLSearchParams();

        if (categoryIds) {
          params.append('categories', categoryIds);
        }
        if (tagIds) {
          params.append('tags', tagIds);
        }

        // Exclude the current post
        params.append('exclude', currentPostId.toString());

        // Limit the number of related posts
        params.append('per_page', '5'); // Fetch up to 5 related posts

  url = `${url}?${params.toString()}`;

  const resp = await fetch(url, { headers: { Accept: 'application/json' } })
  if (!resp.ok) throw new Error(`HTTP ${resp.status}`)
  const data = (await resp.json()) as RelatedPost[]

        // Filter out the current post just in case
        const filteredData = data.filter((post: RelatedPost) => post.id !== currentPostId);

        if (filteredData.length === 0) {
          // Fallback: fetch recent posts in chronological order
          const recentResp = await fetch(`/api/wp/posts?per_page=5&_embed=1`, { headers: { Accept: 'application/json' } })
          if (recentResp.ok) {
            const recent = (await recentResp.json()) as any[]
            const simplified = recent.map(p => ({ id: p.id, slug: p.slug, title: { rendered: p.title?.rendered || '' } }))
            setRelatedPosts(simplified)
            setHeading('Recent Posts')
          } else {
            setRelatedPosts([])
          }
        } else {
          setRelatedPosts(filteredData);
          setHeading('Related Posts')
        }
      } catch (err: any) {
        console.error('Error fetching related posts:', err);
        setError('Failed to load related posts.');
      } finally {
        setLoading(false);
      }
    };

    fetchRelatedPosts();
  }, [currentPostCategories, currentPostTags, currentPostId]);

  if (loading) {
    return <div>Loading related posts...</div>;
  }

  if (error) {
    return <div className="text-red-500">{error}</div>;
  }

  if (relatedPosts.length === 0) {
    return null; // Nothing to show (also covers fallback failure)
  }

  return (
    <div className="w-full lg:w-64 lg:sticky lg:top-20 lg:self-start mt-8 lg:mt-0">
  <h3 className="text-lg font-semibold mb-4 border-b pb-2">{heading}</h3>
      <ul>
        {relatedPosts.map((post) => (
          <li key={post.id} className="mb-3 last:mb-0">
            <Link href={`/blog/${post.slug}`} className="text-gray-800 hover:text-gray-600 dark:text-gray-200 dark:hover:text-gray-400 transition-colors duration-200">
              {post.title.rendered}
            </Link>
          </li>
        ))}
      </ul>
    </div>
  );
};

export default RelatedPostsSidebar;

// ==== FILE: src\components\Search.tsx ====
"use client";
import React, { useState } from 'react';
import { useRouter } from 'next/navigation';

const Search: React.FC = () => {
  const [searchTerm, setSearchTerm] = useState('');
  const router = useRouter();

  const handleInputChange = (event: React.ChangeEvent<HTMLInputElement>) => {
    const inputValue = event.target.value;
    setSearchTerm(inputValue);
  };

  const handleSearchSubmit = (event: React.FormEvent<HTMLFormElement>) => {
    event.preventDefault();
    if (searchTerm.trim()) {
      router.push(`/search?q=${encodeURIComponent(searchTerm.trim())}`);
    }
  };
  return (
    <form onSubmit={handleSearchSubmit} className="flex items-center gap-2">
      <input
        type="text"
        placeholder="Search..."
        value={searchTerm}
        onChange={handleInputChange}
        className="border rounded px-3 py-2"
      />
      <button type="submit" className="bg-primary text-primary-foreground px-3 py-2 rounded">Go</button>
    </form>
  );
};

export default Search;

// ==== FILE: src\components\SEO.tsx ====
"use client";
import Head from 'next/head';

type SEOProps = {
  title?: string;
  description?: string;
  canonical?: string;
  ogImage?: string;
  twitterImage?: string;
  schema?: object;
};

export default function SEO({
  title,
  description,
  canonical,
  ogImage,
  twitterImage,
  schema,
}: SEOProps) {
  return (
    <Head>
      {title && <title>{title}</title>}
      {description && <meta name="description" content={description} />}

      {canonical && <link rel="canonical" href={canonical} />}

      {/* Open Graph */}
      {ogImage && <meta property="og:image" content={ogImage} />}
      {title && <meta property="og:title" content={title} />}
      {description && <meta property="og:description" content={description} />}

      {/* Twitter */}
      {twitterImage && <meta name="twitter:image" content={twitterImage} />}    
      {title && <meta name="twitter:title" content={title} />}
      {description && <meta name="twitter:description" content={description} />}

      {/* Structured Data */}
      {schema && (
        <script
          // eslint-disable-next-line react/no-danger
          dangerouslySetInnerHTML={{ __html: JSON.stringify(schema) }}
          type="application/ld+json"
        />
      )}
    </Head>
  );
}


// ==== FILE: src\components\Tag.tsx ====
import Link from 'next/link';

interface TagProps {
  tag: {
    id: number;
    name: string;
    slug: string;
  };
}

const Tag: React.FC<TagProps> = ({ tag }) => {
  return (
    <Link href={`/tags/${tag.slug}`}>
      {tag.name}
    </Link>
  );
};

export default Tag;

// ==== FILE: src\components\theme-provider.tsx ====
"use client"

import * as React from "react"
import { ThemeProvider as NextThemesProvider } from "next-themes"
import { type ThemeProviderProps } from "next-themes/dist/types"

export function ThemeProvider({ children, ...props }: ThemeProviderProps) {
  return <NextThemesProvider {...props}>{children}</NextThemesProvider>
}


// ==== FILE: src\components\theme-toggle.tsx ====
"use client"

import * as React from "react"
import { Moon, Sun } from "lucide-react"
import { useTheme } from "next-themes"

import { Button } from "@/components/ui/button"

export function ThemeToggle() {
  const { theme, setTheme } = useTheme()

  const toggleTheme = () => {
    setTheme(theme === 'dark' ? 'light' : 'dark')
  }

  return (
    <Button variant="ghost" size="icon" aria-label="Toggle theme" onClick={toggleTheme}>
      <Sun className="h-[1.2rem] w-[1.2rem] rotate-0 scale-100 transition-all dark:-rotate-90 dark:scale-0" />
      <Moon className="absolute h-[1.2rem] w-[1.2rem] rotate-90 scale-0 transition-all dark:rotate-0 dark:scale-100" />
      <span className="sr-only">Toggle theme</span>
    </Button>
  )
}


// ==== FILE: src\components\toc-list.tsx ====
"use client";
import React, { useEffect, useState } from 'react'

import type { TocItem } from '@/lib/toc'

type Props = { items: TocItem[] }

export default function TocList({ items }: Props) {
  const [active, setActive] = useState<string | null>(null)

  useEffect(() => {
    if (!items?.length) return
    const ids = items.map(i => i.slug)
    const els = ids
      .map(id => document.getElementById(id))
      .filter((el): el is HTMLElement => !!el)

    if (!els.length) return

    const onScroll = () => {
      // Find the heading closest to top but not past 120px offset
      const offset = 120
      let current: string | null = null
      for (const el of els) {
        const rect = el.getBoundingClientRect()
        if (rect.top - offset <= 0) {
          current = el.id
        } else {
          break
        }
      }
      // Fallback to first if none selected
      setActive(current ?? els[0].id)
    }

    onScroll()
    window.addEventListener('scroll', onScroll, { passive: true })
    return () => window.removeEventListener('scroll', onScroll)
  }, [items])

  return (
    <ul className="space-y-2">
      {items.map((item) => {
        const isActive = active === item.slug
        return (
          <li key={item.slug} className={`text-sm level-${item.level} ${item.level > 2 ? 'pl-4' : ''}`}>
            <a
              href={`#${item.slug}`}
              className={
                isActive
                  ? 'toc-link text-foreground font-medium underline decoration-primary/60'
                  : 'toc-link text-muted-foreground hover:text-foreground hover:underline'
              }
            >
              {item.text}
            </a>
          </li>
        )
      })}
    </ul>
  )
}


// ==== FILE: src\components\views-counter.tsx ====
"use client"
import { useEffect, useState } from 'react'

export default function ViewsCounter({ postId }: { postId: number }) {
  const [views, setViews] = useState<number | null>(null)
  useEffect(() => {
    let cancelled = false
    const run = async () => {
      try {
        const r = await fetch(`/api/wp/track-view`, { method: 'POST', cache: 'no-store', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ postId }) })
        if (!cancelled && r.ok) {
          const j = await r.json().catch(() => null)
          const v = (j && (j.views_total ?? j.count))
          if (typeof v === 'number') setViews(v)
        }
      } catch {}
    }
    run()
    return () => { cancelled = true }
  }, [postId])
  return <span>{views != null ? `${views.toLocaleString()} views` : '‚Äî views'}</span>
}


// ==== FILE: src\components\admin\AdminDashboard.tsx ====
'use client'
import React, { useCallback, useEffect, useMemo, useState } from 'react'
import dynamic from 'next/dynamic'

import GridLayout from 'react-grid-layout'
import 'react-grid-layout/css/styles.css'
import 'react-resizable/css/styles.css'

import { useLayoutPersistence } from '../../hooks/useLayoutPersistence'

import Tile from './tiles/Tile'

const PostEditorTile = dynamic(() => import('./tiles/PostEditorTile'), { ssr: false })
// Lazy heavy tiles example (actual tiles can be split per section later)
const CrewMan = dynamic(() => import('../dashboard/CrewMan'), { ssr: false })

export type SectionKey =
  | 'dashboard' | 'analytics' | 'posts' | 'media' | 'categories' | 'tags' | 'comments' | 'users' | 'settings' | 'plugins' | 'themes' | 'site-health' | 'debug'

type LayoutItem = { i: string; x: number; y: number; w: number; h: number }
// Default layouts provided by user
const DEFAULTS: Record<SectionKey, LayoutItem[]> = {
  dashboard: [
    { i: 'postsCount', x: 0, y: 0, w: 3, h: 2 },
    { i: 'usersCount', x: 3, y: 0, w: 3, h: 2 },
    { i: 'commentsCount', x: 6, y: 0, w: 3, h: 2 },
    { i: 'sessionsToday', x: 9, y: 0, w: 3, h: 2 },
  ],
  analytics: [
    { i: 'sessionsTrend', x: 0, y: 0, w: 6, h: 4 },
    { i: 'sessionTimeseries', x: 6, y: 0, w: 6, h: 4 },
    { i: 'topCountries', x: 0, y: 4, w: 4, h: 4 },
    { i: 'devicesBreakdown', x: 4, y: 4, w: 4, h: 4 },
    { i: 'topPosts', x: 8, y: 4, w: 4, h: 4 },
    { i: 'referrers', x: 0, y: 8, w: 12, h: 3 },
  ],
  posts: [
    { i: 'latestDrafts', x: 0, y: 0, w: 6, h: 3 },
    { i: 'publishQueue', x: 6, y: 0, w: 6, h: 3 },
    { i: 'pendingReviews', x: 0, y: 3, w: 6, h: 3 },
    { i: 'addPost', x: 6, y: 3, w: 3, h: 2 },
    { i: 'postEditor', x: 0, y: 6, w: 12, h: 6 },
  ],
  media: [
    { i: 'recentUploads', x: 0, y: 0, w: 6, h: 3 },
    { i: 'storageUsage', x: 6, y: 0, w: 6, h: 2 },
    { i: 'uploadWidget', x: 0, y: 3, w: 6, h: 3 },
    { i: 'deletionsPending', x: 6, y: 2, w: 6, h: 2 },
  ],
  categories: [
    { i: 'categoriesList', x: 0, y: 0, w: 8, h: 4 },
    { i: 'addCategory', x: 8, y: 0, w: 4, h: 2 },
  ],
  tags: [
    { i: 'tagsCloud', x: 0, y: 0, w: 8, h: 4 },
    { i: 'addTag', x: 8, y: 0, w: 4, h: 2 },
  ],
  comments: [
    { i: 'commentsStream', x: 0, y: 0, w: 8, h: 4 },
    { i: 'toxicityAlerts', x: 8, y: 0, w: 4, h: 2 },
    { i: 'bulkModeration', x: 0, y: 4, w: 12, h: 3 },
  ],
  users: [
    { i: 'activeUsers', x: 0, y: 0, w: 6, h: 2 },
    { i: 'presence', x: 6, y: 0, w: 6, h: 2 },
    { i: 'roleBreakdown', x: 0, y: 2, w: 6, h: 3 },
    { i: 'inviteUser', x: 6, y: 2, w: 6, h: 2 },
  ],
  settings: [
    { i: 'siteSettings', x: 0, y: 0, w: 6, h: 3 },
    { i: 'themeToggle', x: 6, y: 0, w: 6, h: 2 },
    { i: 'apiLatency', x: 0, y: 3, w: 6, h: 2 },
    { i: 'siteHealthSummary', x: 6, y: 2, w: 6, h: 3 },
  ],
  plugins: [
    { i: 'pluginsList', x: 0, y: 0, w: 8, h: 4 },
    { i: 'updateAlerts', x: 8, y: 0, w: 4, h: 2 },
  ],
  themes: [
    { i: 'themesList', x: 0, y: 0, w: 8, h: 4 },
    { i: 'themeUpdateAlerts', x: 8, y: 0, w: 4, h: 2 },
  ],
  'site-health': [
    { i: 'healthSummary', x: 0, y: 0, w: 6, h: 3 },
    { i: 'cacheHitRate', x: 6, y: 0, w: 6, h: 2 },
    { i: 'serverInfo', x: 0, y: 3, w: 12, h: 3 },
  ],
  debug: [
    { i: 'crewMan', x: 0, y: 0, w: 12, h: 6 },
    { i: 'endpointDiscovery', x: 0, y: 6, w: 6, h: 3 },
    { i: 'logsViewer', x: 6, y: 6, w: 6, h: 3 },
  ],
}

const breakpoints = { lg: 1200, md: 996, sm: 768 }
const cols = { lg: 12, md: 8, sm: 4 }

export default function AdminDashboard({ sectionKey }: { sectionKey: SectionKey }) {
  const { loadLayout, saveLayout } = useLayoutPersistence()
  const [layout, setLayout] = useState<LayoutItem[]>(DEFAULTS[sectionKey])

  // Load saved per-user layout
  useEffect(() => {
    let alive = true
    ;(async () => {
    const saved = await loadLayout(sectionKey)
    if (alive && Array.isArray(saved) && saved.length) setLayout(saved as LayoutItem[])
      if (!saved?.length) setLayout(DEFAULTS[sectionKey])
    })()
    return () => { alive = false }
  }, [loadLayout, sectionKey])

  const onLayoutChange = useCallback((l: LayoutItem[]) => {
    setLayout(l)
  }, [])

  const onLayoutSave = useCallback(async () => {
    await saveLayout(sectionKey, layout)
  }, [layout, saveLayout, sectionKey])

  // Simple placeholder tiles by id for now
  const tileIds = useMemo(() => DEFAULTS[sectionKey].map(d => d.i), [sectionKey])

  return (
    <div className="p-4 space-y-3">
      <div className="flex gap-2 justify-end">
        <button onClick={onLayoutSave} className="px-3 py-1 text-sm rounded bg-primary text-primary-foreground">Save Layout</button>
      </div>
      <GridLayout
        className="layout"
        cols={cols.lg}
        rowHeight={48}
        width={breakpoints.lg}
        margin={[16, 16] as [number, number]}
        containerPadding={[0, 0] as [number, number]}
        onLayoutChange={onLayoutChange}
        layout={layout}
        isDraggable
        isResizable
      >
        {tileIds.map((id) => (
          <div key={id} data-grid={layout.find(l => l.i === id)}>
            <Tile>
              <div className="text-sm font-semibold mb-1">{id}</div>
              {id === 'postEditor' ? (
                <PostEditorTile />
              ) : id === 'crewMan' ? (
                <CrewMan />
              ) : (
                <div className="text-xs text-muted-foreground">Content for {id}</div>
              )}
            </Tile>
          </div>
        ))}
      </GridLayout>
    </div>
  )
}


// ==== FILE: src\components\admin\BulkActionsBar.tsx ====
"use client"

import { useState } from 'react'
import { Check, ShieldAlert, Slash, Trash2 } from 'lucide-react'

import { Button } from '@/components/ui/button'

export type BulkAction = 'approve' | 'disapprove' | 'spam' | 'delete'

type Props = {
  onAction: (action: BulkAction) => void | Promise<void>
  disabled?: boolean
}

export default function BulkActionsBar({ onAction, disabled }: Props) {
  const [pending, setPending] = useState<BulkAction | null>(null)
  const run = async (action: BulkAction) => {
    try {
      setPending(action)
      await onAction(action)
    } finally {
      setPending(null)
    }
  }
  const isBusy = !!pending || disabled
  return (
    <div className="mb-4 flex gap-2">
      <Button size="sm" disabled={isBusy} onClick={() => run('approve')}><Check className="mr-2 h-4 w-4" /> Approve</Button>
      <Button size="sm" variant="secondary" disabled={isBusy} onClick={() => run('disapprove')}><Slash className="mr-2 h-4 w-4" /> Disapprove</Button>
      <Button size="sm" variant="destructive" disabled={isBusy} onClick={() => run('spam')}><ShieldAlert className="mr-2 h-4 w-4" /> Mark as Spam</Button>
      <Button size="sm" variant="destructive" disabled={isBusy} onClick={() => run('delete')}><Trash2 className="mr-2 h-4 w-4" /> Delete</Button>
    </div>
  )
}


// ==== FILE: src\components\admin\PageHeader.tsx ====
"use client"
import Link from 'next/link'
import { usePathname } from 'next/navigation'

export default function PageHeader({ title, subtitle }: { title: string; subtitle?: string }) {
  const pathname = usePathname() || '/'
  const parts = pathname.split('/').filter(Boolean)
  const crumbs = parts.map((p, i) => ({
    href: '/' + parts.slice(0, i + 1).join('/'),
    label: p.replace(/-/g, ' '),
  }))
  return (
    <div className="mb-6 border-b pb-4">
      <nav className="mb-2 text-xs text-muted-foreground">
        <ol className="flex items-center gap-1">
          <li><Link href="/">Home</Link></li>
          {crumbs.map((c, i) => (
            <li key={c.href} className="flex items-center gap-1">
              <span>/</span>
              {i === crumbs.length - 1 ? (
                <span className="font-medium text-foreground">{c.label}</span>
              ) : (
                <Link href={c.href} className="hover:underline">{c.label}</Link>
              )}
            </li>
          ))}
        </ol>
      </nav>
      <h1 className="text-3xl font-bold capitalize">{title}</h1>
      {subtitle && <p className="text-sm text-muted-foreground mt-1">{subtitle}</p>}
    </div>
  )
}


// ==== FILE: src\components\admin\PostEditorPageClient.tsx ====
'use client'
import React from 'react'

import PostEditorTile from './tiles/PostEditorTile'

type EditorInitial = { title?: string; content?: string; excerpt?: string; status?: string }

export default function PostEditorPageClient({ postId, initial }: { postId?: number; initial?: EditorInitial }) {
  // The tile already handles autosave/publish; this wrapper just provides full height container
  return (
    <div className="p-6 h-[calc(100vh-4rem)]">
      <PostEditorTile postId={postId} initial={initial} />
    </div>
  )
}


// ==== FILE: src\components\admin\SelectableTable.tsx ====
"use client"

import { useMemo, useState } from 'react'

import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table'
import { Checkbox } from '@/components/ui/checkbox'

export type Row = { id: number; cells: React.ReactNode[] }

type Props = {
  rows: Row[]
  header: React.ReactNode[]
  onSelectionChange?: (ids: number[]) => void
}

export default function SelectableTable({ rows, header, onSelectionChange }: Props) {
  const [selected, setSelected] = useState<Set<number>>(new Set())

  const allIds = useMemo(() => rows.map(r => r.id), [rows])
  const allChecked = selected.size > 0 && selected.size === rows.length
  const indeterminate = selected.size > 0 && selected.size < rows.length

  const toggleAll = (checked: boolean) => {
    const next = new Set<number>()
    if (checked) allIds.forEach(id => next.add(id))
    setSelected(next)
    onSelectionChange?.(Array.from(next))
  }
  const toggleOne = (id: number, checked: boolean) => {
    const next = new Set(selected)
    if (checked) next.add(id)
    else next.delete(id)
    setSelected(next)
    onSelectionChange?.(Array.from(next))
  }

  return (
    <Table>
      <TableHeader>
        <TableRow>
          <TableHead className="w-[40px]">
            <Checkbox checked={allChecked} onCheckedChange={(v)=>toggleAll(!!v)}
              {...(indeterminate ? { 'data-state': 'indeterminate' } : {})} />
          </TableHead>
          {header.map((h,i)=>(<TableHead key={i}>{h}</TableHead>))}
        </TableRow>
      </TableHeader>
      <TableBody>
        {rows.map(r=> (
          <TableRow key={r.id}>
            <TableCell className="w-[40px]"><Checkbox checked={selected.has(r.id)} onCheckedChange={(v)=>toggleOne(r.id, !!v)} /></TableCell>
            {r.cells.map((c,i)=>(<TableCell key={i}>{c}</TableCell>))}
          </TableRow>
        ))}
      </TableBody>
    </Table>
  )
}


// ==== FILE: src\components\admin\UnifiedAdmin.tsx ====
"use client"
import { useRoleGate } from '@/hooks/useRoleGate'
import { Tabs, TabsList, TabsTrigger, TabsContent } from '@/components/ui/tabs'
import { Card } from '@/components/ui/card'
import AnalyticsDashboard from '@/components/analytics/AnalyticsDashboard'

import ModerationPanel from './moderation/ModerationPanel'
import SettingsPanel from './settings/SettingsPanel'

export default function UnifiedAdmin() {
  const { allowed, loading } = useRoleGate('admin')
  if (loading) return <div>Loading‚Ä¶</div>
  if (!allowed) return <div className="text-sm text-muted-foreground">You don‚Äôt have access to the Admin Dashboard.</div>
  return (
    <Card className="p-4">
      <Tabs defaultValue="analytics">
        <TabsList>
          <TabsTrigger value="analytics">Analytics</TabsTrigger>
          <TabsTrigger value="moderation">Moderation</TabsTrigger>
          <TabsTrigger value="settings">Settings</TabsTrigger>
        </TabsList>
        <TabsContent value="analytics">
          <AnalyticsDashboard />
        </TabsContent>
        <TabsContent value="moderation">
          <ModerationPanel />
        </TabsContent>
        <TabsContent value="settings">
          <SettingsPanel />
        </TabsContent>
      </Tabs>
    </Card>
  )
}


// ==== FILE: src\components\admin\moderation\ModerationPanel.tsx ====
"use client"
import { useState } from 'react'

import { Card } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import { Accordion, AccordionContent, AccordionItem, AccordionTrigger } from '@/components/ui/accordion'

type Item = { id: number; title: string; status: 'pending'|'flagged'|'banned' }

export default function ModerationPanel() {
  const [pendingPosts] = useState<Item[]>([
    { id: 1, title: 'Pending draft: AI Trends', status: 'pending' },
  ])
  const [flaggedContent] = useState<Item[]>([
    { id: 2, title: 'Comment ID 4829', status: 'flagged' },
  ])
  const [userBans] = useState<Item[]>([
    { id: 3, title: 'user: spammer42', status: 'banned' },
  ])

  return (
    <div className="space-y-4">
      <Accordion type="multiple" className="w-full">
        <AccordionItem value="posts">
          <AccordionTrigger>Pending posts</AccordionTrigger>
          <AccordionContent>
            <Card className="p-4 overflow-x-auto">
              <table className="w-full text-sm">
                <thead>
                  <tr className="text-left text-muted-foreground">
                    <th className="py-1">ID</th>
                    <th className="py-1">Title</th>
                    <th className="py-1">Status</th>
                  </tr>
                </thead>
                <tbody>
                  {pendingPosts.map(p => (
                    <tr key={p.id} className="border-t">
                      <td className="py-2">{p.id}</td>
                      <td className="py-2">{p.title}</td>
                      <td className="py-2"><Badge variant="secondary">{p.status}</Badge></td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </Card>
          </AccordionContent>
        </AccordionItem>

        <AccordionItem value="flagged">
          <AccordionTrigger>Flagged content</AccordionTrigger>
          <AccordionContent>
            <Card className="p-4 overflow-x-auto">
              <table className="w-full text-sm">
                <thead>
                  <tr className="text-left text-muted-foreground">
                    <th className="py-1">ID</th>
                    <th className="py-1">Item</th>
                    <th className="py-1">Status</th>
                  </tr>
                </thead>
                <tbody>
                  {flaggedContent.map(p => (
                    <tr key={p.id} className="border-t">
                      <td className="py-2">{p.id}</td>
                      <td className="py-2">{p.title}</td>
                      <td className="py-2"><Badge variant="destructive">{p.status}</Badge></td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </Card>
          </AccordionContent>
        </AccordionItem>

        <AccordionItem value="bans">
          <AccordionTrigger>User bans</AccordionTrigger>
          <AccordionContent>
            <Card className="p-4 overflow-x-auto">
              <table className="w-full text-sm">
                <thead>
                  <tr className="text-left text-muted-foreground">
                    <th className="py-1">ID</th>
                    <th className="py-1">User</th>
                    <th className="py-1">Status</th>
                  </tr>
                </thead>
                <tbody>
                  {userBans.map(p => (
                    <tr key={p.id} className="border-t">
                      <td className="py-2">{p.id}</td>
                      <td className="py-2">{p.title}</td>
                      <td className="py-2"><Badge variant="outline">{p.status}</Badge></td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </Card>
          </AccordionContent>
        </AccordionItem>
      </Accordion>
    </div>
  )
}


// ==== FILE: src\components\admin\settings\SettingsPanel.tsx ====
"use client"
import { useState } from 'react'

import { Card } from '@/components/ui/card'
import { Switch } from '@/components/ui/switch'
import { Button } from '@/components/ui/button'

export default function SettingsPanel() {
  const [enableReferers, setEnableReferers] = useState(true)
  const [threshold, setThreshold] = useState(10)

  const refreshCache = async () => {
    try {
      const u = new URL('/api/analytics/summary', window.location.origin)
      u.searchParams.set('refresh', 'true')
      await fetch(u)
    } catch {}
  }

  return (
    <div className="grid gap-4 md:grid-cols-2">
      <Card className="p-4 space-y-3">
        <div className="font-medium">Feature toggles</div>
        <div className="flex items-center justify-between">
          <span className="text-sm">Enable referers</span>
          <Switch checked={enableReferers} onCheckedChange={setEnableReferers} />
        </div>
        <div className="text-xs text-muted-foreground">More toggles can be added later.</div>
      </Card>
      <Card className="p-4 space-y-3">
        <div className="font-medium">Cache controls</div>
        <div className="flex items-center gap-2">
          <Button size="sm" onClick={refreshCache}>Refresh Analytics Cache</Button>
          <span className="text-xs text-muted-foreground">Triggers transient eviction upstream</span>
        </div>
      </Card>
    </div>
  )
}


// ==== FILE: src\components\admin\tiles\PostEditorTile.tsx ====
'use client'
import React, { useCallback, useEffect, useMemo, useRef, useState } from 'react'

type WPPost = {
  id: number
  status?: string
  title?: { rendered?: string } | string
  content?: { rendered?: string } | string
  excerpt?: { rendered?: string } | string
}

function useDebouncedCallback(fn: () => void, delay: number) {
  const t = useRef<NodeJS.Timeout | null>(null)
  return useCallback(() => {
    if (t.current) clearTimeout(t.current)
    t.current = setTimeout(fn, delay)
  }, [fn, delay])
}

export default function PostEditorTile({ postId: postIdProp, initial }: { postId?: number, initial?: { title?: string, content?: string, excerpt?: string, status?: string } }) {
  const [postId, setPostId] = useState<number | null>(postIdProp ?? null)
  const [title, setTitle] = useState(initial?.title || '')
  const [content, setContent] = useState(initial?.content || '')
  const [excerpt, setExcerpt] = useState(initial?.excerpt || '')
  const [status, setStatus] = useState<'draft'|'pending'|'publish'|'auto-draft'|'future'|'private'|'trash'|'unknown'>(
    (initial?.status as any) || 'draft'
  )
  const [isSaving, setIsSaving] = useState(false)
  const [lastSavedAt, setLastSavedAt] = useState<number | null>(null)
  const [error, setError] = useState<string | null>(null)
  const [lastSyncHash, setLastSyncHash] = useState<string>('')

  const isDirty = useMemo(() => {
    return !!(title || content || excerpt)
  }, [title, content, excerpt])
  const currentHash = useMemo(() => JSON.stringify({ title, content, excerpt }), [title, content, excerpt])

  // Create draft automatically on first typing with small debounce
  const createDraftDebounced = useDebouncedCallback(async () => {
    if (postId || !isDirty || postIdProp) return
    try {
      setIsSaving(true)
      setError(null)
      const res = await fetch('/api/wp/posts', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title: title || 'Untitled draft', content, excerpt, status: 'draft' }),
      })
      if (!res.ok) throw new Error(`${res.status}`)
      const j: WPPost = await res.json()
      setPostId(j.id)
      setStatus('draft')
  setLastSavedAt(Date.now())
  setLastSyncHash(currentHash)
    } catch (e: any) {
      setError(`Failed to create draft: ${e?.message || e}`)
    } finally {
      setIsSaving(false)
    }
  }, 800)

  useEffect(() => {
    if (!postId && isDirty && !postIdProp) createDraftDebounced()
  }, [postId, isDirty, createDraftDebounced, title, content, excerpt, postIdProp])

  // Autosave every 10s when there are changes and we have a postId
  useEffect(() => {
    if (!postId) return
    const iv = setInterval(() => {
      void autosave()
    }, 10_000)
    return () => clearInterval(iv)
  }, [postId, title, content, excerpt])

  const autosave = useCallback(async () => {
    if (!postId) return
    if (!isDirty) return
    if (currentHash === lastSyncHash) return
    try {
      setIsSaving(true)
      setError(null)
      const res = await fetch(`/api/wp/posts?id=${postId}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title, content, excerpt, meta: { _autosave: true } }),
      })
      if (!res.ok) throw new Error(`${res.status}`)
      setLastSavedAt(Date.now())
      setLastSyncHash(currentHash)
    } catch (e: any) {
      setError(`Autosave failed: ${e?.message || e}`)
    } finally {
      setIsSaving(false)
    }
  }, [postId, title, content, excerpt, isDirty, currentHash, lastSyncHash])

  const saveNow = useCallback(async () => {
    await autosave()
  }, [autosave])

  const publishRequest = useCallback(async () => {
    if (!postId) return
    try {
      setIsSaving(true)
      setError(null)
      const res = await fetch(`/api/wp/posts?id=${postId}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: 'pending' }),
      })
      if (!res.ok) throw new Error(`${res.status}`)
      setStatus('pending')
    } catch (e: any) {
      setError(`Publish request failed: ${e?.message || e}`)
    } finally {
      setIsSaving(false)
    }
  }, [postId])

  const deleteDraft = useCallback(async () => {
    if (!postId) return
    try {
      setIsSaving(true)
      setError(null)
      const res = await fetch(`/api/wp/posts?id=${postId}`, { method: 'DELETE' })
      if (!res.ok) throw new Error(`${res.status}`)
      // Reset editor state
      setPostId(null)
      setTitle('')
      setContent('')
      setExcerpt('')
      setStatus('draft')
      setLastSavedAt(null)
    } catch (e: any) {
      setError(`Delete failed: ${e?.message || e}`)
    } finally {
      setIsSaving(false)
    }
  }, [postId])

  const disabled = status === 'pending'

  return (
    <div className="h-full flex flex-col">
      <div className="mb-2 flex items-center gap-2 text-xs">
        <span className="px-2 py-0.5 rounded bg-secondary text-secondary-foreground">{postId ? `Draft #${postId}` : 'New draft'}</span>
        <span className={`px-2 py-0.5 rounded ${status === 'pending' ? 'bg-amber-500 text-white' : 'bg-muted text-muted-foreground'}`}>{status}</span>
        {isSaving ? <span className="text-muted-foreground">Saving‚Ä¶</span> : lastSavedAt ? <span className="text-muted-foreground">Saved {new Date(lastSavedAt).toLocaleTimeString()}</span> : null}
        {error && <span className="text-red-600">{error}</span>}
        <div className="ml-auto flex gap-2">
          <button className="px-2 py-1 rounded border text-xs" onClick={saveNow} disabled={!postId || disabled || isSaving}>Save</button>
          <button className="px-2 py-1 rounded border text-xs" onClick={publishRequest} disabled={!postId || disabled || isSaving}>Request Publish</button>
          <button className="px-2 py-1 rounded border text-xs" onClick={deleteDraft} disabled={!postId || disabled || isSaving}>Delete</button>
        </div>
      </div>
      <input
        type="text"
        placeholder="Post title..."
        className="w-full mb-2 px-3 py-2 rounded border bg-background"
        value={title}
        onChange={(e) => setTitle(e.target.value)}
        onBlur={saveNow}
        disabled={disabled}
      />
      <textarea
        placeholder="Write your content here..."
        className="w-full flex-1 mb-2 px-3 py-2 rounded border bg-background resize-none"
        value={content}
        onChange={(e) => setContent(e.target.value)}
        onBlur={saveNow}
        disabled={disabled}
      />
      <textarea
        placeholder="Excerpt (optional)"
        className="w-full px-3 py-2 rounded border bg-background resize-y"
        value={excerpt}
        onChange={(e) => setExcerpt(e.target.value)}
        onBlur={saveNow}
        disabled={disabled}
      />
      {postId && (
        <div className="mt-2 text-xs text-muted-foreground">
          Continue in full editor: <a className="underline" href={`/admin/posts/${postId}/edit`}>/admin/posts/{postId}/edit</a>
        </div>
      )}
    </div>
  )
}


// ==== FILE: src\components\admin\tiles\Tile.tsx ====
import React from 'react'

export default function Tile({ children, className = '' }: { children: React.ReactNode; className?: string }) {
  return (
    <div className={`p-4 bg-white dark:bg-gray-900 rounded-xl shadow transition-all duration-300 ease-in-out hover:shadow-lg hover:scale-[1.01] ${className}`}>
      {children}
    </div>
  )
}


// ==== FILE: src\components\analytics\AnalyticsCharts.tsx ====
"use client"
import { useMemo } from 'react'
import { useQuery } from '@tanstack/react-query'
import { ResponsiveContainer, LineChart, Line, BarChart, Bar, XAxis, YAxis, Tooltip, PieChart, Pie, Cell } from 'recharts'

import { Card } from '@/components/ui/card'

import type { Period } from '../../../types/analytics'

type Props = {
  period: Period
  postIds: number[]
  chartType: 'line'|'bar'
  granularity: 'daily'|'weekly'
  autoRefresh: boolean
  queryKeyBase: any[]
}

export default function AnalyticsCharts({ period, postIds, chartType, granularity, autoRefresh, queryKeyBase }: Props) {
  const refreshMs = autoRefresh ? 60000 : undefined
  const postId = postIds.length === 1 ? String(postIds[0]) : undefined
  const summaryKey = useMemo(() => ['analytics','summary', period], [period])
  const { data: summary } = useQuery({
    queryKey: summaryKey,
    queryFn: async () => {
      const u = new URL('/api/analytics/summary', window.location.origin)
      u.searchParams.set('period', period)
      const res = await fetch(u)
      if (!res.ok) throw new Error('Failed to load summary')
      return res.json()
    },
    refetchInterval: refreshMs,
    staleTime: 60_000,
    gcTime: 5 * 60_000,
  })

  const topKey = useMemo(() => ['analytics','top',period], [period])
  const { data: topPosts } = useQuery({
    queryKey: topKey,
    queryFn: async () => {
      const u = new URL('/api/analytics/top-posts', window.location.origin)
      u.searchParams.set('period', period)
      const res = await fetch(u)
      return res.json()
    },
    refetchInterval: refreshMs,
  })

  // Devices can be read from summary when needed elsewhere

  return (
    <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <Card className="p-4">
        <h3 className="font-medium mb-2">Views over time</h3>
        <div className="h-64">
          <ResponsiveContainer width="100%" height="100%">
            {chartType === 'line' ? (
              <LineChart data={summary?.trends?.series || []}>
                <XAxis dataKey="date" hide={false} />
                <YAxis />
                <Tooltip />
                <Line type="monotone" dataKey="views" stroke="#2563eb" strokeWidth={2} dot={false} />
              </LineChart>
            ) : (
              <BarChart data={summary?.trends?.series || []}>
                <XAxis dataKey="date" hide={false} />
                <YAxis />
                <Tooltip />
                <Bar dataKey="views" fill="#10b981" />
              </BarChart>
            )}
          </ResponsiveContainer>
        </div>
      </Card>

      <Card className="p-4">
        <h3 className="font-medium mb-2">Top posts</h3>
        <div className="h-64">
          <ResponsiveContainer width="100%" height="100%">
            <BarChart data={topPosts || []}>
              <XAxis dataKey="title" hide={false} interval={0} angle={-20} textAnchor="end" height={70} />
              <YAxis />
              <Tooltip />
              <Bar dataKey="views" fill="#f59e0b" />
            </BarChart>
          </ResponsiveContainer>
        </div>
      </Card>
    </div>
  )
}


// ==== FILE: src\components\analytics\AnalyticsDashboard.tsx ====
"use client"
import { useMemo, useState } from 'react'
import { useQuery } from '@tanstack/react-query'

import { Tabs, TabsList, TabsTrigger, TabsContent } from '@/components/ui/tabs'
import { Card } from '@/components/ui/card'

import type { Period } from '../../../types/analytics'

import AnalyticsHeader from './AnalyticsHeader'
import AnalyticsCharts from './AnalyticsCharts'
import AnalyticsTable from './AnalyticsTable'
import AnalyticsSidebar from './AnalyticsSidebar'
import SessionsChart from './SessionsChart'
import AnalyticsWorldMap from './AnalyticsWorldMap'


export default function AnalyticsDashboard() {
  const [period, setPeriod] = useState<Period>('month')
  const [postIds, setPostIds] = useState<number[]>([])
  const [chartType, setChartType] = useState<'line'|'bar'>('line')
  const [granularity, setGranularity] = useState<'daily'|'weekly'>('daily')
  const [autoRefresh, setAutoRefresh] = useState(false)
  const [tab, setTab] = useState<'views'|'devices'|'countries'|'referers'|'sessions'>('views')

  const queryKeyBase = useMemo(() => [period, postIds.join(','), granularity], [period, postIds, granularity])

  // Prefetch unified summary for sidebar and possibly charts
  useQuery({
    queryKey: ['analytics','summary',period],
    queryFn: async () => {
      const u = new URL('/api/analytics/summary', window.location.origin)
      u.searchParams.set('period', period)
      const r = await fetch(u)
      if (!r.ok) throw new Error('Failed to load summary')
      return r.json()
    },
    staleTime: 60_000,
    gcTime: 5 * 60_000,
  })

  return (
    <div className="grid grid-cols-1 lg:grid-cols-12 gap-4">
      <div className="lg:col-span-9 space-y-4">
        <AnalyticsHeader
          period={period}
          onPeriodChange={setPeriod}
          postIds={postIds}
          onPostIdsChange={setPostIds}
          chartType={chartType}
          onChartTypeChange={setChartType}
          granularity={granularity}
          onGranularityChange={setGranularity}
          autoRefresh={autoRefresh}
          onAutoRefreshChange={setAutoRefresh}
        />
        <Tabs value={tab} onValueChange={(v: any) => setTab(v)}>
          <TabsList>
            <TabsTrigger value="views">Views</TabsTrigger>
            <TabsTrigger value="devices">Devices</TabsTrigger>
            <TabsTrigger value="countries">Countries</TabsTrigger>
            <TabsTrigger value="referers">Referers</TabsTrigger>
            <TabsTrigger value="sessions">Sessions</TabsTrigger>
          </TabsList>
          <TabsContent value="views">
            <AnalyticsCharts
              period={period}
              postIds={postIds}
              chartType={chartType}
              granularity={granularity}
              autoRefresh={autoRefresh}
              queryKeyBase={queryKeyBase}
            />
          </TabsContent>
          <TabsContent value="devices">
            <DevicesMain period={period} />
          </TabsContent>
          <TabsContent value="countries">
            <AnalyticsWorldMap period={period} />
          </TabsContent>
          <TabsContent value="referers">
            <AnalyticsTable period={period} postIds={postIds} />
          </TabsContent>
          <TabsContent value="sessions">
            <SessionsChart period={period} />
          </TabsContent>
        </Tabs>
      </div>
      <div className="lg:col-span-3">
        <AnalyticsSidebar period={period} postIds={postIds} />
      </div>
    </div>
  )
}

function DevicesMain({ period }: { period: Period }) {
  const { data } = useQuery({
    queryKey: ['analytics','summary',period,'devices'],
    queryFn: async () => {
      const u = new URL('/api/analytics/summary', window.location.origin)
      u.searchParams.set('period', period)
      const r = await fetch(u)
      if (!r.ok) throw new Error('Failed to load summary')
      return r.json()
    },
    staleTime: 60_000,
    gcTime: 5 * 60_000,
  })
  return (
    <Card className="p-4">
      <div className="font-medium mb-2">Devices breakdown</div>
      <pre className="text-xs overflow-auto">{JSON.stringify(data?.devices || [], null, 2)}</pre>
    </Card>
  )
}

function CountriesMain({ period }: { period: Period }) {
  // Deprecated: countries now rendered via AnalyticsWorldMap which consumes summary.countries
  return null
}


// ==== FILE: src\components\analytics\AnalyticsHeader.tsx ====
"use client"
import { useEffect, useMemo, useState } from 'react'
import { motion } from 'framer-motion'

import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'
import { Button } from '@/components/ui/button'
import { Calendar } from '@/components/ui/calendar'
import { Command, CommandEmpty, CommandGroup, CommandInput, CommandItem, CommandList } from '@/components/ui/command'
import { Badge } from '@/components/ui/badge'

import type { Period } from '../../../types/analytics'


type Props = {
  period: Period
  onPeriodChange: (p: Period) => void
  postIds: number[]
  onPostIdsChange: (ids: number[]) => void
  chartType: 'line' | 'bar'
  onChartTypeChange: (t: 'line' | 'bar') => void
  granularity: 'daily' | 'weekly'
  onGranularityChange: (g: 'daily' | 'weekly') => void
  autoRefresh: boolean
  onAutoRefreshChange: (v: boolean) => void
}

export default function AnalyticsHeader(props: Props) {
  const { period, onPeriodChange, postIds, onPostIdsChange, chartType, onChartTypeChange, granularity, onGranularityChange, autoRefresh, onAutoRefreshChange } = props
  const [date, setDate] = useState<Date | undefined>(new Date())

  return (
    <motion.div initial={{ opacity: 0, y: -8 }} animate={{ opacity: 1, y: 0 }} className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
      <div className="flex items-center gap-2">
        <Select value={period} onValueChange={(v: any) => onPeriodChange(v)}>
          <SelectTrigger className="w-40"><SelectValue placeholder="Period" /></SelectTrigger>
          <SelectContent>
            <SelectItem value="day">Day</SelectItem>
            <SelectItem value="week">Week</SelectItem>
            <SelectItem value="month">Month</SelectItem>
            <SelectItem value="quarter">Quarter</SelectItem>
            <SelectItem value="year">Year</SelectItem>
          </SelectContent>
        </Select>
        <Select value={chartType} onValueChange={(v: any) => onChartTypeChange(v)}>
          <SelectTrigger className="w-32"><SelectValue placeholder="Chart" /></SelectTrigger>
          <SelectContent>
            <SelectItem value="line">Line</SelectItem>
            <SelectItem value="bar">Bar</SelectItem>
          </SelectContent>
        </Select>
        <Select value={granularity} onValueChange={(v: any) => onGranularityChange(v)}>
          <SelectTrigger className="w-36"><SelectValue placeholder="Granularity" /></SelectTrigger>
          <SelectContent>
            <SelectItem value="daily">Daily</SelectItem>
            <SelectItem value="weekly">Weekly</SelectItem>
          </SelectContent>
        </Select>
      </div>
      <div className="flex items-center gap-2">
        <PostMultiSelect selected={postIds} onChange={onPostIdsChange} />
        <Button size="sm" variant="outline" onClick={() => {
          const u = new URL('/api/analytics/export', window.location.origin)
          u.searchParams.set('type', 'views')
          u.searchParams.set('period', period)
          if (postIds.length === 1) u.searchParams.set('postId', String(postIds[0]))
          window.location.href = u.toString()
        }}>Download CSV</Button>
      </div>
      <div className="flex items-center gap-2">
        <Calendar mode="single" selected={date} onSelect={setDate} className="rounded-md border" />
      </div>
      <div className="flex items-center gap-2 col-span-full">
        <label className="inline-flex items-center gap-2 text-sm">
          <input type="checkbox" checked={autoRefresh} onChange={(e) => onAutoRefreshChange(e.target.checked)} />
          Auto-refresh (60s)
        </label>
        <Button size="sm" onClick={() => window.location.reload()}>Refresh</Button>
      </div>
    </motion.div>
  )
}

type PostItem = { id: number; title: string; slug: string }

function PostMultiSelect({ selected, onChange }: { selected: number[]; onChange: (ids: number[]) => void }) {
  const [q, setQ] = useState('')
  const [loading, setLoading] = useState(false)
  const [options, setOptions] = useState<PostItem[]>([])

  // Debounced search to /api/wp/posts
  useEffect(() => {
    const h = setTimeout(async () => {
      setLoading(true)
      try {
        const url = new URL('/api/wp/posts', window.location.origin)
        url.searchParams.set('search', q)
        url.searchParams.set('_fields', 'id,slug,title')
        url.searchParams.set('per_page', '20')
        const res = await fetch(url.toString())
        if (res.ok) {
          const arr = await res.json()
          const mapped = Array.isArray(arr) ? arr.map((p: any) => ({ id: p.id, slug: p.slug, title: p.title?.rendered || p.title || p.slug })) : []
          setOptions(mapped)
        }
      } finally {
        setLoading(false)
      }
    }, 300)
    return () => clearTimeout(h)
  }, [q])

  const toggle = (id: number) => {
    const set = new Set(selected)
    if (set.has(id)) set.delete(id); else set.add(id)
    onChange(Array.from(set))
  }

  return (
    <div className="flex flex-col gap-2">
      <div className="flex flex-wrap gap-1">
        {selected.length === 0 && <Badge variant="secondary">All posts</Badge>}
        {selected.map(id => (
          <Badge key={id} variant="outline" className="cursor-pointer" onClick={() => toggle(id)}>#{id}</Badge>
        ))}
        {selected.length > 0 && (
          <Button size="sm" variant="ghost" onClick={() => onChange([])}>Clear</Button>
        )}
      </div>
      <div className="w-96 max-w-full">
        <Command>
          <CommandInput value={q} onValueChange={setQ} placeholder="Search posts‚Ä¶" />
          <CommandList>
            <CommandEmpty>{loading ? 'Loading‚Ä¶' : 'No results.'}</CommandEmpty>
            <CommandGroup heading="Results">
              {options.map(o => (
                <CommandItem key={o.id} onSelect={() => toggle(o.id)}>
                  <span className="mr-2 text-xs text-muted-foreground">#{o.id}</span>
                  {o.title}
                </CommandItem>
              ))}
            </CommandGroup>
          </CommandList>
        </Command>
      </div>
    </div>
  )
}


// ==== FILE: src\components\analytics\AnalyticsSidebar.tsx ====
"use client"
import { useQuery } from '@tanstack/react-query'
import { ResponsiveContainer, PieChart, Pie, Cell, Tooltip } from 'recharts'

import { Card } from '@/components/ui/card'

import type { Period } from '../../../types/analytics'

const COLORS = ['#2563eb', '#10b981', '#f59e0b', '#ef4444']

type Summary = {
  period: string
  devices: { device_type: string; count: number }[]
  countries: { country_code: string; count: number }[]
}

export default function AnalyticsSidebar({ period, postIds: _postIds }: { period: Period, postIds: number[] }) {
  const { data } = useQuery<Summary>({
    queryKey: ['analytics','summary',period],
    queryFn: async () => {
      const u = new URL('/api/analytics/summary', window.location.origin)
      u.searchParams.set('period', period)
      const r = await fetch(u)
      if (!r.ok) throw new Error('Failed to load summary')
      return r.json()
    },
    staleTime: 60_000,
    gcTime: 5 * 60_000,
  })

  const devices = data?.devices || []
  const countries = data?.countries || []
  const total = devices.reduce((a: number, b: any) => a + (b.count || 0), 0)

  return (
    <div className="space-y-4">
      <Card className="p-4">
        <div className="text-sm text-muted-foreground">Total device-sampled views</div>
        <div className="text-2xl font-semibold">{total}</div>
        <div className="h-48 mt-4">
          <ResponsiveContainer width="100%" height="100%">
            <PieChart>
              <Pie 
                data={devices} 
                dataKey="count" 
                nameKey="device_type" 
                outerRadius={70} 
                label
              >
                {devices.map((_: any, i: number) => (
                  <Cell key={`c-${i}`} fill={COLORS[i % COLORS.length]} />
                ))}
              </Pie>
              <Tooltip />
            </PieChart>
          </ResponsiveContainer>
        </div>
      </Card>
      <Card className="p-4">
        <div className="text-sm font-medium mb-2">Top countries</div>
        <ul className="space-y-1 text-sm">
          {countries.slice(0, 10).map((c: any, i: number) => (
            <li key={i} className="flex justify-between">
              <span>{c.country_code}</span>
              <span>{c.count}</span>
            </li>
          ))}
        </ul>
      </Card>
    </div>
  )
}


// ==== FILE: src\components\analytics\AnalyticsTable.tsx ====
"use client"
import { useQuery } from '@tanstack/react-query'

import { Card } from '@/components/ui/card'

import type { Period } from '../../../types/analytics'

type SummaryResp = { referers?: { source: string; count: number }[] }

export default function AnalyticsTable({ period, postIds }: { period: Period, postIds: number[] }) {
  const { data } = useQuery<SummaryResp>({
    queryKey: ['analytics','summary',period],
    queryFn: async () => {
      const u = new URL('/api/analytics/summary', window.location.origin)
      u.searchParams.set('period', period)
      const r = await fetch(u)
      if (!r.ok) throw new Error('Failed to load summary')
      return r.json()
    },
    staleTime: 60_000,
    gcTime: 5 * 60_000,
  })
  const rows = data?.referers || []
  return (
    <Card className="p-4 overflow-auto">
      <h3 className="font-medium mb-2">Referers</h3>
      <table className="min-w-full text-sm">
        <thead><tr><th className="text-left">Source</th><th className="text-left">Count</th></tr></thead>
        <tbody>
          {rows.map((row: any, i: number) => (
            <tr key={i} className="border-t"><td>{row.source}</td><td>{row.count}</td></tr>
          ))}
        </tbody>
      </table>
    </Card>
  )
}


// ==== FILE: src\components\analytics\AnalyticsWorldMap.tsx ====
"use client"
import { useMemo } from 'react'
import { useQuery } from '@tanstack/react-query'
import { scaleLinear } from 'd3-scale'
import isoCountries from 'i18n-iso-countries'
import { ComposableMap, Geographies, Geography } from 'react-simple-maps'
import enCountries from 'i18n-iso-countries/langs/en.json'
type LocaleData = { locale: string; countries: Record<string, string> }

import { Card } from '@/components/ui/card'

import type { Period, CountryBreakdown } from '../../../types/analytics'

// Register English locale for country mappings if needed
try {
  isoCountries.registerLocale(enCountries as unknown as LocaleData)
} catch {
  // TODO: implement fallback if locale registration fails
}

const geoUrl = 'https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json'

export default function AnalyticsWorldMap({ period }: { period: Period }) {
  const { data, isLoading } = useQuery<{ countries?: CountryBreakdown[] }>({
    queryKey: ['analytics', 'summary', period, 'map'],
    queryFn: async () => {
      const u = new URL('/api/analytics/summary', window.location.origin)
      u.searchParams.set('period', period)
      const r = await fetch(u)
      if (!r.ok) throw new Error('Failed to load summary')
      return r.json()
    },
    staleTime: 60_000,
    gcTime: 5 * 60_000,
  })

  const { countsByNumeric, max } = useMemo(() => {
  const list = data?.countries || []
    const map: Record<string, number> = {}
    let max = 0
    for (const c of list) {
      const code = (c.country_code || '').toString().trim()
      let numeric: string | undefined
      if (/^\d+$/.test(code)) {
        // already numeric string, pad to 3
        numeric = code.padStart(3, '0')
      } else if (code.length === 2) {
        const all = isoCountries.getNumericCodes() as Record<string, string>
        const n = all[code.toUpperCase()]
        if (n) numeric = String(n).padStart(3, '0')
      } else if (code.length === 3) {
        // alpha-3 -> numeric
        const alpha2 = isoCountries.alpha3ToAlpha2(code.toUpperCase()) as string | undefined
        if (alpha2) {
          const all = isoCountries.getNumericCodes() as Record<string, string>
          const n = all[alpha2.toUpperCase()]
          if (n) numeric = String(n).padStart(3, '0')
        }
      }
      if (numeric) {
        map[numeric] = (map[numeric] || 0) + (c.count || 0)
        if (map[numeric] > max) max = map[numeric]
      }
    }
    return { countsByNumeric: map, max }
  }, [data])

  const color = useMemo(() => {
    // Tailwind indigo-100 -> indigo-900-ish
    return scaleLinear<string>().domain([0, Math.max(1, max)])
      .range(['#dbeafe', '#1e3a8a'])
  }, [max])

  return (
    <Card className="p-4">
      <div className="font-medium mb-2">World traffic heatmap</div>
      <div className="w-full h-[420px]">
        <ComposableMap projectionConfig={{ scale: 140 }}>
          <Geographies geography={geoUrl}>
            {({ geographies }: { geographies: Array<{ id: string | number; rsmKey: string }> }) =>
              geographies.map((geo) => {
                const key = String(geo.id).padStart(3, '0')
                const v = countsByNumeric[key] || 0
                return (
                  <Geography
                    key={geo.rsmKey}
                    geography={geo}
                    fill={v ? color(v) : '#f1f5f9'}
                    stroke="#ffffff"
                    strokeWidth={0.4}
                    style={{ default: { outline: 'none' }, hover: { outline: 'none', fill: '#60a5fa' }, pressed: { outline: 'none' } }}
                  />
                )
              })
            }
          </Geographies>
        </ComposableMap>
      </div>
      {isLoading ? <div className="text-xs text-muted-foreground">Loading‚Ä¶</div> : null}
    </Card>
  )
}


// ==== FILE: src\components\analytics\SessionsChart.tsx ====
"use client"
import { useQuery } from '@tanstack/react-query'
import { ResponsiveContainer, LineChart, Line, XAxis, YAxis, Tooltip, CartesianGrid } from 'recharts'

import { Card } from '@/components/ui/card'

import type { Period } from '../../../types/analytics'

type SummaryResp = { sessions?: { data: { date: string; sessions: number }[] } }

export default function SessionsChart({ period }: { period: Period }) {
  const { data, isLoading } = useQuery<SummaryResp>({
    queryKey: ['analytics','summary',period],
    queryFn: async () => {
      const u = new URL('/api/analytics/summary', window.location.origin)
      u.searchParams.set('period', period)
      const r = await fetch(u)
      if (!r.ok) throw new Error('Failed to load summary')
      return r.json()
    },
    staleTime: 60_000,
    gcTime: 5 * 60_000,
  })

  const series = data?.sessions?.data || []

  return (
    <Card className="p-4 h-[360px]">
      <div className="font-medium mb-2">Sessions over time</div>
      <ResponsiveContainer width="100%" height="100%">
        <LineChart data={series} margin={{ top: 10, right: 10, bottom: 0, left: 0 }}>
          <CartesianGrid strokeDasharray="3 3" />
          <XAxis dataKey="date" minTickGap={24} />
          <YAxis allowDecimals={false} />
          <Tooltip />
          <Line type="monotone" dataKey="sessions" stroke="#6366f1" strokeWidth={2} dot={false} />
        </LineChart>
      </ResponsiveContainer>
      {isLoading ? <div className="text-xs text-muted-foreground">Loading‚Ä¶</div> : null}
    </Card>
  )
}


// ==== FILE: src\components\auth\UserMenu.tsx ====
import React from 'react'

export default function UserMenu({ user }: { user: any }) {
  async function logout() {
    await fetch('/api/auth/logout', { method: 'POST', headers: { 'x-csrf-token': getCsrfCookie() } })
    // reload client
    window.location.href = '/login'
  }

  function getCsrfCookie() {
    if (typeof document === 'undefined') return ''
    return document.cookie.split('; ').find(c => c.startsWith('csrf='))?.split('=')[1] || ''
  }

  return (
    <div>
      <div>{user.display_name || user.username}</div>
      <div>Roles: {(user.roles || []).join(', ')}</div>
      <button onClick={logout}>Logout</button>
    </div>
  )
}


// ==== FILE: src\components\dashboard\CrewMan.tsx ====
"use client"
import React, { useEffect, useMemo, useState } from 'react'

import { Card } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { Textarea } from '@/components/ui/textarea'
import { Input } from '@/components/ui/input'
import { RoleGate } from '@/hooks/useRoleGate'

type Endpoint = { method: string; route: string }

export default function CrewMan() {
  const [endpoints, setEndpoints] = useState<Endpoint[]>([])
  const [method, setMethod] = useState('GET')
  const [route, setRoute] = useState('/api/_debug')
  const [headers, setHeaders] = useState('{"Content-Type":"application/json"}')
  const [body, setBody] = useState('{}')
  const [result, setResult] = useState<string>('')
  const [saving, setSaving] = useState(false)
  const [favorites, setFavorites] = useState<any[]>([])

  useEffect(() => {
    const run = async () => {
      try {
        const r = await fetch('/api/core/endpoints')
        if (r.ok) {
          const list = await r.json()
          setEndpoints(list)
        }
      } catch {}
    }
    run()
  }, [])

  useEffect(() => {
    try { const fav = JSON.parse(localStorage.getItem('crewman:favorites') || '[]'); setFavorites(Array.isArray(fav) ? fav : []) } catch {}
  }, [])

  const methods = useMemo(() => ['GET','POST','PUT','PATCH','DELETE'], [])

  const fire = async () => {
    setSaving(true)
    try {
      const init: RequestInit = { method }
      try { init.headers = JSON.parse(headers || '{}') } catch {}
      if (method !== 'GET' && method !== 'HEAD' && body && body.trim() && init.headers && (init.headers as any)['Content-Type']?.includes('application/json')) {
        init.body = body
      }
      const r = await fetch(route, init)
      const ct = r.headers.get('content-type') || ''
      const text = ct.includes('application/json') ? JSON.stringify(await r.json(), null, 2) : await r.text()
      setResult(text)
    } catch (e: any) {
      setResult(`Error: ${e?.message || 'Request failed'}`)
    } finally { setSaving(false) }
  }

  const saveFav = () => {
    const fav = { method, route, headers, body, at: Date.now() }
    const all = [fav, ...favorites].slice(0, 20)
    setFavorites(all)
    localStorage.setItem('crewman:favorites', JSON.stringify(all))
  }

  return (
    <RoleGate action="admin" as="div">
      <Card className="p-3 space-y-3">
        <div className="flex items-center justify-between">
          <div className="font-medium">CrewMan ‚Äî API Tester</div>
          <div className="flex gap-2">
            <Button size="sm" onClick={saveFav} variant="secondary">Save Favorite</Button>
            <Button size="sm" onClick={fire} disabled={saving}>{saving ? 'Sending‚Ä¶' : 'Send'}</Button>
          </div>
        </div>
        <div className="grid grid-cols-1 md:grid-cols-4 gap-2">
          <select className="border rounded px-2 py-1" value={method} onChange={(e) => setMethod(e.target.value)}>
            {methods.map(m => <option key={m} value={m}>{m}</option>)}
          </select>
          <select className="border rounded px-2 py-1 md:col-span-3" value={route} onChange={(e) => setRoute(e.target.value)}>
            {[route, ...endpoints.map(e => e.route)].filter((v, i, a) => !!v && a.indexOf(v) === i).map((r) => (
              <option key={r} value={r}>{r}</option>
            ))}
          </select>
        </div>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
          <div className="space-y-2">
            <div className="text-xs text-muted-foreground">Headers (JSON)</div>
            <Textarea value={headers} onChange={(e) => setHeaders(e.target.value)} className="h-28 font-mono text-xs" />
            <div className="text-xs text-muted-foreground">Body</div>
            <Textarea value={body} onChange={(e) => setBody(e.target.value)} className="h-36 font-mono text-xs" />
          </div>
          <div className="space-y-2">
            <div className="text-xs text-muted-foreground">Response</div>
            <Textarea readOnly value={result} className="h-72 font-mono text-xs" />
          </div>
        </div>
        {favorites.length ? (
          <div>
            <div className="text-xs font-medium mb-1">Favorites</div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
              {favorites.map((f, i) => (
                <Card key={i} className="p-2 text-xs flex items-center justify-between gap-2">
                  <div className="truncate"><span className="text-muted-foreground">{f.method}</span> {f.route}</div>
                  <Button size="sm" variant="secondary" onClick={() => { setMethod(f.method); setRoute(f.route); setHeaders(f.headers); setBody(f.body) }}>Load</Button>
                </Card>
              ))}
            </div>
          </div>
        ) : null}
      </Card>
    </RoleGate>
  )
}


// ==== FILE: src\components\dashboard\DashboardClientShell.tsx ====
"use client"
import dynamic from 'next/dynamic'
import React from 'react'

// Load heavy client-only widgets without SSR to avoid window references at build/prerender
const FullDashboard = dynamic(() => import('./FullDashboard'), { ssr: false })
const CrewMan = dynamic(() => import('./CrewMan'), { ssr: false })

export default function DashboardClientShell() {
  return (
    <>
      <FullDashboard />
      <CrewMan />
    </>
  )
}


// ==== FILE: src\components\dashboard\FullDashboard.tsx ====
"use client"
import React, { useEffect, useMemo, useState } from 'react'

import GridLayout, { type Layout as RGLLayout } from 'react-grid-layout'
import 'react-grid-layout/css/styles.css'
import 'react-resizable/css/styles.css'
import { Card } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { MetricsProvider, useMetrics } from '@/contexts/metrics-context'
import { RoleGate } from '@/hooks/useRoleGate'

import MetricsDashboardControls from './MetricsDashboardControls'

type SavedLayout = RGLLayout

function WidgetFrame({ title, children, actions }: { title: string; actions?: React.ReactNode; children: React.ReactNode }) {
  return (
    <Card className="h-full w-full p-3 flex flex-col gap-2 overflow-hidden">
      <div className="flex items-center justify-between text-sm">
        <div className="font-medium truncate">{title}</div>
        <div className="flex items-center gap-2">{actions}</div>
      </div>
      <div className="flex-1 min-h-0">{children}</div>
    </Card>
  )
}

function MetricsWidget() {
  const { metrics, evals, evalMetric } = useMetrics()
  useEffect(() => {
    // kick off evals for pinned metrics
    metrics.filter(m => m.pinned).forEach(m => {
      if (!evals[m.id]) evalMetric(m.id)
    })
  }, [metrics])
  const visible = metrics.filter(m => m.pinned)
  if (visible.length === 0) return <div className="text-xs text-muted-foreground">No pinned metrics.</div>
  return (
    <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
      {visible.map(m => {
        const e = evals[m.id]
        const current = e?.result?.current
        return (
          <Card key={m.id} className="p-3">
            <div className="text-xs text-muted-foreground">{m.name}</div>
            <div className="text-2xl font-semibold">{current ?? '‚Äî'}</div>
          </Card>
        )
      })}
    </div>
  )
}

function SessionsWidget() {
  const { sessionSummary, sessionTS } = useMetrics()
  return (
    <div className="h-full flex flex-col gap-3">
      <div className="grid grid-cols-3 gap-3">
        <Card className="p-3"><div className="text-xs text-muted-foreground">Sessions</div><div className="text-xl font-semibold">{sessionSummary?.count ?? '‚Äî'}</div></Card>
        <Card className="p-3"><div className="text-xs text-muted-foreground">Avg Duration</div><div className="text-xl font-semibold">{sessionSummary ? Math.round(sessionSummary.avg_duration) + 's' : '‚Äî'}</div></Card>
        <Card className="p-3"><div className="text-xs text-muted-foreground">Devices</div><div className="text-xl font-semibold">{sessionSummary?.by_device?.length ?? 0}</div></Card>
      </div>
      <div className="text-xs text-muted-foreground">Timeseries points: {sessionTS.length}</div>
      <div className="flex-1 rounded-md border border-border/50 p-2 text-xs overflow-auto">{sessionTS.slice(-20).map(p => (
        <div key={p.date} className="grid grid-cols-3 gap-2"><span>{p.date}</span><span>{p.sessions}</span><span>{Math.round(p.avg_duration)}s</span></div>
      ))}</div>
    </div>
  )
}

function PresenceWidget() {
  const { presences } = useMetrics()
  if (!presences.length) return <div className="text-xs text-muted-foreground">No active users.</div>
  return (
    <div className="space-y-2 text-sm">
      {presences.map(p => (
        <div key={String(p.id)} className="flex items-center justify-between"><span>{p.name || 'User ' + p.id}</span><span className="text-muted-foreground text-xs">{p.device || 'unknown'}</span></div>
      ))}
    </div>
  )
}

type MediaItem = { id: number; source_url?: string; title?: { rendered?: string }; media_details?: { sizes?: { thumbnail?: { source_url?: string } } } }
function MediaWidget() {
  const [items, setItems] = useState<MediaItem[]>([])
  useEffect(() => {
    const load = async () => {
      try {
        const r = await fetch('/api/wp/media?per_page=6')
        if (r.ok) setItems(await r.json())
      } catch {
        // ignore
      }
    }
    load()
  }, [])
  if (!items.length) return <div className="text-xs text-muted-foreground">No media.</div>
  return (
    <div className="grid grid-cols-3 gap-2">
      {items.map((m) => (
        <img key={m.id} src={m.media_details?.sizes?.thumbnail?.source_url || m.source_url} className="w-full aspect-square object-cover rounded" alt={m.title?.rendered || ''} />
      ))}
    </div>
  )
}

function Controls() { return <MetricsDashboardControls /> }

function InnerDashboard() {
  const [layout, setLayout] = useState<SavedLayout[]>([])
  const defaultLayout: SavedLayout[] = useMemo(() => ([
    { i: 'metrics', x: 0, y: 0, w: 6, h: 4 },
    { i: 'sessions', x: 6, y: 0, w: 6, h: 5 },
    { i: 'presence', x: 0, y: 4, w: 3, h: 3 },
    { i: 'media', x: 3, y: 4, w: 3, h: 3 },
  ]), [])

  useEffect(() => {
    const run = async () => {
      try {
        const r = await fetch('/api/metrics/layout', { cache: 'no-store' })
        if (r.ok) {
          const l = await r.json()
          if (Array.isArray(l) && l.length) setLayout(l)
          else setLayout(defaultLayout)
        } else setLayout(defaultLayout)
      } catch { setLayout(defaultLayout) }
    }
    run()
  }, [defaultLayout])

  const onLayoutChange = (l: SavedLayout[]) => setLayout(l)
  // Bind layout actions on window only on client
  useEffect(() => {
    if (typeof window === 'undefined') return
  ;(window as unknown as { __saveDashboard?: () => Promise<void> }).__saveDashboard = async () => {
      await fetch('/api/metrics/layout', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(layout) })
    }
  ;(window as unknown as { __resetDashboard?: () => Promise<void> }).__resetDashboard = async () => {
      await fetch('/api/metrics/layout', { method: 'DELETE' })
      setLayout(defaultLayout)
    }
  ;(window as unknown as { __setDefaultDashboard?: () => Promise<void> }).__setDefaultDashboard = async () => {
      await fetch('/api/metrics/layout/default', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(layout) })
    }
    return () => {
      try {
    delete (window as unknown as { __saveDashboard?: unknown }).__saveDashboard
    delete (window as unknown as { __resetDashboard?: unknown }).__resetDashboard
    delete (window as unknown as { __setDefaultDashboard?: unknown }).__setDefaultDashboard
      } catch {}
    }
  }, [layout, defaultLayout])

  const cols = 12
  const rowHeight = 48

  return (
    <div className="space-y-3">
      <div className="flex items-center justify-between">
        <div className="text-lg font-semibold">Dashboard</div>
        <Controls />
      </div>
      <GridLayout
        className="layout"
        cols={cols}
        rowHeight={rowHeight}
        width={1200}
        layout={layout}
        onLayoutChange={onLayoutChange}
        isResizable
        isDraggable
      >
        <div key="metrics">
          <WidgetFrame title="Metrics">
            <MetricsWidget />
          </WidgetFrame>
        </div>
        <div key="sessions">
          <WidgetFrame title="Sessions">
            <SessionsWidget />
          </WidgetFrame>
        </div>
        <div key="presence">
          <WidgetFrame title="Presence">
            <PresenceWidget />
          </WidgetFrame>
        </div>
        <div key="media">
          <WidgetFrame title="Media">
            <MediaWidget />
          </WidgetFrame>
        </div>
      </GridLayout>
    </div>
  )
}

export default function FullDashboard() {
  return (
    <MetricsProvider>
      <InnerDashboard />
    </MetricsProvider>
  )
}


// ==== FILE: src\components\dashboard\MetricsDashboardControls.tsx ====
"use client"
import React, { useState } from 'react'

import { Button } from '@/components/ui/button'
import { RoleGate } from '@/hooks/useRoleGate'

export default function MetricsDashboardControls() {
  const [saving, setSaving] = useState(false)
  const run = async (fn: string) => {
    setSaving(true)
    try { await (window as any)[fn]?.() } finally { setSaving(false) }
  }
  return (
    <div className="flex gap-2">
      <Button size="sm" onClick={() => run('__saveDashboard')} disabled={saving}>{saving ? 'Saving‚Ä¶' : 'Save'}</Button>
      <Button size="sm" variant="secondary" onClick={() => run('__resetDashboard')}>Reset</Button>
      <RoleGate action="admin" as="span"><Button size="sm" variant="outline" onClick={() => run('__setDefaultDashboard')}>Set Default</Button></RoleGate>
    </div>
  )
}


// ==== FILE: src\components\dashboard\SectionRenderer.tsx ====
"use client"
import React, { useEffect, useMemo, useState } from 'react'

import GridLayout from 'react-grid-layout'

import 'react-grid-layout/css/styles.css'
import 'react-resizable/css/styles.css'
import { Card } from '@/components/ui/card'

import { widgetRegistry, type Widget } from './WidgetRegistry'
import TileRenderer from './TileRenderer'

type SavedLayout = { i: string; x: number; y: number; w: number; h: number }

export default function SectionRenderer({ section }: { section: Widget['section'] }) {
  const widgets = useMemo(() => widgetRegistry.filter(w => w.section === section), [section])
  const defaultLayout: SavedLayout[] = useMemo(() => widgets.map(w => w.defaultLayout), [widgets])
  const [layout, setLayout] = useState<SavedLayout[]>(defaultLayout)
  const handleLayoutChange = (l: SavedLayout[]) => setLayout(l as any)

  useEffect(() => {
    let alive = true
    ;(async () => {
      try {
        const r = await fetch('/api/metrics/layout', { cache: 'no-store' })
        if (!r.ok) throw new Error('layout load failed')
        const saved = await r.json()
        if (alive && Array.isArray(saved) && saved.length) setLayout(saved)
      } catch {
        if (alive) setLayout(defaultLayout)
      }
    })()
    return () => { alive = false }
  }, [defaultLayout])

  return (
    <div className="space-y-3">
      <GridLayout
        className="layout"
        cols={12}
        rowHeight={48}
        width={1200}
        layout={layout}
        onLayoutChange={handleLayoutChange as any}
      >
        {widgets.map(w => (
          <div key={w.id}>
            <Card className="h-full w-full p-3 overflow-auto">
              <div className="text-sm font-medium mb-2">{w.title}</div>
              <TileRenderer widget={w} />
            </Card>
          </div>
        ))}
      </GridLayout>
    </div>
  )
}


// ==== FILE: src\components\dashboard\TileRenderer.tsx ====
"use client"
import React, { useEffect, useState } from 'react'
import Link from 'next/link'

import { Button } from '@/components/ui/button'

import type { Widget } from './WidgetRegistry'
import CrewMan from './CrewMan'

function NumberTile({ endpoint, pick }: { endpoint: string; pick: (j: unknown) => number | string | undefined }) {
  const [val, setVal] = useState<number | string | undefined>('‚Äî')
  useEffect(() => {
    let alive = true
    ;(async () => {
      try {
        const r = await fetch(endpoint, { cache: 'no-store' })
        const j = r.ok ? await r.json() : null
        if (alive) setVal(pick(j))
      } catch {
        // TODO: implement fetch error handling
      }
    })()
    return () => { alive = false }
  }, [endpoint, pick])
  return <div className="text-2xl font-semibold">{val ?? '‚Äî'}</div>
}

function ChartTile({ endpoint }: { endpoint: string }) {
  const [data, setData] = useState<unknown[]>([])
  useEffect(() => {
    let mounted = true
    ;(async () => {
      try {
        const r = await fetch(endpoint, { cache: 'no-store' })
        const j: unknown = r.ok ? await r.json() : []
        const series = Array.isArray(j) ? j : (typeof j === 'object' && j && Array.isArray((j as Record<string, unknown>).series) ? (j as Record<string, unknown>).series as unknown[] : [])
        if (mounted) setData(series)
      } catch {
        // TODO: implement fetch error handling
      }
    })()
    return () => { mounted = false }
  }, [endpoint])
  return <pre className="text-xs overflow-auto h-full">{JSON.stringify(data.slice(-10), null, 2)}</pre>
}

type BasicRow = { id?: string | number; slug?: string; title?: string | { rendered?: string }; name?: string }
function TableTile({ endpoint, href }: { endpoint: string; href?: string }) {
  const [rows, setRows] = useState<BasicRow[]>([])
  useEffect(() => {
    let mounted = true
    ;(async () => {
      try {
        const r = await fetch(endpoint, { cache: 'no-store' })
        const j: unknown = r.ok ? await r.json() : []
        const items: BasicRow[] = Array.isArray(j)
          ? j as BasicRow[]
          : (typeof j === 'object' && j && Array.isArray((j as Record<string, unknown>).items)
              ? ((j as Record<string, unknown>).items as BasicRow[])
              : [])
        if (mounted) setRows(items)
      } catch {
        // TODO: implement fetch error handling
      }
    })()
    return () => { mounted = false }
  }, [endpoint])
  return (
    <div className="text-sm space-y-1">
      {rows.slice(0, 8).map((row) => {
        const key = row.id ?? row.slug ?? Math.random().toString(36)
        const title = typeof row.title === 'object' ? (row.title?.rendered ?? '') : (row.title ?? row.name ?? row.slug ?? row.id)
        return (
          <div key={String(key)} className="flex items-center justify-between gap-2">
            <div className="truncate">{title as React.ReactNode}</div>
            {href && row.id ? (
              <Button asChild size="sm" variant="secondary"><Link href={`${href}/${row.id}`}>Open</Link></Button>
            ) : null}
          </div>
        )
      })}
      {!rows.length ? <div className="text-xs text-muted-foreground">No rows.</div> : null}
    </div>
  )
}

function MiniPostEditor({ endpoint }: { endpoint: string }) {
  const [title, setTitle] = useState('')
  const [content, setContent] = useState('')
  const [saving, setSaving] = useState<'idle' | 'saving' | 'error' | 'ok'>('idle')

  // Autosave draft every 20s if dirty
  useEffect(() => {
    const i = window.setInterval(async () => {
      if (!title && !content) return
      try {
        await fetch(endpoint, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ title, content, status: 'draft' }) })
      } catch {}
    }, 20000)
    return () => window.clearInterval(i)
  }, [endpoint, title, content])

  const saveDraft = async () => {
    setSaving('saving')
    try {
      const r = await fetch(endpoint, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ title, content, status: 'draft' }) })
      setSaving(r.ok ? 'ok' : 'error')
    } catch { setSaving('error') }
  }
  const requestPublish = async () => {
    setSaving('saving')
    try {
      const r = await fetch(endpoint, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ title, content, status: 'pending' }) })
      setSaving(r.ok ? 'ok' : 'error')
    } catch { setSaving('error') }
  }
  const publishNow = async () => {
    setSaving('saving')
    try {
      const r = await fetch(endpoint, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ title, content, status: 'publish' }) })
      setSaving(r.ok ? 'ok' : 'error')
    } catch { setSaving('error') }
  }

  return (
    <div className="space-y-2">
      <input className="w-full border rounded px-2 py-1" placeholder="Post title" value={title} onChange={(e) => setTitle(e.target.value)} />
      <textarea className="w-full border rounded px-2 py-1 h-32" placeholder="Write your post‚Ä¶" value={content} onChange={(e) => setContent(e.target.value)} />
      <div className="flex items-center gap-2">
        <Button size="sm" onClick={saveDraft} disabled={saving==='saving'}>Save Draft</Button>
        <Button size="sm" variant="secondary" onClick={requestPublish} disabled={saving==='saving'}>Request Publish</Button>
        <Button size="sm" variant="destructive" onClick={publishNow} disabled={saving==='saving'}>Publish</Button>
        <div className="text-xs text-muted-foreground">{saving==='ok' ? 'Saved' : saving==='error' ? 'Error' : null}</div>
      </div>
    </div>
  )
}

export default function TileRenderer({ widget }: { widget: Widget }) {
  const { type } = widget
  if (type === 'api_tester') return <CrewMan />
  if (type === 'tile') {
    if (widget.id === 'sessions_count') {
      return <NumberTile endpoint={widget.endpoint!} pick={(j) => (j && typeof j === 'object' ? (j as Record<string, unknown>).count as number | string | undefined : undefined)} />
    }
    if (widget.id === 'avg_duration') {
      return <NumberTile endpoint={widget.endpoint!} pick={(j) => {
        const v = j && typeof j === 'object' ? (j as Record<string, unknown>).avg_duration : undefined
        return typeof v === 'number' ? Math.round(v) + 's' : '‚Äî'
      }} />
    }
    if (widget.id.endsWith('_count') || widget.endpoint?.includes('/count')) {
      return <NumberTile endpoint={widget.endpoint!} pick={(j) => {
        if (Array.isArray(j)) return j.length
        if (j && typeof j === 'object') {
          const c = (j as Record<string, unknown>).count
          if (typeof c === 'number') return c
        }
        return '‚Äî'
      }} />
    }
    return <div className="text-xs text-muted-foreground">Tile: {widget.title}</div>
  }
  if (type === 'chart') {
    return <ChartTile endpoint={widget.endpoint!} />
  }
  if (type === 'table') {
    return <TableTile endpoint={widget.endpoint!} href={widget.href} />
  }
  if (type === 'editor') {
    return <MiniPostEditor endpoint={widget.endpoint!} />
  }
  return <div className="text-xs text-muted-foreground">Unsupported widget.</div>
}


// ==== FILE: src\components\dashboard\WidgetRegistry.ts ====
export type Widget = {
  id: string
  title: string
  section: 'Dashboard' | 'Analytics' | 'Posts' | 'Media' | 'Users' | 'Settings' | 'Plugins' | 'Themes' | 'Site Health' | 'Debug/Test'
  type: 'tile' | 'chart' | 'crud' | 'table' | 'api_tester' | 'editor'
  endpoint?: string
  method?: 'GET' | 'POST' | 'PUT' | 'DELETE'
  chartType?: 'line' | 'bar' | 'pie' | 'gauge'
  realtime?: boolean
  refreshInterval?: number
  role?: 'user' | 'editor' | 'admin'
  pinned?: boolean
  schema?: unknown
  href?: string
  defaultLayout: { i: string; x: number; y: number; w: number; h: number }
}

export const widgetRegistry: Widget[] = [
  // Dashboard section
  { id: 'sessions_count', title: '‚≠ê Sessions', section: 'Dashboard', type: 'tile', endpoint: '/api/analytics/sessions/summary', defaultLayout: { i: 'sessions_count', x: 0, y: 0, w: 3, h: 3 } },
  { id: 'avg_duration', title: '‚è± Avg Duration', section: 'Dashboard', type: 'tile', endpoint: '/api/analytics/sessions/summary', defaultLayout: { i: 'avg_duration', x: 3, y: 0, w: 3, h: 3 } },
  { id: 'sessions_trend', title: 'üìà Sessions Trend', section: 'Dashboard', type: 'chart', chartType: 'line', endpoint: '/api/analytics/sessions/timeseries', defaultLayout: { i: 'sessions_trend', x: 6, y: 0, w: 6, h: 5 } },
  { id: 'api_health', title: '‚ö° API Health', section: 'Dashboard', type: 'tile', endpoint: '/api/analytics/check', defaultLayout: { i: 'api_health', x: 0, y: 3, w: 3, h: 3 } },

  // Analytics
  { id: 'views_trend', title: 'Views Trend', section: 'Analytics', type: 'chart', chartType: 'line', endpoint: '/api/analytics/views', defaultLayout: { i: 'views_trend', x: 0, y: 0, w: 6, h: 5 } },
  { id: 'devices_usage', title: 'Devices', section: 'Analytics', type: 'chart', chartType: 'pie', endpoint: '/api/analytics/devices', defaultLayout: { i: 'devices_usage', x: 6, y: 0, w: 3, h: 4 } },
  { id: 'referers_dist', title: 'Referrers', section: 'Analytics', type: 'chart', chartType: 'pie', endpoint: '/api/analytics/referers', defaultLayout: { i: 'referers_dist', x: 9, y: 0, w: 3, h: 4 } },
  { id: 'top_posts', title: 'Top Posts', section: 'Analytics', type: 'table', endpoint: '/api/analytics/top-posts', defaultLayout: { i: 'top_posts', x: 0, y: 5, w: 6, h: 5 } },

  // Posts
  { id: 'total_posts', title: 'Total Posts', section: 'Posts', type: 'tile', endpoint: '/api/wp/posts/count', defaultLayout: { i: 'total_posts', x: 0, y: 0, w: 3, h: 3 } },
  { id: 'drafts_count', title: 'Drafts', section: 'Posts', type: 'tile', endpoint: '/api/wp/posts/count?status=draft', defaultLayout: { i: 'drafts_count', x: 3, y: 0, w: 3, h: 3 } },
  { id: 'pending_count', title: 'Pending Review', section: 'Posts', type: 'tile', endpoint: '/api/wp/posts/count?status=pending', defaultLayout: { i: 'pending_count', x: 6, y: 0, w: 3, h: 3 } },
  { id: 'recent_posts', title: 'Recent Posts', section: 'Posts', type: 'table', endpoint: '/api/wp/posts?perPage=5', href: '/editor', defaultLayout: { i: 'recent_posts', x: 0, y: 3, w: 6, h: 5 } },
  { id: 'post_editor', title: '‚úçÔ∏è New Post', section: 'Posts', type: 'editor', endpoint: '/api/wp/posts', method: 'POST', role: 'editor', defaultLayout: { i: 'post_editor', x: 6, y: 3, w: 6, h: 6 } },

  // Media
  { id: 'total_media', title: 'Total Media', section: 'Media', type: 'tile', endpoint: '/api/wp/media/count', defaultLayout: { i: 'total_media', x: 0, y: 0, w: 3, h: 3 } },
  { id: 'recent_media', title: 'Recent Uploads', section: 'Media', type: 'table', endpoint: '/api/wp/media?per_page=6', defaultLayout: { i: 'recent_media', x: 3, y: 0, w: 6, h: 4 } },

  // Users
  { id: 'total_users', title: 'Total Users', section: 'Users', type: 'tile', endpoint: '/api/wp/users/count', defaultLayout: { i: 'total_users', x: 0, y: 0, w: 3, h: 3 } },
  { id: 'presence', title: 'Real-time Presence', section: 'Users', type: 'tile', endpoint: '/api/analytics/stream', realtime: true, defaultLayout: { i: 'presence', x: 3, y: 0, w: 3, h: 4 } },

  // Debug
  { id: 'crewman', title: 'CrewMan API Tester', section: 'Debug/Test', type: 'api_tester', endpoint: '/api/core/endpoints', role: 'admin', defaultLayout: { i: 'crewman', x: 0, y: 0, w: 12, h: 6 } },
]


// ==== FILE: src\components\markdown\MarkdownRenderer.tsx ====
"use client"

import React from 'react'
import ReactMarkdown from 'react-markdown'
import remarkGfm from 'remark-gfm'
import rehypeSlug from 'rehype-slug'
import rehypeAutolinkHeadings from 'rehype-autolink-headings'
import rehypeRaw from 'rehype-raw'
import rehypeHighlight from 'rehype-highlight'

type Props = {
  markdown: string
  className?: string
}

export default function MarkdownRenderer({ markdown, className }: Props) {
  return (
    <div className={className}>
      <ReactMarkdown
        // Allow HTML embedded in markdown safely handled by rehype-raw + downstream sanitizers/styles
        rehypePlugins={[
          rehypeRaw as any,
          rehypeSlug as any,
          [rehypeAutolinkHeadings as any, { behavior: 'wrap' }],
          rehypeHighlight as any,
        ]}
        remarkPlugins={[remarkGfm as any]}
        // Limit image width and add lazy loading via components mapping
        components={{
          img: (props) => <img loading="lazy" {...props} />,
          code: (codeProps: any) => {
            const { inline, className, children, ...props } = codeProps || {}
            const child = String(children || '')
            if (inline) return <code className={className} {...props}>{child}</code>
            return (
              <pre className="group relative">
                <code className={className} {...props}>{child}</code>
                <button
                  type="button"
                  className="absolute right-2 top-2 hidden rounded bg-muted px-2 py-1 text-xs text-foreground group-hover:block"
                  onClick={() => navigator.clipboard?.writeText(child).catch(() => {})}
                  aria-label="Copy code"
               >
                  Copy
                </button>
              </pre>
            )
          }
        }}
      >
        {markdown || ''}
      </ReactMarkdown>
    </div>
  )
}


// ==== FILE: src\components\profile\CommentsList.tsx ====
"use client"

import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'

import PostExcerpt from './PostExcerpt'

export type CommentItem = {
  id: number
  post: number
  date: string
  link: string
  content_raw: string
  content_rendered: string
}

export default function CommentsList({ comments, clampPx }: { comments: CommentItem[]; clampPx?: number }) {
  if (!comments || comments.length === 0) {
    return (
      <Card className="rounded-2xl shadow">
        <CardContent className="p-8 text-center text-muted-foreground">No activity yet</CardContent>
      </Card>
    )
  }
  return (
    <div className="grid grid-cols-1 gap-6">
      {comments.map((c) => (
        <a key={c.id} href={c.link} target="_blank" rel="noopener noreferrer">
          <Card className="rounded-2xl shadow transition hover:shadow-lg">
            <CardHeader>
              <CardTitle className="text-base">Comment on post #{c.post}</CardTitle>
            </CardHeader>
            <CardContent className="prose prose-invert max-w-none">
              <PostExcerpt html={c.content_rendered} clampPx={clampPx} />
              <div className="mt-3 text-sm text-muted-foreground">{c.date}</div>
            </CardContent>
          </Card>
        </a>
      ))}
    </div>
  )
}


// ==== FILE: src\components\profile\CommentsTabClient.tsx ====
"use client"

import { useEffect, useState } from 'react'

import { Card, CardContent } from '@/components/ui/card'
import { Skeleton } from '@/components/ui/skeleton'

import CommentsList, { CommentItem } from './CommentsList'

const commentsCache = new Map<string, CommentItem[]>()

export default function CommentsTabClient({ slug }: { slug: string }) {
  const [loading, setLoading] = useState(true)
  const [comments, setComments] = useState<CommentItem[] | null>(null)

  useEffect(() => {
    let mounted = true
    const site = (process.env.NEXT_PUBLIC_SITE_URL || '').replace(/\/$/, '')
    const cached = commentsCache.get(slug)
    if (cached) {
      setComments(cached)
      setLoading(false)
      return
    }
    const controller = new AbortController()
    const run = async () => {
      try {
        const res = await fetch(`${site}/api/wp/users/${encodeURIComponent(slug)}`, {
          cache: 'force-cache',
          signal: controller.signal,
        })
        if (!res.ok) throw new Error('Failed')
        const data = await res.json()
        const c = Array.isArray(data?.recent_comments) ? (data.recent_comments as CommentItem[]) : []
        if (!mounted) return
        commentsCache.set(slug, c)
        setComments(c)
      } catch {
        if (mounted) setComments([])
      } finally {
        if (mounted) setLoading(false)
      }
    }
    run()
    return () => {
      mounted = false
      controller.abort()
    }
  }, [slug])

  if (loading) {
    return (
      <Card className="rounded-2xl shadow">
        <CardContent className="p-6 space-y-6">
          {Array.from({ length: 3 }).map((_, i) => (
            <div key={i} className="rounded-2xl border p-4">
              <Skeleton className="h-5 w-2/5" />
              <Skeleton className="mt-3 h-4 w-full" />
              <Skeleton className="mt-2 h-4 w-5/6" />
            </div>
          ))}
        </CardContent>
      </Card>
    )
  }

  return <CommentsList comments={comments || []} clampPx={160} />
}


// ==== FILE: src\components\profile\PostExcerpt.tsx ====
"use client"

import { useEffect, useMemo, useRef } from 'react'
import sanitizeHtml from 'sanitize-html'
import hljs from 'highlight.js'
import 'highlight.js/styles/github-dark.css'

export default function PostExcerpt({ html, clampPx }: { html: string; clampPx?: number }) {
  const containerRef = useRef<HTMLDivElement>(null)

  const safe = useMemo(() => {
    return sanitizeHtml(html || '', {
      allowedTags: false, // default lista
      allowedAttributes: false,
      // Allow common embeds/images/links
      allowedSchemesByTag: { a: ['http', 'https', 'mailto'] },
    })
  }, [html])

  useEffect(() => {
    if (!containerRef.current) return
    const blocks = containerRef.current.querySelectorAll('pre code, code')
    blocks.forEach((el) => {
      try { hljs.highlightElement(el as HTMLElement) } catch {}
    })
  }, [safe])

  return (
    <div className="relative">
      <div
        ref={containerRef}
        className="prose dark:prose-invert max-w-none"
        style={clampPx ? { maxHeight: clampPx, overflow: 'hidden' } : undefined}
        dangerouslySetInnerHTML={{ __html: safe }}
      />
      {clampPx ? (
        <div
          className="pointer-events-none absolute inset-x-0 bottom-0 h-10"
          style={{
            background: 'linear-gradient(to bottom, rgba(0,0,0,0), var(--background))',
          }}
        />
      ) : null}
    </div>
  )
}


// ==== FILE: src\components\profile\PostsList.tsx ====
"use client"

import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'

import PostExcerpt from './PostExcerpt'

export type PostItem = {
  id: number
  title: string
  slug: string
  date: string
  link: string
  content_raw: string
  content_rendered: string
}

export default function PostsList({ posts, clampPx }: { posts: PostItem[]; clampPx?: number }) {
  if (!posts || posts.length === 0) {
    return (
      <Card className="rounded-2xl shadow">
        <CardContent className="p-8 text-center text-muted-foreground">No activity yet</CardContent>
      </Card>
    )
  }
  return (
    <div className="grid grid-cols-1 gap-6">
      {posts.map((p) => (
        <a key={p.id} href={p.link} target="_blank" rel="noopener noreferrer">
          <Card className="rounded-2xl shadow transition hover:shadow-lg">
            <CardHeader>
              <CardTitle className="text-lg">{p.title}</CardTitle>
            </CardHeader>
            <CardContent className="prose prose-invert max-w-none">
              <PostExcerpt html={p.content_rendered} clampPx={clampPx} />
              <div className="mt-3 text-sm text-muted-foreground">{p.date}</div>
            </CardContent>
          </Card>
        </a>
      ))}
    </div>
  )
}


// ==== FILE: src\components\profile\PostsTabClient.tsx ====
"use client"

import { useEffect, useState } from 'react'

import { Card, CardContent } from '@/components/ui/card'
import { Skeleton } from '@/components/ui/skeleton'

import PostsList, { PostItem } from './PostsList'

const postsCache = new Map<string, PostItem[]>()

export default function PostsTabClient({ slug }: { slug: string }) {
  const [loading, setLoading] = useState(true)
  const [posts, setPosts] = useState<PostItem[] | null>(null)

  useEffect(() => {
    let mounted = true
    const site = (process.env.NEXT_PUBLIC_SITE_URL || '').replace(/\/$/, '')
    const cached = postsCache.get(slug)
    if (cached) {
      setPosts(cached)
      setLoading(false)
      return
    }
    const controller = new AbortController()
    const run = async () => {
      try {
        const res = await fetch(`${site}/api/wp/users/${encodeURIComponent(slug)}`, {
          cache: 'force-cache',
          signal: controller.signal,
        })
        if (!res.ok) throw new Error('Failed')
        const data = await res.json()
        const p = Array.isArray(data?.recent_posts) ? (data.recent_posts as PostItem[]) : []
        if (!mounted) return
        postsCache.set(slug, p)
        setPosts(p)
      } catch {
        if (mounted) setPosts([])
      } finally {
        if (mounted) setLoading(false)
      }
    }
    run()
    return () => {
      mounted = false
      controller.abort()
    }
  }, [slug])

  if (loading) {
    return (
      <Card className="rounded-2xl shadow">
        <CardContent className="p-6 space-y-6">
          {Array.from({ length: 3 }).map((_, i) => (
            <div key={i} className="rounded-2xl border p-4">
              <Skeleton className="h-5 w-1/2" />
              <Skeleton className="mt-3 h-4 w-full" />
              <Skeleton className="mt-2 h-4 w-5/6" />
            </div>
          ))}
        </CardContent>
      </Card>
    )
  }

  return <PostsList posts={posts || []} clampPx={180} />
}


// ==== FILE: src\components\profile\ProfilePage.tsx ====
"use client"

import { useEffect, useMemo, useState } from 'react'
import Image from 'next/image'
import { useRouter } from 'next/navigation'
import dynamic from 'next/dynamic'
import { motion } from 'framer-motion'
import { ArrowLeft, ExternalLink } from 'lucide-react'

import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { Skeleton } from '@/components/ui/skeleton'

const PostsTabClient = dynamic(() => import('./PostsTabClient'))
const CommentsTabClient = dynamic(() => import('./CommentsTabClient'))

export type PublicUserProfile = {
  id: number
  name: string
  slug: string
  description?: string
  avatar_urls?: Record<string, string>
  roles?: string[]
  profile_fields?: Record<string, any>
  recent_posts: Array<{
    id: number
    title: string
    slug: string
    date: string
    link: string
    content_raw: string
    content_rendered: string
  }>
  recent_comments: Array<{
    id: number
    post: number
    date: string
    link: string
    content_raw: string
    content_rendered: string
  }>
}

export default function ProfilePage({ user }: { user: PublicUserProfile }) {
  const router = useRouter()

  const avatar = useMemo(() => {
    const urls = user.avatar_urls || {}
    return urls['512'] || urls['256'] || urls['96'] || Object.values(urls)[0]
  }, [user.avatar_urls])

  const hasPosts = (user.recent_posts?.length || 0) > 0
  const wpBase = (process.env.NEXT_PUBLIC_WP_URL || '').replace(/\/$/, '')
  const authorArchive = hasPosts ? `${wpBase}/author/${encodeURIComponent(user.slug)}/` : null

  const joined = typeof (user as any)?.profile_fields?.registered === 'string' ? (user as any).profile_fields.registered : null

  return (
    <div className="container mx-auto max-w-5xl px-4 py-10">
      {/* Header */}
      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ duration: 0.4 }}
        className="mb-8"
      >
        <div className="mb-3">
          <Button variant="ghost" size="sm" onClick={() => (history.length > 1 ? router.back() : router.push('/'))}>
            <ArrowLeft className="mr-2" /> Back
          </Button>
        </div>
        <Card className="rounded-2xl shadow-lg">
          <CardContent className="p-6 flex flex-col gap-5 sm:flex-row sm:items-start">
            <div className="relative h-24 w-24 shrink-0 overflow-hidden rounded-2xl ring-1 ring-border">
              {avatar ? (
                <Image src={avatar} alt={user.name} fill sizes="96px" className="object-cover" />
              ) : (
                <Skeleton className="h-full w-full" />)
              }
            </div>
            <div className="flex-1">
              <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                <div>
                  <h1 className="text-2xl font-semibold tracking-tight">{user.name}</h1>
                  <RolesBadges user={user} />
                  {joined && (
                    <div className="mt-1 text-xs text-muted-foreground">Joined on {joined}</div>
                  )}
                </div>
                {authorArchive && (
                  <Button asChild variant="outline" size="sm" className="shrink-0">
                    <a href={authorArchive} target="_blank" rel="noopener noreferrer">
                      View all posts <ExternalLink className="ml-2" />
                    </a>
                  </Button>
                )}
              </div>
              {user.description ? (
                <p className="mt-2 text-muted-foreground leading-relaxed">{user.description}</p>
              ) : (
                <Skeleton className="mt-2 h-5 w-2/3" />
              )}
            </div>
          </CardContent>
        </Card>
      </motion.div>

      {/* Profile fields */}
      {user.profile_fields && Object.keys(user.profile_fields).length > 0 ? (
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.4, delay: 0.05 }}
          className="mb-8"
        >
          <Card className="rounded-2xl shadow-lg">
            <CardHeader>
              <CardTitle>Profile</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                {Object.entries(user.profile_fields).map(([key, value]) => (
                  <div key={key} className="rounded-xl border bg-card p-4">
                    <div className="text-xs uppercase text-muted-foreground">{key}</div>
                    <div className="mt-1 font-medium break-words">{String(value)}</div>
                  </div>
                ))}
              </div>
            </CardContent>
          </Card>
        </motion.div>
      ) : (
        <div className="mb-8">
          <Card className="rounded-2xl shadow-lg">
            <CardHeader>
              <CardTitle>Profile</CardTitle>
            </CardHeader>
            <CardContent>
              <FieldsSkeleton />
            </CardContent>
          </Card>
        </div>
      )}

      {/* Tabs: Posts / Comments (client-side fetch on switch) */}
      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ duration: 0.4, delay: 0.1 }}
      >
        <Tabs defaultValue={hasPosts ? 'posts' : 'comments'} className="w-full">
          <TabsList>
            {hasPosts && <TabsTrigger value="posts">Recent Posts</TabsTrigger>}
            <TabsTrigger value="comments">Recent Comments</TabsTrigger>
          </TabsList>
          {hasPosts && (
            <TabsContent value="posts">
              <PostsTabClient slug={user.slug} />
            </TabsContent>
          )}
          <TabsContent value="comments">
            <CommentsTabClient slug={user.slug} />
          </TabsContent>
        </Tabs>
      </motion.div>
    </div>
  )
}

function RolesBadges({ user }: { user: PublicUserProfile }) {
  const [roles, setRoles] = useState<string[] | null>(() => {
    // Prefer explicit roles field
    if (Array.isArray(user.roles) && user.roles.length) return user.roles
    // Some setups may stash roles in profile_fields.roles
    const pf = user.profile_fields
    if (pf && Array.isArray(pf.roles) && pf.roles.length) return pf.roles as string[]
    // Load cached
    try {
      const cached = localStorage.getItem(`roles:${user.id}`)
      if (cached) return JSON.parse(cached)
    } catch {}
    return null
  })

  useEffect(() => {
    if (roles && roles.length) return
    // Best-effort probe: query public users search and find by id (only if it returns roles)
    // Many WP setups do not expose roles publicly; if unavailable, we keep roles hidden.
    const controller = new AbortController()
    const run = async () => {
      try {
        const site = (process.env.NEXT_PUBLIC_SITE_URL || '').replace(/\/$/, '')
        const res = await fetch(`${site}/api/wp/users?search=${encodeURIComponent(user.slug)}&per_page=20`, {
          signal: controller.signal,
          cache: 'force-cache',
        })
        if (!res.ok) return
        const arr = (await res.json()) as any[]
        const hit = Array.isArray(arr) ? arr.find((u) => u?.id === user.id) : null
        const foundRoles = hit?.roles
        if (Array.isArray(foundRoles) && foundRoles.length) {
          setRoles(foundRoles)
          try { localStorage.setItem(`roles:${user.id}`, JSON.stringify(foundRoles)) } catch {}
        }
      } catch {}
    }
    run()
    return () => controller.abort()
  }, [roles, user.id, user.slug])

  if (!roles || roles.length === 0) return null

  return (
    <div className="mt-2 flex flex-wrap gap-2">
      {roles.map((r) => (
        <span key={r} className="rounded-full border px-2 py-0.5 text-xs text-muted-foreground">
          {r}
        </span>
      ))}
    </div>
  )
}

function FieldsSkeleton() {
  return (
    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
      {Array.from({ length: 6 }).map((_, i) => (
        <div key={i} className="rounded-xl border bg-card p-4">
          <Skeleton className="h-3 w-24" />
          <Skeleton className="mt-2 h-4 w-40" />
        </div>
      ))}
    </div>
  )
}

function ListSkeleton() {
  return (
    <div className="space-y-6">
      {Array.from({ length: 3 }).map((_, i) => (
        <div key={i} className="rounded-2xl border p-4">
          <Skeleton className="h-5 w-1/2" />
          <Skeleton className="mt-3 h-4 w-full" />
          <Skeleton className="mt-2 h-4 w-5/6" />
        </div>
      ))}
    </div>
  )
}


// ==== FILE: src\components\providers\react-query.tsx ====
"use client"

import { QueryClient, QueryClientProvider } from '@tanstack/react-query'
import { ReactNode, useState } from 'react'

export function ReactQueryProvider({ children }: { children: ReactNode }) {
  const [client] = useState(() => new QueryClient({
    defaultOptions: {
      queries: {
        staleTime: 60_000,
        gcTime: 5 * 60_000,
        refetchOnWindowFocus: false,
      },
    },
  }))
  return <QueryClientProvider client={client}>{children}</QueryClientProvider>
}


// ==== FILE: src\components\toc\TableOfContents.tsx ====
"use client"
import { useEffect, useMemo, useRef, useState } from 'react'
import { motion, AnimatePresence } from 'framer-motion'

import { TocItem as FlatItem } from '@/lib/toc-md'
import { useScrollSpy } from '@/hooks/useScrollSpy'

import TOCItem from './TOCItem'
import type { TocNode, SectionTimeMap } from './types'

function toHierarchy(items: FlatItem[]): TocNode[] {
  const root: TocNode = { id: 'root', depth: 1, value: 'root', children: [] }
  const stack: TocNode[] = [root]
  items.forEach((i) => {
    const node: TocNode = { id: i.id, depth: i.depth, value: i.value, children: [] }
    while (stack.length && (stack[stack.length - 1].depth >= node.depth)) stack.pop()
    stack[stack.length - 1].children!.push(node)
    stack.push(node)
  })
  return root.children!
}

function flatIds(items: FlatItem[]): string[] {
  return items.map(i => i.id)
}

export default function TableOfContents({ items }: { items: FlatItem[] }) {
  const [zoom, setZoom] = useState<number>(100)
  const [expanded, setExpanded] = useState<boolean>(items.length <= 24)
  const [focusedIndex, setFocusedIndex] = useState<number>(0)
  const [open, setOpen] = useState<boolean>(false) // floating disabled

  useEffect(() => {
    const fromReader = Number(localStorage.getItem('reader:scale') || '100')
    const s = Number(localStorage.getItem('toc:zoom') || String(fromReader || '100'))
    setZoom(isNaN(s) ? 100 : s)
  }, [])
  useEffect(() => {
    localStorage.setItem('toc:zoom', String(zoom))
    // Drive global reader scale (affects .wp-content font-size)
    document.documentElement.style.setProperty('--reader-scale', String(zoom))
    localStorage.setItem('reader:scale', String(zoom))
  }, [zoom])
  // Floating mode removed on post page

  const ids = useMemo(() => flatIds(items), [items])
  // Compute rootMargin to account for sticky header height
  const rootMargin = useMemo(() => {
    if (typeof window === 'undefined') return '-25% 0px -60% 0px'
    const styles = getComputedStyle(document.documentElement)
    const header = parseInt(styles.getPropertyValue('--header-height') || '64', 10)
    const topOffset = (isNaN(header) ? 64 : header) + 24 // add small cushion
    return `-${topOffset}px 0px -60% 0px`
  }, [])
  // Keep nearby range small so only the truly in-view section remains highlighted
  const state = useScrollSpy(ids, { rootMargin, nearbyRange: 0, adjacentRange: 1 })
  const hierarchy = useMemo(() => toHierarchy(items), [items])
  // Sync a class on the active heading in the document to avoid flicker
  // Sync content heading highlight strictly to the single activeId
  useEffect(() => {
    if (!ids.length) return
    const clearAll = () => ids.forEach(id => document.getElementById(id)?.classList.remove('heading-active'))
    clearAll()
    if (state.activeId) {
      document.getElementById(state.activeId)?.classList.add('heading-active')
    }
  }, [state.activeId, ids])
  // Floating mode removed

  // Keyboard navigation
  const listRef = useRef<HTMLDivElement | null>(null)
  useEffect(() => {
    const el = listRef.current
    if (!el) return
    const onKey = (e: KeyboardEvent) => {
      if (!['ArrowUp','ArrowDown','Enter'].includes(e.key)) return
      e.preventDefault()
      const idx = focusedIndex
      if (e.key === 'ArrowUp') setFocusedIndex(Math.max(0, idx - 1))
      if (e.key === 'ArrowDown') setFocusedIndex(Math.min(ids.length - 1, idx + 1))
      if (e.key === 'Enter') {
        const id = ids[focusedIndex]
        const t = document.getElementById(id)
        t?.scrollIntoView({ behavior: 'smooth', block: 'start' })
      }
    }
    el.addEventListener('keydown', onKey)
    return () => el.removeEventListener('keydown', onKey)
  }, [focusedIndex, ids])

  // Compute per-section reading time badges by measuring text between headings
  const [sectionTimes, setSectionTimes] = useState<SectionTimeMap>({})
  useEffect(() => {
    if (!items.length) return
    const compute = () => {
      const idsOnPage = items.map(i => i.id).filter(id => document.getElementById(id))
      if (!idsOnPage.length) { setSectionTimes({}); return }
      const speedWpm = 200
      const getSectionRange = (startId: string, endId?: string) => {
        const startEl = document.getElementById(startId)
        const endEl = endId ? document.getElementById(endId) : null
        if (!startEl) return ''
        let text = ''
        let node: Node | null = startEl.nextSibling
        while (node) {
          if (endEl && node === endEl) break
          if (node.nodeType === Node.ELEMENT_NODE) {
            const el = node as HTMLElement
            if (/^H[1-6]$/.test(el.tagName)) break
            text += ' ' + el.innerText
          } else if (node.nodeType === Node.TEXT_NODE) {
            text += ' ' + (node.textContent || '')
          }
          node = node.nextSibling
        }
        return text
      }
      const map: SectionTimeMap = {}
      for (let i = 0; i < idsOnPage.length; i++) {
        const start = idsOnPage[i]
        const end = idsOnPage[i+1]
        const text = getSectionRange(start, end)
        const words = text.trim().split(/\s+/).filter(Boolean).length
        const minutes = Math.max(0, Math.round(words / speedWpm))
        map[start] = minutes
      }
      setSectionTimes(map)
    }
    // compute after paint
    const id = requestAnimationFrame(() => setTimeout(compute, 0))
    return () => cancelAnimationFrame(id)
  }, [items])

  const content = (
    <div className={`overflow-hidden print:hidden`}>
      <div className="toc-scroll max-h-[60vh] overflow-auto focus:outline-none" ref={listRef} tabIndex={0}>
        <div className="py-2">
          {(expanded ? items : items.slice(0, 24)).map((i, idx) => {
            const st = i.id === state.activeId
              ? 'active'
              : state.nearbyIds.has(i.id) ? 'nearby'
              : state.adjacentIds.has(i.id) ? 'adjacent'
              : 'idle'
      type ItemState = 'active' | 'nearby' | 'adjacent' | 'idle'
      return (
              <TOCItem
                key={i.id}
                id={i.id}
                value={i.value}
                depth={i.depth}
        state={st as ItemState}
                focused={idx === focusedIndex}
                onClick={() => setFocusedIndex(idx)}
                minutes={sectionTimes[i.id]}
              />
            )
          })}
        </div>
      </div>
      {items.length > 24 && (
        <button className="w-full text-xs py-1.5 hover:bg-muted border-t" onClick={() => setExpanded(!expanded)}>
          {expanded ? 'Collapse' : `Show all ${items.length}`}
        </button>
      )}
    </div>
  )

  // Keep active TOC item in view when list overflows
  useEffect(() => {
    if (!state.activeId) return
    const container = listRef.current
    if (!container) return
  const el = container.querySelector(`a[href="#${CSS.escape(state.activeId)}"]`) as HTMLElement | null
    if (!el) return
    const cRect = container.getBoundingClientRect()
    const eRect = el.getBoundingClientRect()
    const isAbove = eRect.top < cRect.top + 8
    const isBelow = eRect.bottom > cRect.bottom - 8
    if (isAbove || isBelow) {
      el.scrollIntoView({ block: 'nearest', behavior: 'smooth' })
    }
  }, [state.activeId])

  return (
    <div className="relative">
  {/* Floating opener removed */}
  {false && (
        <button
          type="button"
          onClick={() => setOpen(true)}
          className="hidden md:flex fixed right-4 bottom-24 z-40 items-center gap-2 rounded-full border bg-card px-3 py-2 text-sm shadow-lg hover:bg-muted print:hidden"
          aria-label="Open table of contents"
        >
          On this page
        </button>
      )}

      {/* Desktop sticky (only when sticky mode) */}
      <div className="hidden lg:block lg:sticky lg:top-20 print:hidden">
        {content}
      </div>

      {/* Tablet collapsible (sticky mode) */}
      <div className="hidden md:block lg:hidden print:hidden">
        <details>
          <summary className="cursor-pointer px-3 py-2 font-medium">On this page</summary>
          <div className="p-3">{content}</div>
        </details>
      </div>

      {/* Floating side flyout for md+ when mode=floating */}
  <AnimatePresence>
  {false && open && (
          <motion.aside
            initial={{ x: 320, opacity: 0 }}
            animate={{ x: 0, opacity: 1 }}
            exit={{ x: 320, opacity: 0 }}
            transition={{ type: 'spring', stiffness: 260, damping: 24 }}
    className="fixed top-16 right-4 bottom-4 z-50 hidden md:flex w-[300px] flex-col overflow-hidden rounded-lg border bg-card shadow-2xl print:hidden cursor-default"
            role="dialog"
            aria-label="Table of contents"
    drag
    dragMomentum={false}
    dragElastic={0.05}
    dragConstraints={{ top: 8, left: 8, right: 8, bottom: 8 }}
          >
    <div className="flex items-center justify-between border-b px-3 py-2 cursor-move select-none">
              <span className="text-sm font-semibold">On this page</span>
              <div className="flex items-center gap-2">
                <button className="text-xs rounded border px-2 py-0.5 hover:bg-muted" onClick={() => setOpen(false)}>Close</button>
              </div>
            </div>
            <div className="flex-1 overflow-auto">{content}</div>
          </motion.aside>
        )}
      </AnimatePresence>

      {/* Mobile bottom sheet (always available) */}
      <div className="md:hidden print:hidden">
        <AnimatePresence>
          <motion.details className="rounded-t-lg fixed bottom-0 left-0 right-0 z-40 bg-card border-t" initial={{ y: 100 }} animate={{ y: 0 }} exit={{ y: 100 }}>
            <summary className="cursor-pointer px-3 py-2 font-medium text-center">On this page</summary>
            <div className="p-3 max-h-[50vh] overflow-auto">{content}</div>
          </motion.details>
        </AnimatePresence>
      </div>
    </div>
  )
}


// ==== FILE: src\components\toc\TOCControls.tsx ====
"use client"
import { Sun, Moon } from 'lucide-react'
import { useTheme } from 'next-themes'

export default function TOCControls() {
  const { theme, setTheme, systemTheme } = useTheme()
  const effectiveTheme = (theme === 'system' ? systemTheme : theme) || 'light'
  return (
    <div className="sticky top-0 z-10 px-2 py-1 flex items-center gap-2">
      <button
        className={`p-1 rounded ${effectiveTheme==='light' ? 'text-primary bg-primary/10' : 'hover:text-primary'}`}
        aria-label="Light"
        aria-pressed={effectiveTheme==='light'}
        onClick={()=>setTheme('light')}
      >
        <Sun className="h-4 w-4"/>
      </button>
      <button
        className={`p-1 rounded ${effectiveTheme==='dark' ? 'text-primary bg-primary/10' : 'hover:text-primary'}`}
        aria-label="Dark"
        aria-pressed={effectiveTheme==='dark'}
        onClick={()=>setTheme('dark')}
      >
        <Moon className="h-4 w-4"/>
      </button>
    </div>
  )
}


// ==== FILE: src\components\toc\TOCItem.tsx ====
"use client"
import { motion } from 'framer-motion'
import Link from 'next/link'

import { decodeEntities } from '@/lib/entities'

export default function TOCItem({ id, value, depth, state, onClick, focused, minutes }: {
  id: string
  value: string
  depth: number
  focused?: boolean
  state: 'active'|'nearby'|'adjacent'|'idle'
  onClick?: () => void
  minutes?: number
}) {
  const padding = Math.max(0, (depth - 1)) * 12
  const classes = {
    active: 'bg-primary/10 font-semibold border-l-2 border-primary text-foreground',
    nearby: 'text-foreground/90',
    adjacent: 'text-muted-foreground',
    idle: 'text-muted-foreground hover:text-foreground/80'
  }[state]
  return (
    <motion.div initial={{ opacity: 0, x: -4 }} animate={{ opacity: 1, x: 0 }} transition={{ duration: 0.25, ease: [0.4,0,0.2,1] }}>
      <Link href={`#${id}`} onClick={onClick} className={`toc-link group block rounded-sm px-2 py-1.5 transition-colors ${classes}`} style={{ paddingLeft: padding + 8 }}>
        <span className={`inline-block transition-transform duration-150 ease-out group-hover:translate-x-[2px] group-hover:scale-[1.015]`}>
          {decodeEntities(value)}
        </span>
        {typeof minutes === 'number' && minutes > 0 && (
          <span className="float-right ml-2 inline-flex items-center gap-1 text-[10px] text-muted-foreground">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="h-3 w-3">
              <circle cx="12" cy="12" r="10"></circle>
              <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
            {minutes}m
          </span>
        )}
      </Link>
    </motion.div>
  )
}


// ==== FILE: src\components\toc\types.ts ====
export interface TocNode {
  id: string
  depth: number
  value: string
  children?: TocNode[]
}

export interface TocControlsState {
  zoom: number // 50-200
  theme: 'light' | 'dark' | 'system'
  mode: 'sticky' | 'floating'
}

// Map of heading id -> estimated minutes to read that section
export type SectionTimeMap = Record<string, number>


// ==== FILE: src\components\ui\accordion.tsx ====
"use client"

import * as React from "react"
import * as AccordionPrimitive from "@radix-ui/react-accordion"
import { ChevronDown } from "lucide-react"

import { cn } from "@/lib/utils"

const Accordion = AccordionPrimitive.Root

const AccordionItem = React.forwardRef<
  React.ElementRef<typeof AccordionPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>
>(({ className, ...props }, ref) => (
  <AccordionPrimitive.Item
    ref={ref}
    className={cn("border-b", className)}
    {...props}
  />
))
AccordionItem.displayName = "AccordionItem"

const AccordionTrigger = React.forwardRef<
  React.ElementRef<typeof AccordionPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>
>(({ className, children, ...props }, ref) => (
  <AccordionPrimitive.Header className="flex">
    <AccordionPrimitive.Trigger
      ref={ref}
      className={cn(
        "flex flex-1 items-center justify-between py-4 font-medium transition-all hover:underline [&[data-state=open]>svg]:rotate-180",
        className
      )}
      {...props}
    >
      {children}
      <ChevronDown className="h-4 w-4 shrink-0 transition-transform duration-200" />
    </AccordionPrimitive.Trigger>
  </AccordionPrimitive.Header>
))
AccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName

const AccordionContent = React.forwardRef<
  React.ElementRef<typeof AccordionPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>
>(({ className, children, ...props }, ref) => (
  <AccordionPrimitive.Content
    ref={ref}
    className="overflow-hidden text-sm transition-all data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down"
    {...props}
  >
    <div className={cn("pb-4 pt-0", className)}>{children}</div>
  </AccordionPrimitive.Content>
))

AccordionContent.displayName = AccordionPrimitive.Content.displayName

export { Accordion, AccordionItem, AccordionTrigger, AccordionContent }


// ==== FILE: src\components\ui\alert-dialog.tsx ====
"use client"

import * as React from "react"
import * as AlertDialogPrimitive from "@radix-ui/react-alert-dialog"

import { cn } from "@/lib/utils"
import { buttonVariants } from "@/components/ui/button"

const AlertDialog = AlertDialogPrimitive.Root

const AlertDialogTrigger = AlertDialogPrimitive.Trigger

const AlertDialogPortal = AlertDialogPrimitive.Portal

const AlertDialogOverlay = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Overlay
    className={cn(
      "fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className
    )}
    {...props}
    ref={ref}
  />
))
AlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName

const AlertDialogContent = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>
>(({ className, ...props }, ref) => (
  <AlertDialogPortal>
    <AlertDialogOverlay />
    <AlertDialogPrimitive.Content
      ref={ref}
      className={cn(
        "fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",
        className
      )}
      {...props}
    />
  </AlertDialogPortal>
))
AlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName

const AlertDialogHeader = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col space-y-2 text-center sm:text-left",
      className
    )}
    {...props}
  />
)
AlertDialogHeader.displayName = "AlertDialogHeader"

const AlertDialogFooter = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",
      className
    )}
    {...props}
  />
)
AlertDialogFooter.displayName = "AlertDialogFooter"

const AlertDialogTitle = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Title
    ref={ref}
    className={cn("text-lg font-semibold", className)}
    {...props}
  />
))
AlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName

const AlertDialogDescription = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
AlertDialogDescription.displayName =
  AlertDialogPrimitive.Description.displayName

const AlertDialogAction = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Action>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Action
    ref={ref}
    className={cn(buttonVariants(), className)}
    {...props}
  />
))
AlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName

const AlertDialogCancel = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Cancel>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Cancel
    ref={ref}
    className={cn(
      buttonVariants({ variant: "outline" }),
      "mt-2 sm:mt-0",
      className
    )}
    {...props}
  />
))
AlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName

export {
  AlertDialog,
  AlertDialogPortal,
  AlertDialogOverlay,
  AlertDialogTrigger,
  AlertDialogContent,
  AlertDialogHeader,
  AlertDialogFooter,
  AlertDialogTitle,
  AlertDialogDescription,
  AlertDialogAction,
  AlertDialogCancel,
}


// ==== FILE: src\components\ui\alert.tsx ====
import * as React from "react"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const alertVariants = cva(
  "relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground",
  {
    variants: {
      variant: {
        default: "bg-background text-foreground",
        destructive:
          "border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

const Alert = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>
>(({ className, variant, ...props }, ref) => (
  <div
    ref={ref}
    role="alert"
    className={cn(alertVariants({ variant }), className)}
    {...props}
  />
))
Alert.displayName = "Alert"

const AlertTitle = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLHeadingElement>
>(({ className, ...props }, ref) => (
  <h5
    ref={ref}
    className={cn("mb-1 font-medium leading-none tracking-tight", className)}
    {...props}
  />
))
AlertTitle.displayName = "AlertTitle"

const AlertDescription = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLParagraphElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("text-sm [&_p]:leading-relaxed", className)}
    {...props}
  />
))
AlertDescription.displayName = "AlertDescription"

export { Alert, AlertTitle, AlertDescription }


// ==== FILE: src\components\ui\avatar.tsx ====
"use client"

import * as React from "react"
import * as AvatarPrimitive from "@radix-ui/react-avatar"

import { cn } from "@/lib/utils"

const Avatar = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Root
    ref={ref}
    className={cn(
      "relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",
      className
    )}
    {...props}
  />
))
Avatar.displayName = AvatarPrimitive.Root.displayName

const AvatarImage = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Image>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Image
    ref={ref}
    className={cn("aspect-square h-full w-full", className)}
    {...props}
  />
))
AvatarImage.displayName = AvatarPrimitive.Image.displayName

const AvatarFallback = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Fallback>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Fallback
    ref={ref}
    className={cn(
      "flex h-full w-full items-center justify-center rounded-full bg-muted",
      className
    )}
    {...props}
  />
))
AvatarFallback.displayName = AvatarPrimitive.Fallback.displayName

export { Avatar, AvatarImage, AvatarFallback }


// ==== FILE: src\components\ui\badge.tsx ====
import * as React from "react"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const badgeVariants = cva(
  "inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",
  {
    variants: {
      variant: {
        default:
          "border-transparent bg-primary text-primary-foreground hover:bg-primary/80",
        secondary:
          "border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",
        destructive:
          "border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",
        outline: "text-foreground",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

export interface BadgeProps
  extends React.HTMLAttributes<HTMLDivElement>,
    VariantProps<typeof badgeVariants> {}

function Badge({ className, variant, ...props }: BadgeProps) {
  return (
    <div className={cn(badgeVariants({ variant }), className)} {...props} />
  )
}

export { Badge, badgeVariants }


// ==== FILE: src\components\ui\button.tsx ====
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const buttonVariants = cva(
  "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",
  {
    variants: {
      variant: {
        default: "bg-primary text-primary-foreground hover:bg-primary/90",
        destructive:
          "bg-destructive text-destructive-foreground hover:bg-destructive/90",
        outline:
          "border border-input bg-background hover:bg-accent hover:text-accent-foreground",
        secondary:
          "bg-secondary text-secondary-foreground hover:bg-secondary/80",
        ghost: "hover:bg-accent hover:text-accent-foreground",
        link: "text-primary underline-offset-4 hover:underline",
      },
      size: {
        default: "h-10 px-4 py-2",
        sm: "h-9 rounded-md px-3",
        lg: "h-11 rounded-md px-8",
        icon: "h-10 w-10",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

export interface ButtonProps
  extends React.ButtonHTMLAttributes<HTMLButtonElement>,
    VariantProps<typeof buttonVariants> {
  asChild?: boolean
}

const Button = React.forwardRef<HTMLButtonElement, ButtonProps>(
  ({ className, variant, size, asChild = false, ...props }, ref) => {
    const Comp = asChild ? Slot : "button"
    return (
      <Comp
        className={cn(buttonVariants({ variant, size, className }))}
        ref={ref}
        {...props}
      />
    )
  }
)
Button.displayName = "Button"

export { Button, buttonVariants }


// ==== FILE: src\components\ui\calendar.tsx ====
"use client"

import * as React from "react"
import { ChevronLeft, ChevronRight } from "lucide-react"
import { DayPicker } from "react-day-picker"

import { cn } from "@/lib/utils"
import { buttonVariants } from "@/components/ui/button"

export type CalendarProps = React.ComponentProps<typeof DayPicker>

function Calendar({
  className,
  classNames,
  showOutsideDays = true,
  ...props
}: CalendarProps) {
  return (
    <DayPicker
      showOutsideDays={showOutsideDays}
      className={cn("p-3", className)}
      classNames={{
        months: "flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0",
        month: "space-y-4",
        caption: "flex justify-center pt-1 relative items-center",
        caption_label: "text-sm font-medium",
        nav: "space-x-1 flex items-center",
        nav_button: cn(
          buttonVariants({ variant: "outline" }),
          "h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100"
        ),
        nav_button_previous: "absolute left-1",
        nav_button_next: "absolute right-1",
        table: "w-full border-collapse space-y-1",
        head_row: "flex",
        head_cell:
          "text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]",
        row: "flex w-full mt-2",
        cell: "h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20",
        day: cn(
          buttonVariants({ variant: "ghost" }),
          "h-9 w-9 p-0 font-normal aria-selected:opacity-100"
        ),
        day_range_end: "day-range-end",
        day_selected:
          "bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground",
        day_today: "bg-accent text-accent-foreground",
        day_outside:
          "day-outside text-muted-foreground aria-selected:bg-accent/50 aria-selected:text-muted-foreground",
        day_disabled: "text-muted-foreground opacity-50",
        day_range_middle:
          "aria-selected:bg-accent aria-selected:text-accent-foreground",
        day_hidden: "invisible",
        ...classNames,
      }}
      components={{
        IconLeft: ({ className, ...props }) => (
          <ChevronLeft className={cn("h-4 w-4", className)} {...props} />
        ),
        IconRight: ({ className, ...props }) => (
          <ChevronRight className={cn("h-4 w-4", className)} {...props} />
        ),
      }}
      {...props}
    />
  )
}
Calendar.displayName = "Calendar"

export { Calendar }


// ==== FILE: src\components\ui\card.tsx ====
import * as React from "react"

import { cn } from "@/lib/utils"

const Card = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn(
      "rounded-lg border bg-card text-card-foreground shadow-sm",
      className
    )}
    {...props}
  />
))
Card.displayName = "Card"

const CardHeader = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex flex-col space-y-1.5 p-6", className)}
    {...props}
  />
))
CardHeader.displayName = "CardHeader"

const CardTitle = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn(
      "text-2xl font-semibold leading-none tracking-tight",
      className
    )}
    {...props}
  />
))
CardTitle.displayName = "CardTitle"

const CardDescription = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
CardDescription.displayName = "CardDescription"

const CardContent = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div ref={ref} className={cn("p-6 pt-0", className)} {...props} />
))
CardContent.displayName = "CardContent"

const CardFooter = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex items-center p-6 pt-0", className)}
    {...props}
  />
))
CardFooter.displayName = "CardFooter"

export { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent }


// ==== FILE: src\components\ui\carousel.tsx ====
"use client"

import * as React from "react"
import useEmblaCarousel, {
  type UseEmblaCarouselType,
} from "embla-carousel-react"
import { ArrowLeft, ArrowRight } from "lucide-react"

import { cn } from "@/lib/utils"
import { Button } from "@/components/ui/button"

type CarouselApi = UseEmblaCarouselType[1]
type UseCarouselParameters = Parameters<typeof useEmblaCarousel>
type CarouselOptions = UseCarouselParameters[0]
type CarouselPlugin = UseCarouselParameters[1]

type CarouselProps = {
  opts?: CarouselOptions
  plugins?: CarouselPlugin
  orientation?: "horizontal" | "vertical"
  setApi?: (api: CarouselApi) => void
}

type CarouselContextProps = {
  carouselRef: ReturnType<typeof useEmblaCarousel>[0]
  api: ReturnType<typeof useEmblaCarousel>[1]
  scrollPrev: () => void
  scrollNext: () => void
  canScrollPrev: boolean
  canScrollNext: boolean
} & CarouselProps

const CarouselContext = React.createContext<CarouselContextProps | null>(null)

function useCarousel() {
  const context = React.useContext(CarouselContext)

  if (!context) {
    throw new Error("useCarousel must be used within a <Carousel />")
  }

  return context
}

const Carousel = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement> & CarouselProps
>(
  (
    {
      orientation = "horizontal",
      opts,
      setApi,
      plugins,
      className,
      children,
      ...props
    },
    ref
  ) => {
    const [carouselRef, api] = useEmblaCarousel(
      {
        ...opts,
        axis: orientation === "horizontal" ? "x" : "y",
      },
      plugins
    )
    const [canScrollPrev, setCanScrollPrev] = React.useState(false)
    const [canScrollNext, setCanScrollNext] = React.useState(false)

    const onSelect = React.useCallback((api: CarouselApi) => {
      if (!api) {
        return
      }

      setCanScrollPrev(api.canScrollPrev())
      setCanScrollNext(api.canScrollNext())
    }, [])

    const scrollPrev = React.useCallback(() => {
      api?.scrollPrev()
    }, [api])

    const scrollNext = React.useCallback(() => {
      api?.scrollNext()
    }, [api])

    const handleKeyDown = React.useCallback(
      (event: React.KeyboardEvent<HTMLDivElement>) => {
        if (event.key === "ArrowLeft") {
          event.preventDefault()
          scrollPrev()
        } else if (event.key === "ArrowRight") {
          event.preventDefault()
          scrollNext()
        }
      },
      [scrollPrev, scrollNext]
    )

    React.useEffect(() => {
      if (!api || !setApi) {
        return
      }

      setApi(api)
    }, [api, setApi])

    React.useEffect(() => {
      if (!api) {
        return
      }

      onSelect(api)
      api.on("reInit", onSelect)
      api.on("select", onSelect)

      return () => {
        api?.off("select", onSelect)
      }
    }, [api, onSelect])

    return (
      <CarouselContext.Provider
        value={{
          carouselRef,
          api: api,
          opts,
          orientation:
            orientation || (opts?.axis === "y" ? "vertical" : "horizontal"),
          scrollPrev,
          scrollNext,
          canScrollPrev,
          canScrollNext,
        }}
      >
        <div
          ref={ref}
          onKeyDownCapture={handleKeyDown}
          className={cn("relative", className)}
          role="region"
          aria-roledescription="carousel"
          {...props}
        >
          {children}
        </div>
      </CarouselContext.Provider>
    )
  }
)
Carousel.displayName = "Carousel"

const CarouselContent = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => {
  const { carouselRef, orientation } = useCarousel()

  return (
    <div ref={carouselRef} className="overflow-hidden">
      <div
        ref={ref}
        className={cn(
          "flex",
          orientation === "horizontal" ? "-ml-4" : "-mt-4 flex-col",
          className
        )}
        {...props}
      />
    </div>
  )
})
CarouselContent.displayName = "CarouselContent"

const CarouselItem = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => {
  const { orientation } = useCarousel()

  return (
    <div
      ref={ref}
      role="group"
      aria-roledescription="slide"
      className={cn(
        "min-w-0 shrink-0 grow-0 basis-full",
        orientation === "horizontal" ? "pl-4" : "pt-4",
        className
      )}
      {...props}
    />
  )
})
CarouselItem.displayName = "CarouselItem"

const CarouselPrevious = React.forwardRef<
  HTMLButtonElement,
  React.ComponentProps<typeof Button>
>(({ className, variant = "outline", size = "icon", ...props }, ref) => {
  const { orientation, scrollPrev, canScrollPrev } = useCarousel()

  return (
    <Button
      ref={ref}
      variant={variant}
      size={size}
      className={cn(
        "absolute  h-8 w-8 rounded-full",
        orientation === "horizontal"
          ? "-left-12 top-1/2 -translate-y-1/2"
          : "-top-12 left-1/2 -translate-x-1/2 rotate-90",
        className
      )}
      disabled={!canScrollPrev}
      onClick={scrollPrev}
      {...props}
    >
      <ArrowLeft className="h-4 w-4" />
      <span className="sr-only">Previous slide</span>
    </Button>
  )
})
CarouselPrevious.displayName = "CarouselPrevious"

const CarouselNext = React.forwardRef<
  HTMLButtonElement,
  React.ComponentProps<typeof Button>
>(({ className, variant = "outline", size = "icon", ...props }, ref) => {
  const { orientation, scrollNext, canScrollNext } = useCarousel()

  return (
    <Button
      ref={ref}
      variant={variant}
      size={size}
      className={cn(
        "absolute h-8 w-8 rounded-full",
        orientation === "horizontal"
          ? "-right-12 top-1/2 -translate-y-1/2"
          : "-bottom-12 left-1/2 -translate-x-1/2 rotate-90",
        className
      )}
      disabled={!canScrollNext}
      onClick={scrollNext}
      {...props}
    >
      <ArrowRight className="h-4 w-4" />
      <span className="sr-only">Next slide</span>
    </Button>
  )
})
CarouselNext.displayName = "CarouselNext"

export {
  type CarouselApi,
  Carousel,
  CarouselContent,
  CarouselItem,
  CarouselPrevious,
  CarouselNext,
}


// ==== FILE: src\components\ui\chart.tsx ====
"use client"

import * as React from "react"
import * as RechartsPrimitive from "recharts"

import { cn } from "@/lib/utils"

// Format: { THEME_NAME: CSS_SELECTOR }
const THEMES = { light: "", dark: ".dark" } as const

export type ChartConfig = {
  [k in string]: {
    label?: React.ReactNode
    icon?: React.ComponentType
  } & (
    | { color?: string; theme?: never }
    | { color?: never; theme: Record<keyof typeof THEMES, string> }
  )
}

type ChartContextProps = {
  config: ChartConfig
}

const ChartContext = React.createContext<ChartContextProps | null>(null)

function useChart() {
  const context = React.useContext(ChartContext)

  if (!context) {
    throw new Error("useChart must be used within a <ChartContainer />")
  }

  return context
}

const ChartContainer = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div"> & {
    config: ChartConfig
    children: React.ComponentProps<
      typeof RechartsPrimitive.ResponsiveContainer
    >["children"]
  }
>(({ id, className, children, config, ...props }, ref) => {
  const uniqueId = React.useId()
  const chartId = `chart-${id || uniqueId.replace(/:/g, "")}`

  return (
    <ChartContext.Provider value={{ config }}>
      <div
        data-chart={chartId}
        ref={ref}
        className={cn(
          "flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none",
          className
        )}
        {...props}
      >
        <ChartStyle id={chartId} config={config} />
        <RechartsPrimitive.ResponsiveContainer>
          {children}
        </RechartsPrimitive.ResponsiveContainer>
      </div>
    </ChartContext.Provider>
  )
})
ChartContainer.displayName = "Chart"

const ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {
  const colorConfig = Object.entries(config).filter(
    ([, config]) => config.theme || config.color
  )

  if (!colorConfig.length) {
    return null
  }

  return (
    <style
      dangerouslySetInnerHTML={{
        __html: Object.entries(THEMES)
          .map(
            ([theme, prefix]) => `
${prefix} [data-chart=${id}] {
${colorConfig
  .map(([key, itemConfig]) => {
    const color =
      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||
      itemConfig.color
    return color ? `  --color-${key}: ${color};` : null
  })
  .join("\n")}
}
`
          )
          .join("\n"),
      }}
    />
  )
}

const ChartTooltip = RechartsPrimitive.Tooltip

const ChartTooltipContent = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<typeof RechartsPrimitive.Tooltip> &
    React.ComponentProps<"div"> & {
      hideLabel?: boolean
      hideIndicator?: boolean
      indicator?: "line" | "dot" | "dashed"
      nameKey?: string
      labelKey?: string
    }
>(
  (
    {
      active,
      payload,
      className,
      indicator = "dot",
      hideLabel = false,
      hideIndicator = false,
      label,
      labelFormatter,
      labelClassName,
      formatter,
      color,
      nameKey,
      labelKey,
    },
    ref
  ) => {
    const { config } = useChart()

    const tooltipLabel = React.useMemo(() => {
      if (hideLabel || !payload?.length) {
        return null
      }

      const [item] = payload
      const key = `${labelKey || item.dataKey || item.name || "value"}`
      const itemConfig = getPayloadConfigFromPayload(config, item, key)
      const value =
        !labelKey && typeof label === "string"
          ? config[label as keyof typeof config]?.label || label
          : itemConfig?.label

      if (labelFormatter) {
        return (
          <div className={cn("font-medium", labelClassName)}>
            {labelFormatter(value, payload)}
          </div>
        )
      }

      if (!value) {
        return null
      }

      return <div className={cn("font-medium", labelClassName)}>{value}</div>
    }, [
      label,
      labelFormatter,
      payload,
      hideLabel,
      labelClassName,
      config,
      labelKey,
    ])

    if (!active || !payload?.length) {
      return null
    }

    const nestLabel = payload.length === 1 && indicator !== "dot"

    return (
      <div
        ref={ref}
        className={cn(
          "grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-background px-2.5 py-1.5 text-xs shadow-xl",
          className
        )}
      >
        {!nestLabel ? tooltipLabel : null}
        <div className="grid gap-1.5">
          {payload.map((item, index) => {
            const key = `${nameKey || item.name || item.dataKey || "value"}`
            const itemConfig = getPayloadConfigFromPayload(config, item, key)
            const indicatorColor = color || item.payload.fill || item.color

            return (
              <div
                key={item.dataKey}
                className={cn(
                  "flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground",
                  indicator === "dot" && "items-center"
                )}
              >
                {formatter && item?.value !== undefined && item.name ? (
                  formatter(item.value, item.name, item, index, item.payload)
                ) : (
                  <>
                    {itemConfig?.icon ? (
                      <itemConfig.icon />
                    ) : (
                      !hideIndicator && (
                        <div
                          className={cn(
                            "shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]",
                            {
                              "h-2.5 w-2.5": indicator === "dot",
                              "w-1": indicator === "line",
                              "w-0 border-[1.5px] border-dashed bg-transparent":
                                indicator === "dashed",
                              "my-0.5": nestLabel && indicator === "dashed",
                            }
                          )}
                          style={
                            {
                              "--color-bg": indicatorColor,
                              "--color-border": indicatorColor,
                            } as React.CSSProperties
                          }
                        />
                      )
                    )}
                    <div
                      className={cn(
                        "flex flex-1 justify-between leading-none",
                        nestLabel ? "items-end" : "items-center"
                      )}
                    >
                      <div className="grid gap-1.5">
                        {nestLabel ? tooltipLabel : null}
                        <span className="text-muted-foreground">
                          {itemConfig?.label || item.name}
                        </span>
                      </div>
                      {item.value && (
                        <span className="font-mono font-medium tabular-nums text-foreground">
                          {item.value.toLocaleString()}
                        </span>
                      )}
                    </div>
                  </>
                )}
              </div>
            )
          })}
        </div>
      </div>
    )
  }
)
ChartTooltipContent.displayName = "ChartTooltip"

const ChartLegend = RechartsPrimitive.Legend

const ChartLegendContent = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div"> &
    Pick<RechartsPrimitive.LegendProps, "payload" | "verticalAlign"> & {
      hideIcon?: boolean
      nameKey?: string
    }
>(
  (
    { className, hideIcon = false, payload, verticalAlign = "bottom", nameKey },
    ref
  ) => {
    const { config } = useChart()

    if (!payload?.length) {
      return null
    }

    return (
      <div
        ref={ref}
        className={cn(
          "flex items-center justify-center gap-4",
          verticalAlign === "top" ? "pb-3" : "pt-3",
          className
        )}
      >
        {payload.map((item) => {
          const key = `${nameKey || item.dataKey || "value"}`
          const itemConfig = getPayloadConfigFromPayload(config, item, key)

          return (
            <div
              key={item.value}
              className={cn(
                "flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground"
              )}
            >
              {itemConfig?.icon && !hideIcon ? (
                <itemConfig.icon />
              ) : (
                <div
                  className="h-2 w-2 shrink-0 rounded-[2px]"
                  style={{
                    backgroundColor: item.color,
                  }}
                />
              )}
              {itemConfig?.label}
            </div>
          )
        })}
      </div>
    )
  }
)
ChartLegendContent.displayName = "ChartLegend"

// Helper to extract item config from a payload.
function getPayloadConfigFromPayload(
  config: ChartConfig,
  payload: unknown,
  key: string
) {
  if (typeof payload !== "object" || payload === null) {
    return undefined
  }

  const payloadPayload =
    "payload" in payload &&
    typeof payload.payload === "object" &&
    payload.payload !== null
      ? payload.payload
      : undefined

  let configLabelKey: string = key

  if (
    key in payload &&
    typeof payload[key as keyof typeof payload] === "string"
  ) {
    configLabelKey = payload[key as keyof typeof payload] as string
  } else if (
    payloadPayload &&
    key in payloadPayload &&
    typeof payloadPayload[key as keyof typeof payloadPayload] === "string"
  ) {
    configLabelKey = payloadPayload[
      key as keyof typeof payloadPayload
    ] as string
  }

  return configLabelKey in config
    ? config[configLabelKey]
    : config[key as keyof typeof config]
}

export {
  ChartContainer,
  ChartTooltip,
  ChartTooltipContent,
  ChartLegend,
  ChartLegendContent,
  ChartStyle,
}


// ==== FILE: src\components\ui\checkbox.tsx ====
"use client"

import * as React from "react"
import * as CheckboxPrimitive from "@radix-ui/react-checkbox"
import { Check } from "lucide-react"

import { cn } from "@/lib/utils"

const Checkbox = React.forwardRef<
  React.ElementRef<typeof CheckboxPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>
>(({ className, ...props }, ref) => (
  <CheckboxPrimitive.Root
    ref={ref}
    className={cn(
      "peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground",
      className
    )}
    {...props}
  >
    <CheckboxPrimitive.Indicator
      className={cn("flex items-center justify-center text-current")}
    >
      <Check className="h-4 w-4" />
    </CheckboxPrimitive.Indicator>
  </CheckboxPrimitive.Root>
))
Checkbox.displayName = CheckboxPrimitive.Root.displayName

export { Checkbox }


// ==== FILE: src\components\ui\client-image.tsx ====
"use client"
import Image, { ImageProps } from 'next/image'
import { useMemo, useState } from 'react'

type ClientImageProps = ImageProps & {
  fallbackSrc?: string
}

const DEFAULT_BLUR =
  'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAwMBA6m+Vb8AAAAASUVORK5CYII='

export default function ClientImage({ fallbackSrc = '/favicon.ico', placeholder = 'blur', blurDataURL, ...rest }: ClientImageProps) {
  const [failed, setFailed] = useState(false)
  const [localSrc] = useState<string | null>(null)
  const blur = useMemo(() => blurDataURL || DEFAULT_BLUR, [blurDataURL])
  const initialSrc = (rest.src as string)

  // Simplified: don't attempt client-side caching; rely on direct URLs.

  const src = failed ? fallbackSrc : (localSrc || initialSrc)
  return (
    <Image
      {...rest}
      src={src}
      placeholder={placeholder}
      blurDataURL={blur}
      onError={() => setFailed(true)}
    />
  )
}


// ==== FILE: src\components\ui\collapsible.tsx ====
"use client"

import * as CollapsiblePrimitive from "@radix-ui/react-collapsible"

const Collapsible = CollapsiblePrimitive.Root

const CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger

const CollapsibleContent = CollapsiblePrimitive.CollapsibleContent

export { Collapsible, CollapsibleTrigger, CollapsibleContent }


// ==== FILE: src\components\ui\command.tsx ====
"use client"

import * as React from "react"
import { type DialogProps } from "@radix-ui/react-dialog"
import { Command as CommandPrimitive } from "cmdk"

import { cn } from "@/lib/utils"
import { Dialog, DialogContent } from "@/components/ui/dialog"

const Command = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive>
>(({ className, ...props }, ref) => (
  <CommandPrimitive
    ref={ref}
    className={cn(
      "flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground",
      className
    )}
    {...props}
  />
))
Command.displayName = CommandPrimitive.displayName

const CommandDialog = ({ children, ...props }: DialogProps) => {
  return (
    <Dialog {...props}>
      <DialogContent className="overflow-hidden p-0 shadow-lg">
        <Command className="[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5">
          {children}
        </Command>
      </DialogContent>
    </Dialog>
  )
}

const CommandInput = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Input>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>
>(({ className, ...props }, ref) => (
  <div className="flex items-center border-b px-3" cmdk-input-wrapper="">
    <CommandPrimitive.Input
      ref={ref}
      className={cn(
        "flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50",
        className
      )}
      {...props}
    />
  </div>
))
CommandInput.displayName = CommandPrimitive.Input.displayName

const CommandList = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.List>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>
>(({ className, ...props }, ref) => (
  <CommandPrimitive.List
    ref={ref}
    className={cn("max-h-[300px] overflow-y-auto overflow-x-hidden", className)}
    {...props}
  />
))
CommandList.displayName = CommandPrimitive.List.displayName

const CommandEmpty = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Empty>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>
>((props, ref) => (
  <CommandPrimitive.Empty ref={ref} className="py-6 text-center text-sm" {...props} />
))
CommandEmpty.displayName = CommandPrimitive.Empty.displayName

const CommandGroup = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Group>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>
>(({ className, ...props }, ref) => (
  <CommandPrimitive.Group
    ref={ref}
    className={cn(
      "overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground",
      className
    )}
    {...props}
  />
))
CommandGroup.displayName = CommandPrimitive.Group.displayName

const CommandSeparator = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <CommandPrimitive.Separator ref={ref} className={cn("-mx-1 h-px bg-border", className)} {...props} />
))
CommandSeparator.displayName = CommandPrimitive.Separator.displayName

const CommandItem = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>
>(({ className, ...props }, ref) => (
  <CommandPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected=true]:bg-accent data-[disabled=true]:opacity-50",
      className
    )}
    {...props}
  />
))
CommandItem.displayName = CommandPrimitive.Item.displayName

const CommandShortcut = ({ className, ...props }: React.HTMLAttributes<HTMLSpanElement>) => {
  return (
    <span
      className={cn("ml-auto text-xs tracking-widest text-muted-foreground", className)}
      {...props}
    />
  )
}
CommandShortcut.displayName = "CommandShortcut"

export {
  Command,
  CommandDialog,
  CommandInput,
  CommandList,
  CommandEmpty,
  CommandGroup,
  CommandItem,
  CommandShortcut,
  CommandSeparator,
}


// ==== FILE: src\components\ui\dialog.tsx ====
"use client"

import * as React from "react"
import * as DialogPrimitive from "@radix-ui/react-dialog"
import { X } from "lucide-react"

import { cn } from "@/lib/utils"

const Dialog = DialogPrimitive.Root

const DialogTrigger = DialogPrimitive.Trigger

const DialogPortal = DialogPrimitive.Portal

const DialogClose = DialogPrimitive.Close

const DialogOverlay = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Overlay
    ref={ref}
    className={cn(
      "fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className
    )}
    {...props}
  />
))
DialogOverlay.displayName = DialogPrimitive.Overlay.displayName

const DialogContent = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>
>(({ className, children, ...props }, ref) => (
  <DialogPortal>
    <DialogOverlay />
    <DialogPrimitive.Content
      ref={ref}
      className={cn(
        "fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",
        className
      )}
      {...props}
    >
      {children}
      <DialogPrimitive.Close className="absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground">
        <X className="h-4 w-4" />
        <span className="sr-only">Close</span>
      </DialogPrimitive.Close>
    </DialogPrimitive.Content>
  </DialogPortal>
))
DialogContent.displayName = DialogPrimitive.Content.displayName

const DialogHeader = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col space-y-1.5 text-center sm:text-left",
      className
    )}
    {...props}
  />
)
DialogHeader.displayName = "DialogHeader"

const DialogFooter = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",
      className
    )}
    {...props}
  />
)
DialogFooter.displayName = "DialogFooter"

const DialogTitle = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Title
    ref={ref}
    className={cn(
      "text-lg font-semibold leading-none tracking-tight",
      className
    )}
    {...props}
  />
))
DialogTitle.displayName = DialogPrimitive.Title.displayName

const DialogDescription = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
DialogDescription.displayName = DialogPrimitive.Description.displayName

export {
  Dialog,
  DialogPortal,
  DialogOverlay,
  DialogClose,
  DialogTrigger,
  DialogContent,
  DialogHeader,
  DialogFooter,
  DialogTitle,
  DialogDescription,
}


// ==== FILE: src\components\ui\dropdown-menu.tsx ====
"use client"

import * as React from "react"
import * as DropdownMenuPrimitive from "@radix-ui/react-dropdown-menu"
import { Check, ChevronRight, Circle } from "lucide-react"

import { cn } from "@/lib/utils"

const DropdownMenu = DropdownMenuPrimitive.Root

const DropdownMenuTrigger = DropdownMenuPrimitive.Trigger

const DropdownMenuGroup = DropdownMenuPrimitive.Group

const DropdownMenuPortal = DropdownMenuPrimitive.Portal

const DropdownMenuSub = DropdownMenuPrimitive.Sub

const DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup

const DropdownMenuSubTrigger = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {
    inset?: boolean
  }
>(({ className, inset, children, ...props }, ref) => (
  <DropdownMenuPrimitive.SubTrigger
    ref={ref}
    className={cn(
      "flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",
      inset && "pl-8",
      className
    )}
    {...props}
  >
    {children}
    <ChevronRight className="ml-auto" />
  </DropdownMenuPrimitive.SubTrigger>
))
DropdownMenuSubTrigger.displayName =
  DropdownMenuPrimitive.SubTrigger.displayName

const DropdownMenuSubContent = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>
>(({ className, ...props }, ref) => (
  <DropdownMenuPrimitive.SubContent
    ref={ref}
    className={cn(
      "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
      className
    )}
    {...props}
  />
))
DropdownMenuSubContent.displayName =
  DropdownMenuPrimitive.SubContent.displayName

const DropdownMenuContent = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>
>(({ className, sideOffset = 4, ...props }, ref) => (
  <DropdownMenuPrimitive.Portal>
    <DropdownMenuPrimitive.Content
      ref={ref}
      sideOffset={sideOffset}
      className={cn(
        "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        className
      )}
      {...props}
    />
  </DropdownMenuPrimitive.Portal>
))
DropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName

const DropdownMenuItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {
    inset?: boolean
  }
>(({ className, inset, ...props }, ref) => (
  <DropdownMenuPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",
      inset && "pl-8",
      className
    )}
    {...props}
  />
))
DropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName

const DropdownMenuCheckboxItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>
>(({ className, children, checked, ...props }, ref) => (
  <DropdownMenuPrimitive.CheckboxItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    checked={checked}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <DropdownMenuPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </DropdownMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </DropdownMenuPrimitive.CheckboxItem>
))
DropdownMenuCheckboxItem.displayName =
  DropdownMenuPrimitive.CheckboxItem.displayName

const DropdownMenuRadioItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>
>(({ className, children, ...props }, ref) => (
  <DropdownMenuPrimitive.RadioItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <DropdownMenuPrimitive.ItemIndicator>
        <Circle className="h-2 w-2 fill-current" />
      </DropdownMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </DropdownMenuPrimitive.RadioItem>
))
DropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName

const DropdownMenuLabel = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Label>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {
    inset?: boolean
  }
>(({ className, inset, ...props }, ref) => (
  <DropdownMenuPrimitive.Label
    ref={ref}
    className={cn(
      "px-2 py-1.5 text-sm font-semibold",
      inset && "pl-8",
      className
    )}
    {...props}
  />
))
DropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName

const DropdownMenuSeparator = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <DropdownMenuPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 my-1 h-px bg-muted", className)}
    {...props}
  />
))
DropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName

const DropdownMenuShortcut = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLSpanElement>) => {
  return (
    <span
      className={cn("ml-auto text-xs tracking-widest opacity-60", className)}
      {...props}
    />
  )
}
DropdownMenuShortcut.displayName = "DropdownMenuShortcut"

export {
  DropdownMenu,
  DropdownMenuTrigger,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuCheckboxItem,
  DropdownMenuRadioItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuShortcut,
  DropdownMenuGroup,
  DropdownMenuPortal,
  DropdownMenuSub,
  DropdownMenuSubContent,
  DropdownMenuSubTrigger,
  DropdownMenuRadioGroup,
}


// ==== FILE: src\components\ui\form.tsx ====
"use client"

import * as React from "react"
import * as LabelPrimitive from "@radix-ui/react-label"
import { Slot } from "@radix-ui/react-slot"
import {
  Controller,
  FormProvider,
  useFormContext,
  type ControllerProps,
  type FieldPath,
  type FieldValues,
} from "react-hook-form"

import { cn } from "@/lib/utils"
import { Label } from "@/components/ui/label"

const Form = FormProvider

type FormFieldContextValue<
  TFieldValues extends FieldValues = FieldValues,
  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>
> = {
  name: TName
}

const FormFieldContext = React.createContext<FormFieldContextValue>(
  {} as FormFieldContextValue
)

const FormField = <
  TFieldValues extends FieldValues = FieldValues,
  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>
>({
  ...props
}: ControllerProps<TFieldValues, TName>) => {
  return (
    <FormFieldContext.Provider value={{ name: props.name }}>
      <Controller {...props} />
    </FormFieldContext.Provider>
  )
}

const useFormField = () => {
  const fieldContext = React.useContext(FormFieldContext)
  const itemContext = React.useContext(FormItemContext)
  const { getFieldState, formState } = useFormContext()

  const fieldState = getFieldState(fieldContext.name, formState)

  if (!fieldContext) {
    throw new Error("useFormField should be used within <FormField>")
  }

  const { id } = itemContext

  return {
    id,
    name: fieldContext.name,
    formItemId: `${id}-form-item`,
    formDescriptionId: `${id}-form-item-description`,
    formMessageId: `${id}-form-item-message`,
    ...fieldState,
  }
}

type FormItemContextValue = {
  id: string
}

const FormItemContext = React.createContext<FormItemContextValue>(
  {} as FormItemContextValue
)

const FormItem = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => {
  const id = React.useId()

  return (
    <FormItemContext.Provider value={{ id }}>
      <div ref={ref} className={cn("space-y-2", className)} {...props} />
    </FormItemContext.Provider>
  )
})
FormItem.displayName = "FormItem"

const FormLabel = React.forwardRef<
  React.ElementRef<typeof LabelPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>
>(({ className, ...props }, ref) => {
  const { error, formItemId } = useFormField()

  return (
    <Label
      ref={ref}
      className={cn(error && "text-destructive", className)}
      htmlFor={formItemId}
      {...props}
    />
  )
})
FormLabel.displayName = "FormLabel"

const FormControl = React.forwardRef<
  React.ElementRef<typeof Slot>,
  React.ComponentPropsWithoutRef<typeof Slot>
>(({ ...props }, ref) => {
  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()

  return (
    <Slot
      ref={ref}
      id={formItemId}
      aria-describedby={
        !error
          ? `${formDescriptionId}`
          : `${formDescriptionId} ${formMessageId}`
      }
      aria-invalid={!!error}
      {...props}
    />
  )
})
FormControl.displayName = "FormControl"

const FormDescription = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLParagraphElement>
>(({ className, ...props }, ref) => {
  const { formDescriptionId } = useFormField()

  return (
    <p
      ref={ref}
      id={formDescriptionId}
      className={cn("text-sm text-muted-foreground", className)}
      {...props}
    />
  )
})
FormDescription.displayName = "FormDescription"

const FormMessage = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLParagraphElement>
>(({ className, children, ...props }, ref) => {
  const { error, formMessageId } = useFormField()
  const body = error ? String(error?.message ?? "") : children

  if (!body) {
    return null
  }

  return (
    <p
      ref={ref}
      id={formMessageId}
      className={cn("text-sm font-medium text-destructive", className)}
      {...props}
    >
      {body}
    </p>
  )
})
FormMessage.displayName = "FormMessage"

export {
  useFormField,
  Form,
  FormItem,
  FormLabel,
  FormControl,
  FormDescription,
  FormMessage,
  FormField,
}


// ==== FILE: src\components\ui\input.tsx ====
import * as React from "react"

import { cn } from "@/lib/utils"

const Input = React.forwardRef<HTMLInputElement, React.ComponentProps<"input">>(
  ({ className, type, ...props }, ref) => {
    return (
      <input
        type={type}
        className={cn(
          "flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
          className
        )}
        ref={ref}
        {...props}
      />
    )
  }
)
Input.displayName = "Input"

export { Input }


// ==== FILE: src\components\ui\label.tsx ====
"use client"

import * as React from "react"
import * as LabelPrimitive from "@radix-ui/react-label"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const labelVariants = cva(
  "text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"
)

const Label = React.forwardRef<
  React.ElementRef<typeof LabelPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &
    VariantProps<typeof labelVariants>
>(({ className, ...props }, ref) => (
  <LabelPrimitive.Root
    ref={ref}
    className={cn(labelVariants(), className)}
    {...props}
  />
))
Label.displayName = LabelPrimitive.Root.displayName

export { Label }


// ==== FILE: src\components\ui\menubar.tsx ====
"use client"

import * as React from "react"
import * as MenubarPrimitive from "@radix-ui/react-menubar"
import { Check, ChevronRight, Circle } from "lucide-react"

import { cn } from "@/lib/utils"

function MenubarMenu({
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Menu>) {
  return <MenubarPrimitive.Menu {...props} />
}

function MenubarGroup({
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Group>) {
  return <MenubarPrimitive.Group {...props} />
}

function MenubarPortal({
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Portal>) {
  return <MenubarPrimitive.Portal {...props} />
}

function MenubarRadioGroup({
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.RadioGroup>) {
  return <MenubarPrimitive.RadioGroup {...props} />
}

function MenubarSub({
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Sub>) {
  return <MenubarPrimitive.Sub data-slot="menubar-sub" {...props} />
}

const Menubar = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Root>
>(({ className, ...props }, ref) => (
  <MenubarPrimitive.Root
    ref={ref}
    className={cn(
      "flex h-10 items-center space-x-1 rounded-md border bg-background p-1",
      className
    )}
    {...props}
  />
))
Menubar.displayName = MenubarPrimitive.Root.displayName

const MenubarTrigger = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Trigger>
>(({ className, ...props }, ref) => (
  <MenubarPrimitive.Trigger
    ref={ref}
    className={cn(
      "flex cursor-default select-none items-center rounded-sm px-3 py-1.5 text-sm font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground",
      className
    )}
    {...props}
  />
))
MenubarTrigger.displayName = MenubarPrimitive.Trigger.displayName

const MenubarSubTrigger = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.SubTrigger>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubTrigger> & {
    inset?: boolean
  }
>(({ className, inset, children, ...props }, ref) => (
  <MenubarPrimitive.SubTrigger
    ref={ref}
    className={cn(
      "flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground",
      inset && "pl-8",
      className
    )}
    {...props}
  >
    {children}
    <ChevronRight className="ml-auto h-4 w-4" />
  </MenubarPrimitive.SubTrigger>
))
MenubarSubTrigger.displayName = MenubarPrimitive.SubTrigger.displayName

const MenubarSubContent = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.SubContent>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubContent>
>(({ className, ...props }, ref) => (
  <MenubarPrimitive.SubContent
    ref={ref}
    className={cn(
      "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
      className
    )}
    {...props}
  />
))
MenubarSubContent.displayName = MenubarPrimitive.SubContent.displayName

const MenubarContent = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Content>
>(
  (
    { className, align = "start", alignOffset = -4, sideOffset = 8, ...props },
    ref
  ) => (
    <MenubarPrimitive.Portal>
      <MenubarPrimitive.Content
        ref={ref}
        align={align}
        alignOffset={alignOffset}
        sideOffset={sideOffset}
        className={cn(
          "z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
          className
        )}
        {...props}
      />
    </MenubarPrimitive.Portal>
  )
)
MenubarContent.displayName = MenubarPrimitive.Content.displayName

const MenubarItem = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Item> & {
    inset?: boolean
  }
>(({ className, inset, ...props }, ref) => (
  <MenubarPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      inset && "pl-8",
      className
    )}
    {...props}
  />
))
MenubarItem.displayName = MenubarPrimitive.Item.displayName

const MenubarCheckboxItem = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.CheckboxItem>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.CheckboxItem>
>(({ className, children, checked, ...props }, ref) => (
  <MenubarPrimitive.CheckboxItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    checked={checked}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <MenubarPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </MenubarPrimitive.ItemIndicator>
    </span>
    {children}
  </MenubarPrimitive.CheckboxItem>
))
MenubarCheckboxItem.displayName = MenubarPrimitive.CheckboxItem.displayName

const MenubarRadioItem = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.RadioItem>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.RadioItem>
>(({ className, children, ...props }, ref) => (
  <MenubarPrimitive.RadioItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <MenubarPrimitive.ItemIndicator>
        <Circle className="h-2 w-2 fill-current" />
      </MenubarPrimitive.ItemIndicator>
    </span>
    {children}
  </MenubarPrimitive.RadioItem>
))
MenubarRadioItem.displayName = MenubarPrimitive.RadioItem.displayName

const MenubarLabel = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.Label>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Label> & {
    inset?: boolean
  }
>(({ className, inset, ...props }, ref) => (
  <MenubarPrimitive.Label
    ref={ref}
    className={cn(
      "px-2 py-1.5 text-sm font-semibold",
      inset && "pl-8",
      className
    )}
    {...props}
  />
))
MenubarLabel.displayName = MenubarPrimitive.Label.displayName

const MenubarSeparator = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <MenubarPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 my-1 h-px bg-muted", className)}
    {...props}
  />
))
MenubarSeparator.displayName = MenubarPrimitive.Separator.displayName

const MenubarShortcut = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLSpanElement>) => {
  return (
    <span
      className={cn(
        "ml-auto text-xs tracking-widest text-muted-foreground",
        className
      )}
      {...props}
    />
  )
}
MenubarShortcut.displayname = "MenubarShortcut"

export {
  Menubar,
  MenubarMenu,
  MenubarTrigger,
  MenubarContent,
  MenubarItem,
  MenubarSeparator,
  MenubarLabel,
  MenubarCheckboxItem,
  MenubarRadioGroup,
  MenubarRadioItem,
  MenubarPortal,
  MenubarSubContent,
  MenubarSubTrigger,
  MenubarGroup,
  MenubarSub,
  MenubarShortcut,
}


// ==== FILE: src\components\ui\popover.tsx ====
"use client"

import * as React from "react"
import * as PopoverPrimitive from "@radix-ui/react-popover"

import { cn } from "@/lib/utils"

const Popover = PopoverPrimitive.Root

const PopoverTrigger = PopoverPrimitive.Trigger

const PopoverContent = React.forwardRef<
  React.ElementRef<typeof PopoverPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>
>(({ className, align = "center", sideOffset = 4, ...props }, ref) => (
  <PopoverPrimitive.Portal>
    <PopoverPrimitive.Content
      ref={ref}
      align={align}
      sideOffset={sideOffset}
      className={cn(
        "z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        className
      )}
      {...props}
    />
  </PopoverPrimitive.Portal>
))
PopoverContent.displayName = PopoverPrimitive.Content.displayName

export { Popover, PopoverTrigger, PopoverContent }


// ==== FILE: src\components\ui\progress.tsx ====
"use client"

import * as React from "react"
import * as ProgressPrimitive from "@radix-ui/react-progress"

import { cn } from "@/lib/utils"

const Progress = React.forwardRef<
  React.ElementRef<typeof ProgressPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>
>(({ className, value, ...props }, ref) => (
  <ProgressPrimitive.Root
    ref={ref}
    className={cn(
      "relative h-4 w-full overflow-hidden rounded-full bg-secondary",
      className
    )}
    {...props}
  >
    <ProgressPrimitive.Indicator
      className="h-full w-full flex-1 bg-primary transition-all"
      style={{ transform: `translateX(-${100 - (value || 0)}%)` }}
    />
  </ProgressPrimitive.Root>
))
Progress.displayName = ProgressPrimitive.Root.displayName

export { Progress }


// ==== FILE: src\components\ui\radio-group.tsx ====
"use client"

import * as React from "react"
import * as RadioGroupPrimitive from "@radix-ui/react-radio-group"
import { Circle } from "lucide-react"

import { cn } from "@/lib/utils"

const RadioGroup = React.forwardRef<
  React.ElementRef<typeof RadioGroupPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>
>(({ className, ...props }, ref) => {
  return (
    <RadioGroupPrimitive.Root
      className={cn("grid gap-2", className)}
      {...props}
      ref={ref}
    />
  )
})
RadioGroup.displayName = RadioGroupPrimitive.Root.displayName

const RadioGroupItem = React.forwardRef<
  React.ElementRef<typeof RadioGroupPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>
>(({ className, ...props }, ref) => {
  return (
    <RadioGroupPrimitive.Item
      ref={ref}
      className={cn(
        "aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",
        className
      )}
      {...props}
    >
      <RadioGroupPrimitive.Indicator className="flex items-center justify-center">
        <Circle className="h-2.5 w-2.5 fill-current text-current" />
      </RadioGroupPrimitive.Indicator>
    </RadioGroupPrimitive.Item>
  )
})
RadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName

export { RadioGroup, RadioGroupItem }


// ==== FILE: src\components\ui\scroll-area.tsx ====
"use client"

import * as React from "react"
import * as ScrollAreaPrimitive from "@radix-ui/react-scroll-area"

import { cn } from "@/lib/utils"

const ScrollArea = React.forwardRef<
  React.ElementRef<typeof ScrollAreaPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>
>(({ className, children, ...props }, ref) => (
  <ScrollAreaPrimitive.Root
    ref={ref}
    className={cn("relative overflow-hidden", className)}
    {...props}
  >
    <ScrollAreaPrimitive.Viewport className="h-full w-full rounded-[inherit]">
      {children}
    </ScrollAreaPrimitive.Viewport>
    <ScrollBar />
    <ScrollAreaPrimitive.Corner />
  </ScrollAreaPrimitive.Root>
))
ScrollArea.displayName = ScrollAreaPrimitive.Root.displayName

const ScrollBar = React.forwardRef<
  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,
  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>
>(({ className, orientation = "vertical", ...props }, ref) => (
  <ScrollAreaPrimitive.ScrollAreaScrollbar
    ref={ref}
    orientation={orientation}
    className={cn(
      "flex touch-none select-none transition-colors",
      orientation === "vertical" &&
        "h-full w-2.5 border-l border-l-transparent p-[1px]",
      orientation === "horizontal" &&
        "h-2.5 flex-col border-t border-t-transparent p-[1px]",
      className
    )}
    {...props}
  >
    <ScrollAreaPrimitive.ScrollAreaThumb className="relative flex-1 rounded-full bg-border" />
  </ScrollAreaPrimitive.ScrollAreaScrollbar>
))
ScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName

export { ScrollArea, ScrollBar }


// ==== FILE: src\components\ui\select.tsx ====
"use client"

import * as React from "react"
import * as SelectPrimitive from "@radix-ui/react-select"
import { Check, ChevronDown, ChevronUp } from "lucide-react"

import { cn } from "@/lib/utils"

const Select = SelectPrimitive.Root

const SelectGroup = SelectPrimitive.Group

const SelectValue = SelectPrimitive.Value

const SelectTrigger = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>
>(({ className, children, ...props }, ref) => (
  <SelectPrimitive.Trigger
    ref={ref}
    className={cn(
      "flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1",
      className
    )}
    {...props}
  >
    {children}
    <SelectPrimitive.Icon asChild>
      <ChevronDown className="h-4 w-4 opacity-50" />
    </SelectPrimitive.Icon>
  </SelectPrimitive.Trigger>
))
SelectTrigger.displayName = SelectPrimitive.Trigger.displayName

const SelectScrollUpButton = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.ScrollUpButton
    ref={ref}
    className={cn(
      "flex cursor-default items-center justify-center py-1",
      className
    )}
    {...props}
  >
    <ChevronUp className="h-4 w-4" />
  </SelectPrimitive.ScrollUpButton>
))
SelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName

const SelectScrollDownButton = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.ScrollDownButton
    ref={ref}
    className={cn(
      "flex cursor-default items-center justify-center py-1",
      className
    )}
    {...props}
  >
    <ChevronDown className="h-4 w-4" />
  </SelectPrimitive.ScrollDownButton>
))
SelectScrollDownButton.displayName =
  SelectPrimitive.ScrollDownButton.displayName

const SelectContent = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>
>(({ className, children, position = "popper", ...props }, ref) => (
  <SelectPrimitive.Portal>
    <SelectPrimitive.Content
      ref={ref}
      className={cn(
        "relative z-50 max-h-96 min-w-[8rem] overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        position === "popper" &&
          "data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",
        className
      )}
      position={position}
      {...props}
    >
      <SelectScrollUpButton />
      <SelectPrimitive.Viewport
        className={cn(
          "p-1",
          position === "popper" &&
            "h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"
        )}
      >
        {children}
      </SelectPrimitive.Viewport>
      <SelectScrollDownButton />
    </SelectPrimitive.Content>
  </SelectPrimitive.Portal>
))
SelectContent.displayName = SelectPrimitive.Content.displayName

const SelectLabel = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Label>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.Label
    ref={ref}
    className={cn("py-1.5 pl-8 pr-2 text-sm font-semibold", className)}
    {...props}
  />
))
SelectLabel.displayName = SelectPrimitive.Label.displayName

const SelectItem = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>
>(({ className, children, ...props }, ref) => (
  <SelectPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <SelectPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </SelectPrimitive.ItemIndicator>
    </span>

    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>
  </SelectPrimitive.Item>
))
SelectItem.displayName = SelectPrimitive.Item.displayName

const SelectSeparator = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 my-1 h-px bg-muted", className)}
    {...props}
  />
))
SelectSeparator.displayName = SelectPrimitive.Separator.displayName

export {
  Select,
  SelectGroup,
  SelectValue,
  SelectTrigger,
  SelectContent,
  SelectLabel,
  SelectItem,
  SelectSeparator,
  SelectScrollUpButton,
  SelectScrollDownButton,
}


// ==== FILE: src\components\ui\separator.tsx ====
"use client"

import * as React from "react"
import * as SeparatorPrimitive from "@radix-ui/react-separator"

import { cn } from "@/lib/utils"

const Separator = React.forwardRef<
  React.ElementRef<typeof SeparatorPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>
>(
  (
    { className, orientation = "horizontal", decorative = true, ...props },
    ref
  ) => (
    <SeparatorPrimitive.Root
      ref={ref}
      decorative={decorative}
      orientation={orientation}
      className={cn(
        "shrink-0 bg-border",
        orientation === "horizontal" ? "h-[1px] w-full" : "h-full w-[1px]",
        className
      )}
      {...props}
    />
  )
)
Separator.displayName = SeparatorPrimitive.Root.displayName

export { Separator }


// ==== FILE: src\components\ui\sheet.tsx ====
"use client"

import * as React from "react"
import * as SheetPrimitive from "@radix-ui/react-dialog"
import { cva, type VariantProps } from "class-variance-authority"
import { X } from "lucide-react"

import { cn } from "@/lib/utils"

const Sheet = SheetPrimitive.Root

const SheetTrigger = SheetPrimitive.Trigger

const SheetClose = SheetPrimitive.Close

const SheetPortal = SheetPrimitive.Portal

const SheetOverlay = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <SheetPrimitive.Overlay
    className={cn(
      "fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className
    )}
    {...props}
    ref={ref}
  />
))
SheetOverlay.displayName = SheetPrimitive.Overlay.displayName

const sheetVariants = cva(
  "fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500",
  {
    variants: {
      side: {
        top: "inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top",
        bottom:
          "inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom",
        left: "inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm",
        right:
          "inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm",
      },
    },
    defaultVariants: {
      side: "right",
    },
  }
)

interface SheetContentProps
  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,
    VariantProps<typeof sheetVariants> {}

const SheetContent = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Content>,
  SheetContentProps
>(({ side = "right", className, children, ...props }, ref) => (
  <SheetPortal>
    <SheetOverlay />
    <SheetPrimitive.Content
      ref={ref}
      className={cn(sheetVariants({ side }), className)}
      {...props}
    >
      {children}
      <SheetPrimitive.Close className="absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary">
        <X className="h-4 w-4" />
        <span className="sr-only">Close</span>
      </SheetPrimitive.Close>
    </SheetPrimitive.Content>
  </SheetPortal>
))
SheetContent.displayName = SheetPrimitive.Content.displayName

const SheetHeader = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col space-y-2 text-center sm:text-left",
      className
    )}
    {...props}
  />
)
SheetHeader.displayName = "SheetHeader"

const SheetFooter = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",
      className
    )}
    {...props}
  />
)
SheetFooter.displayName = "SheetFooter"

const SheetTitle = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>
>(({ className, ...props }, ref) => (
  <SheetPrimitive.Title
    ref={ref}
    className={cn("text-lg font-semibold text-foreground", className)}
    {...props}
  />
))
SheetTitle.displayName = SheetPrimitive.Title.displayName

const SheetDescription = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>
>(({ className, ...props }, ref) => (
  <SheetPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
SheetDescription.displayName = SheetPrimitive.Description.displayName

export {
  Sheet,
  SheetPortal,
  SheetOverlay,
  SheetTrigger,
  SheetClose,
  SheetContent,
  SheetHeader,
  SheetFooter,
  SheetTitle,
  SheetDescription,
}


// ==== FILE: src\components\ui\sidebar.tsx ====
"use client"

import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { VariantProps, cva } from "class-variance-authority"
import { PanelLeft } from "lucide-react"

import { useIsMobile } from "@/hooks/use-mobile"
import { cn } from "@/lib/utils"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Separator } from "@/components/ui/separator"
import { Sheet, SheetContent } from "@/components/ui/sheet"
import { Skeleton } from "@/components/ui/skeleton"
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from "@/components/ui/tooltip"

const SIDEBAR_COOKIE_NAME = "sidebar_state"
const SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7
const SIDEBAR_WIDTH = "16rem"
const SIDEBAR_WIDTH_MOBILE = "18rem"
const SIDEBAR_WIDTH_ICON = "3rem"
const SIDEBAR_KEYBOARD_SHORTCUT = "b"

type SidebarContext = {
  state: "expanded" | "collapsed"
  open: boolean
  setOpen: (open: boolean) => void
  openMobile: boolean
  setOpenMobile: (open: boolean) => void
  isMobile: boolean
  toggleSidebar: () => void
}

const SidebarContext = React.createContext<SidebarContext | null>(null)

function useSidebar() {
  const context = React.useContext(SidebarContext)
  if (!context) {
    throw new Error("useSidebar must be used within a SidebarProvider.")
  }

  return context
}

const SidebarProvider = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div"> & {
    defaultOpen?: boolean
    open?: boolean
    onOpenChange?: (open: boolean) => void
  }
>(
  (
    {
      defaultOpen = true,
      open: openProp,
      onOpenChange: setOpenProp,
      className,
      style,
      children,
      ...props
    },
    ref
  ) => {
    const isMobile = useIsMobile()
    const [openMobile, setOpenMobile] = React.useState(false)

    // This is the internal state of the sidebar.
    // We use openProp and setOpenProp for control from outside the component.
    const [_open, _setOpen] = React.useState(defaultOpen)
    const open = openProp ?? _open
    const setOpen = React.useCallback(
      (value: boolean | ((value: boolean) => boolean)) => {
        const openState = typeof value === "function" ? value(open) : value
        if (setOpenProp) {
          setOpenProp(openState)
        } else {
          _setOpen(openState)
        }

        // This sets the cookie to keep the sidebar state.
        document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`
      },
      [setOpenProp, open]
    )

    // Helper to toggle the sidebar.
    const toggleSidebar = React.useCallback(() => {
      return isMobile
        ? setOpenMobile((open) => !open)
        : setOpen((open) => !open)
    }, [isMobile, setOpen, setOpenMobile])

    // Adds a keyboard shortcut to toggle the sidebar.
    React.useEffect(() => {
      const handleKeyDown = (event: KeyboardEvent) => {
        if (
          event.key === SIDEBAR_KEYBOARD_SHORTCUT &&
          (event.metaKey || event.ctrlKey)
        ) {
          event.preventDefault()
          toggleSidebar()
        }
      }

      window.addEventListener("keydown", handleKeyDown)
      return () => window.removeEventListener("keydown", handleKeyDown)
    }, [toggleSidebar])

    // We add a state so that we can do data-state="expanded" or "collapsed".
    // This makes it easier to style the sidebar with Tailwind classes.
    const state = open ? "expanded" : "collapsed"

    const contextValue = React.useMemo<SidebarContext>(
      () => ({
        state,
        open,
        setOpen,
        isMobile,
        openMobile,
        setOpenMobile,
        toggleSidebar,
      }),
      [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar]
    )

    return (
      <SidebarContext.Provider value={contextValue}>
        <TooltipProvider delayDuration={0}>
          <div
            style={
              {
                "--sidebar-width": SIDEBAR_WIDTH,
                "--sidebar-width-icon": SIDEBAR_WIDTH_ICON,
                ...style,
              } as React.CSSProperties
            }
            className={cn(
              "group/sidebar-wrapper flex min-h-svh w-full has-[[data-variant=inset]]:bg-sidebar",
              className
            )}
            ref={ref}
            {...props}
          >
            {children}
          </div>
        </TooltipProvider>
      </SidebarContext.Provider>
    )
  }
)
SidebarProvider.displayName = "SidebarProvider"

const Sidebar = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div"> & {
    side?: "left" | "right"
    variant?: "sidebar" | "floating" | "inset"
    collapsible?: "offcanvas" | "icon" | "none"
  }
>(
  (
    {
      side = "left",
      variant = "sidebar",
      collapsible = "offcanvas",
      className,
      children,
      ...props
    },
    ref
  ) => {
    const { isMobile, state, openMobile, setOpenMobile } = useSidebar()

    if (collapsible === "none") {
      return (
        <div
          className={cn(
            "flex h-full w-[--sidebar-width] flex-col bg-sidebar text-sidebar-foreground",
            className
          )}
          ref={ref}
          {...props}
        >
          {children}
        </div>
      )
    }

    if (isMobile) {
      return (
        <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>
          <SheetContent
            data-sidebar="sidebar"
            data-mobile="true"
            className="w-[--sidebar-width] bg-sidebar p-0 text-sidebar-foreground [&>button]:hidden"
            style={
              {
                "--sidebar-width": SIDEBAR_WIDTH_MOBILE,
              } as React.CSSProperties
            }
            side={side}
          >
            <div className="flex h-full w-full flex-col">{children}</div>
          </SheetContent>
        </Sheet>
      )
    }

    return (
      <div
        ref={ref}
        className="group peer hidden md:block text-sidebar-foreground"
        data-state={state}
        data-collapsible={state === "collapsed" ? collapsible : ""}
        data-variant={variant}
        data-side={side}
      >
        {/* This is what handles the sidebar gap on desktop */}
        <div
          className={cn(
            "duration-200 relative h-svh w-[--sidebar-width] bg-transparent transition-[width] ease-linear",
            "group-data-[collapsible=offcanvas]:w-0",
            "group-data-[side=right]:rotate-180",
            variant === "floating" || variant === "inset"
              ? "group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4))]"
              : "group-data-[collapsible=icon]:w-[--sidebar-width-icon]"
          )}
        />
        <div
          className={cn(
            "duration-200 fixed inset-y-0 z-10 hidden h-svh w-[--sidebar-width] transition-[left,right,width] ease-linear md:flex",
            side === "left"
              ? "left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]"
              : "right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]",
            // Adjust the padding for floating and inset variants.
            variant === "floating" || variant === "inset"
              ? "p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4)_+2px)]"
              : "group-data-[collapsible=icon]:w-[--sidebar-width-icon] group-data-[side=left]:border-r group-data-[side=right]:border-l",
            className
          )}
          {...props}
        >
          <div
            data-sidebar="sidebar"
            className="flex h-full w-full flex-col bg-sidebar group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:border-sidebar-border group-data-[variant=floating]:shadow"
          >
            {children}
          </div>
        </div>
      </div>
    )
  }
)
Sidebar.displayName = "Sidebar"

const SidebarTrigger = React.forwardRef<
  React.ElementRef<typeof Button>,
  React.ComponentProps<typeof Button>
>(({ className, onClick, ...props }, ref) => {
  const { toggleSidebar } = useSidebar()

  return (
    <Button
      ref={ref}
      data-sidebar="trigger"
      variant="ghost"
      size="icon"
      className={cn("h-7 w-7", className)}
      onClick={(event) => {
        onClick?.(event)
        toggleSidebar()
      }}
      {...props}
    >
      <PanelLeft />
      <span className="sr-only">Toggle Sidebar</span>
    </Button>
  )
})
SidebarTrigger.displayName = "SidebarTrigger"

const SidebarRail = React.forwardRef<
  HTMLButtonElement,
  React.ComponentProps<"button">
>(({ className, ...props }, ref) => {
  const { toggleSidebar } = useSidebar()

  return (
    <button
      ref={ref}
      data-sidebar="rail"
      aria-label="Toggle Sidebar"
      tabIndex={-1}
      onClick={toggleSidebar}
      title="Toggle Sidebar"
      className={cn(
        "absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] hover:after:bg-sidebar-border group-data-[side=left]:-right-4 group-data-[side=right]:left-0 sm:flex",
        "[[data-side=left]_&]:cursor-w-resize [[data-side=right]_&]:cursor-e-resize",
        "[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize",
        "group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full group-data-[collapsible=offcanvas]:hover:bg-sidebar",
        "[[data-side=left][data-collapsible=offcanvas]_&]:-right-2",
        "[[data-side=right][data-collapsible=offcanvas]_&]:-left-2",
        className
      )}
      {...props}
    />
  )
})
SidebarRail.displayName = "SidebarRail"

const SidebarInset = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"main">
>(({ className, ...props }, ref) => {
  return (
    <main
      ref={ref}
      className={cn(
        "relative flex min-h-svh flex-1 flex-col bg-background",
        "peer-data-[variant=inset]:min-h-[calc(100svh-theme(spacing.4))] md:peer-data-[variant=inset]:m-2 md:peer-data-[state=collapsed]:peer-data-[variant=inset]:ml-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow",
        className
      )}
      {...props}
    />
  )
})
SidebarInset.displayName = "SidebarInset"

const SidebarInput = React.forwardRef<
  React.ElementRef<typeof Input>,
  React.ComponentProps<typeof Input>
>(({ className, ...props }, ref) => {
  return (
    <Input
      ref={ref}
      data-sidebar="input"
      className={cn(
        "h-8 w-full bg-background shadow-none focus-visible:ring-2 focus-visible:ring-sidebar-ring",
        className
      )}
      {...props}
    />
  )
})
SidebarInput.displayName = "SidebarInput"

const SidebarHeader = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div">
>(({ className, ...props }, ref) => {
  return (
    <div
      ref={ref}
      data-sidebar="header"
      className={cn("flex flex-col gap-2 p-2", className)}
      {...props}
    />
  )
})
SidebarHeader.displayName = "SidebarHeader"

const SidebarFooter = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div">
>(({ className, ...props }, ref) => {
  return (
    <div
      ref={ref}
      data-sidebar="footer"
      className={cn("flex flex-col gap-2 p-2", className)}
      {...props}
    />
  )
})
SidebarFooter.displayName = "SidebarFooter"

const SidebarSeparator = React.forwardRef<
  React.ElementRef<typeof Separator>,
  React.ComponentProps<typeof Separator>
>(({ className, ...props }, ref) => {
  return (
    <Separator
      ref={ref}
      data-sidebar="separator"
      className={cn("mx-2 w-auto bg-sidebar-border", className)}
      {...props}
    />
  )
})
SidebarSeparator.displayName = "SidebarSeparator"

const SidebarContent = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div">
>(({ className, ...props }, ref) => {
  return (
    <div
      ref={ref}
      data-sidebar="content"
      className={cn(
        "flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden",
        className
      )}
      {...props}
    />
  )
})
SidebarContent.displayName = "SidebarContent"

const SidebarGroup = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div">
>(({ className, ...props }, ref) => {
  return (
    <div
      ref={ref}
      data-sidebar="group"
      className={cn("relative flex w-full min-w-0 flex-col p-2", className)}
      {...props}
    />
  )
})
SidebarGroup.displayName = "SidebarGroup"

const SidebarGroupLabel = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div"> & { asChild?: boolean }
>(({ className, asChild = false, ...props }, ref) => {
  const Comp = asChild ? Slot : "div"

  return (
    <Comp
      ref={ref}
      data-sidebar="group-label"
      className={cn(
        "duration-200 flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium text-sidebar-foreground/70 outline-none ring-sidebar-ring transition-[margin,opa] ease-linear focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0",
        "group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0",
        className
      )}
      {...props}
    />
  )
})
SidebarGroupLabel.displayName = "SidebarGroupLabel"

const SidebarGroupAction = React.forwardRef<
  HTMLButtonElement,
  React.ComponentProps<"button"> & { asChild?: boolean }
>(({ className, asChild = false, ...props }, ref) => {
  const Comp = asChild ? Slot : "button"

  return (
    <Comp
      ref={ref}
      data-sidebar="group-action"
      className={cn(
        "absolute right-3 top-3.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0",
        // Increases the hit area of the button on mobile.
        "after:absolute after:-inset-2 after:md:hidden",
        "group-data-[collapsible=icon]:hidden",
        className
      )}
      {...props}
    />
  )
})
SidebarGroupAction.displayName = "SidebarGroupAction"

const SidebarGroupContent = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div">
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    data-sidebar="group-content"
    className={cn("w-full text-sm", className)}
    {...props}
  />
))
SidebarGroupContent.displayName = "SidebarGroupContent"

const SidebarMenu = React.forwardRef<
  HTMLUListElement,
  React.ComponentProps<"ul">
>(({ className, ...props }, ref) => (
  <ul
    ref={ref}
    data-sidebar="menu"
    className={cn("flex w-full min-w-0 flex-col gap-1", className)}
    {...props}
  />
))
SidebarMenu.displayName = "SidebarMenu"

const SidebarMenuItem = React.forwardRef<
  HTMLLIElement,
  React.ComponentProps<"li">
>(({ className, ...props }, ref) => (
  <li
    ref={ref}
    data-sidebar="menu-item"
    className={cn("group/menu-item relative", className)}
    {...props}
  />
))
SidebarMenuItem.displayName = "SidebarMenuItem"

const sidebarMenuButtonVariants = cva(
  "peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-none ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-[[data-sidebar=menu-action]]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:!size-8 group-data-[collapsible=icon]:!p-2 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0",
  {
    variants: {
      variant: {
        default: "hover:bg-sidebar-accent hover:text-sidebar-accent-foreground",
        outline:
          "bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]",
      },
      size: {
        default: "h-8 text-sm",
        sm: "h-7 text-xs",
        lg: "h-12 text-sm group-data-[collapsible=icon]:!p-0",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

const SidebarMenuButton = React.forwardRef<
  HTMLButtonElement,
  React.ComponentProps<"button"> & {
    asChild?: boolean
    isActive?: boolean
    tooltip?: string | React.ComponentProps<typeof TooltipContent>
  } & VariantProps<typeof sidebarMenuButtonVariants>
>(
  (
    {
      asChild = false,
      isActive = false,
      variant = "default",
      size = "default",
      tooltip,
      className,
      ...props
    },
    ref
  ) => {
    const Comp = asChild ? Slot : "button"
    const { isMobile, state } = useSidebar()

    const button = (
      <Comp
        ref={ref}
        data-sidebar="menu-button"
        data-size={size}
        data-active={isActive}
        className={cn(sidebarMenuButtonVariants({ variant, size }), className)}
        {...props}
      />
    )

    if (!tooltip) {
      return button
    }

    if (typeof tooltip === "string") {
      tooltip = {
        children: tooltip,
      }
    }

    return (
      <Tooltip>
        <TooltipTrigger asChild>{button}</TooltipTrigger>
        <TooltipContent
          side="right"
          align="center"
          hidden={state !== "collapsed" || isMobile}
          {...tooltip}
        />
      </Tooltip>
    )
  }
)
SidebarMenuButton.displayName = "SidebarMenuButton"

const SidebarMenuAction = React.forwardRef<
  HTMLButtonElement,
  React.ComponentProps<"button"> & {
    asChild?: boolean
    showOnHover?: boolean
  }
>(({ className, asChild = false, showOnHover = false, ...props }, ref) => {
  const Comp = asChild ? Slot : "button"

  return (
    <Comp
      ref={ref}
      data-sidebar="menu-action"
      className={cn(
        "absolute right-1 top-1.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 peer-hover/menu-button:text-sidebar-accent-foreground [&>svg]:size-4 [&>svg]:shrink-0",
        // Increases the hit area of the button on mobile.
        "after:absolute after:-inset-2 after:md:hidden",
        "peer-data-[size=sm]/menu-button:top-1",
        "peer-data-[size=default]/menu-button:top-1.5",
        "peer-data-[size=lg]/menu-button:top-2.5",
        "group-data-[collapsible=icon]:hidden",
        showOnHover &&
          "group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 peer-data-[active=true]/menu-button:text-sidebar-accent-foreground md:opacity-0",
        className
      )}
      {...props}
    />
  )
})
SidebarMenuAction.displayName = "SidebarMenuAction"

const SidebarMenuBadge = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div">
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    data-sidebar="menu-badge"
    className={cn(
      "absolute right-1 flex h-5 min-w-5 items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums text-sidebar-foreground select-none pointer-events-none",
      "peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground",
      "peer-data-[size=sm]/menu-button:top-1",
      "peer-data-[size=default]/menu-button:top-1.5",
      "peer-data-[size=lg]/menu-button:top-2.5",
      "group-data-[collapsible=icon]:hidden",
      className
    )}
    {...props}
  />
))
SidebarMenuBadge.displayName = "SidebarMenuBadge"

const SidebarMenuSkeleton = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div"> & {
    showIcon?: boolean
  }
>(({ className, showIcon = false, ...props }, ref) => {
  // Random width between 50 to 90%.
  const width = React.useMemo(() => {
    return `${Math.floor(Math.random() * 40) + 50}%`
  }, [])

  return (
    <div
      ref={ref}
      data-sidebar="menu-skeleton"
      className={cn("rounded-md h-8 flex gap-2 px-2 items-center", className)}
      {...props}
    >
      {showIcon && (
        <Skeleton
          className="size-4 rounded-md"
          data-sidebar="menu-skeleton-icon"
        />
      )}
      <Skeleton
        className="h-4 flex-1 max-w-[--skeleton-width]"
        data-sidebar="menu-skeleton-text"
        style={
          {
            "--skeleton-width": width,
          } as React.CSSProperties
        }
      />
    </div>
  )
})
SidebarMenuSkeleton.displayName = "SidebarMenuSkeleton"

const SidebarMenuSub = React.forwardRef<
  HTMLUListElement,
  React.ComponentProps<"ul">
>(({ className, ...props }, ref) => (
  <ul
    ref={ref}
    data-sidebar="menu-sub"
    className={cn(
      "mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l border-sidebar-border px-2.5 py-0.5",
      "group-data-[collapsible=icon]:hidden",
      className
    )}
    {...props}
  />
))
SidebarMenuSub.displayName = "SidebarMenuSub"

const SidebarMenuSubItem = React.forwardRef<
  HTMLLIElement,
  React.ComponentProps<"li">
>(({ ...props }, ref) => <li ref={ref} {...props} />)
SidebarMenuSubItem.displayName = "SidebarMenuSubItem"

const SidebarMenuSubButton = React.forwardRef<
  HTMLAnchorElement,
  React.ComponentProps<"a"> & {
    asChild?: boolean
    size?: "sm" | "md"
    isActive?: boolean
  }
>(({ asChild = false, size = "md", isActive, className, ...props }, ref) => {
  const Comp = asChild ? Slot : "a"

  return (
    <Comp
      ref={ref}
      data-sidebar="menu-sub-button"
      data-size={size}
      data-active={isActive}
      className={cn(
        "flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 text-sidebar-foreground outline-none ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 [&>svg]:text-sidebar-accent-foreground",
        "data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground",
        size === "sm" && "text-xs",
        size === "md" && "text-sm",
        "group-data-[collapsible=icon]:hidden",
        className
      )}
      {...props}
    />
  )
})
SidebarMenuSubButton.displayName = "SidebarMenuSubButton"

export {
  Sidebar,
  SidebarContent,
  SidebarFooter,
  SidebarGroup,
  SidebarGroupAction,
  SidebarGroupContent,
  SidebarGroupLabel,
  SidebarHeader,
  SidebarInput,
  SidebarInset,
  SidebarMenu,
  SidebarMenuAction,
  SidebarMenuBadge,
  SidebarMenuButton,
  SidebarMenuItem,
  SidebarMenuSkeleton,
  SidebarMenuSub,
  SidebarMenuSubButton,
  SidebarMenuSubItem,
  SidebarProvider,
  SidebarRail,
  SidebarSeparator,
  SidebarTrigger,
  useSidebar,
}


// ==== FILE: src\components\ui\skeleton.tsx ====
import { cn } from "@/lib/utils"

function Skeleton({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) {
  return (
    <div
      className={cn("animate-pulse rounded-md bg-muted", className)}
      {...props}
    />
  )
}

export { Skeleton }


// ==== FILE: src\components\ui\slider.tsx ====
"use client"

import * as React from "react"
import * as SliderPrimitive from "@radix-ui/react-slider"

import { cn } from "@/lib/utils"

const Slider = React.forwardRef<
  React.ElementRef<typeof SliderPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof SliderPrimitive.Root>
>(({ className, ...props }, ref) => (
  <SliderPrimitive.Root
    ref={ref}
    className={cn(
      "relative flex w-full touch-none select-none items-center",
      className
    )}
    {...props}
  >
    <SliderPrimitive.Track className="relative h-2 w-full grow overflow-hidden rounded-full bg-secondary">
      <SliderPrimitive.Range className="absolute h-full bg-primary" />
    </SliderPrimitive.Track>
    <SliderPrimitive.Thumb className="block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50" />
  </SliderPrimitive.Root>
))
Slider.displayName = SliderPrimitive.Root.displayName

export { Slider }


// ==== FILE: src\components\ui\switch.tsx ====
"use client"

import * as React from "react"
import * as SwitchPrimitives from "@radix-ui/react-switch"

import { cn } from "@/lib/utils"

const Switch = React.forwardRef<
  React.ElementRef<typeof SwitchPrimitives.Root>,
  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>
>(({ className, ...props }, ref) => (
  <SwitchPrimitives.Root
    className={cn(
      "peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input",
      className
    )}
    {...props}
    ref={ref}
  >
    <SwitchPrimitives.Thumb
      className={cn(
        "pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0"
      )}
    />
  </SwitchPrimitives.Root>
))
Switch.displayName = SwitchPrimitives.Root.displayName

export { Switch }


// ==== FILE: src\components\ui\table.tsx ====
import * as React from "react"

import { cn } from "@/lib/utils"

const Table = React.forwardRef<
  HTMLTableElement,
  React.HTMLAttributes<HTMLTableElement>
>(({ className, ...props }, ref) => (
  <div className="relative w-full overflow-auto">
    <table
      ref={ref}
      className={cn("w-full caption-bottom text-sm", className)}
      {...props}
    />
  </div>
))
Table.displayName = "Table"

const TableHeader = React.forwardRef<
  HTMLTableSectionElement,
  React.HTMLAttributes<HTMLTableSectionElement>
>(({ className, ...props }, ref) => (
  <thead ref={ref} className={cn("[&_tr]:border-b", className)} {...props} />
))
TableHeader.displayName = "TableHeader"

const TableBody = React.forwardRef<
  HTMLTableSectionElement,
  React.HTMLAttributes<HTMLTableSectionElement>
>(({ className, ...props }, ref) => (
  <tbody
    ref={ref}
    className={cn("[&_tr:last-child]:border-0", className)}
    {...props}
  />
))
TableBody.displayName = "TableBody"

const TableFooter = React.forwardRef<
  HTMLTableSectionElement,
  React.HTMLAttributes<HTMLTableSectionElement>
>(({ className, ...props }, ref) => (
  <tfoot
    ref={ref}
    className={cn(
      "border-t bg-muted/50 font-medium [&>tr]:last:border-b-0",
      className
    )}
    {...props}
  />
))
TableFooter.displayName = "TableFooter"

const TableRow = React.forwardRef<
  HTMLTableRowElement,
  React.HTMLAttributes<HTMLTableRowElement>
>(({ className, ...props }, ref) => (
  <tr
    ref={ref}
    className={cn(
      "border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted",
      className
    )}
    {...props}
  />
))
TableRow.displayName = "TableRow"

const TableHead = React.forwardRef<
  HTMLTableCellElement,
  React.ThHTMLAttributes<HTMLTableCellElement>
>(({ className, ...props }, ref) => (
  <th
    ref={ref}
    className={cn(
      "h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0",
      className
    )}
    {...props}
  />
))
TableHead.displayName = "TableHead"

const TableCell = React.forwardRef<
  HTMLTableCellElement,
  React.TdHTMLAttributes<HTMLTableCellElement>
>(({ className, ...props }, ref) => (
  <td
    ref={ref}
    className={cn("p-4 align-middle [&:has([role=checkbox])]:pr-0", className)}
    {...props}
  />
))
TableCell.displayName = "TableCell"

const TableCaption = React.forwardRef<
  HTMLTableCaptionElement,
  React.HTMLAttributes<HTMLTableCaptionElement>
>(({ className, ...props }, ref) => (
  <caption
    ref={ref}
    className={cn("mt-4 text-sm text-muted-foreground", className)}
    {...props}
  />
))
TableCaption.displayName = "TableCaption"

export {
  Table,
  TableHeader,
  TableBody,
  TableFooter,
  TableHead,
  TableRow,
  TableCell,
  TableCaption,
}


// ==== FILE: src\components\ui\tabs.tsx ====
"use client"

import * as React from "react"
import * as TabsPrimitive from "@radix-ui/react-tabs"

import { cn } from "@/lib/utils"

const Tabs = TabsPrimitive.Root

const TabsList = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.List>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.List
    ref={ref}
    className={cn(
      "inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",
      className
    )}
    {...props}
  />
))
TabsList.displayName = TabsPrimitive.List.displayName

const TabsTrigger = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.Trigger
    ref={ref}
    className={cn(
      "inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm",
      className
    )}
    {...props}
  />
))
TabsTrigger.displayName = TabsPrimitive.Trigger.displayName

const TabsContent = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.Content
    ref={ref}
    className={cn(
      "mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",
      className
    )}
    {...props}
  />
))
TabsContent.displayName = TabsPrimitive.Content.displayName

export { Tabs, TabsList, TabsTrigger, TabsContent }


// ==== FILE: src\components\ui\textarea.tsx ====
import * as React from 'react';

import {cn} from '@/lib/utils';

const Textarea = React.forwardRef<HTMLTextAreaElement, React.ComponentProps<'textarea'>>(
  ({className, ...props}, ref) => {
    return (
      <textarea
        className={cn(
          'flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm',
          className
        )}
        ref={ref}
        {...props}
      />
    );
  }
);
Textarea.displayName = 'Textarea';

export {Textarea};


// ==== FILE: src\components\ui\toast.tsx ====
"use client"

import * as React from "react"
import * as ToastPrimitives from "@radix-ui/react-toast"
import { cva, type VariantProps } from "class-variance-authority"
import { X } from "lucide-react"

import { cn } from "@/lib/utils"

const ToastProvider = ToastPrimitives.Provider

const ToastViewport = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Viewport>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Viewport
    ref={ref}
    className={cn(
      "fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]",
      className
    )}
    {...props}
  />
))
ToastViewport.displayName = ToastPrimitives.Viewport.displayName

const toastVariants = cva(
  "group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full",
  {
    variants: {
      variant: {
        default: "border bg-background text-foreground",
        destructive:
          "destructive group border-destructive bg-destructive text-destructive-foreground",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

const Toast = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Root>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &
    VariantProps<typeof toastVariants>
>(({ className, variant, ...props }, ref) => {
  return (
    <ToastPrimitives.Root
      ref={ref}
      className={cn(toastVariants({ variant }), className)}
      {...props}
    />
  )
})
Toast.displayName = ToastPrimitives.Root.displayName

const ToastAction = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Action>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Action
    ref={ref}
    className={cn(
      "inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive",
      className
    )}
    {...props}
  />
))
ToastAction.displayName = ToastPrimitives.Action.displayName

const ToastClose = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Close>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Close
    ref={ref}
    className={cn(
      "absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600",
      className
    )}
    toast-close=""
    {...props}
  >
    <X className="h-4 w-4" />
  </ToastPrimitives.Close>
))
ToastClose.displayName = ToastPrimitives.Close.displayName

const ToastTitle = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Title>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Title
    ref={ref}
    className={cn("text-sm font-semibold", className)}
    {...props}
  />
))
ToastTitle.displayName = ToastPrimitives.Title.displayName

const ToastDescription = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Description>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Description
    ref={ref}
    className={cn("text-sm opacity-90", className)}
    {...props}
  />
))
ToastDescription.displayName = ToastPrimitives.Description.displayName

type ToastProps = React.ComponentPropsWithoutRef<typeof Toast>

type ToastActionElement = React.ReactElement<typeof ToastAction>

export {
  type ToastProps,
  type ToastActionElement,
  ToastProvider,
  ToastViewport,
  Toast,
  ToastTitle,
  ToastDescription,
  ToastClose,
  ToastAction,
}


// ==== FILE: src\components\ui\toaster.tsx ====
"use client"

import { useToast } from "@/hooks/use-toast"
import {
  Toast,
  ToastClose,
  ToastDescription,
  ToastProvider,
  ToastTitle,
  ToastViewport,
} from "@/components/ui/toast"

export function Toaster() {
  const { toasts } = useToast()

  return (
    <ToastProvider>
      {toasts.map(function ({ id, title, description, action, ...props }) {
        return (
          <Toast key={id} {...props}>
            <div className="grid gap-1">
              {title && <ToastTitle>{title}</ToastTitle>}
              {description && (
                <ToastDescription>{description}</ToastDescription>
              )}
            </div>
            {action}
            <ToastClose />
          </Toast>
        )
      })}
      <ToastViewport />
    </ToastProvider>
  )
}


// ==== FILE: src\components\ui\tooltip.tsx ====
"use client"

import * as React from "react"
import * as TooltipPrimitive from "@radix-ui/react-tooltip"

import { cn } from "@/lib/utils"

const TooltipProvider = TooltipPrimitive.Provider

const Tooltip = TooltipPrimitive.Root

const TooltipTrigger = TooltipPrimitive.Trigger

const TooltipContent = React.forwardRef<
  React.ElementRef<typeof TooltipPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>
>(({ className, sideOffset = 4, ...props }, ref) => (
  <TooltipPrimitive.Content
    ref={ref}
    sideOffset={sideOffset}
    className={cn(
      "z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
      className
    )}
    {...props}
  />
))
TooltipContent.displayName = TooltipPrimitive.Content.displayName

export { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }


// ==== FILE: src\config\apiRolesMatrix.ts ====
// Single source of truth for API RBAC
// NOTE: Do not import Node-specific modules here; keep this file isomorphic.

export type Role =
  | 'public'
  | 'subscriber'
  | 'contributor'
  | 'author'
  | 'editor'
  | 'seo_editor'
  | 'seo_manager'
  | 'administrator'

export type AccessLevel = 'read' | 'write' | 'delete' | 'moderate'

export interface EndpointAccess {
  path: string
  method: 'GET' | 'POST' | 'PATCH' | 'PUT' | 'DELETE'
  roles: Partial<Record<Role, AccessLevel[]>>
  // Optional notes for caveats like "own posts only" or "draft only"
  note?: string
}

// Helper to mark allow with specific actions for multiple roles
const allow = (
  roles: Role[],
  actions: AccessLevel[]
): Partial<Record<Role, AccessLevel[]>> => {
  return roles.reduce((acc, r) => {
    acc[r] = actions
    return acc
  }, {} as Partial<Record<Role, AccessLevel[]>>)
}

export const apiRolesMatrix: EndpointAccess[] = [
  // Auth
  {
    path: '/api/auth/login',
    method: 'POST',
    roles: allow(
      [
        'public',
        'subscriber',
        'contributor',
        'author',
        'editor',
        'seo_editor',
        'seo_manager',
        'administrator',
      ],
      ['write']
    ),
  },
  {
    path: '/api/auth/logout',
    method: 'POST',
    roles: allow(
      [
        'public',
        'subscriber',
        'contributor',
        'author',
        'editor',
        'seo_editor',
        'seo_manager',
        'administrator',
      ],
      ['write']
    ),
  },
  {
    path: '/api/auth/logout',
    method: 'GET',
    roles: allow(
      [
        'public',
        'subscriber',
        'contributor',
        'author',
        'editor',
        'seo_editor',
        'seo_manager',
        'administrator',
      ],
      ['write']
    ),
  },
  {
    path: '/api/auth/me',
    method: 'GET',
    roles: allow(
      [
        'subscriber',
        'contributor',
        'author',
        'editor',
        'seo_editor',
        'seo_manager',
        'administrator',
      ],
      ['read']
    ),
  },
  {
    path: '/api/auth/register',
    method: 'POST',
    roles: allow(
      [
        'public',
        'subscriber',
        'contributor',
        'author',
        'editor',
        'seo_editor',
        'seo_manager',
        'administrator',
      ],
      ['write']
    ),
  },

  // Users
  {
    path: '/api/wp/users',
    method: 'GET',
    roles: allow(['administrator'], ['read']),
  },
  {
    path: '/api/wp/users/[slug]',
    method: 'GET',
    roles: allow(
      [
        'public',
        'subscriber',
        'contributor',
        'author',
        'editor',
        'seo_editor',
        'seo_manager',
        'administrator',
      ],
      ['read']
    ),
  },
  {
    path: '/api/wp/users/me',
    method: 'GET',
    roles: allow(
      [
        'subscriber',
        'contributor',
        'author',
        'editor',
        'seo_editor',
        'seo_manager',
        'administrator',
      ],
      ['read']
    ),
  },
  {
    path: '/api/wp/users/avatar',
    method: 'GET',
    roles: allow(
      [
        'public',
        'subscriber',
        'contributor',
        'author',
        'editor',
        'seo_editor',
        'seo_manager',
        'administrator',
      ],
      ['read']
    ),
  },

  // Posts
  {
    path: '/api/wp/posts',
    method: 'GET',
    roles: allow(
      [
        'public',
        'subscriber',
        'contributor',
        'author',
        'editor',
        'seo_editor',
        'seo_manager',
        'administrator',
      ],
      ['read']
    ),
  },
  {
    path: '/api/wp/posts',
    method: 'POST',
    roles: {
      ...allow(['contributor', 'author', 'editor', 'seo_editor', 'seo_manager', 'administrator'], ['write']),
    },
    note: 'Contributors: draft only; Authors: own posts',
  },
  {
  path: '/api/wp/posts',
    method: 'PATCH',
    roles: allow(['author', 'editor', 'seo_editor', 'seo_manager', 'administrator'], ['write']),
  note: 'Authors: own posts only; accepts ?id= query',
  },
  {
    path: '/api/wp/posts/[id]',
    method: 'DELETE',
    roles: allow(['administrator'], ['delete']),
  },
  {
    path: '/api/wp/posts/[id]/revisions',
    method: 'GET',
    roles: allow(['editor', 'seo_editor', 'seo_manager', 'administrator'], ['read']),
  },

  // Comments
  {
    path: '/api/wp/comments',
    method: 'GET',
    roles: allow(
      [
        'public',
        'subscriber',
        'contributor',
        'author',
        'editor',
        'seo_editor',
        'seo_manager',
        'administrator',
      ],
      ['read']
    ),
  },
  {
    path: '/api/wp/comments',
    method: 'POST',
    roles: allow(['subscriber', 'contributor', 'author', 'editor', 'seo_editor', 'seo_manager', 'administrator'], ['write']),
  },
  {
    path: '/api/wp/comments/[id]',
    method: 'PATCH',
    roles: allow(['editor', 'administrator'], ['moderate']),
  },
  {
    path: '/api/wp/comments/[id]',
    method: 'DELETE',
    roles: allow(['administrator'], ['delete']),
  },

  // Media
  {
    path: '/api/wp/media/list',
    method: 'GET',
    roles: allow(
      [
        'public',
        'subscriber',
        'contributor',
        'author',
        'editor',
        'seo_editor',
        'seo_manager',
        'administrator',
      ],
      ['read']
    ),
  },
  {
    path: '/api/wp/media',
    method: 'POST',
    roles: allow(['author', 'editor', 'seo_editor', 'seo_manager', 'administrator'], ['write']),
  },
  {
    path: '/api/wp/media/[id]',
    method: 'PATCH',
    roles: allow(['author', 'editor', 'seo_editor', 'seo_manager', 'administrator'], ['write']),
    note: 'Authors: own media only',
  },
  {
    path: '/api/wp/media/[id]',
    method: 'DELETE',
    roles: allow(['administrator'], ['delete']),
  },

  // Taxonomies (read-only)
  {
    path: '/api/wp/categories',
    method: 'GET',
    roles: allow(
      [
        'public',
        'subscriber',
        'contributor',
        'author',
        'editor',
        'seo_editor',
        'seo_manager',
        'administrator',
      ],
      ['read']
    ),
  },
  {
    path: '/api/wp/categories',
    method: 'POST',
    roles: allow(['contributor', 'author', 'editor', 'administrator'], ['write']),
  },
  {
    path: '/api/wp/tags',
    method: 'GET',
    roles: allow(
      [
        'public',
        'subscriber',
        'contributor',
        'author',
        'editor',
        'seo_editor',
        'seo_manager',
        'administrator',
      ],
      ['read']
    ),
  },
  {
    path: '/api/wp/tags',
    method: 'POST',
    roles: allow(['contributor', 'author', 'editor', 'administrator'], ['write']),
  },
  {
    path: '/api/wp/tags/resolve',
    method: 'POST',
    roles: allow(['contributor', 'author', 'editor', 'administrator'], ['write']),
  },

  // Admin / Site Settings (admin only)
  {
    path: '/api/admin',
    method: 'GET',
    roles: allow(['administrator'], ['read']),
  },
  {
    path: '/api/wp/settings',
    method: 'GET',
    roles: allow(['administrator'], ['read']),
  },
  {
    path: '/api/wp/settings',
    method: 'PATCH',
    roles: allow(['administrator'], ['write']),
  },

  // CSRF
  { path: '/api/csrf', method: 'GET', roles: allow(['public', 'subscriber', 'contributor', 'author', 'editor', 'seo_editor', 'seo_manager', 'administrator'], ['read']) },

  // Media cache proxy
  { path: '/api/media-cache', method: 'GET', roles: allow(['public', 'subscriber', 'contributor', 'author', 'editor', 'seo_editor', 'seo_manager', 'administrator'], ['read']) },
  { path: '/api/media-cache/image', method: 'GET', roles: allow(['public', 'subscriber', 'contributor', 'author', 'editor', 'seo_editor', 'seo_manager', 'administrator'], ['read']) },

  // Revalidate (admin only)
  { path: '/api/revalidate', method: 'POST', roles: allow(['administrator'], ['write']) },

  // Test WP (lock down by default)
  { path: '/api/test-wp', method: 'GET', roles: allow(['administrator'], ['read']) },

  // WP helpers
  { path: '/api/wp/search', method: 'GET', roles: allow(['public', 'subscriber', 'contributor', 'author', 'editor', 'seo_editor', 'seo_manager', 'administrator'], ['read']) },
  { path: '/api/wp/related', method: 'GET', roles: allow(['public', 'subscriber', 'contributor', 'author', 'editor', 'seo_editor', 'seo_manager', 'administrator'], ['read']) },
  { path: '/api/wp/popular', method: 'GET', roles: allow(['public', 'subscriber', 'contributor', 'author', 'editor', 'seo_editor', 'seo_manager', 'administrator'], ['read']) },
  { path: '/api/wp/media/[...slug]', method: 'GET', roles: allow(['public', 'subscriber', 'contributor', 'author', 'editor', 'seo_editor', 'seo_manager', 'administrator'], ['read']) },

  // User self updates
  { path: '/api/wp/users/avatar', method: 'POST', roles: allow(['subscriber', 'contributor', 'author', 'editor', 'seo_editor', 'seo_manager', 'administrator'], ['write']) },
  { path: '/api/wp/users/me', method: 'POST', roles: allow(['subscriber', 'contributor', 'author', 'editor', 'seo_editor', 'seo_manager', 'administrator'], ['write']) },
  { path: '/api/wp/users/me', method: 'PUT', roles: allow(['subscriber', 'contributor', 'author', 'editor', 'seo_editor', 'seo_manager', 'administrator'], ['write']) },

  // Analytics (read for editorial + SEO + admin)
  { path: '/api/analytics/check', method: 'GET', roles: allow(['editor', 'seo_editor', 'seo_manager', 'administrator'], ['read']) },
  { path: '/api/analytics/countries', method: 'GET', roles: allow(['editor', 'seo_editor', 'seo_manager', 'administrator'], ['read']) },
  { path: '/api/analytics/devices', method: 'GET', roles: allow(['editor', 'seo_editor', 'seo_manager', 'administrator'], ['read']) },
  { path: '/api/analytics/export', method: 'GET', roles: allow(['editor', 'seo_editor', 'seo_manager', 'administrator'], ['read']) },
  { path: '/api/analytics/referers', method: 'GET', roles: allow(['editor', 'seo_editor', 'seo_manager', 'administrator'], ['read']) },
  { path: '/api/analytics/sessions', method: 'GET', roles: allow(['editor', 'seo_editor', 'seo_manager', 'administrator'], ['read']) },
  { path: '/api/analytics/summary', method: 'GET', roles: allow(['editor', 'seo_editor', 'seo_manager', 'administrator'], ['read']) },
  { path: '/api/analytics/top-posts', method: 'GET', roles: allow(['editor', 'seo_editor', 'seo_manager', 'administrator'], ['read']) },
  { path: '/api/analytics/views', method: 'GET', roles: allow(['editor', 'seo_editor', 'seo_manager', 'administrator'], ['read']) },

  // Plugins & Themes (admin only)
  {
    path: '/api/wp/themes',
    method: 'GET',
    roles: allow(['administrator'], ['read']),
  },
  {
    path: '/api/wp/plugins',
    method: 'GET',
    roles: allow(['administrator'], ['read']),
  },
  {
    path: '/api/wp/plugins/[id]',
    method: 'POST',
    roles: allow(['administrator'], ['write']),
    note: 'Activate/Deactivate',
  },

  // Site Health (admin only)
  {
    path: '/api/wp/site-health/background-updates',
    method: 'GET',
    roles: allow(['administrator'], ['read']),
  },
  {
    path: '/api/wp/site-health/directory-sizes',
    method: 'GET',
    roles: allow(['administrator'], ['read']),
  },

  // SEO Tools
  {
    path: '/yoast/v1/get_head',
    method: 'GET',
    roles: allow(
      [
        'public',
        'subscriber',
        'contributor',
        'author',
        'editor',
        'seo_editor',
        'seo_manager',
        'administrator',
      ],
      ['read']
    ),
  },
  {
    path: '/yoast/v1/semrush/related_keyphrases',
    method: 'GET',
    roles: allow(['seo_editor', 'seo_manager', 'administrator'], ['read']),
  },
  {
    path: '/yoast/v1/indexing/posts',
    method: 'POST',
    roles: allow(['seo_manager', 'administrator'], ['write']),
  },
  {
    path: '/google-site-kit/v1/...',
    method: 'GET',
    roles: allow(['seo_manager', 'administrator'], ['read']),
  },

  // Misc (MU)
  {
    path: '/api/wp/track-view',
    method: 'POST',
    roles: allow(['subscriber', 'contributor', 'author', 'editor', 'seo_editor', 'seo_manager', 'administrator'], ['write']),
  },
  {
    path: '/api/wp/bookmarks',
    method: 'GET',
    roles: allow(['subscriber', 'contributor', 'author', 'editor', 'seo_editor', 'seo_manager', 'administrator'], ['read']),
  },
  {
    path: '/api/wp/bookmarks',
    method: 'POST',
    roles: allow(['subscriber', 'contributor', 'author', 'editor', 'seo_editor', 'seo_manager', 'administrator'], ['write']),
  },

  // Site Utilities (public)
  { path: '/robots.txt', method: 'GET', roles: allow(['public', 'subscriber', 'contributor', 'author', 'editor', 'seo_editor', 'seo_manager', 'administrator'], ['read']) },
  { path: '/sitemap.xml', method: 'GET', roles: allow(['public', 'subscriber', 'contributor', 'author', 'editor', 'seo_editor', 'seo_manager', 'administrator'], ['read']) },
  // Diagnostics (lock down by default)
  { path: '/api/_debug', method: 'GET', roles: allow(['administrator'], ['read']) },
  { path: '/api/test', method: 'GET', roles: allow(['administrator'], ['read']) },
]

export default apiRolesMatrix


// ==== FILE: src\contexts\auth-context.tsx ====
"use client"

import React, { createContext, useContext, useEffect, useState } from 'react'

interface User {
  id: string
  username: string
  email: string
  displayName: string
  url?: string
  website?: string
  // Canonical container coming from WP via FE Auth Bridge
  profile_fields?: Record<string, string>
  // Legacy fallback
  meta?: Record<string, string>
}

interface AuthContextType {
  user: User | null
  isLoading: boolean
  login: (credentials: { identifier: string; password: string }) => Promise<void>
  logout: () => Promise<void>
  checkAuth: () => Promise<void>
}

const AuthContext = createContext<AuthContextType | undefined>(undefined)

export function useAuth() {
  // Soft guard: return a no-op context if not wrapped to avoid runtime crashes
  const context = useContext(AuthContext)
  if (context === undefined) {
    return {
      user: null,
      isLoading: false,
      login: async () => {},
      logout: async () => {},
      checkAuth: async () => {},
    }
  }
  return context
}

export function AuthProvider({ children }: { children: React.ReactNode }) {
  const [user, setUser] = useState<User | null>(null)
  const [isLoading, setIsLoading] = useState(true)

  const checkAuth = async () => {
    try {
      const res = await fetch('/api/auth/me')
      if (res.ok) {
        const data = await res.json()
        const u = data?.user || null
        // Normalize profile_fields (preferred) or meta (fallback) to Record<string,string>
        const normalize = (obj: any) => {
          const out: Record<string, string> = {}
          try {
            Object.entries(obj || {}).forEach(([k, v]) => {
              if (v == null) return
              if (Array.isArray(v)) {
                const val = v.find((x) => typeof x === 'string' && x.trim()) as string | undefined
                if (val) out[k] = val
              } else if (typeof v === 'string') {
                out[k] = v
              } else if (typeof v === 'number' || typeof v === 'boolean') {
                out[k] = String(v)
              }
            })
          } catch {}
          return out
        }
        if (u) {
          if (u.profile_fields && typeof u.profile_fields === 'object') {
            u.profile_fields = normalize(u.profile_fields)
          } else if (u.meta && typeof u.meta === 'object') {
            // migration path: surface old meta as profile_fields for consumers
            u.profile_fields = normalize(u.meta)
          }
        }
        setUser(u)
      } else {
        setUser(null)
      }
    } catch (error) {
      console.error('Auth check failed:', error)
      setUser(null)
    } finally {
      setIsLoading(false)
    }
  }

  const login = async (credentials: { identifier: string; password: string }) => {
    const res = await fetch('/api/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(credentials),
    })

    if (!res.ok) {
      const error = await res.json()
      throw new Error(error.message || 'Login failed')
    }

    const data = await res.json()
    setUser(data.user)
  }

  const logout = async () => {
    try {
      await fetch('/api/auth/logout', { method: 'POST' })
    } catch (error) {
      console.error('Logout failed:', error)
    } finally {
      setUser(null)
    }
  }

  useEffect(() => {
    checkAuth()
  }, [])

  const value: AuthContextType = {
    user,
    isLoading,
    login,
    logout,
    checkAuth,
  }

  return (
    <AuthContext.Provider value={value}>
      {children}
    </AuthContext.Provider>
  )
}


// ==== FILE: src\contexts\metrics-context.tsx ====
"use client"
import React, { createContext, useCallback, useContext, useEffect, useMemo, useRef, useState } from 'react'

export type Metric = {
  id: number
  name: string
  formula: string
  chart_type: 'line' | 'bar' | 'area' | string
  pinned?: boolean
  status?: 'ok' | 'error' | string
}

export type MetricEval = {
  status: 'ok' | 'error'
  result?: { current?: number; timeseries?: { date: string; value: number }[] }
  message?: string
}

export type SessionSummary = {
  count: number
  avg_duration: number
  by_device: { device_type: string; count: number }[]
}

export type SessionTS = { date: string; sessions: number; avg_duration: number }

type PresenceEvent = { user: { id: number | string; name?: string; device?: string } }
type StreamEvent =
  | { event: 'session_start'; user_id: number; page: string }
  | { event: 'session_end'; user_id: number; duration: number }
  | { event: 'presence'; user: PresenceEvent['user'] }

type Ctx = {
  metrics: Metric[]
  refreshMetrics: () => Promise<void>
  evals: Record<number, MetricEval>
  evalMetric: (id: number) => Promise<void>
  sessionSummary: SessionSummary | null
  sessionTS: SessionTS[]
  presences: PresenceEvent['user'][]
  error?: string
}

const MetricsCtx = createContext<Ctx | undefined>(undefined)

export function useMetrics() {
  const v = useContext(MetricsCtx)
  if (!v) throw new Error('useMetrics must be used within MetricsProvider')
  return v
}

export function MetricsProvider({ children }: { children: React.ReactNode }) {
  const [metrics, setMetrics] = useState<Metric[]>([])
  const [evals, setEvals] = useState<Record<number, MetricEval>>({})
  const [sessionSummary, setSessionSummary] = useState<SessionSummary | null>(null)
  const [sessionTS, setSessionTS] = useState<SessionTS[]>([])
  const [presences, setPresences] = useState<PresenceEvent['user'][]>([])
  const [error, setError] = useState<string | undefined>()

  const pollTimer = useRef<number | null>(null)
  const sseRef = useRef<EventSource | null>(null)

  const refreshMetrics = useCallback(async () => {
    try {
      const r = await fetch('/api/metrics', { cache: 'no-store' })
      if (!r.ok) throw new Error('Failed to load metrics')
      const list: Metric[] = await r.json()
      setMetrics(list)
    } catch (e: any) {
      setError(e?.message || 'Failed to load metrics')
    }
  }, [])

  const evalMetric = useCallback(async (id: number) => {
    try {
      const r = await fetch(`/api/metrics/${id}/eval`, { cache: 'no-store' })
      if (!r.ok) throw new Error('Eval failed')
      const data: MetricEval = await r.json()
      setEvals((prev) => ({ ...prev, [id]: data }))
    } catch (e: any) {
      setEvals((prev) => ({ ...prev, [id]: { status: 'error', message: e?.message || 'Eval failed' } }))
    }
  }, [])

  const loadSessions = useCallback(async () => {
    try {
      const [sumR, tsR] = await Promise.all([
        fetch('/api/analytics/sessions/summary', { cache: 'no-store' }),
        fetch('/api/analytics/sessions/timeseries', { cache: 'no-store' }),
      ])
      if (sumR.ok) setSessionSummary(await sumR.json())
      if (tsR.ok) setSessionTS(await tsR.json())
    } catch (e) {
      // ignore
    }
  }, [])

  useEffect(() => {
    refreshMetrics()
    loadSessions()
    // poll metrics every 15s
    pollTimer.current = window.setInterval(() => {
      refreshMetrics()
    }, 15_000) as unknown as number
    return () => {
      if (pollTimer.current) window.clearInterval(pollTimer.current)
    }
  }, [refreshMetrics, loadSessions])

  useEffect(() => {
    // SSE for sessions + presence
    try {
      const es = new EventSource('/api/analytics/stream')
      sseRef.current = es
      es.onmessage = (ev) => {
        try {
          const data: StreamEvent = JSON.parse(ev.data)
          if (data.event === 'presence' && data.user) {
            setPresences((prev) => {
              const filtered = prev.filter((p) => String(p.id) !== String(data.user.id))
              return [...filtered, data.user]
            })
          }
          if (data.event === 'session_start' || data.event === 'session_end') {
            // light refresh on events
            loadSessions()
          }
        } catch {}
      }
      es.onerror = () => {
        // Autoreconnect handled by EventSource when reloaded; onerror we can close and retry later
        es.close()
        sseRef.current = null
      }
    } catch {}
    return () => {
      sseRef.current?.close()
      sseRef.current = null
    }
  }, [loadSessions])

  const value = useMemo<Ctx>(() => ({
    metrics,
    refreshMetrics,
    evals,
    evalMetric,
    sessionSummary,
    sessionTS,
    presences,
    error,
  }), [metrics, evals, sessionSummary, sessionTS, presences, error, refreshMetrics, evalMetric])

  return <MetricsCtx.Provider value={value}>{children}</MetricsCtx.Provider>
}


// ==== FILE: src\data\dummy-posts.ts ====

export type Post = {
  id: string;
  title: string;
  author: string;
  avatar: string;
  imageUrl: string;
  imageHint: string;
  excerpt: string;
  slug: string;
  date: string;
};

export const dummyPosts: Post[] = [
  {
    id: "1",
    title: "The Future of AI in Web Development",
    author: "Jane Doe",
    avatar: "https://i.pravatar.cc/150?u=a042581f4e29026704d",
    imageUrl: "https://picsum.photos/800/600?random=1",
    imageHint: "AI technology",
    excerpt: "Discover how artificial intelligence is revolutionizing the way we build and interact with websites.",
    slug: "future-of-ai-in-web-dev",
    date: "2024-07-28",
  },
  {
    id: "2",
    title: "A Deep Dive into React Server Components",
    author: "John Smith",
    avatar: "https://i.pravatar.cc/150?u=a042581f4e29026705d",
    imageUrl: "https://picsum.photos/800/600?random=2",
    imageHint: "server code",
    excerpt: "Exploring the latest advancements in React and how server components are changing the game.",
    slug: "react-server-components-deep-dive",
    date: "2024-07-27",
  },
  {
    id: "3",
    title: "Mastering Tailwind CSS for Modern UIs",
    author: "Emily White",
    avatar: "https://i.pravatar.cc/150?u=a042581f4e29026706d",
    imageUrl: "https://picsum.photos/800/600?random=3",
    imageHint: "modern design",
    excerpt: "Tips and tricks for leveraging Tailwind CSS to create beautiful and responsive user interfaces.",
    slug: "mastering-tailwind-css",
    date: "2024-07-26",
  },
  {
    id: "4",
    title: "Getting Started with Next.js 14",
    author: "Chris Green",
    avatar: "https://i.pravatar.cc/150?u=a042581f4e29026707d",
    imageUrl: "https://picsum.photos/800/600?random=4",
    imageHint: "web framework",
    excerpt: "A comprehensive guide to setting up your first project with the latest version of Next.js.",
    slug: "getting-started-with-nextjs-14",
    date: "2024-07-25",
  },
  {
    id: "5",
    title: "The Rise of Genkit for AI Applications",
    author: "Sarah Brown",
    avatar: "https://i.pravatar.cc/150?u=a042581f4e29026708d",
    imageUrl: "https://picsum.photos/800/600?random=5",
    imageHint: "AI development",
    excerpt: "An overview of Genkit and how it simplifies building powerful, production-ready AI apps.",
    slug: "rise-of-genkit",
    date: "2024-07-24",
  },
  {
    id: "6",
    title: "Optimizing Your Site for Core Web Vitals",
    author: "Michael Black",
    avatar: "https://i.pravatar.cc/150?u=a042581f4e29026709d",
    imageUrl: "https://picsum.photos/800/600?random=6",
    imageHint: "website performance",
    excerpt: "Practical advice for improving your website's performance and user experience metrics.",
    slug: "optimizing-core-web-vitals",
    date: "2024-07-23",
  },
];


// ==== FILE: src\hooks\use-mobile.tsx ====
import * as React from "react"

const MOBILE_BREAKPOINT = 768

export function useIsMobile() {
  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined)

  React.useEffect(() => {
    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)
    const onChange = () => {
      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)
    }
    mql.addEventListener("change", onChange)
    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)
    return () => mql.removeEventListener("change", onChange)
  }, [])

  return !!isMobile
}


// ==== FILE: src\hooks\use-toast.ts ====
"use client"

// Inspired by react-hot-toast library
import * as React from "react"

import type {
  ToastActionElement,
  ToastProps,
} from "@/components/ui/toast"

const TOAST_LIMIT = 1
const TOAST_REMOVE_DELAY = 1000000

type ToasterToast = ToastProps & {
  id: string
  title?: React.ReactNode
  description?: React.ReactNode
  action?: ToastActionElement
}

const actionTypes = {
  ADD_TOAST: "ADD_TOAST",
  UPDATE_TOAST: "UPDATE_TOAST",
  DISMISS_TOAST: "DISMISS_TOAST",
  REMOVE_TOAST: "REMOVE_TOAST",
} as const

let count = 0

function genId() {
  count = (count + 1) % Number.MAX_SAFE_INTEGER
  return count.toString()
}

type ActionType = typeof actionTypes

type Action =
  | {
      type: ActionType["ADD_TOAST"]
      toast: ToasterToast
    }
  | {
      type: ActionType["UPDATE_TOAST"]
      toast: Partial<ToasterToast>
    }
  | {
      type: ActionType["DISMISS_TOAST"]
      toastId?: ToasterToast["id"]
    }
  | {
      type: ActionType["REMOVE_TOAST"]
      toastId?: ToasterToast["id"]
    }

interface State {
  toasts: ToasterToast[]
}

const toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()

const addToRemoveQueue = (toastId: string) => {
  if (toastTimeouts.has(toastId)) {
    return
  }

  const timeout = setTimeout(() => {
    toastTimeouts.delete(toastId)
    dispatch({
      type: "REMOVE_TOAST",
      toastId: toastId,
    })
  }, TOAST_REMOVE_DELAY)

  toastTimeouts.set(toastId, timeout)
}

export const reducer = (state: State, action: Action): State => {
  switch (action.type) {
    case "ADD_TOAST":
      return {
        ...state,
        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),
      }

    case "UPDATE_TOAST":
      return {
        ...state,
        toasts: state.toasts.map((t) =>
          t.id === action.toast.id ? { ...t, ...action.toast } : t
        ),
      }

    case "DISMISS_TOAST": {
      const { toastId } = action

      // ! Side effects ! - This could be extracted into a dismissToast() action,
      // but I'll keep it here for simplicity
      if (toastId) {
        addToRemoveQueue(toastId)
      } else {
        state.toasts.forEach((toast) => {
          addToRemoveQueue(toast.id)
        })
      }

      return {
        ...state,
        toasts: state.toasts.map((t) =>
          t.id === toastId || toastId === undefined
            ? {
                ...t,
                open: false,
              }
            : t
        ),
      }
    }
    case "REMOVE_TOAST":
      if (action.toastId === undefined) {
        return {
          ...state,
          toasts: [],
        }
      }
      return {
        ...state,
        toasts: state.toasts.filter((t) => t.id !== action.toastId),
      }
  }
}

const listeners: Array<(state: State) => void> = []

let memoryState: State = { toasts: [] }

function dispatch(action: Action) {
  memoryState = reducer(memoryState, action)
  listeners.forEach((listener) => {
    listener(memoryState)
  })
}

type Toast = Omit<ToasterToast, "id">

function toast({ ...props }: Toast) {
  const id = genId()

  const update = (props: ToasterToast) =>
    dispatch({
      type: "UPDATE_TOAST",
      toast: { ...props, id },
    })
  const dismiss = () => dispatch({ type: "DISMISS_TOAST", toastId: id })

  dispatch({
    type: "ADD_TOAST",
    toast: {
      ...props,
      id,
      open: true,
      onOpenChange: (open) => {
        if (!open) dismiss()
      },
    },
  })

  return {
    id: id,
    dismiss,
    update,
  }
}

function useToast() {
  const [state, setState] = React.useState<State>(memoryState)

  React.useEffect(() => {
    listeners.push(setState)
    return () => {
      const index = listeners.indexOf(setState)
      if (index > -1) {
        listeners.splice(index, 1)
      }
    }
  }, [state])

  return {
    ...state,
    toast,
    dismiss: (toastId?: string) => dispatch({ type: "DISMISS_TOAST", toastId }),
  }
}

export { useToast, toast }


// ==== FILE: src\hooks\useLayoutPersistence.ts ====
"use client"

export type RGLItem = { i: string; x: number; y: number; w: number; h: number; static?: boolean; minW?: number; minH?: number }

const fetcher = (url: string) => fetch(url, { cache: 'no-store' }).then(r => r.json())

export function useLayoutPersistence() {
  // last section helper
  const setLastSection = (s: string) => { try { localStorage.setItem('admin:lastSection', s) } catch {} }
  const getLastSection = (): string | null => { try { return localStorage.getItem('admin:lastSection') } catch { return null } }

  const loadLayout = async (section: string): Promise<RGLItem[] | null> => {
    try {
      const r = await fetch(`/api/metrics/layout?section=${encodeURIComponent(section)}`, { cache: 'no-store' })
      if (!r.ok) return null
      const j = await r.json()
      if (Array.isArray(j?.items)) return j.items as RGLItem[]
      if (Array.isArray(j)) return j as RGLItem[]
      return null
    } catch { return null }
  }

  const saveLayout = async (section: string, items: RGLItem[]) => {
    try {
      await fetch('/api/metrics/layout', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ section, items }),
      })
      setLastSection(section)
    } catch {}
  }

  const deleteLayout = async (section: string) => {
    try { await fetch(`/api/metrics/layout?section=${encodeURIComponent(section)}`, { method: 'DELETE' }) } catch {}
  }

  const setDefaultLayout = async (section: string, items: RGLItem[]) => {
    try {
      await fetch('/api/metrics/layout/default', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ section, items }) })
    } catch {}
  }

  return { loadLayout, saveLayout, deleteLayout, setDefaultLayout, getLastSection }
}


// ==== FILE: src\hooks\useRoleGate.tsx ====
"use client"
import { useEffect, useState } from 'react'

import { can as canAction, messageFor, Action } from '@/lib/roles'

type Me = { roles?: string[] } | null

export function useMe() {
  const [me, setMe] = useState<Me>(null)
  const [loading, setLoading] = useState(true)
  useEffect(() => {
    let cancelled = false
    const run = async () => {
      setLoading(true)
      try {
        const r = await fetch('/api/auth/me', { cache: 'no-store' })
        if (!cancelled) {
          if (r.ok) {
            try {
              const j = await r.json()
              // API returns { user } wrapper
              setMe((j && typeof j === 'object' && 'user' in j) ? (j as { user: Me }).user : (j as Me))
            } catch { setMe(null) }
          } else setMe(null)
        }
      } catch {
        if (!cancelled) setMe(null)
      } finally {
        if (!cancelled) setLoading(false)
      }
    }
    run()
    const onFocus = () => run()
  const onLogin = () => run()
    window.addEventListener('focus', onFocus)
    window.addEventListener('visibilitychange', onFocus)
  window.addEventListener('auth:login', onLogin as unknown as EventListener)
    return () => {
      cancelled = true
      window.removeEventListener('focus', onFocus)
      window.removeEventListener('visibilitychange', onFocus)
  window.removeEventListener('auth:login', onLogin as unknown as EventListener)
    }
  }, [])
  return { me, loading }
}

export function useRoleGate(action: Action) {
  const { me, loading } = useMe()
  const roles = me?.roles || null
  const allowed = canAction(roles, action)
  const reason = allowed ? '' : messageFor(roles, action)
  return { allowed, reason, loading, me }
}

type GateProps = React.PropsWithChildren<{
  action: Action
  as?: 'div' | 'span'
  className?: string
  disabledClassName?: string
  tooltip?: boolean
}>

export function RoleGate({ action, children, as = 'div', className, disabledClassName, tooltip = true }: GateProps) {
  const { allowed, reason, loading } = useRoleGate(action)
  const Cmp = as as keyof JSX.IntrinsicElements
  if (loading) return <Cmp className={className} aria-busy="true">{children}</Cmp>
  if (allowed) return <Cmp className={className}>{children}</Cmp>
  const merged = [className, disabledClassName || 'opacity-50 pointer-events-none select-none'].filter(Boolean).join(' ')
  return (
    <Cmp className={merged} aria-disabled="true" title={tooltip ? reason : undefined}>
      {children}
    </Cmp>
  )
}


// ==== FILE: src\hooks\useScrollSpy.ts ====
"use client"
import { useEffect, useMemo, useState } from 'react'

export type ActiveState = {
  activeId: string | null
  nearbyIds: Set<string>
  adjacentIds: Set<string>
}

export function useScrollSpy(
  ids: string[],
  options?: { rootMargin?: string; nearbyRange?: number; adjacentRange?: number }
) {
  const [state, setState] = useState<ActiveState>({ activeId: null, nearbyIds: new Set(), adjacentIds: new Set() })
  const nearbyRange = options?.nearbyRange ?? 1
  const adjacentRange = options?.adjacentRange ?? 2

  const idIndex = useMemo(() => {
    const map = new Map<string, number>()
    ids.forEach((id, i) => map.set(id, i))
    return map
  }, [ids])

  // Derive an offset from CSS variable --header-height with a small cushion.
  function getTopOffset(): number {
    try {
      const styles = getComputedStyle(document.documentElement)
      const header = parseInt(styles.getPropertyValue('--header-height') || '64', 10)
      return (isNaN(header) ? 64 : header) + 24
    } catch {
      return 88
    }
  }

  useEffect(() => {
    if (!ids.length) return
    const elements = ids
      .map((id) => document.getElementById(id))
      .filter(Boolean) as HTMLElement[]
    if (!elements.length) return

    let raf = 0
    let lastActive: string | null = null

    const compute = () => {
      raf = 0
      const offset = getTopOffset()
      let current: string | null = null
      for (const el of elements) {
        const top = el.getBoundingClientRect().top
        if (top - offset <= 0) current = el.id
        else break
      }
      // Fallbacks: top of page => first; bottom past last => last
      if (!current) current = elements[0].id
      const idx = idIndex.get(current) ?? 0
      const nearby = new Set<string>()
      const adjacent = new Set<string>()
      for (let i = Math.max(0, idx - nearbyRange); i <= Math.min(ids.length - 1, idx + nearbyRange); i++) {
        if (i !== idx) nearby.add(ids[i])
      }
      for (let i = Math.max(0, idx - adjacentRange); i <= Math.min(ids.length - 1, idx + adjacentRange); i++) {
        if (!nearby.has(ids[i]) && i !== idx) adjacent.add(ids[i])
      }
      if (current !== lastActive) {
        lastActive = current
        setState({ activeId: current, nearbyIds: nearby, adjacentIds: adjacent })
        // Update URL hash (without page jump)
        try {
          const url = new URL(window.location.href)
          url.hash = `#${current}`
          history.replaceState({}, '', url)
        } catch {}
      } else {
        // Still update nearby/adjacent to keep badges consistent
        setState((s) => ({ activeId: s.activeId, nearbyIds: nearby, adjacentIds: adjacent }))
      }
    }

    const onScroll = () => {
      if (raf) return
      raf = requestAnimationFrame(compute)
    }
    const onResize = () => {
      if (raf) cancelAnimationFrame(raf)
      raf = requestAnimationFrame(compute)
    }

    // Initial run after paint to avoid layout thrash
    raf = requestAnimationFrame(compute)
    window.addEventListener('scroll', onScroll, { passive: true })
    window.addEventListener('resize', onResize)
    return () => {
      if (raf) cancelAnimationFrame(raf)
      window.removeEventListener('scroll', onScroll)
      window.removeEventListener('resize', onResize)
    }
  }, [ids, idIndex, nearbyRange, adjacentRange])

  return state
}


// ==== FILE: src\hooks\useSSE.ts ====
"use client"
import { useEffect, useRef, useState } from 'react'

export type SessionsPayload = { sessions: { sessionsNow: number; timestamp: string }; presence: { userId: string; username: string; editingPostId?: number; lastSeen: string }[] }

export function useAnalyticsSSE() {
  const [data, setData] = useState<SessionsPayload | null>(null)
  const [error, setError] = useState<string | null>(null)
  const ref = useRef<EventSource | null>(null)

  useEffect(() => {
    let cancelled = false
    try {
      const es = new EventSource('/api/analytics/stream')
      ref.current = es
      es.onmessage = (e) => {
        try {
          const j = JSON.parse(e.data)
          if (!cancelled) setData(j)
        } catch {}
      }
      es.onerror = () => {
        setError('sse_error')
        es.close()
        ref.current = null
      }
    } catch (e: any) {
      setError(e?.message || 'sse_init_failed')
    }
    return () => { cancelled = true; ref.current?.close(); ref.current = null }
  }, [])

  // Fallback polling every 15s
  useEffect(() => {
    if (!error) return
    let timer: any = null
    const tick = async () => {
      try {
        const r = await fetch('/api/metrics', { cache: 'no-store' })
        // app-specific transform could happen here
        if (r.ok) {
          // leave as-is; caller can combine
        }
      } catch {}
    }
    timer = setInterval(tick, 15000)
    return () => { if (timer) clearInterval(timer) }
  }, [error])

  return { data, error }
}


// ==== FILE: src\lib\auth.ts ====
import { cookies } from 'next/headers'

import { verifySession } from './jwt'

export type User = {
  id: number
  username: string
  email: string
  roles: string[]
  display_name?: string
  wpUserId?: number
  // New canonical container from FE Auth Bridge plugin
  profile_fields?: Record<string, string>
  // Legacy: keep meta for backward compat; callers should prefer profile_fields
  meta?: Record<string, string>
}

const SESSION_COOKIE = process.env.SESSION_COOKIE_NAME ?? 'session'

export async function getSessionUser(): Promise<User | null> {
  const cookieStore = await cookies()
  const session = cookieStore.get(SESSION_COOKIE)
  if (!session?.value) return null
  try {
    const claims = await verifySession(session.value)
    const asObj = claims as Record<string, unknown>
    const idCandidate = typeof asObj.wpUserId === 'number' ? asObj.wpUserId : (Number.isFinite(Number((claims as { sub?: unknown }).sub)) ? Number((claims as { sub?: unknown }).sub) : -1)
    const user: User = {
      id: typeof idCandidate === 'number' ? idCandidate : -1,
      username: String((claims as { username?: unknown }).username || ''),
      email: String((claims as { email?: unknown }).email || ''),
      roles: Array.isArray((claims as { roles?: unknown }).roles) ? ((claims as { roles?: unknown }).roles as string[]) : [],
      display_name: typeof asObj.displayName === 'string' ? asObj.displayName : undefined,
      wpUserId: typeof asObj.wpUserId === 'number' ? asObj.wpUserId : undefined,
    }
    return user
  } catch {
    return null
  }
}

export async function requireRole(role: string) {
  const user = await getSessionUser()
  if (!user) {
  const e = new Error('Unauthorized') as Error & { status?: number }
    e.status = 401
    throw e
  }
  if (!user.roles || !user.roles.includes(role)) {
  const e = new Error('Forbidden') as Error & { status?: number }
    e.status = 403
    throw e
  }
  return user
}

export async function requireAnyRole(roles: string[]) {
  const user = await getSessionUser()
  if (!user) {
  const e = new Error('Unauthorized') as Error & { status?: number }
    e.status = 401
    throw e
  }
  if (!user.roles || !roles.some(r => user.roles.includes(r))) {
  const e = new Error('Forbidden') as Error & { status?: number }
    e.status = 403
    throw e
  }
  return user
}


// ==== FILE: src\lib\autolink.ts ====
// Simple auto-linker: given content HTML and a list of {phrase, href},
// link only the first occurrence of each phrase, skip if already inside a link.
export type AutoLinkTarget = { phrase: string; href: string }

export function autoLinkFirst(html: string, targets: AutoLinkTarget[]): string {
  if (!targets?.length || !html) return html
  let out = html
  for (const t of targets) {
    const phrase = (t.phrase || '').trim()
    const href = (t.href || '').trim()
    if (!phrase || !href) continue
    // Avoid matching inside existing <a> tags using a tempered dot regex
    const re = new RegExp(`(?![^<]*>)(${escapeRegExp(phrase)})`, 'i')
    out = out.replace(re, (m, g1) => `<a href="${href}" rel="noopener" target="_blank">${g1}</a>`)
  }
  return out
}

function escapeRegExp(s: string) {
  return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')
}


// ==== FILE: src\lib\checkAccess.ts ====
import { apiRolesMatrix, type AccessLevel, type Role } from '@/config/apiRolesMatrix'

export function checkAccess(
  role: Role,
  path: string,
  method: string,
  action: AccessLevel
): boolean {
  const methodUpper = method.toUpperCase()
  // Direct match first
  let endpoint = apiRolesMatrix.find((e) => e.path === path && e.method === (methodUpper as any))
  if (!endpoint) {
    // Try parameterized segments: replace [param] to match dynamic route
    endpoint = apiRolesMatrix.find((e) => {
      if (e.method !== (methodUpper as any)) return false
      const pattern = e.path
        .replace(/\//g, '\\/')
        .replace(/\[.+?\]/g, '[^/]+')
        .replace(/\.+/g, '.+')
      const re = new RegExp(`^${pattern}$`)
      return re.test(path)
    })
  }

  if (!endpoint) return false
  return endpoint.roles[role]?.includes(action) ?? false
}

export default checkAccess


// ==== FILE: src\lib\csrf.ts ====
import { cookies } from 'next/headers'

export const CSRF_COOKIE = 'csrf'

export function generateCsrfToken() {
  return cryptoRandom()
}

function cryptoRandom() {
  try {
    return Array.from(crypto.getRandomValues(new Uint8Array(32))).map(b => b.toString(16).padStart(2,'0')).join('')
  } catch (e) {
    // fallback
    return Math.random().toString(36).slice(2) + Date.now().toString(36)
  }
}

export function validateCsrf(headerToken?: string) {
  const cookieStore = (cookies() as any)
  const cookie = (cookieStore.get ? cookieStore.get(CSRF_COOKIE) : null)
  if (!cookie) return false
  if (!headerToken) return false
  return cookie.value === headerToken
}

export function validateCsrfFromRequest(req: Request, headerToken?: string) {
  try {
    const raw = req.headers.get('cookie') || ''
    if (!raw || !headerToken) return false
    const parts = raw.split(';').map(p => p.trim())
    const match = parts.find(p => p.startsWith(`${CSRF_COOKIE}=`))
    if (!match) return false
    const value = match.substring(CSRF_COOKIE.length + 1)
    return value === headerToken
  } catch {
    return false
  }
}


// ==== FILE: src\lib\entities.ts ====
export function decodeEntities(input: string): string {
  if (!input) return ''
  // Use a browser DOM element to decode standard entities on client
  if (typeof window !== 'undefined') {
    const txt = document.createElement('textarea')
    txt.innerHTML = input
    let out = txt.value
    // strip any still-unresolved entity like &and; or malformed
    out = out.replace(/&[a-zA-Z]+;|&#\d+;|&#x[0-9a-fA-F]+;/g, (m) => {
      // try decoding again; if unchanged, drop it
      txt.innerHTML = m
      const v = txt.value
      return v === m ? '' : v
    })
    return out
  }
  // On server, do a light decode for common entities
  const map: Record<string, string> = {
    '&amp;': '&', '&lt;': '<', '&gt;': '>', '&quot;': '"', '&#39;': "'", '&nbsp;': ' ',
  }
  return input.replace(/&[a-zA-Z#0-9]+;/g, (m) => (map[m] ?? ''))
}


// ==== FILE: src\lib\fetcher.ts ====
export type APIError = { status: number; message: string; details?: unknown }

// Don't throw at module load time; some build steps import this file when
// environment variables may not be present. Validate WP_URL at runtime in
// `wpFetch` so build-time data collection doesn't crash.
const WP_URL = process.env.WP_URL ?? ''

export async function apiFetch<T = unknown>(path: string, opts?: { method?: string; body?: unknown; headers?: Record<string,string>; credentials?: RequestCredentials }) : Promise<T> {
  let url = path
  if (!path.startsWith('http')) {
    if (typeof window !== 'undefined') {
      // In the browser, use relative URLs to avoid cross-origin issues in dev
      url = path
    } else {
      // On the server, build an absolute URL
      const base = (process.env.NEXT_PUBLIC_SITE_URL || process.env.SITE_URL || 'http://localhost:3000').replace(/\/$/, '')
      url = `${base}${path}`
    }
  }
  const res = await fetch(url, {
    method: opts?.method ?? 'GET',
    headers: {
      'content-type': opts?.body ? 'application/json' : 'application/json',
      ...(opts?.headers ?? {}),
    },
    body: opts?.body ? JSON.stringify(opts.body) : undefined,
    credentials: opts?.credentials ?? 'same-origin',
  })

  const contentType = res.headers.get('content-type') ?? ''
  let payload: unknown = undefined
  if (contentType.includes('application/json')) payload = await res.json()
  else payload = await res.text()

  if (!res.ok) {
    const msg = (payload && typeof payload === 'object' && 'message' in (payload as any)) ? (payload as any).message : res.statusText
    const err: APIError = { status: res.status, message: msg, details: payload }
    throw err
  }

  return payload as T
}

export const wpFetch = async <T = unknown>(wpPath: string, opts?: { method?: string; body?: unknown; cookie?: string }) => {
  if (!WP_URL) throw new Error('WP_URL env required')
  const url = wpPath.startsWith('http') ? wpPath : `${WP_URL.replace(/\/$/, '')}/${wpPath.replace(/^\//, '')}`
  const headers: Record<string,string> = { 'content-type': 'application/json' }
  if (opts?.cookie) headers['cookie'] = opts.cookie
  const res = await fetch(url, {
    method: opts?.method ?? 'GET',
    headers,
    body: opts?.body ? JSON.stringify(opts.body) : undefined,
  })
  const ct = res.headers.get('content-type') ?? ''
  const data = ct.includes('application/json') ? await res.json() : await res.text()
  if (!res.ok) {
    throw { status: res.status, message: (data && (data as any).message) ? (data as any).message : res.statusText, details: data } as APIError
  }
  return data as T
}


// ==== FILE: src\lib\fetchWithAuth.ts ====
import { verifySession } from '@/lib/jwt'

export class MissingWpTokenError extends Error {
  status = 401 as const
  constructor(message = 'Missing wpToken in session') {
    super(message)
    this.name = 'MissingWpTokenError'
  }
}

export async function getWpTokenFromRequest(req: Request): Promise<string | null> {
  const cookieHeader = req.headers.get('cookie') || ''
  const cookieName = process.env.SESSION_COOKIE_NAME || 'session'
  const match = cookieHeader.match(new RegExp(`${cookieName}=([^;]+)`))
  const token = match?.[1]
  if (!token) return null
  try {
    const claims = await verifySession(token)
    const wpToken = claims && typeof claims === 'object' && 'wpToken' in claims ? (claims as Record<string, unknown>).wpToken : null
    return typeof wpToken === 'string' ? wpToken : null
  } catch {
    return null
  }
}

export async function fetchWithAuth(reqOrToken: Request | string | null | undefined, url: string, init: RequestInit = {}) {
  let wpToken: string | null = null
  if (typeof reqOrToken === 'string') {
    wpToken = reqOrToken
  } else if (reqOrToken && typeof (reqOrToken as { headers?: unknown }).headers === 'object') {
    wpToken = await getWpTokenFromRequest(reqOrToken as Request)
  }
  if (!wpToken) throw new MissingWpTokenError()

  const headers = new Headers(init.headers as HeadersInit | undefined)
  headers.set('Authorization', `Bearer ${wpToken}`)
  // Some proxies may read cookie Authorization
  if (!headers.has('Cookie')) {
    headers.set('Cookie', `Authorization=Bearer ${wpToken}`)
  }

  // Honor caller-provided caching options. Default to no-store only if not provided.
  const finalInit: RequestInit & { next?: { revalidate?: number | false } } = { ...init, headers }
  if (finalInit.cache === undefined && finalInit.next === undefined) {
    finalInit.cache = 'no-store'
  }
  const res = await fetch(url, finalInit)
  // If upstream denies auth, return a structured JSON error instead of raw HTML/text
  if (res.status === 401 || res.status === 403) {
    let message = res.statusText || 'Unauthorized'
    try {
      const t = await res.text()
      const j = t ? JSON.parse(t) as unknown : null
      if (j && typeof j === 'object' && 'message' in j && typeof (j as { message?: unknown }).message === 'string') {
        message = (j as { message?: string }).message || message
      }
    } catch {
      // ignore parse errors
    }
    return new Response(JSON.stringify({ error: 'unauthorized', message }), { status: res.status, headers: { 'Content-Type': 'application/json' } })
  }
  const text = await res.text()
  return new Response(text, { status: res.status, headers: { 'Content-Type': res.headers.get('Content-Type') || 'application/json' } })
}


// ==== FILE: src\lib\generateSchema.ts ====
// Utility functions to generate JSON-LD schemas for SEO

export function getArticleSchema(post: any) {
  const slug = post.slug || post?.seo?.slug || post?.uri?.replace(/^\/?blog\//, '') || '';
  const title = post.title?.rendered || post.title || '';
  const description = (post.excerpt?.rendered || post.excerpt || '').replace(/<[^>]+>/g, "");
  const image = post.featuredImage?.node?.sourceUrl || post.featuredImage || "https://techoblivion.in/default-cover.jpg";
  const authorName = post.author?.node?.name || post.authorName || "tech.oblivion";
  const datePublished = post.date || post.publishedAt || undefined;
  const dateModified = post.modified || post.updatedAt || datePublished;
  return {
    "@context": "https://schema.org",
    "@type": "Article",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": `https://techoblivion.in/blog/${slug}`
    },
    "headline": title,
    "description": description,
    "image": image,
    "author": {
      "@type": "Person",
      "name": authorName
    },
    "publisher": {
      "@type": "Organization",
      "name": "tech.oblivion",
      "logo": {
        "@type": "ImageObject",
        "url": "https://techoblivion.in/logo.png"
      }
    },
    "datePublished": datePublished,
    "dateModified": dateModified
  };
}

export function getBreadcrumbSchema(post: any) {
  const slug = post.slug || post?.seo?.slug || post?.uri?.replace(/^\/?blog\//, '') || '';
  const title = post.title?.rendered || post.title || '';
  return {
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
      {
        "@type": "ListItem",
        "position": 1,
        "name": "Home",
        "item": "https://techoblivion.in/"
      },
      {
        "@type": "ListItem",
        "position": 2,
        "name": "Blog",
        "item": "https://techoblivion.in/blog"
      },
      {
        "@type": "ListItem",
        "position": 3,
        "name": title,
        "item": `https://techoblivion.in/blog/${slug}`
      }
    ]
  };
}

export function getFAQSchema(faqs: any[]) {
  if (!faqs?.length) return null;
  return {
    "@context": "https://schema.org",
    "@type": "FAQPage",
    "mainEntity": faqs.map((faq: any) => ({
      "@type": "Question",
      "name": faq.question,
      "acceptedAnswer": {
        "@type": "Answer",
        "text": faq.answer
      }
    }))
  };
}

export function getVideoSchema({ post, videoId, uploadDate }: { post: any, videoId: string, uploadDate: string }) {
  if (!videoId) return null;
  const title = post.title?.rendered || post.title || '';
  const description = (post.excerpt?.rendered || post.excerpt || '').replace(/<[^>]+>/g, "");
  const image = post.featuredImage?.node?.sourceUrl || post.featuredImage || "https://techoblivion.in/default-cover.jpg";
  return {
    "@context": "https://schema.org",
    "@type": "VideoObject",
    "name": title,
    "description": description,
    "thumbnailUrl": image,
    "uploadDate": uploadDate,
    "contentUrl": `https://www.youtube.com/watch?v=${videoId}`,
    "embedUrl": `https://www.youtube.com/embed/${videoId}`,
    "publisher": {
      "@type": "Organization",
      "name": "tech.oblivion",
      "logo": {
        "@type": "ImageObject",
        "url": "https://techoblivion.in/logo.png"
      }
    }
  };
}

export function getWebSiteSchema() {
  return {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "url": "https://techoblivion.in/",
    "name": "tech.oblivion",
    "publisher": {
      "@type": "Organization",
      "name": "tech.oblivion",
      "logo": {
        "@type": "ImageObject",
        "url": "https://techoblivion.in/logo.png"
      }
    },
    "potentialAction": {
      "@type": "SearchAction",
      "target": "https://techoblivion.in/?s={search_term_string}",
      "query-input": "required name=search_term_string"
    }
  };
}


// ==== FILE: src\lib\jwt.ts ====
import { SignJWT, jwtVerify } from 'jose'

const secret = new TextEncoder().encode(process.env.JWT_SECRET!)
const issuer = 'techoblivion-fe'
const audience = 'techoblivion-user'

export type SessionClaims = {
  sub: string // WP user ID
  username: string
  email: string
  roles: string[]
  displayName?: string
  wpUserId?: number
  // Server-only: WordPress JWT token for privileged proxy calls
  wpToken?: string
}

export async function signSession(claims: SessionClaims, maxAgeSec = 60 * 60 * 24 * 7) {
  return await new SignJWT(claims as any)
    .setProtectedHeader({ alg: 'HS256' })
    .setIssuedAt()
    .setIssuer(issuer)
    .setAudience(audience)
    .setExpirationTime(`${maxAgeSec}s`)
    .sign(secret)
}

export async function verifySession(token: string) {
  const { payload } = await jwtVerify(token, secret, { issuer, audience })
  return payload as unknown as SessionClaims
}


// ==== FILE: src\lib\log.ts ====
import { logger } from './logger'

export function logWPError(context: string, info: { status?: number; statusText?: string; body?: string }) {
  const entry = {
    context,
    status: info.status,
    statusText: info.statusText,
    bodySnippet: info.body ? (typeof info.body === 'string' ? info.body.slice(0, 2000) : String(info.body)) : undefined,
  }

  // Error-level for HTTP >=500 or explicit errors
  if (entry.status && entry.status >= 500) {
    logger.error(context, entry)
  } else if (entry.status && entry.status >= 400) {
    // client errors -> info
    logger.info(context, entry)
  } else {
    // otherwise debug
    logger.debug(context, entry)
  }
}

export default logWPError


// ==== FILE: src\lib\logger.ts ====
import fs from 'fs'
import path from 'path'

const LOG_DIR = path.join(process.cwd(), 'logs')
const DEBUG_FILE = path.join(LOG_DIR, 'debug.log')
const INFO_FILE = path.join(LOG_DIR, 'app.log')
const ERROR_FILE = path.join(LOG_DIR, 'error.log')

function ensureDir() {
  try {
    if (!fs.existsSync(LOG_DIR)) fs.mkdirSync(LOG_DIR, { recursive: true })
  } catch (e) {
    // ignore
  }
}

function write(file: string, entry: any) {
  try {
    ensureDir()
    fs.appendFileSync(file, JSON.stringify(entry) + '\n')
  } catch (e) {
    // swallow logging errors
  }
}

export const logger = {
  debug: (context: string, data: any) => {
    const entry = { ts: new Date().toISOString(), level: 'debug', context, data }
    // console.debug can be noisy; keep for local visibility
    // eslint-disable-next-line no-console
    console.debug('[DEBUG]', JSON.stringify(entry))
    write(DEBUG_FILE, entry)
  },
  info: (context: string, data: any) => {
    const entry = { ts: new Date().toISOString(), level: 'info', context, data }
    // eslint-disable-next-line no-console
    console.log('[LOG]', JSON.stringify(entry))
    write(INFO_FILE, entry)
  },
  error: (context: string, data: any) => {
    const entry = { ts: new Date().toISOString(), level: 'error', context, data }
    // eslint-disable-next-line no-console
    console.error('[ERROR]', JSON.stringify(entry))
    write(ERROR_FILE, entry)
  },
}

export default logger


// ==== FILE: src\lib\mediaCache.ts ====
import { promises as fs } from 'fs'
import path from 'path'
import crypto from 'crypto'

const PUBLIC_DIR = path.resolve(process.cwd(), 'public')
const CACHE_DIR = path.join(PUBLIC_DIR, 'media-cache')

function sha1(input: string) {
  return crypto.createHash('sha1').update(input).digest('hex')
}

function extFromContentType(ct?: string | null, fallbackUrl?: string) {
  const map: Record<string, string> = {
    'image/jpeg': 'jpg',
    'image/jpg': 'jpg',
    'image/png': 'png',
    'image/webp': 'webp',
    'image/gif': 'gif',
    'image/avif': 'avif',
    'image/svg+xml': 'svg',
  }
  const t = (ct || '').toLowerCase()
  if (map[t]) return map[t]
  // try from URL suffix
  try {
    const u = new URL(fallbackUrl || '')
    const m = u.pathname.match(/\.([a-zA-Z0-9]+)$/)
    if (m) return m[1].toLowerCase()
  } catch {}
  return 'img'
}

export async function cacheImage(url: string): Promise<string> {
  if (!/^https?:\/\//i.test(url)) throw new Error('Only absolute http(s) URLs allowed')
  await fs.mkdir(CACHE_DIR, { recursive: true })
  const key = sha1(url)
  // We'll store original ext if determinable; otherwise choose from content-type later
  let dest = ''
  // If any file exists with this key and any ext, return it
  const existing = await findExisting(key)
  if (existing) return `/media-cache/${existing}`

  const headers: Record<string, string> = {
    Accept: 'image/*,*/*;q=0.8',
    'User-Agent': 'techoblivion-media-cache/1.0',
  }
  try {
    const WP = process.env.WP_URL
    if (WP) {
      try {
        const wpHost = new URL(WP).host
        const u = new URL(url)
        if (u.host === wpHost) headers['Referer'] = WP
      } catch {}
    }
  } catch {}

  const res = await fetch(url, { cache: 'no-store', headers })
  if (!res.ok) throw new Error(`Upstream ${res.status}`)
  const ct = res.headers.get('content-type') || ''
  if (!ct.toLowerCase().startsWith('image/')) throw new Error(`Bad content-type ${ct}`)

  const ab = await res.arrayBuffer()
  const ext = extFromContentType(ct, url)
  const filename = `${key}.${ext}`
  dest = path.join(CACHE_DIR, filename)
  await fs.writeFile(dest, Buffer.from(ab))
  return `/media-cache/${filename}`
}

async function findExisting(key: string): Promise<string | null> {
  try {
    const entries = await fs.readdir(CACHE_DIR)
    const found = entries.find((f) => f.startsWith(key + '.'))
    return found || null
  } catch {
    return null
  }
}


// ==== FILE: src\lib\rbac.ts ====
import type { Role } from '@/config/apiRolesMatrix'

// Map arbitrary WP/user roles to apiRolesMatrix Role values; choose highest privilege
export function mapToApiRole(userRoles?: string[] | null): Role {
  if (!userRoles || userRoles.length === 0) return 'public'
  const norm = userRoles.map((r) => r.toLowerCase())
  const has = (s: string) => norm.includes(s)
  const priority: Role[] = [
    'administrator',
    'seo_manager',
    'editor',
    'seo_editor',
    'author',
    'contributor',
    'subscriber',
    'public',
  ]
  // Normalize some custom role labels
  const alias: Record<string, Role> = {
    admin: 'administrator',
    'seo manager': 'seo_manager',
    'seo_manager': 'seo_manager',
    'seo lead': 'seo_manager',
    'seo-editor': 'seo_editor',
    'seo editor': 'seo_editor',
    'seo_editor': 'seo_editor',
  }
  const resolved = new Set<Role>()
  for (const r of norm) {
    if (alias[r]) resolved.add(alias[r])
    else if (['administrator','editor','author','contributor','subscriber'].includes(r)) resolved.add(r as Role)
  }
  for (const p of priority) {
    if (resolved.has(p)) return p
  }
  return 'public'
}


// ==== FILE: src\lib\requireAccess.ts ====
import { getServerSessionClaims } from '@/lib/server-session'
import checkAccess from '@/lib/checkAccess'
import { mapToApiRole } from '@/lib/rbac'
import type { AccessLevel } from '@/config/apiRolesMatrix'

export async function requireAccess(opts: { path: string; method: string; action: AccessLevel }) {
  const claims = await getServerSessionClaims()
  const token = claims && typeof claims === 'object' && 'wpToken' in claims ? (claims as Record<string, unknown>).wpToken : null
  let roles: string[] | null = (claims && typeof claims === 'object' && 'roles' in claims && Array.isArray((claims as Record<string, unknown>).roles))
    ? ((claims as Record<string, unknown>).roles as string[])
    : null

  // Enrich roles from WordPress if we have a WP token
  if (typeof token === 'string' && token) {
    const wp = process.env.WP_URL || process.env.NEXT_PUBLIC_WP_URL
    if (wp) {
      try {
        const url = new URL('/wp-json/wp/v2/users/me', wp)
        url.searchParams.set('context', 'edit')
        const res = await fetch(url, { headers: { Authorization: `Bearer ${token}` }, cache: 'no-store' })
        if (res.ok) {
          const j = (await res.json()) as unknown
          if (j && typeof j === 'object' && 'roles' in j && Array.isArray((j as { roles?: unknown }).roles)) {
            const r = (j as { roles?: unknown }).roles as unknown
            roles = Array.isArray(r) ? (r as string[]) : roles
          }
        }
      } catch {
        // ignore network errors; fall back to token roles
      }
    }
  }
  const apiRole = mapToApiRole(roles)
  const ok = checkAccess(apiRole, opts.path, opts.method, opts.action)
  if (!ok) {
    const err = new Error('Forbidden') as Error & { status?: number }
    err.status = 403
    throw err
  }
}


// ==== FILE: src\lib\roles.ts ====
export type Action =
  | 'read'
  | 'bookmark'
  | 'comment'
  | 'draft'
  | 'requestPublish'
  | 'publishOwn'
  | 'editOthers'
  | 'moderateComments'
  | 'seoEdit'
  | 'seoManage'
  | 'admin'

type RoleKey =
  | 'guest'
  | 'reader'
  | 'writer'
  | 'author'
  | 'editor'
  | 'publisher'
  | 'seo_specialist'
  | 'seo_lead'
  | 'admin'

export type RoleConfig = {
  allowed: Set<Action>
  messages: Partial<Record<Action, string>> & { fallback?: string }
}

export const roleConfig: Record<RoleKey, RoleConfig> = {
  guest: {
    allowed: new Set<Action>(['read']),
    messages: {
      bookmark: 'Log in to bookmark.',
      comment: 'Log in to comment.',
      draft: 'Log in to write drafts.',
      fallback: 'Please log in to use this feature.',
    },
  },
  reader: {
    allowed: new Set<Action>(['read', 'bookmark', 'comment']),
    messages: {
      draft: 'Upgrade to Writer to draft posts.',
      fallback: 'This action requires a higher role.',
    },
  },
  writer: {
    allowed: new Set<Action>(['read', 'bookmark', 'comment', 'draft', 'requestPublish']),
    messages: {
      publishOwn: 'Editors handle publishing.',
      fallback: 'Ask an editor to publish or upgrade your role.',
    },
  },
  author: {
    allowed: new Set<Action>(['read', 'bookmark', 'comment', 'draft', 'requestPublish', 'publishOwn']),
    messages: {
      editOthers: 'You can publish your own posts only.',
      fallback: 'This action is limited to editors.',
    },
  },
  editor: {
    allowed: new Set<Action>(['read', 'bookmark', 'comment', 'draft', 'requestPublish', 'publishOwn', 'editOthers', 'moderateComments']),
    messages: {
      fallback: 'You have editor access.',
    },
  },
  publisher: {
    allowed: new Set<Action>(['read', 'bookmark', 'comment', 'draft', 'requestPublish', 'publishOwn', 'editOthers', 'moderateComments']),
    messages: { fallback: 'You can approve & publish others‚Äô posts.' },
  },
  seo_specialist: {
    allowed: new Set<Action>(['read', 'seoEdit']),
    messages: { publishOwn: 'Publishing is handled by editors.', fallback: 'SEO editing enabled.' },
  },
  seo_lead: {
    allowed: new Set<Action>(['read', 'seoEdit', 'seoManage']),
    messages: { publishOwn: 'Publishing is handled by editors.', fallback: 'SEO management enabled.' },
  },
  admin: {
    allowed: new Set<Action>(['read', 'bookmark', 'comment', 'draft', 'requestPublish', 'publishOwn', 'editOthers', 'moderateComments', 'seoEdit', 'seoManage', 'admin']),
    messages: { fallback: 'You have full access.' },
  },
}

// Map from WP roles to our RoleKey
const roleAlias: Record<string, RoleKey> = {
  anonymous: 'guest',
  guest: 'guest',
  subscriber: 'reader',
  reader: 'reader',
  contributor: 'writer',
  writer: 'writer',
  author: 'author',
  editor: 'editor',
  'seo-specialist': 'seo_specialist',
  'seo_lead': 'seo_lead',
  'seo-lead': 'seo_lead',
  administrator: 'admin',
  admin: 'admin',
  publisher: 'publisher',
}

export function normalizeRole(userRoles?: string[] | null): RoleKey {
  if (!userRoles || userRoles.length === 0) return 'guest'
  // Choose the highest-privileged role based on priority order
  const priority: RoleKey[] = ['admin','publisher','editor','author','writer','reader','seo_lead','seo_specialist','guest']
  // Normalize case before mapping; WP roles may come capitalized (e.g., 'Subscriber')
  const mapped = userRoles.map(r => roleAlias[r.toLowerCase?.() as any] || (r.toLowerCase?.() as RoleKey))
  for (const key of priority) {
    if (mapped.includes(key)) return key
  }
  return 'guest'
}

export function can(userRoles: string[] | null | undefined, action: Action): boolean {
  const role = normalizeRole(userRoles)
  return roleConfig[role].allowed.has(action)
}

export function messageFor(userRoles: string[] | null | undefined, action: Action): string {
  const role = normalizeRole(userRoles)
  const conf = roleConfig[role]
  return conf.messages[action] || conf.messages.fallback || 'Not permitted.'
}


// ==== FILE: src\lib\sanitize.ts ====
import sanitizeHtml from 'sanitize-html'

import { decodeEntities } from './text'

// Include heading tags so we can build TOC and preserve document structure
const baseAllowedTags = ['a','b','i','strong','em','p','ul','ol','li','br','blockquote','code','pre','h1','h2','h3','h4','h5','h6']
// Do NOT include 'script' or 'style' in allowedTags
export const allowedTags = baseAllowedTags.concat(['img','figure','figcaption','iframe'])

export const allowedAttributes: any = {
  a: ['href','name','target','rel'],
  img: ['src','alt','title','width','height','srcset','sizes','loading','decoding'],
  iframe: ['src','width','height','title','allow','allowfullscreen','frameborder'],
  // Avoid allowing arbitrary inline style by default. If needed, whitelist specific style props via
  // a custom transform later. Keeping class/id only here prevents the sanitize-html warnings.
  '*': ['class','id'],
}

export function sanitizeWP(html: string) {
  const WP = process.env.WP_URL ?? ''

  const rewriteIfWP = (src?: string) => src

  return sanitizeHtml(html, {
    allowedTags,
    allowedAttributes,
    allowedSchemes: ['http','https','mailto','tel'],
    allowedSchemesAppliedToAttributes: ['href','src'],
    allowProtocolRelative: false,
    allowedSchemesByTag: { iframe: ['http','https'] },
    transformTags: {
      a: (tag: any, attribs: any) => ({
        tagName: 'a',
        attribs: { ...attribs, rel: 'noopener noreferrer' }
      }),
      img: (tag: any, attribs: any) => ({
        tagName: 'img',
        attribs: { ...attribs, src: rewriteIfWP(attribs.src) }
      }),
  iframe: (tag: any, attribs: any) => ({ tagName: 'iframe', attribs }),
    },
  // Post-process style attributes embedded in CSS text (if any) to rewrite url(...) references
  textFilter: (text: string) => {
      if (!WP) return text
      return text.replace(/url\(([^)]+)\)/g, (m, g1) => {
        const raw = g1.trim().replace(/^['"]|['"]$/g, '')
        try {
          const u = new URL(raw)
          if (u.host === new URL(WP).host) {
            return `url(/api/wp/media${u.pathname}${u.search})`
          }
          return `url(${raw})`
        } catch (e) {
          return `url(${raw})`
        }
      })
    },
  })
}

export function renderUpdatesSummary(html: string, maxWords = 50) {
  const cleaned = decodeEntities(sanitizeHtml(html, { allowedTags: [], allowedAttributes: {} }))
  // Split into sentences by full-stop and trim
  const sentences = cleaned.split('.')
    .map(s => s.trim())
    .filter(Boolean)
  // join with bullet and ensure maxWords
  const joined = sentences.join(' ‚Ä¢ ')
  const words = joined.split(/\s+/).filter(Boolean)
  if (words.length <= maxWords) return joined
  return words.slice(0, maxWords).join(' ') + '...'
}


// ==== FILE: src\lib\server-session.ts ====
import { cookies } from 'next/headers'

import { verifySession } from './jwt'

export async function getServerSessionClaims() {
  const SESSION_COOKIE = process.env.SESSION_COOKIE_NAME ?? 'session'
  const cookieStore = await cookies()
  const session = cookieStore.get(SESSION_COOKIE)
  if (!session?.value) return null
  try {
    return await verifySession(session.value)
  } catch {
    return null
  }
}

export async function requireAnyRoleServer(roles: string[]) {
  const claims = await getServerSessionClaims()
  if (!claims) {
    const e = new Error('Unauthorized') as Error & { status?: number }
    e.status = 401
    throw e
  }
  const userRoles: string[] = (claims && typeof claims === 'object' && 'roles' in claims && Array.isArray((claims as Record<string, unknown>).roles))
    ? ((claims as { roles?: unknown }).roles as string[])
    : []
  if (!roles.some(r => userRoles.includes(r))) {
    const e = new Error('Forbidden') as Error & { status?: number }
    e.status = 403
    throw e
  }
  return claims
}


// ==== FILE: src\lib\serverCache.ts ====
type CacheEntry<T> = { value: T; expiresAt: number; tags: Set<string> }

const store = new Map<string, CacheEntry<any>>()

export function getCache<T>(key: string): T | undefined {
  const now = Date.now()
  const hit = store.get(key)
  if (!hit) return undefined
  if (hit.expiresAt < now) {
    store.delete(key)
    return undefined
  }
  return hit.value as T
}

export function setCache<T>(key: string, value: T, ttlSeconds: number, tags: string[] = []) {
  const expiresAt = Date.now() + ttlSeconds * 1000
  store.set(key, { value, expiresAt, tags: new Set(tags) })
}

export function invalidateTags(tags: string[]) {
  const doomed = new Set(tags)
  for (const [k, v] of store.entries()) {
    if ([...v.tags].some(t => doomed.has(t))) {
      store.delete(k)
    }
  }
}

export async function cached<T>(key: string, ttlSeconds: number, tags: string[], loader: () => Promise<T>): Promise<T> {
  const hit = getCache<T>(key)
  if (hit !== undefined) return hit
  const value = await loader()
  setCache(key, value, ttlSeconds, tags)
  return value
}


// ==== FILE: src\lib\settings.ts ====
import { promises as fs } from 'fs'
import path from 'path'

export type SiteSettings = {
  siteTitle: string
  siteUrl: string
  defaultOgImage: string
  defaultTwitterImage?: string
  defaultDescription?: string
  robotsCustom?: string | null
  sitemapEnabled: boolean
}

const SETTINGS_DIR = path.resolve(process.cwd(), 'data')
const SETTINGS_FILE = path.join(SETTINGS_DIR, 'site-settings.json')

function envDefaults(): SiteSettings {
  return {
    siteTitle: process.env.NEXT_PUBLIC_SITE_TITLE || 'Tech Oblivion',
    siteUrl: process.env.NEXT_PUBLIC_SITE_URL || 'https://techoblivion.in',
    defaultOgImage: process.env.NEXT_PUBLIC_DEFAULT_OG || 'https://techoblivion.in/wp-content/uploads/og-default.jpg',
    defaultTwitterImage: process.env.NEXT_PUBLIC_DEFAULT_TW || undefined,
    defaultDescription: process.env.NEXT_PUBLIC_DEFAULT_DESC || undefined,
    robotsCustom: null,
    sitemapEnabled: true,
  }
}

export async function getSettings(): Promise<SiteSettings> {
  try {
    const buf = await fs.readFile(SETTINGS_FILE, 'utf8')
    const parsed = JSON.parse(buf)
    return { ...envDefaults(), ...parsed }
  } catch {
    // On first run, ensure directory and file with defaults
    const defaults = envDefaults()
    try {
      await fs.mkdir(SETTINGS_DIR, { recursive: true })
      await fs.writeFile(SETTINGS_FILE, JSON.stringify(defaults, null, 2), 'utf8')
    } catch {}
    return defaults
  }
}

export async function updateSettings(patch: Partial<SiteSettings>): Promise<SiteSettings> {
  const current = await getSettings()
  const next = { ...current, ...patch }
  await fs.mkdir(SETTINGS_DIR, { recursive: true })
  await fs.writeFile(SETTINGS_FILE, JSON.stringify(next, null, 2), 'utf8')
  return next
}


// ==== FILE: src\lib\site.ts ====
export const site = {
  title: process.env.NEXT_PUBLIC_SITE_TITLE || 'Tech Oblivion',
  url: process.env.NEXT_PUBLIC_SITE_URL || 'https://techoblivion.in',
  defaultOgImage: process.env.NEXT_PUBLIC_DEFAULT_OG || 'https://techoblivion.in/wp-content/uploads/og-default.jpg',
};


// ==== FILE: src\lib\taxonomy-client.ts ====
export type WpCategory = { id: number; name: string; slug: string; parent: number; count?: number }
export type WpTag = { id: number; name: string; slug: string; count?: number }

export async function fetchAllCategories(): Promise<WpCategory[]> {
  const res = await fetch('/api/wp/categories?per_page=100&hide_empty=0', { cache: 'no-store' })
  if (!res.ok) throw new Error(`Failed categories: ${res.status}`)
  return res.json()
}

export function buildCategoryTree(cats: WpCategory[]) {
  const byId = new Map<number, any>()
  const roots: any[] = []
  cats.forEach(c => byId.set(c.id, { ...c, children: [] as any[] }))
  cats.forEach(c => {
    const node = byId.get(c.id)
    if (c.parent && byId.has(c.parent)) {
      byId.get(c.parent).children.push(node)
    } else {
      roots.push(node)
    }
  })
  return roots
}

export async function createCategory(input: { name: string; slug?: string; parent?: number }) {
  const res = await fetch('/api/wp/categories', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(input),
  })
  if (!res.ok) throw new Error(`Create category failed: ${res.status}`)
  return res.json()
}

export async function fetchAllTags(): Promise<WpTag[]> {
  const res = await fetch('/api/wp/tags?per_page=100', { cache: 'no-store' })
  if (!res.ok) throw new Error(`Failed tags: ${res.status}`)
  return res.json()
}

export async function resolveTags(names: string[]): Promise<number[]> {
  const res = await fetch('/api/wp/tags/resolve', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ names }),
  })
  if (!res.ok) throw new Error('Resolve tags failed')
  const j = await res.json()
  return Array.isArray(j?.ids) ? j.ids : []
}


// ==== FILE: src\lib\template.ts ====
export function renderTemplate(template: string, data: Record<string, unknown>): string {
  if (!template) return ''
  return template.replace(/\{([a-zA-Z0-9_.$\-]+)\}/g, (_, key) => {
    const value = getByPath(data, key)
    return value == null ? '' : String(value)
  })
}

function getByPath(obj: unknown, path: string) {
  try {
    return path.split('.').reduce<unknown>((acc, k) => {
      if (acc == null) return undefined
      if (typeof acc === 'object' && k in (acc as Record<string, unknown>)) {
        return (acc as Record<string, unknown>)[k]
      }
      return undefined
    }, obj)
  } catch {
    return undefined
  }
}

export default renderTemplate


// ==== FILE: src\lib\text.ts ====
// Utilities for converting HTML to readable text and decoding entities

// Strip HTML tags
export function stripTags(html: string): string {
  return (html || '').replace(/<[^>]+>/g, '')
}

// Decode common HTML entities, including numeric (dec/hex)
export function decodeEntities(s: string): string {
  if (!s) return ''
  let out = s
  // Named basic entities
  const named: Record<string, string> = {
    '&amp;': '&',
    '&lt;': '<',
    '&gt;': '>',
    '&quot;': '"',
    '&#39;': "'",
    '&apos;': "'",
    '&nbsp;': ' ',
  }
  out = out.replace(/&(amp|lt|gt|quot|#39|apos|nbsp);/g, (m) => named[m] || m)
  // Numeric decimal
  out = out.replace(/&#(\d+);/g, (_, dec: string) => {
    const code = Number(dec)
    return Number.isFinite(code) ? String.fromCodePoint(code) : _
  })
  // Numeric hex
  out = out.replace(/&#x([0-9a-fA-F]+);/g, (_, hex: string) => {
    const code = parseInt(hex, 16)
    return Number.isFinite(code) ? String.fromCodePoint(code) : _
  })
  return out
}

// Convert HTML to plain text: strip tags then decode entities
export function htmlToText(html: string): string {
  return decodeEntities(stripTags(html || ''))
}


// ==== FILE: src\lib\toc-md.ts ====
import { unified } from 'unified'
import remarkParse from 'remark-parse'
import type { Root, Content, Heading } from 'mdast'
import { toString } from 'mdast-util-to-string'
import GithubSlugger from 'github-slugger'

export type TocItem = { id: string; depth: number; value: string }

export function extractTocFromMarkdown(markdown: string, options?: { minDepth?: number; maxDepth?: number }) {
  const minDepth = options?.minDepth ?? 2
  const maxDepth = options?.maxDepth ?? 3
  const tree = unified().use(remarkParse).parse(markdown) as Root
  const slugger = new GithubSlugger()
  const items: TocItem[] = []

  function visit(node: Content) {
    if ((node as any).type === 'heading') {
      const h = node as unknown as Heading
      const depth = h.depth
      if (depth >= minDepth && depth <= maxDepth) {
        const text = toString(h)
        const id = slugger.slug(text)
        items.push({ id, depth, value: text })
      }
    }
    const children = (node as any).children as Content[] | undefined
    if (children && Array.isArray(children)) children.forEach(visit)
  }

  ;(tree.children as Content[]).forEach(visit)
  return items
}


// ==== FILE: src\lib\toc.ts ====
import { cached } from './serverCache'

export type TocItem = { level: 2 | 3; text: string; slug: string }

export function extractTOCFromHtml(html: string): TocItem[] {
  const items: TocItem[] = []
  const re = /<h([23])[^>]*>([\s\S]*?)<\/h\1>/gi
  let m: RegExpExecArray | null
  while ((m = re.exec(html))) {
    const level = Number(m[1]) as 2 | 3
    const text = m[2].replace(/<[^>]+>/g, '')
    const slug = text.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '')
    items.push({ level, text, slug })
  }
  return items
}

export async function getOrBuildToc(postId: number, html: string) {
  const key = `toc:${postId}`
  return cached<TocItem[]>(key, 3600, [key], async () => extractTOCFromHtml(html))
}


// ==== FILE: src\lib\utils.ts ====
import { clsx, type ClassValue } from "clsx"
import { twMerge } from "tailwind-merge"

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}


// ==== FILE: src\lib\wordpress-client.ts ====
// Direct WordPress REST API client (temporary - bypasses proxy)
// This makes direct calls from browser to WordPress

const WP_BASE_URL = 'https://techoblivion.in';
const WP_API_BASE = `${WP_BASE_URL}/wp-json/wp/v2`;

export interface WordPressPost {
  id: number;
  date: string;
  title: {
    rendered: string;
  };
  content: {
    rendered: string;
  };
  excerpt: {
    rendered: string;
  };
  slug: string;
  featured_media: number;
  categories: number[];
  tags: number[];
  _embedded?: {
    'wp:featuredmedia'?: Array<{
      source_url: string;
      alt_text: string;
    }>;
    'wp:term'?: Array<Array<{
      id: number;
      name: string;
      slug: string;
    }>>;
  };
}

export interface WordPressMedia {
  id: number;
  source_url: string;
  alt_text: string;
  media_details: {
    width: number;
    height: number;
    sizes: Record<string, {
      source_url: string;
      width: number;
      height: number;
    }>;
  };
}

export class WordPressClient {
  private baseUrl: string;

  constructor(baseUrl: string = WP_API_BASE) {
    this.baseUrl = baseUrl;
  }

  // Get posts with embedded media and terms
  async getPosts(params?: {
    page?: number;
    per_page?: number;
    categories?: number[];
    tags?: number[];
    search?: string;
  }): Promise<{ posts: WordPressPost[]; totalPages: number; total: number }> {
    const searchParams = new URLSearchParams();
    
    // Add embed parameter to include featured media and terms
    searchParams.set('_embed', '1');
    
    if (params?.page) {
      searchParams.set('page', params.page.toString());
    }
    
    if (params?.per_page) {
      searchParams.set('per_page', params.per_page.toString());
    }
    
    if (params?.categories?.length) {
      searchParams.set('categories', params.categories.join(','));
    }
    
    if (params?.tags?.length) {
      searchParams.set('tags', params.tags.join(','));
    }
    
    if (params?.search) {
      searchParams.set('search', params.search);
    }

    const url = `${this.baseUrl}/posts?${searchParams.toString()}`;
    
    try {
      const response = await fetch(url);
      
      if (!response.ok) {
        throw new Error(`WordPress API error: ${response.status} ${response.statusText}`);
      }
      
      const posts: WordPressPost[] = await response.json();
      
      // Get pagination info from headers
      const totalPages = parseInt(response.headers.get('X-WP-TotalPages') || '1');
      const total = parseInt(response.headers.get('X-WP-Total') || '0');
      
      return { posts, totalPages, total };
    } catch (error) {
      console.error('Error fetching posts:', error);
      throw error;
    }
  }

  // Get a single post by ID
  async getPost(id: number): Promise<WordPressPost> {
    const url = `${this.baseUrl}/posts/${id}?_embed=1`;
    
    try {
      const response = await fetch(url);
      
      if (!response.ok) {
        throw new Error(`WordPress API error: ${response.status} ${response.statusText}`);
      }
      
      return await response.json();
    } catch (error) {
      console.error('Error fetching post:', error);
      throw error;
    }
  }

  // Get a single post by slug
  async getPostBySlug(slug: string): Promise<WordPressPost | null> {
    const url = `${this.baseUrl}/posts?slug=${slug}&_embed=1`;
    
    try {
      const response = await fetch(url);
      
      if (!response.ok) {
        throw new Error(`WordPress API error: ${response.status} ${response.statusText}`);
      }
      
      const posts: WordPressPost[] = await response.json();
      return posts.length > 0 ? posts[0] : null;
    } catch (error) {
      console.error('Error fetching post by slug:', error);
      throw error;
    }
  }

  // Get media by ID
  async getMedia(id: number): Promise<WordPressMedia> {
    const url = `${this.baseUrl}/media/${id}`;
    
    try {
      const response = await fetch(url);
      
      if (!response.ok) {
        throw new Error(`WordPress API error: ${response.status} ${response.statusText}`);
      }
      
      return await response.json();
    } catch (error) {
      console.error('Error fetching media:', error);
      throw error;
    }
  }

  // Get categories
  async getCategories(): Promise<Array<{ id: number; name: string; slug: string; count: number }>> {
    const url = `${this.baseUrl}/categories`;
    
    try {
      const response = await fetch(url);
      
      if (!response.ok) {
        throw new Error(`WordPress API error: ${response.status} ${response.statusText}`);
      }
      
      return await response.json();
    } catch (error) {
      console.error('Error fetching categories:', error);
      throw error;
    }
  }

  // Get tags
  async getTags(): Promise<Array<{ id: number; name: string; slug: string; count: number }>> {
    const url = `${this.baseUrl}/tags`;
    
    try {
      const response = await fetch(url);
      
      if (!response.ok) {
        throw new Error(`WordPress API error: ${response.status} ${response.statusText}`);
      }
      
      return await response.json();
    } catch (error) {
      console.error('Error fetching tags:', error);
      throw error;
    }
  }
}

// Export a default instance
export const wordpressClient = new WordPressClient();

// Helper functions for easier usage
export const getPosts = (params?: Parameters<WordPressClient['getPosts']>[0]) => 
  wordpressClient.getPosts(params);

export const getPost = (id: number) => 
  wordpressClient.getPost(id);

export const getPostBySlug = (slug: string) => 
  wordpressClient.getPostBySlug(slug);

export const getMedia = (id: number) => 
  wordpressClient.getMedia(id);

export const getCategories = () => 
  wordpressClient.getCategories();

export const getTags = () => 
  wordpressClient.getTags();


// ==== FILE: src\lib\wp-author.ts ====
export async function getLatestByAuthor(authorId: number, excludeId?: number, perPage = 3) {
  const origin = process.env.NEXT_PUBLIC_SITE_URL || process.env.SITE_URL || ''
  const url = new URL('/api/wp/posts', origin || 'http://localhost')
  url.searchParams.set('author', String(authorId))
  url.searchParams.set('per_page', String(perPage))
  url.searchParams.set('orderby', 'date')
  url.searchParams.set('order', 'desc')
  if (excludeId) url.searchParams.set('exclude', String(excludeId))
  const r = await fetch(url.toString(), { headers: { Accept: 'application/json' }, cache: 'no-store' })
  if (!r.ok) return []
  const j = await r.json().catch(() => [])
  return Array.isArray(j) ? j : []
}


// ==== FILE: src\lib\wp-public.ts ====
export type PublicUser = {
  id: number
  name?: string
  slug: string
  description?: string
  avatar_urls?: Record<string, string>
  profile_fields?: Record<string, unknown> | null
}

export async function getUserBySlug(slug: string): Promise<PublicUser | null> {
  if (!slug) return null
  const url = typeof window !== 'undefined'
    ? new URL(`/api/wp/users/${encodeURIComponent(slug)}`, window.location.origin)
    : new URL(`/api/wp/users/${encodeURIComponent(slug)}`, (process.env.NEXT_PUBLIC_SITE_URL || process.env.SITE_URL || 'http://localhost:3000').replace(/\/$/, ''))

  const res = await fetch(url.toString(), { cache: 'no-store' })
  if (!res.ok) return null
  // Endpoint returns a single object or 404
  try {
    const data = await res.json()
    if (data && typeof data === 'object' && data.slug) return data as PublicUser
  } catch {}
  return null
}


// ==== FILE: src\lib\wp.ts ====
export type WordPressUser = {
  id: number
  slug: string
  name?: string
  display_name?: string
  description?: string
  avatar_urls?: Record<string, string>
  url?: string
}

function getSiteOrigin() {
  if (typeof window !== 'undefined' && window.location) {
    return window.location.origin
  }
  const site = process.env.NEXT_PUBLIC_SITE_URL || process.env.SITE_URL || ''
  return String(site).replace(/\/$/, '') || 'http://localhost:3000'
}

export async function getUsers(params?: Record<string, string | number | boolean>): Promise<WordPressUser[]> {
  const origin = getSiteOrigin()
  const url = new URL('/api/wp/users', origin)
  if (params) {
    for (const [k, v] of Object.entries(params)) url.searchParams.set(k, String(v))
  }
  const res = await fetch(url.toString(), { cache: 'no-store' })
  if (!res.ok) return []
  const data = await res.json().catch(() => null)
  return Array.isArray(data) ? data : []
}

export async function getUserBySlug(slug: string): Promise<WordPressUser | null> {
  const list = await getUsers({ slug })
  return list[0] || null
}
import { logWPError } from './log'

// Centralized caching knobs
const DEFAULT_TTL = Number(process.env.WP_CACHE_TTL || 300) // seconds
const TAGS = {
  posts: 'wp:posts',
  post: (slug: string|number) => `wp:post:${slug}`,
  page: (slug: string|number) => `wp:page:${slug}`,
}

// NOTE: do not read WP_URL at module load time. Read it at runtime inside each
// function so build-time imports won't crash when envs aren't present.

export type WPPost = {
  id: number
  date: string
  slug: string
  title: { rendered: string }
  excerpt: { rendered: string }
  content: { rendered: string }
  categories?: number[]
  tags?: number[]
  _embedded?: Record<string, unknown>
  // ACF or custom meta could surface under 'acf' or via meta fields
  acf?: Record<string, unknown>
  meta?: Record<string, unknown>
}

export type PostSummary = {
  id: number
  slug: string
  title: string
  excerptHtml?: string
  featuredImage?: string | null
  authorId?: number | null
  authorName?: string | null
  authorAvatar?: string | null
  authorSlug?: string | null
  date: string
}

export type PostDetail = {
  id: number
  slug: string
  title: string
  contentHtml: string
  featuredImage?: string | null
  date: string
  authorId?: number | null
  authorName?: string | null
  authorAvatar?: string | null
  authorSlug?: string | null
  categories?: { id: number; name?: string; slug?: string }[]
  tags?: { id: number; name?: string; slug?: string }[]
  seo?: {
    title?: string
    description?: string
    canonical?: string
    ogImage?: string
    twitterImage?: string
    schemaType?: string
  }
}

function _rawMediaUrl(p: WPPost) {
  const fm = p._embedded?.['wp:featuredmedia'] as Array<{ source_url?: string }> | undefined
  return fm?.[0]?.source_url ?? null
}

export async function getPosts({ page = 1, perPage = 10, search = '' } = {}) {
  const WP = process.env.WP_URL ?? ''
  if (!WP) throw new Error('WP_URL env required')

  const url = new URL('/wp-json/wp/v2/posts', WP)
  url.searchParams.set('_embed', '1')
  url.searchParams.set('page', String(page))
  url.searchParams.set('per_page', String(perPage))
  if (search) url.searchParams.set('search', search)

  const res = await fetch(url.toString(), {
    // ISR w/ tags so we can surgically revalidate from /api/revalidate
    next: { revalidate: DEFAULT_TTL, tags: [TAGS.posts] },
    // include polite headers so upstream doesn't block anonymous requests
    headers: {
      'User-Agent': 'techoblivion-proxy/1.0 (+https://techoblivion.in)',
      'Referer': WP,
      'Accept': 'application/json',
    },
  })

  if (!res.ok) {
    const body = await res.text()
    // Log upstream diagnostic for debugging (truncated body)
    logWPError('getPosts', { status: res.status, statusText: res.statusText, body: body.slice(0, 2000) })
    throw new Error(`WP posts ${res.status}: ${body}`)
  }

  const total = Number(res.headers.get('X-WP-Total') || 0)
  const totalPages = Number(res.headers.get('X-WP-TotalPages') || 0)
  let items = [] as WPPost[]
  try {
    items = (await res.json()) as WPPost[]
  } catch (e: unknown) {
    logWPError('getPosts-json', { statusText: String(e), body: undefined })
    throw e as Error
  }

  const itemsMapped = items.map((p) => ({
      id: p.id,
      slug: p.slug,
      title: p.title.rendered,
      excerptHtml: p.excerpt.rendered,
      // Direct WP media URL for stability
      featuredImage: _rawMediaUrl(p),
  authorId: (p as unknown as { author?: number }).author ?? null,
      authorName: (p._embedded?.author as Array<{ name?: string }> | undefined)?.[0]?.name ?? null,
      authorAvatar: (p._embedded?.author as Array<{ avatar_urls?: Record<string, string> }> | undefined)?.[0]?.avatar_urls?.['48']
        ?? (p._embedded?.author as Array<{ avatar_urls?: Record<string, string> }> | undefined)?.[0]?.avatar_urls?.['96']
        ?? null,
  authorSlug: (p._embedded?.author as Array<{ slug?: string }> | undefined)?.[0]?.slug ?? null,
      date: p.date,
    }))
  return { items: itemsMapped, total, totalPages }
}

export async function getPostBySlug(slug: string) {
  const WP = process.env.WP_URL ?? ''
  if (!WP) throw new Error('WP_URL env required')

  const url = new URL('/wp-json/wp/v2/posts', WP)
  url.searchParams.set('slug', slug)
  url.searchParams.set('_embed', '1')

  const res = await fetch(url.toString(), {
    next: { revalidate: DEFAULT_TTL, tags: [TAGS.posts, TAGS.post(slug)] },
    headers: { 'User-Agent': 'techoblivion-proxy/1.0 (+https://techoblivion.in)', 'Referer': WP, 'Accept': 'application/json' }
  })
  if (!res.ok) {
    const body = await res.text()
    logWPError('getPostBySlug', { status: res.status, statusText: res.statusText, body: body.slice(0, 2000) })
    throw new Error(`WP post ${res.status}: ${body}`)
  }

  let arr: WPPost[] = []
  try {
    arr = (await res.json()) as WPPost[]
  } catch (e: unknown) {
    logWPError('getPostBySlug-json', { statusText: String(e), body: undefined })
    throw e as Error
  }
  const p = arr[0]
  if (!p) return null

  const categories: { id: number; name?: string; slug?: string }[] = []
  const tags: { id: number; name?: string; slug?: string }[] = []
  // Collect taxonomy IDs if present
  const catIds: number[] = (p as any).categories || []
  const tagIds: number[] = (p as any).tags || []
  // Try to enrich from _embedded terms if available
  type Term = { taxonomy?: string; id?: number; name?: string; slug?: string }
  const embeddedTerms = (p._embedded?.['wp:term'] as unknown[] | undefined) || []
  const flatTerms = (embeddedTerms as unknown[]).flat?.() || []
  for (const tUnknown of flatTerms) {
    const t = tUnknown as Term
    const id = typeof t.id === 'number' ? t.id : undefined
    if (t.taxonomy === 'category' && id !== undefined && catIds.includes(id)) categories.push({ id, name: t.name, slug: t.slug })
    if (t.taxonomy === 'post_tag' && id !== undefined && tagIds.includes(id)) tags.push({ id, name: t.name, slug: t.slug })
  }

  // Extract SEO from ACF or meta namespaces if present
  const metaSource = (p.acf as Record<string, unknown> | undefined) || (p.meta as Record<string, unknown> | undefined) || {}
  const seo = {
    title: (metaSource.seo_title as string | undefined) || undefined,
    description: (metaSource.seo_description as string | undefined) || undefined,
    canonical: (metaSource.seo_canonical as string | undefined) || undefined,
    ogImage: (metaSource.seo_og_image as string | undefined) || undefined,
    twitterImage: (metaSource.seo_twitter_image as string | undefined) || undefined,
    schemaType: (metaSource.seo_schema_type as string | undefined) || undefined,
  }

  const featuredImage = _rawMediaUrl(p)
  return {
    id: p.id,
    slug: p.slug,
    title: p.title.rendered,
    contentHtml: p.content.rendered,
    featuredImage,
    date: p.date,
    authorId: (p as unknown as { author?: number }).author ?? null,
    authorName: (p._embedded?.author as Array<{ name?: string }> | undefined)?.[0]?.name ?? null,
    authorAvatar: (p._embedded?.author as Array<{ avatar_urls?: Record<string, string> }> | undefined)?.[0]?.avatar_urls?.['48']
      ?? (p._embedded?.author as Array<{ avatar_urls?: Record<string, string> }> | undefined)?.[0]?.avatar_urls?.['96']
      ?? null,
    authorSlug: (p._embedded?.author as Array<{ slug?: string }> | undefined)?.[0]?.slug ?? null,
    categories,
    tags,
    seo,
  }
}

export async function getPageContent(slug: string) {
  const WP = process.env.WP_URL ?? ''
  if (!WP) throw new Error('WP_URL env required')

  const url = new URL(`/wp-json/wp/v2/pages`, WP)
  url.searchParams.set('slug', slug)
  url.searchParams.set('_embed', '0')

  const res = await fetch(url.toString(), {
    next: { revalidate: DEFAULT_TTL, tags: [TAGS.page(slug)] },
    headers: { 'User-Agent': 'techoblivion-proxy/1.0 (+https://techoblivion.in)', 'Referer': WP, 'Accept': 'application/json' }
  })
  if (!res.ok) {
    const body = await res.text()
    logWPError('getPageContent', { status: res.status, statusText: res.statusText, body: body.slice(0, 2000) })
    throw new Error(`WP page ${res.status}: ${body}`)
  }

  let arr: Array<{ id: number; slug: string; content?: { rendered?: string } }> = []
  try {
    arr = (await res.json()) as Array<{ id: number; slug: string; content?: { rendered?: string } }>
  } catch (e: unknown) {
    logWPError('getPageContent-json', { statusText: String(e), body: undefined })
    throw e as Error
  }
  const p = arr[0]
  if (!p) return null
  return { id: p.id, slug: p.slug, contentHtml: p.content?.rendered ?? '' }
}


// ==== FILE: src\lib\wpAPIMap.ts ====
// filepath: lib/wpApiMap.ts
// Centralized mapping of Next.js API routes ‚Üí WordPress REST endpoints

export const WP_BASE = process.env.WP_URL || process.env.NEXT_PUBLIC_WP_URL || '';

export const apiMap = {
  auth: {
    login: `${WP_BASE}/wp-json/jwt-auth/v1/token`,
    logout: `/api/auth/logout`, // handled locally in Next.js
    me: `${WP_BASE}/wp-json/wp/v2/users/me?context=edit`,
    register: `${WP_BASE}/wp-json/fe-auth/v1/register`,
  },
  users: {
    list: `${WP_BASE}/wp-json/wp/v2/users`,
    bySlug: (slug: string) => `${WP_BASE}/wp-json/fe-auth/v1/public-user/${slug}`,
    me: `${WP_BASE}/wp-json/wp/v2/users/me`,
    avatar: (id: number) => `${WP_BASE}/wp-json/wp/v2/media/${id}`,
    create: `${WP_BASE}/wp-json/wp/v2/users`,
    update: (id: number) => `${WP_BASE}/wp-json/wp/v2/users/${id}`,
    delete: (id: number) => `${WP_BASE}/wp-json/wp/v2/users/${id}`,
  // Custom MU endpoint for bulk deletion (see docs/mu-plugins-backup/mu-fe-auth-users-bulk-delete.php)
  bulkDelete: `${WP_BASE}/wp-json/fe-auth/v1/users/bulk-delete`,
  },
  posts: {
    list: `${WP_BASE}/wp-json/wp/v2/posts`,
    create: `${WP_BASE}/wp-json/wp/v2/posts`,
    update: (id: number) => `${WP_BASE}/wp-json/wp/v2/posts/${id}`,
    delete: (id: number) => `${WP_BASE}/wp-json/wp/v2/posts/${id}`,
    revisions: (id: number) => `${WP_BASE}/wp-json/wp/v2/posts/${id}/revisions`,
    search: (q: string) => `${WP_BASE}/wp-json/wp/v2/search?search=${encodeURIComponent(q)}`,
    related: (query: string) => `${WP_BASE}/wp-json/wp/v2/posts?${query}`,
  },
  comments: {
    list: `${WP_BASE}/wp-json/wp/v2/comments`,
    create: `${WP_BASE}/wp-json/wp/v2/comments`,
    update: (id: number) => `${WP_BASE}/wp-json/wp/v2/comments/${id}`,
    delete: (id: number) => `${WP_BASE}/wp-json/wp/v2/comments/${id}`,
    bulk: `${WP_BASE}/wp-json/fe-auth/v1/comments/bulk`, // custom MU endpoint
  },
  media: {
    list: `${WP_BASE}/wp-json/wp/v2/media`,
    file: (id: number) => `${WP_BASE}/wp-json/wp/v2/media/${id}`,
    create: `${WP_BASE}/wp-json/wp/v2/media`,
    update: (id: number) => `${WP_BASE}/wp-json/wp/v2/media/${id}`,
    delete: (id: number) => `${WP_BASE}/wp-json/wp/v2/media/${id}`,
  },
  taxonomies: {
    categories: `${WP_BASE}/wp-json/wp/v2/categories`,
    tags: `${WP_BASE}/wp-json/wp/v2/tags`,
  },
  settings: {
    get: `${WP_BASE}/wp-json/wp/v2/settings`,
    update: `${WP_BASE}/wp-json/wp/v2/settings`,
  },
  plugins: {
    list: `${WP_BASE}/wp-json/wp/v2/plugins`,
    toggle: (id: string) => `${WP_BASE}/wp-json/wp/v2/plugins/${id}`,
  },
  themes: {
    list: `${WP_BASE}/wp-json/wp/v2/themes`,
  },
  siteHealth: {
    backgroundUpdates: `${WP_BASE}/wp-json/wp-site-health/v1/tests/background-updates`,
    directorySizes: `${WP_BASE}/wp-json/wp-site-health/v1/directory-sizes`,
  },
  mu: {
    trackView: `${WP_BASE}/wp-json/fe-auth/v1/track-view`,
    bookmarks: `${WP_BASE}/wp-json/fe-auth/v1/bookmarks`,
    bookmarkCheck: (postId: number) => `${WP_BASE}/wp-json/fe-auth/v1/bookmarks/check?post_id=${postId}`,
    bookmarkToggle: `${WP_BASE}/wp-json/fe-auth/v1/bookmarks/toggle`,
  },
  utilities: {
    robots: `/robots.txt`,
    sitemap: `/sitemap.xml`,
  },
  analytics: {
    check: `${WP_BASE}/wp-json/fe-analytics/v1/check`,
    views: `${WP_BASE}/wp-json/fe-analytics/v1/views`,
    devices: `${WP_BASE}/wp-json/fe-analytics/v1/devices`,
    countries: `${WP_BASE}/wp-json/fe-analytics/v1/countries`,
    referers: `${WP_BASE}/wp-json/fe-analytics/v1/referers`,
    topPosts: `${WP_BASE}/wp-json/fe-analytics/v1/top-posts`,
  summary: `${WP_BASE}/wp-json/fe-analytics/v1/summary`,
  sessions: `${WP_BASE}/wp-json/fe-analytics/v1/sessions`,
  sessionSummary: `${WP_BASE}/wp-json/fe-analytics/v1/sessions/summary`,
  sessionTimeseries: `${WP_BASE}/wp-json/fe-analytics/v1/sessions/timeseries`,
  stream: `${WP_BASE}/wp-json/fe-analytics/v1/stream`,
  },
};


// ==== FILE: src\lib\wpProxy.ts ====
// src/lib/wpProxy.ts
export async function signProxy(method: string, path: string, body: any) {
  const ts = Math.floor(Date.now() / 1000).toString();
  const raw = body ? JSON.stringify(body) : '';
  const msg = `${method.toUpperCase()}\n${path}\n${ts}\n${raw}`;
  const secret = process.env.FE_PROXY_SECRET!;
  const crypto = await import('crypto');
  const sig = crypto.createHmac('sha256', secret).update(msg).digest('base64');
  return { ts, sig, raw };
}


// ==== FILE: src\lib\__tests__\wp.spec.ts ====
import { describe, it, expect, vi, beforeEach, afterEach } from 'vitest'

import * as log from '../log'

const HTML_503 = `<!DOCTYPE html><html><head><title>Maintenance</title></head><body><p>Site under maintenance</p></body></html>`

describe('wp helpers - resilience', () => {
  let originalFetch: any
  beforeEach(() => {
    originalFetch = globalThis.fetch
  process.env.WP_URL = 'https://techoblivion.test'
  })
  afterEach(() => {
    globalThis.fetch = originalFetch
    vi.restoreAllMocks()
  })

  it('getPosts should throw when WP returns 503 HTML', async () => {
    globalThis.fetch = vi.fn().mockResolvedValue({ ok: false, status: 503, statusText: 'Service Unavailable', headers: { get: () => 'text/html' }, text: async () => HTML_503 })
  const { getPosts } = await import('../wp')
  await expect(getPosts()).rejects.toThrow(/WP posts 503/)
  })

  it('getPostBySlug should throw when WP returns 503 HTML', async () => {
    globalThis.fetch = vi.fn().mockResolvedValue({ ok: false, status: 503, statusText: 'Service Unavailable', headers: { get: () => 'text/html' }, text: async () => HTML_503 })
  const { getPostBySlug } = await import('../wp')
  await expect(getPostBySlug('nope')).rejects.toThrow(/WP post 503/)
  })
})


// ==== FILE: src\lib\__tests__\wpFetch.env.spec.ts ====
import { describe, it, expect } from 'vitest'

describe('wpFetch env guard', () => {
  it('throws when WP_URL is not set', async () => {
    // Ensure env var is absent for this test
    const orig = process.env.WP_URL
    delete process.env.WP_URL
    // Dynamically import to get fresh module state
  const mod = await import('../fetcher')
    try {
      await expect(mod.wpFetch('/wp-json/')).rejects.toThrow(/WP_URL env required/)
    } finally {
      if (orig !== undefined) process.env.WP_URL = orig
    }
  })
})


// ==== FILE: src\pages\api\alive.ts ====
import { NextApiRequest, NextApiResponse } from 'next';

export default function handler(_req: NextApiRequest, res: NextApiResponse) {
  res.status(200).json({ ok: true });
}


// ==== FILE: src\pages\api\latest-youtube-video.ts ====
// Next.js API route to fetch the latest YouTube video ID for your channel
import type { NextApiRequest, NextApiResponse } from 'next';

export default async function handler(req: NextApiRequest, res: NextApiResponse) {
  try {
    const channelId = process.env.NEXT_PUBLIC_YOUTUBE_CHANNEL_ID;
    if (!channelId) return res.status(500).json({ error: 'YouTube channel ID not set' });
    const rssRes = await fetch(`https://www.youtube.com/feeds/videos.xml?channel_id=${channelId}`);
    if (!rssRes.ok) return res.status(502).json({ error: 'Failed to fetch YouTube RSS' });
    const rssText = await rssRes.text();
    const match = rssText.match(/<yt:videoId>([^<]+)<\/yt:videoId>/);
    if (!match) return res.status(404).json({ error: 'No video found' });
    return res.status(200).json({ videoId: match[1] });
  } catch (e) {
    return res.status(500).json({ error: 'Internal error' });
  }
}


// ==== FILE: scripts\auditRoles.ts ====
import fs from 'node:fs'
import path from 'node:path'

import { apiRolesMatrix } from '../src/config/apiRolesMatrix'

const API_DIRS = [
  path.resolve(process.cwd(), 'app', 'api'),
  path.resolve(process.cwd(), 'src', 'app', 'api'),
]

type RouteDef = { method: string; path: string }
type FileInfo = { absPath: string; path: string; methods: string[]; root: 'app' | 'src' }

function walk(dir: string, acc: string[] = []): string[] {
  if (!fs.existsSync(dir)) return acc
  for (const entry of fs.readdirSync(dir, { withFileTypes: true })) {
    const p = path.join(dir, entry.name)
    if (entry.isDirectory()) walk(p, acc)
    else if (entry.isFile() && entry.name === 'route.ts') acc.push(p)
  }
  return acc
}

function detectMethods(filePath: string): string[] {
  const src = fs.readFileSync(filePath, 'utf8')
  const methods = new Set<string>()
  // Support standard Next.js export const GET/POST/etc patterns
  const re = /export\s+(?:async\s+)?function\s+(GET|POST|PATCH|PUT|DELETE)|export\s+const\s+(GET|POST|PATCH|PUT|DELETE)/g
  let m: RegExpExecArray | null
  while ((m = re.exec(src))) {
    const method = (m[1] || m[2])?.toUpperCase()
    if (method) methods.add(method)
  }
  // Detect named re-exports: export { GET, POST } from '...'
  const reExport = /export\s*{\s*([^}]+)\s*}\s*from\s*['"][^'"]+['"]/g
  while ((m = reExport.exec(src))) {
    const names = (m[1] || '')
      .split(',')
      .map((s) => s.trim().toUpperCase())
      .filter((n) => ['GET', 'POST', 'PATCH', 'PUT', 'DELETE'].includes(n))
    for (const n of names) methods.add(n)
  }
  return Array.from(methods)
}

function toApiPath(absFile: string): string {
  const appRoot = absFile.includes(`${path.sep}src${path.sep}app${path.sep}`)
    ? path.resolve(process.cwd(), 'src', 'app')
    : path.resolve(process.cwd(), 'app')
  const rel = path.relative(appRoot, absFile).replace(/\\/g, '/')
  // drop trailing "/route.ts"
  const base = rel.replace(/\/route\.ts$/, '')
  // convert folder segments to URL
  return '/' + base
}

function main() {
  const files = API_DIRS.flatMap((d) => walk(d))
  const byPath = new Map<string, FileInfo[]>()
  for (const f of files) {
    const apiPath = toApiPath(f)
    const methods = detectMethods(f)
    const root: 'app' | 'src' = f.includes(`${path.sep}src${path.sep}app${path.sep}`) ? 'src' : 'app'
    const list = byPath.get(apiPath) || []
    list.push({ absPath: f, path: apiPath, methods, root })
    byPath.set(apiPath, list)
  }

  const selected: FileInfo[] = []
  for (const [apiPath, infos] of byPath) {
    if (infos.length === 1) {
      selected.push(infos[0])
    } else {
      // prefer the one with more explicitly detected methods; tie-breaker: prefer app/
      const sorted = [...infos].sort((a, b) => {
        if (b.methods.length !== a.methods.length) return b.methods.length - a.methods.length
        if (a.root !== b.root) return a.root === 'app' ? -1 : 1
        return a.absPath.localeCompare(b.absPath)
      })
      selected.push(sorted[0])
    }
  }

  const missing: RouteDef[] = []
  for (const info of selected) {
    // Skip files with no detectable methods (likely pure re-export placeholders or disabled files)
    if (info.methods.length === 0) continue
    for (const method of info.methods) {
      const matched = apiRolesMatrix.some((e) => {
        if (e.method !== (method as any)) return false
        const pattern = e.path
          .replace(/\//g, '\\/')
          .replace(/\[.+?\]/g, '[^/]+')
          .replace(/\.+/g, '.+')
        const re = new RegExp(`^${pattern}$`)
        return re.test(info.path)
      })
      if (!matched) missing.push({ method, path: info.path })
    }
  }

  if (missing.length) {
    // eslint-disable-next-line no-console
    console.warn('RBAC AUDIT: Missing mappings for the following routes:')
    for (const r of missing) {
      // eslint-disable-next-line no-console
      console.warn(` - ${r.method} ${r.path}`)
    }
    process.exitCode = 1
  } else {
    // eslint-disable-next-line no-console
    console.log('RBAC AUDIT: All routes are covered by apiRolesMatrix.')
  }
}

main()


// ==== FILE: scripts\generateApiMap.ts ====
import fs from 'node:fs'
import path from 'node:path'
import { fileURLToPath } from 'node:url'

import { apiMap as loadedApiMap, WP_BASE } from '../src/lib/wpAPIMap'

type Methods = string[]
type RouteInfo = { path: string; methods: Methods; targets: string[] }

const API_DIRS = [
  path.resolve(process.cwd(), 'app', 'api'),
  path.resolve(process.cwd(), 'src', 'app', 'api'),
]

function walk(dir: string, acc: string[] = []): string[] {
  if (!fs.existsSync(dir)) return acc
  for (const entry of fs.readdirSync(dir, { withFileTypes: true })) {
    const p = path.join(dir, entry.name)
    if (entry.isDirectory()) walk(p, acc)
    else if (entry.isFile() && entry.name === 'route.ts') acc.push(p)
  }
  return acc
}

function detectMethods(src: string): Methods {
  const methods = new Set<string>()
  const re = /export\s+(?:async\s+)?function\s+(GET|POST|PATCH|PUT|DELETE)|export\s+const\s+(GET|POST|PATCH|PUT|DELETE)/g
  let m: RegExpExecArray | null
  while ((m = re.exec(src))) {
    const method = (m[1] || m[2])?.toUpperCase()
    if (method) methods.add(method)
  }
  // re-exports
  const reExport = /export\s*{\s*([^}]+)\s*}\s*from\s*['"][^'"]+['"]/g
  while ((m = reExport.exec(src))) {
    const names = (m[1] || '')
      .split(',')
      .map((s) => s.trim().toUpperCase())
      .filter((n) => ['GET', 'POST', 'PATCH', 'PUT', 'DELETE'].includes(n))
    for (const n of names) methods.add(n)
  }
  return Array.from(methods)
}

function toApiPath(absFile: string): string {
  const isSrc = absFile.includes(`${path.sep}src${path.sep}app${path.sep}`)
  const appRoot = isSrc ? path.resolve(process.cwd(), 'src', 'app') : path.resolve(process.cwd(), 'app')
  const rel = path.relative(appRoot, absFile).replace(/\\/g, '/')
  return '/' + rel.replace(/\/route\.ts$/, '')
}

type ApiMap = any

function getValueFromApiMap(obj: ApiMap, chain: string[]): unknown {
  let cur: any = obj
  for (const key of chain) {
    if (cur && typeof cur === 'object' && key in cur) cur = cur[key]
    else return undefined
  }
  return cur
}

function normalizeWP(val: string): string {
  const base = (WP_BASE || '').replace(/\/$/, '')
  return val.replace(base, '{WP}')
}

function extractTargets(src: string): string[] {
  const targets = new Set<string>()
  // direct apiMap usage, e.g., apiMap.analytics.views
  const directRe = /apiMap\.(\w+)\.(\w+)/g
  let m: RegExpExecArray | null
  while ((m = directRe.exec(src))) {
    const section = m[1]
    const key = m[2]
    const val = getValueFromApiMap(loadedApiMap, [section, key])
    if (typeof val === 'string') targets.add(normalizeWP(val))
  }
  // destructured usage: const { analytics } = apiMap; then analytics.views
  const destructured: string[] = []
  const destrRe = /const\s*\{\s*([^}]+)\s*}\s*=\s*apiMap/g
  while ((m = destrRe.exec(src))) {
    const names = (m[1] || '')
      .split(',')
      .map((s) => s.trim())
      .filter(Boolean)
    destructured.push(...names)
  }
  for (const alias of destructured) {
    const aliasRe = new RegExp(`${alias}\\.(\\w+)`, 'g')
    let mm: RegExpExecArray | null
    while ((mm = aliasRe.exec(src))) {
      const key = mm[1]
      const val = getValueFromApiMap(loadedApiMap, [alias, key])
      if (typeof val === 'string') targets.add(normalizeWP(val))
    }
  }
  // new URL('/wp-json/...', WP)
  const newUrlRe = /new\s+URL\(\s*['"](\/wp-json[^'"]+)['"]/g
  while ((m = newUrlRe.exec(src))) {
    const pathOnly = m[1]
    if (pathOnly) targets.add(`{WP}${pathOnly}`)
  }
  // string literal fetch to WP_BASE concatenations
  const literalRe = /['"](https?:[^'"]*wp-json[^'"]+)['"]/g
  while ((m = literalRe.exec(src))) {
    targets.add(normalizeWP(m[1]))
  }
  return Array.from(targets)
}

function buildTable(rows: RouteInfo[]): string {
  const header = ['Endpoint', 'Methods', 'Upstream WP Endpoint(s)']
  const sep = ['---', '---', '---']
  const body = rows
    .sort((a, b) => a.path.localeCompare(b.path))
    .map((r) => `| \`${r.path}\` | ${r.methods.join(', ')} | ${r.targets.length ? r.targets.map((t) => `\`${t}\``).join('<br/>') : '_n/a_'} |`)
  return [
    '# API Proxy Map (generated)',
    '<!-- markdownlint-disable MD033 -->',
    '',
    '> Do not edit manually. Generated from app/api and src/app/api by scripts/generateApiMap.ts',
    '',
    `| ${header.join(' | ')} |`,
    `| ${sep.join(' | ')} |`,
    ...body,
    '',
    '_Note: This is best-effort static analysis. Dynamic endpoints or function-based apiMap entries may not be fully resolved._',
    '<!-- markdownlint-enable MD033 -->',
  ].join('\n')
}

function main() {
  const files = API_DIRS.flatMap((d) => walk(d))
  const rows: RouteInfo[] = []
  for (const file of files) {
    const src = fs.readFileSync(file, 'utf8')
    const methods = detectMethods(src)
    const targets = extractTargets(src)
    rows.push({ path: toApiPath(file), methods: methods.length ? methods : ['GET'], targets })
  }
  const md = buildTable(rows)
  const outPath = path.resolve(process.cwd(), 'docs', 'api-reference', 'proxy-map.md')
  fs.mkdirSync(path.dirname(outPath), { recursive: true })
  fs.writeFileSync(outPath, md, 'utf8')
  // eslint-disable-next-line no-console
  console.log(`Wrote ${outPath}`)
}

main()


// ==== FILE: scripts\generateApiProxyRoles.ts ====
import fs from 'node:fs'
import path from 'node:path'

import { apiMap as loadedApiMap, WP_BASE } from '../src/lib/wpAPIMap'
import { apiRolesMatrix, type Role } from '../src/config/apiRolesMatrix'

type Methods = string[]
type RouteInfo = { path: string; methods: Methods; targets: string[] }

const API_DIRS = [
  path.resolve(process.cwd(), 'app', 'api'),
  path.resolve(process.cwd(), 'src', 'app', 'api'),
]

function walk(dir: string, acc: string[] = []): string[] {
  if (!fs.existsSync(dir)) return acc
  for (const entry of fs.readdirSync(dir, { withFileTypes: true })) {
    const p = path.join(dir, entry.name)
    if (entry.isDirectory()) walk(p, acc)
    else if (entry.isFile() && entry.name === 'route.ts') acc.push(p)
  }
  return acc
}

function detectMethods(src: string): Methods {
  const methods = new Set<string>()
  const re = /export\s+(?:async\s+)?function\s+(GET|POST|PATCH|PUT|DELETE)|export\s+const\s+(GET|POST|PATCH|PUT|DELETE)/g
  let m: RegExpExecArray | null
  while ((m = re.exec(src))) {
    const method = (m[1] || m[2])?.toUpperCase()
    if (method) methods.add(method)
  }
  const reExport = /export\s*{\s*([^}]+)\s*}\s*from\s*['"][^'"]+['"]/g
  while ((m = reExport.exec(src))) {
    const names = (m[1] || '')
      .split(',')
      .map((s) => s.trim().toUpperCase())
      .filter((n) => ['GET', 'POST', 'PATCH', 'PUT', 'DELETE'].includes(n))
    for (const n of names) methods.add(n)
  }
  return Array.from(methods)
}

function toApiPath(absFile: string): string {
  const isSrc = absFile.includes(`${path.sep}src${path.sep}app${path.sep}`)
  const appRoot = isSrc ? path.resolve(process.cwd(), 'src', 'app') : path.resolve(process.cwd(), 'app')
  const rel = path.relative(appRoot, absFile).replace(/\\/g, '/')
  return '/' + rel.replace(/\/route\.ts$/, '')
}

type ApiMap = any

function getValueFromApiMap(obj: ApiMap, chain: string[]): unknown {
  let cur: any = obj
  for (const key of chain) {
    if (cur && typeof cur === 'object' && key in cur) cur = cur[key]
    else return undefined
  }
  return cur
}

function normalizeWP(val: string): string {
  const base = (WP_BASE || '').replace(/\/$/, '')
  return val.replace(base, '{WP}')
}

function extractTargets(src: string): string[] {
  const targets = new Set<string>()
  // apiMap.section.key
  const directRe = /apiMap\.(\w+)\.(\w+)/g
  let m: RegExpExecArray | null
  while ((m = directRe.exec(src))) {
    const val = getValueFromApiMap(loadedApiMap, [m[1], m[2]])
    if (typeof val === 'string') targets.add(normalizeWP(val))
  }
  // const { analytics } = apiMap; analytics.views
  const destr: string[] = []
  const destrRe = /const\s*\{\s*([^}]+)\s*}\s*=\s*apiMap/g
  while ((m = destrRe.exec(src))) {
    destr.push(
      ...((m[1] || '')
        .split(',')
        .map((s) => s.trim())
        .filter(Boolean)),
    )
  }
  for (const alias of destr) {
    const aliasRe = new RegExp(`${alias}\\.(\\w+)`, 'g')
    let mm: RegExpExecArray | null
    while ((mm = aliasRe.exec(src))) {
      const key = mm[1]
      const val = getValueFromApiMap(loadedApiMap, [alias, key])
      if (typeof val === 'string') targets.add(normalizeWP(val))
    }
  }
  // new URL('/wp-json/...', WP)
  const newUrlRe = /new\s+URL\(\s*['"](\/wp-json[^'"]+)['"]/g
  while ((m = newUrlRe.exec(src))) {
    const pathOnly = m[1]
    if (pathOnly) targets.add(`{WP}${pathOnly}`)
  }
  // literal wp-json URLs
  const literalRe = /['"](https?:[^'"]*wp-json[^'"]+)['"]/g
  while ((m = literalRe.exec(src))) {
    targets.add(normalizeWP(m[1]))
  }
  return Array.from(targets)
}

const roles: Role[] = [
  'public',
  'subscriber',
  'contributor',
  'author',
  'editor',
  'seo_editor',
  'seo_manager',
  'administrator',
]

function markAccess(endpointPath: string, method: string): Record<Role, boolean> {
  // Try exact and then pattern match like in audit script
  const methodUpper = method.toUpperCase()
  const match = apiRolesMatrix.find((e) => {
    if (e.method !== (methodUpper as any)) return false
    if (e.path === endpointPath) return true
    const pattern = e.path
      .replace(/\//g, '\\/')
      .replace(/\[.+?\]/g, '[^/]+')
      .replace(/\.+/g, '.+')
    return new RegExp(`^${pattern}$`).test(endpointPath)
  })
  const out = Object.create(null) as Record<Role, boolean>
  for (const r of roles) out[r] = match ? Boolean(match.roles[r]?.length) : false
  return out
}

function headerForRole(r: Role) {
  if (r === 'seo_editor') return 'SEO Editor'
  if (r === 'seo_manager') return 'SEO Manager'
  return r.charAt(0).toUpperCase() + r.slice(1)
}

function buildTable(rows: RouteInfo[]): string {
  const baseHeader = ['Endpoint', 'Methods', 'Upstream WP Endpoint(s)']
  const roleHeader = roles.map(headerForRole)
  const header = [...baseHeader, ...roleHeader]
  const sep = header.map(() => '---')

  const body = rows
    .sort((a, b) => a.path.localeCompare(b.path))
    .map((r) => {
      const firstMethod = r.methods[0] || 'GET'
      const allowed = markAccess(r.path, firstMethod)
      const accessMarks = roles.map((role) => (allowed[role] ? '‚úÖ' : '‚ùå'))
      return `| \`${r.path}\` | ${r.methods.join(', ')} | ${r.targets.length ? r.targets.map((t) => `\`${t}\``).join('<br/>') : '_n/a_'} | ${accessMarks.join(' | ')} |`
    })

  return [
    '# API Proxy Map with Roles (generated)',
    '<!-- markdownlint-disable MD033 -->',
    '',
    '> Do not edit manually. Generated from app/api and src/app/api and joined with src/config/apiRolesMatrix.ts',
    '',
    `| ${header.join(' | ')} |`,
    `| ${sep.join(' | ')} |`,
    ...body,
    '',
    '_Note: Role marks use the first detected method for the route; for routes supporting multiple methods, consult roles-matrix.md for per-method details._',
    '<!-- markdownlint-enable MD033 -->',
  ].join('\n')
}

function main() {
  const files = API_DIRS.flatMap((d) => walk(d))
  const rows: RouteInfo[] = []
  for (const file of files) {
    const src = fs.readFileSync(file, 'utf8')
    const methods = detectMethods(src)
    const targets = extractTargets(src)
    rows.push({ path: toApiPath(file), methods: methods.length ? methods : ['GET'], targets })
  }
  const md = buildTable(rows)
  const outPath = path.resolve(process.cwd(), 'docs', 'api-reference', 'proxy-map-with-roles.md')
  fs.mkdirSync(path.dirname(outPath), { recursive: true })
  fs.writeFileSync(outPath, md, 'utf8')
  // eslint-disable-next-line no-console
  console.log(`Wrote ${outPath}`)
}

main()


// ==== FILE: scripts\generateRoleMatrix.ts ====
import fs from 'node:fs'
import path from 'node:path'

import { apiRolesMatrix, type Role } from '../src/config/apiRolesMatrix'

const roles: Role[] = [
  'public',
  'subscriber',
  'contributor',
  'author',
  'editor',
  'seo_editor',
  'seo_manager',
  'administrator',
]

function allowedMark(has: boolean) {
  return has ? '‚úÖ' : '‚ùå'
}

function roleHeader(role: Role) {
  switch (role) {
    case 'seo_editor':
      return 'SEO Editor'
    case 'seo_manager':
      return 'SEO Manager'
    default:
      return role.charAt(0).toUpperCase() + role.slice(1)
  }
}

function buildTable() {
  const header = ['Endpoint', 'Method', ...roles.map(roleHeader)]
  const sep = header.map(() => '---')

  const rows = apiRolesMatrix.map((e) => {
    const cols: string[] = []
    cols.push(`\`${e.path}\``)
    cols.push(e.method)
    for (const r of roles) {
      const actions = e.roles[r]
      const has = Array.isArray(actions) && actions.length > 0
      cols.push(allowedMark(has))
    }
    return `| ${cols.join(' | ')} |`
  })

  const out = [
    '<!-- markdownlint-disable MD036 -->',
    '# API Roles Matrix (generated)',
    '',
    'Do not edit manually. Source of truth: `src/config/apiRolesMatrix.ts`.',
    '',
    `| ${header.join(' | ')} |`,
    `| ${sep.join(' | ')} |`,
    ...rows,
    '',
    'Legend: ‚úÖ allowed (any of read/write/delete/moderate), ‚ùå disallowed.',
    '<!-- markdownlint-enable MD036 -->',
  ].join('\n')

  return out
}

function main() {
  const md = buildTable()
  const docsDir = path.resolve(process.cwd(), 'docs', 'api-reference')
  const target = path.join(docsDir, 'roles-matrix.md')
  if (!fs.existsSync(docsDir)) fs.mkdirSync(docsDir, { recursive: true })
  fs.writeFileSync(target, md, 'utf8')
  // eslint-disable-next-line no-console
  console.log(`Wrote ${target}`)
}

main()


